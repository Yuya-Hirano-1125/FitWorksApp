<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIã‚³ãƒ¼ãƒ ğŸ¤–ğŸ’¬ | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">
</head>
<body class="chat-page">
<div class="main-container">
    <h1><i class="fa-solid fa-robot header-icon"></i>AIã‚³ãƒ¼ãƒ </h1>
    
    <div class="chat-history" id="chatHistory">
        <div class="message-bubble ai-message">
            ã“ã‚“ã«ã¡ã¯ï¼AIã‚³ãƒ¼ãƒã®FitBotã§ã™ã€‚ã‚ãªãŸã®ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«æœ€é©ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆã—ã¾ã™ï¼
			<br><strong>ã€Œä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€</strong>ã‚„<strong>ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆæ–¹æ³•ã€</strong>ãªã©ã€ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚
        </div>
    </div>
    
    <div class="chat-input-area">
        <input type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." id="messageInput" onkeydown="handleKey(event)">
        <button type="button" class="button chat-send" onclick="sendMessage()">é€ä¿¡ <i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const messageInput = document.getElementById('messageInput');
        
        // â˜… ä¿®æ­£: JavaScriptã§ãƒ¡ã‚¿ã‚¿ã‚°ã‹ã‚‰CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã«å–å¾—
        const csrfMetaToken = document.querySelector('meta[name="_csrf"]');
        const csrfMetaHeader = document.querySelector('meta[name="_csrf_header"]');

        const csrfToken = csrfMetaToken ? csrfMetaToken.content : null;
        const csrfHeader = csrfMetaHeader ? csrfMetaHeader.content : null;

        function handleKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                sendMessage();
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            displayMessage(message, 'user');
            messageInput.value = '';
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¡¨ç¤º
            const loadingBubble = displayMessage('AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­ã§ã™...', 'ai', true);

            try {
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                };
                
                // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ 
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken; 
                }
                
                // APIå‘¼ã³å‡ºã—
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers,
                    body: new URLSearchParams({ 'message': message })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    // 500ã‚¨ãƒ©ãƒ¼ã‚„400ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ãƒãƒ£ãƒƒãƒˆãƒãƒ–ãƒ«ã«è¡¨ç¤º
                    throw new Error(`APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${response.status}. è©³ç´°: ${errorText.substring(0, 300)}`);
                }
                
                const aiResponseText = await response.text();
                
                // Geminiã®Markdownã‚’HTMLã«æ•´å½¢ã™ã‚‹é–¢æ•°
                const formattedResponse = formatAiResponse(aiResponseText);
                
                loadingBubble.innerHTML = formattedResponse;
                loadingBubble.classList.remove('loading');
                
            } catch (error) {
                // â— ä¿®æ­£ç‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦æœ›ã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                const errorMessage = 'AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚³ãƒ¼ãƒ ğŸ¤– FitBot<br>â—AIå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                
                loadingBubble.innerHTML = errorMessage;
                loadingBubble.classList.remove('loading');
                
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èµ¤ãå¤‰æ›´ã—ã¦ç›®ç«‹ãŸã›ã‚‹
                loadingBubble.style.backgroundColor = 'var(--error-color)';
                loadingBubble.style.color = 'white'; 
                loadingBubble.style.border = '1px solid var(--error-color)';
                loadingBubble.style.boxShadow = '0 4px 10px rgba(255, 74, 74, 0.4)';
                
                console.error('API Error:', error);
            }
            
            scrollToBottom();
        }

        function displayMessage(text, sender, isLoading = false) {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${sender}-message ${isLoading ? 'loading' : ''}`;
            bubble.innerHTML = text; 
            chatHistory.appendChild(bubble);
            scrollToBottom();
            return bubble;
        }

        function scrollToBottom() {
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹
            chatHistory.scrollTo({
                top: chatHistory.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        function formatAiResponse(text) {
            // 1. å¼·èª¿ (**å¤ªå­—**) ã‚’ <strong> ã‚¿ã‚°ã«å¤‰æ›
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // 2. ç®‡æ¡æ›¸ã (* ã¾ãŸã¯ - ã§å§‹ã¾ã‚‹è¡Œ) ã‚’ <ul><li> ã«å¤‰æ› (ç°¡æ˜“ç‰ˆ)
            formattedText = formattedText.replace(/(\*|\-)\s(.*?)\n/g, '<li>$2</li>').replace(/(\*|\-)\s(.*?)$/g, '<li>$2</li>');
            if (formattedText.includes('<li>')) {
                // <li>ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã€å…¨ä½“ã‚’<ul>ã§å›²ã‚€
                formattedText = '<ul>' + formattedText + '</ul>';
                formattedText = formattedText.replace(/<\/ul>\s*<ul>/g, ''); 
            }
            
            // 3. æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’ <br> ã«å¤‰æ›
            formattedText = formattedText.replace(/\n/g, '<br>');
            
            return formattedText;
        }

        scrollToBottom();
    </script>
</div>
</body>
</html>