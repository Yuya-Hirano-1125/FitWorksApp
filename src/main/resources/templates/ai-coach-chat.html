<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIã‚³ãƒ¼ãƒ ğŸ¤–ğŸ’¬ | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
   

    <style>
        /* --- CSS VARIABLES (ãƒã‚ªãƒ³ãƒ»ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹) --- */
        :root {
            --primary-color: #00e676;    /* ãƒã‚ªãƒ³ã‚°ãƒªãƒ¼ãƒ³ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/å¼·èª¿) */
            --secondary-color: #00b860;  /* ãƒ‡ã‚£ãƒ¼ãƒ—ã‚°ãƒªãƒ¼ãƒ³ (ã‚µãƒ–) */
            --ai-accent-color: #00ffff;  /* ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ã‚·ã‚¢ãƒ³ (AIå¼·èª¿) */
            --dark-text: #f0f0f0;        /* ãƒ©ã‚¤ãƒˆãƒ†ã‚­ã‚¹ãƒˆ */
            --light-bg: #121212;         /* è¶…ãƒ€ãƒ¼ã‚¯èƒŒæ™¯ */
            --container-bg: #1e1e1e;     /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ */
            --error-color: #ff4a4a;      /* å¼·èª¿ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚«ãƒ©ãƒ¼ */
            
            /* ãƒãƒ£ãƒƒãƒˆãƒãƒ–ãƒ«å°‚ç”¨ */
            --ai-bubble: #333;           /* AIãƒãƒ–ãƒ«èƒŒæ™¯ */
            --user-bubble: #00e676;      /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ–ãƒ«èƒŒæ™¯ (Primary Color) */
        }

        /* --- ANIMATIONS: POP & FLOAT --- */
        @keyframes floatingBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            80% { opacity: 1; transform: translateY(-5px) scale(1.01); }
            100% { opacity: 1; transform: translateY(0) scale(1.0); }
        }
        @keyframes jumpOnHover {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.02); }
            100% { transform: translateY(0) scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* AIã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes typing {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        /* --- BASE STYLE --- */
        body {
            /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯ã«çµ±ä¸€ */
            background: linear-gradient(135deg, #0f1218, #07090b);
            background-size: 400% 400%; 
            animation: floatingBackground 20s ease infinite alternate;
            
            font-family: 'Poppins', 'Noto Sans JP', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            perspective: 1000px;
            color: var(--dark-text);
        }

        /* --- MAIN CONTAINER --- */
        .main-container {
            /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã«çµ±ä¸€ */
            background: var(--container-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 0 3px var(--secondary-color);
            border: 1px solid #333;
            text-align: center;
            transition: all 0.5s cubic-bezier(.25,.8,.25,1);
            width: 100%;
            max-width: 800px; /* ãƒãƒ£ãƒƒãƒˆã—ã‚„ã™ã„ã‚ˆã†ã«åºƒã */
            height: 85vh; /* ç”»é¢ã‚’åºƒãä½¿ã† */
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards;
            transform: rotateX(0deg) scale(1.0);
        }

        .main-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 15px var(--ai-accent-color); /* AIç”»é¢ãªã®ã§ã‚·ã‚¢ãƒ³ã§ãƒ›ãƒãƒ¼ */
        }

        h1 {
            color: var(--ai-accent-color);
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: 800;
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
        }
        
        .header-icon {
            font-size: 30px;
            color: var(--ai-accent-color);
            margin-right: 10px;
        }

        /* --- CHAT AREA --- */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            text-align: left;
            margin-bottom: 20px;
            background-color: #2a2a2a; /* èƒŒæ™¯ã‚’ã•ã‚‰ã«æš—ã */
            border-radius: 10px;
            border: 1px solid #333;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ”¹è‰¯ (Webkitå‘ã‘) */
            &::-webkit-scrollbar {
                width: 8px;
            }
            &::-webkit-scrollbar-thumb {
                background-color: var(--secondary-color);
                border-radius: 4px;
            }
            &::-webkit-scrollbar-track {
                background: #1e1e1e;
            }
        }

        .message-bubble {
            max-width: 75%; /* å°‘ã—ç‹­ã */
            padding: 14px 20px;
            margin: 10px 0;
            border-radius: 20px;
            line-height: 1.7;
            font-size: 16px;
            animation: fadeIn 0.4s ease-out;
            word-break: break-word; /* é•·ã„å˜èªã§ã‚‚æŠ˜ã‚Šè¿”ã™ */
        }
        
        /* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (æš—ã„èƒŒæ™¯ã€ã‚·ã‚¢ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ) */
        .ai-message {
            background-color: var(--ai-bubble); /* #333 */
            color: var(--dark-text);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
            border: 1px solid #444;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        /* AIã®å¼·èª¿ãƒ†ã‚­ã‚¹ãƒˆã¯ãƒã‚ªãƒ³ã‚°ãƒªãƒ¼ãƒ³ã« */
        .ai-message strong {
            color: var(--ai-accent-color);
            font-weight: 700;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (ãƒã‚ªãƒ³ã‚°ãƒªãƒ¼ãƒ³èƒŒæ™¯ã€æš—ã„ãƒ†ã‚­ã‚¹ãƒˆ) */
        .user-message {
            background-color: var(--user-bubble); /* #00e676 */
            color: #1e1e1e; /* æ¿ƒã„ãƒ†ã‚­ã‚¹ãƒˆ */
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 230, 118, 0.4);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ–ãƒ« */
        .message-bubble.loading {
            /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            font-style: italic;
            opacity: 0.8;
            color: var(--ai-accent-color);
        }

        /* --- INPUT AREA --- */
        .chat-input-area {
            display: flex;
            gap: 15px;
            flex-shrink: 0;
            padding-top: 10px;
        }

        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 16px 20px; /* å¤§ããã™ã‚‹ */
            border: none;
            background-color: #333;
            border-radius: 30px;
            box-sizing: border-box;
            font-size: 16px;
            color: var(--dark-text);
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .chat-input-area input[type="text"]:focus {
            outline: none;
            border: 1px solid var(--ai-accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5), inset 0 2px 5px rgba(0,0,0,0.5);
        }
        
        /* --- BUTTONS --- */
        .button.chat-send {
            text-decoration: none;
            border-radius: 30px;
            transition: all 0.3s ease-in-out;
            font-weight: 800;
            display: flex; /* ã‚¢ã‚¤ã‚³ãƒ³å¯¾å¿œã®ãŸã‚ */
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 0 25px; /* é«˜ã•èª¿æ•´ã¯flexã«ä»»ã›ã‚‹ */
            text-transform: uppercase;
            
            /* AIãƒãƒ£ãƒƒãƒˆãªã®ã§ã€AIã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆã‚·ã‚¢ãƒ³ï¼‰ã‚’ä½¿ç”¨ */
            background: linear-gradient(45deg, var(--ai-accent-color), #00c8c8);
            color: #1e1e1e;
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.4);
            margin: 0; 
        }
        .button.chat-send i {
            margin-left: 8px;
            font-size: 18px;
        }
        .button.chat-send:hover {
            animation: jumpOnHover 0.4s ease-out;
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.6);
            transform: translateY(-2px);
        }
        
        /* --- RESPONSIVE MOBILE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            .main-container {
                height: 90vh; 
                max-width: 100%;
                padding: 20px;
            }
            .chat-input-area {
                flex-direction: column;
                gap: 10px;
            }
            .button.chat-send {
                width: 100%;
                padding: 14px 25px;
            }
            .message-bubble {
                max-width: 90%;
            }
            h1 {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
<div class="main-container">
    <h1><i class="fa-solid fa-robot header-icon"></i>AIã‚³ãƒ¼ãƒ </h1>
    
    <div class="chat-history" id="chatHistory">
        <div class="message-bubble ai-message">
            ã“ã‚“ã«ã¡ã¯ï¼AIã‚³ãƒ¼ãƒã®FitBotã§ã™ã€‚ã‚ãªãŸã®ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«æœ€é©ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆã—ã¾ã™ï¼
			<br><strong>ã€Œä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€</strong>ã‚„<strong>ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆæ–¹æ³•ã€</strong>ãªã©ã€ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚
        </div>
    </div>
    
    <div class="chat-input-area">
        <input type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." id="messageInput" onkeydown="handleKey(event)">
        <button type="button" class="button chat-send" onclick="sendMessage()">é€ä¿¡ <i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const messageInput = document.getElementById('messageInput');
        
        // â˜… ä¿®æ­£: JavaScriptã§ãƒ¡ã‚¿ã‚¿ã‚°ã‹ã‚‰CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã«å–å¾—
        const csrfMetaToken = document.querySelector('meta[name="_csrf"]');
        const csrfMetaHeader = document.querySelector('meta[name="_csrf_header"]');

        const csrfToken = csrfMetaToken ? csrfMetaToken.content : null;
        const csrfHeader = csrfMetaHeader ? csrfMetaHeader.content : null;

        function handleKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                sendMessage();
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            displayMessage(message, 'user');
            messageInput.value = '';
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦è¡¨ç¤º
            const loadingBubble = displayMessage('AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­ã§ã™...', 'ai', true);

            try {
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                };
                
                // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ 
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken; 
                }
                
                // APIå‘¼ã³å‡ºã—
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers,
                    body: new URLSearchParams({ 'message': message })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    // 500ã‚¨ãƒ©ãƒ¼ã‚„400ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ãƒãƒ£ãƒƒãƒˆãƒãƒ–ãƒ«ã«è¡¨ç¤º
                    throw new Error(`APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${response.status}. è©³ç´°: ${errorText.substring(0, 300)}`);
                }
                
                const aiResponseText = await response.text();
                
                // Geminiã®Markdownã‚’HTMLã«æ•´å½¢ã™ã‚‹é–¢æ•°
                const formattedResponse = formatAiResponse(aiResponseText);
                
                loadingBubble.innerHTML = formattedResponse;
                loadingBubble.classList.remove('loading');
                
            } catch (error) {
                // â— ä¿®æ­£ç‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦æœ›ã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                const errorMessage = 'AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚³ãƒ¼ãƒ ğŸ¤– FitBot<br>â—AIå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                
                loadingBubble.innerHTML = errorMessage;
                loadingBubble.classList.remove('loading');
                
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èµ¤ãå¤‰æ›´ã—ã¦ç›®ç«‹ãŸã›ã‚‹
                loadingBubble.style.backgroundColor = 'var(--error-color)';
                loadingBubble.style.color = 'white'; 
                loadingBubble.style.border = '1px solid var(--error-color)';
                loadingBubble.style.boxShadow = '0 4px 10px rgba(255, 74, 74, 0.4)';
                
                console.error('API Error:', error);
            }
            
            scrollToBottom();
        }

        function displayMessage(text, sender, isLoading = false) {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${sender}-message ${isLoading ? 'loading' : ''}`;
            bubble.innerHTML = text; 
            chatHistory.appendChild(bubble);
            scrollToBottom();
            return bubble;
        }

        function scrollToBottom() {
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹
            chatHistory.scrollTo({
                top: chatHistory.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        function formatAiResponse(text) {
            // 1. å¼·èª¿ (**å¤ªå­—**) ã‚’ <strong> ã‚¿ã‚°ã«å¤‰æ›
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // 2. ç®‡æ¡æ›¸ã (* ã¾ãŸã¯ - ã§å§‹ã¾ã‚‹è¡Œ) ã‚’ <ul><li> ã«å¤‰æ› (ç°¡æ˜“ç‰ˆ)
            formattedText = formattedText.replace(/(\*|\-)\s(.*?)\n/g, '<li>$2</li>').replace(/(\*|\-)\s(.*?)$/g, '<li>$2</li>');
            if (formattedText.includes('<li>')) {
                // <li>ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã€å…¨ä½“ã‚’<ul>ã§å›²ã‚€
                formattedText = '<ul>' + formattedText + '</ul>';
                formattedText = formattedText.replace(/<\/ul>\s*<ul>/g, ''); 
            }
            
            // 3. æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’ <br> ã«å¤‰æ›
            formattedText = formattedText.replace(/\n/g, '<br>');
            
            return formattedText;
        }

        scrollToBottom();
    </script>
</div>
</body>
</html>