<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIã‚³ãƒ¼ãƒ ğŸ¤–ğŸ’¬ | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
    
    <style>
        /* --- CSS VARIABLES: ã‚¹ãƒãƒ¼ãƒ†ã‚£ãƒ¼ãªãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ã¨ã‚¢ã‚¯ã‚¢ã‚°ãƒªãƒ¼ãƒ³ --- */
        :root {
            --primary-color: #0d47a1; --secondary-color: #26a69a; --dark-text: #212121;
            --light-bg: #f8fbff; --container-bg: #ffffff; --ai-bubble: #e0f7fa; 
            --user-bubble: #4f8cff; --warning-color: #ffb300;
        }

        /* --- ANIMATIONS --- */
        @keyframes floatingBackground { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes popIn { 0% { opacity: 0; transform: translateY(20px) scale(0.95); } 80% { opacity: 1; transform: translateY(-5px) scale(1.01); } 100% { opacity: 1; transform: translateY(0) scale(1.0); } }
        @keyframes flashIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        @keyframes loading-dots { 0% { width: 0; } 33% { width: 0.5em; } 66% { width: 1em; } 100% { width: 1.5em; } }
        
        .loading-dots:after {
            content: " . . ."; overflow: hidden; display: inline-block; vertical-align: bottom;
            animation: loading-dots 1.5s steps(3) infinite; width: 1.5em;
        }

        /* --- BASE STYLE --- */
        body {
            background: linear-gradient(135deg, #a0d8f0, #0d47a1); animation: floatingBackground 15s ease infinite alternate;
            font-family: 'Noto Sans JP', sans-serif; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px; box-sizing: border-box; color: var(--dark-text);
        }
        .main-container {
            background: var(--container-bg); padding: 30px; border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25), 0 0 0 4px var(--light-bg); width: 100%; max-width: 650px; height: 85vh; 
            display: flex; flex-direction: column; box-sizing: border-box;
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards;
            border: 2px solid var(--secondary-color);
        }
        h1 {
            color: var(--primary-color); margin-bottom: 20px; font-size: 28px; font-weight: 800; text-align: center;
            border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px;
        }
        /* CHAT AREA */
        .chat-history {
            flex-grow: 1; overflow-y: auto; padding: 15px; margin-bottom: 20px; background-color: #f1f8f9;
            border-radius: 10px; box-shadow: inset 0 3px 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth;
        }
        /* BUBBLE STYLES */
        .message-bubble {
            max-width: 90%; padding: 14px 20px; border-radius: 18px; line-height: 1.5; font-size: 14px;
            animation: flashIn 0.5s ease-out; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ai-message {
            background-color: var(--ai-bubble); color: var(--dark-text); border-bottom-left-radius: 5px; align-self: flex-start;
        }
        .user-message {
            background: linear-gradient(45deg, var(--user-bubble), #4f63ff); color: white; border-bottom-right-radius: 5px;
            align-self: flex-end; margin-left: auto;
        }
        .ai-message strong { color: var(--primary-color); font-weight: 700; }
        .user-message strong { color: white; font-weight: 700; }
        .ai-message.warning { background-color: #fff8e1; color: var(--warning-color); border: 1px solid var(--warning-color); font-weight: 700; animation: none; }
        .ai-message.warning strong { color: var(--warning-color); }
        /* INPUT AREA */
        .chat-input-area { display: flex; gap: 10px; flex-shrink: 0; }
        .chat-input-area input[type="text"] {
            flex-grow: 1; padding: 12px 20px; border: 2px solid #ccc; border-radius: 25px; font-size: 16px; transition: border-color 0.3s;
        }
        .button.chat-send {
            border-radius: 30px; font-weight: 700; font-size: 16px; padding: 12px 25px; text-transform: uppercase;
            background: linear-gradient(90deg, var(--secondary-color), #00c853); color: white; box-shadow: 0 4px 15px rgba(38, 166, 154, 0.4);
            transition: all 0.2s ease-in-out; border: none; cursor: pointer;
        }
        .button.chat-send:hover {
            box-shadow: 0 6px 20px rgba(38, 166, 154, 0.6); transform: translateY(-2px) scale(1.02);
        }
        @media (max-width: 768px) {
            .main-container { height: 90vh; padding: 15px; }
            .chat-input-area { flex-direction: column; gap: 8px; }
            .button.chat-send { width: 100%; }
        }
    </style>
    
</head>
<body>
<div class="main-container">
    <h1>AIã‚³ãƒ¼ãƒ ğŸ¤–ğŸ’¬</h1>
    
    <div class="chat-history" id="chatHistory">
    </div>

    <div class="chat-input-area">
        <input type="text" 
               placeholder="ä¾‹: èƒ¸ã€åˆç´šã€30åˆ†ã€ã‚¸ãƒ " 
               id="messageInput" 
               autocomplete="off"
               required
               onkeydown="handleKey(event)"> <button type="button" class="button chat-send" onclick="sendMessage()">é€ä¿¡</button>
    </div>
</div>

<script>
    const chatHistory = document.getElementById('chatHistory');
    const messageInput = document.getElementById('messageInput');
    
    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]').content;

    // --- DOMæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    
    function scrollToBottom() {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    /**
     * æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DOMã«è¿½åŠ ã™ã‚‹ (éåŒæœŸé€šä¿¡ç”¨)
     * @param {string} text - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ï¼ˆHTML/Markdownã‚’å«ã‚€ï¼‰
     * @param {string} sender - é€ã‚Šæ‰‹ ('user' or 'ai')
     * @param {boolean} isWarning - è­¦å‘Šã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ã™ã‚‹ã‹
     * @param {boolean} isLoading - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¯ãƒ©ã‚¹ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹ã‹
     * @returns {HTMLElement} - ä½œæˆã•ã‚ŒãŸãƒãƒ–ãƒ«è¦ç´ 
     */
    function displayMessage(text, sender, isWarning = false, isLoading = false) {
        const bubble = document.createElement('div');
        let className = `message-bubble ${sender}-message`;
        if (isWarning) className += ' warning';
        if (isLoading) className += ' loading';
        
        bubble.className = className;
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ãƒ‰ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        if (isLoading) {
             bubble.innerHTML = `<span class="loading-dots">${text}</span>`;
        } else {
             bubble.innerHTML = text; // HTMLã¨ã—ã¦æŒ¿å…¥ (Markdowné¢¨ãƒ†ã‚­ã‚¹ãƒˆ)
        }
        
        chatHistory.appendChild(bubble);
        scrollToBottom();
        return bubble;
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

    function handleKey(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³æ™‚è¡¨ç¤º
        displayMessage(message, 'user');
        messageInput.value = '';

        // 2. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const loadingBubble = displayMessage('AIãŒãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆä¸­ã§ã™', 'ai', false, true);

        try {
            // 3. AJAX POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æº–å‚™
            const requestBody = JSON.stringify({ sender: 'user', text: message }); // Message DTOã®å½¢å¼
            
            const response = await fetch('/api/chat', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeaderName]: csrfToken 
                },
                body: requestBody
            });

            if (!response.ok) {
                const errorDetail = await response.text();
                throw new Error(`APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: HTTP ${response.status}`);
            }

            // 4. JSONå¿œç­”ï¼ˆMessage DTOï¼‰ã‚’è§£æ
            const data = await response.json(); 
            const aiText = data.text; // Message.getText()ã‹ã‚‰å–å¾—
            
            // 5. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å›ç­”ã«ç½®ãæ›ãˆã‚‹
            loadingBubble.classList.remove('loading');
            loadingBubble.innerHTML = aiText; 
            
        } catch (error) {
            // 6. ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
            loadingBubble.classList.remove('loading');
            loadingBubble.classList.add('warning');
            loadingBubble.innerHTML = `<span style="color: var(--warning-color); font-weight: bold;">[ã‚¨ãƒ©ãƒ¼]</span> ${error.message}`;
        }

        scrollToBottom();
    }
    
    // --- åˆæœŸè¡¨ç¤ºå‡¦ç† ---
    document.addEventListener('DOMContentLoaded', function() {
        // AIã‚³ãƒ¼ãƒã®åˆæœŸè³ªå•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const initialQuestion = 
            "**AIã‚³ãƒ¼ãƒ FitBot ã§ã™ï¼**ğŸ’ª æœ€é«˜ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®4ç‚¹ã‚’ã¾ã¨ã‚ã¦æ•™ãˆã¦ãã ã•ã„ï¼"
            + "<br><br>1. **çµŒé¨“ãƒ¬ãƒ™ãƒ«** (åˆç´š / ä¸­ç´š / ä¸Šç´š)"
            + "<br>2. **å¯èƒ½æ™‚é–“** (1å›ã‚ãŸã‚Šã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“)"
            + "<br>3. **é›ãˆãŸã„éƒ¨ä½** (èƒ¸ã€èƒŒä¸­ã€è„šã€å…¨èº«ãªã©)"
            + "<br>4. **å ´æ‰€/å™¨å…·** (å®¶ã€ã‚¸ãƒ ã€ãƒ€ãƒ³ãƒ™ãƒ«åˆ©ç”¨ãªã©)"
            + "<br><br>ä¾‹: **ä¸­ç´šã€45åˆ†ã€èƒ¸ã¨è…•ã€ã‚¸ãƒ **";
            
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ¿å…¥
        displayMessage(initialQuestion, 'ai');
        
        scrollToBottom();
    });
</script>
</body>
</html>



