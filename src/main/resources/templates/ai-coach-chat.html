<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI„Ç≥„Éº„ÉÅ ü§ñüí¨ | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- CSRF„Éà„Éº„ÇØ„É≥„Çí„É°„Çø„Çø„Ç∞„Å®„Åó„Å¶ÂÆâÂÖ®„Å´Âüã„ÇÅËæº„Åø„Åæ„Åô„ÄÇ -->
    <!-- „Åì„ÅÆÊñπÂºè„ÅØ„ÄÅThymeleaf„ÅÆ„Éë„Éº„ÇπÊôÇ„Å´„ÇØ„É©„ÉÉ„Ç∑„É•„Åô„Çã„É™„Çπ„ÇØ„ÅåÊúÄ„ÇÇ‰Ωé„ÅÑÊ®ôÊ∫ñÁöÑ„Å™ÊñπÊ≥ï„Åß„Åô„ÄÇ -->
   
   

    <style>
        /* --- CSS VARIABLES (Èùí„Éô„Éº„Çπ) --- */
        :root {
            --primary-color: #4f8cff;
            --secondary-color: #8cb3ff;
            --dark-text: #36454f;
            --light-bg: #f8fbff;
            --error-color: #ff4a4a;
            --success-color: #4CAF50;
            --container-bg: #ffffff;
            --ai-bubble: #e3f2fd;
            --user-bubble: #8cb3ff;
        }

        /* --- ANIMATIONS: POP & FLOAT --- */
        @keyframes floatingBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            80% { opacity: 1; transform: translateY(-5px) scale(1.01); }
            100% { opacity: 1; transform: translateY(0) scale(1.0); }
        }
        @keyframes jumpOnHover {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.02); }
            100% { transform: translateY(0) scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- BASE STYLE --- */
        body {
            background: linear-gradient(135deg, #e0f0ff, #b3d9ff);
            background-size: 400% 400%; 
            animation: floatingBackground 15s ease infinite alternate;
            
            font-family: 'Poppins', 'Noto Sans JP', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            perspective: 1000px;
            color: var(--dark-text);
        }

        /* --- MAIN CONTAINER --- */
        .main-container {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1), 0 0 0 8px var(--light-bg);
            text-align: center;
            transition: all 0.5s cubic-bezier(.25,.8,.25,1);
            width: 100%;
            max-width: 700px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards;
            transform: rotateX(0deg) scale(1.0);
        }

        .main-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2), 0 0 0 10px var(--primary-color);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: 800;
        }

        /* --- CHAT AREA --- */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            text-align: left;
            margin-bottom: 20px;
            background-color: var(--light-bg);
            border-radius: 15px;
            border: 1px solid #eee;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 18px;
            margin: 10px 0;
            border-radius: 20px;
            line-height: 1.6;
            font-size: 15px;
            animation: fadeIn 0.4s ease-out;
        }
        .ai-message {
            background-color: var(--ai-bubble);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
        }
        .user-message {
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 14px 18px;
            border: 2px solid var(--secondary-color);
            border-radius: 25px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* --- BUTTONS --- */
        .button.chat-send {
            text-decoration: none;
            border-radius: 30px;
            transition: all 0.3s ease-in-out;
            font-weight: 700;
            display: inline-block;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 14px 25px;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--primary-color), #4f63ff);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 140, 255, 0.4);
            margin: 0; 
        }
        .button.chat-send:hover {
            animation: jumpOnHover 0.4s ease-out;
            box-shadow: 0 6px 20px rgba(79, 140, 255, 0.6);
            transform: translateY(-2px);
        }
        
        /* --- RESPONSIVE MOBILE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            .main-container {
                height: 90vh; 
            }
            .chat-input-area {
                flex-direction: column;
                gap: 5px;
            }
            .button.chat-send {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="main-container">
    <h1>AI„Ç≥„Éº„ÉÅ </h1>
    
    <div class="chat-history" id="chatHistory">
        <div class="message-bubble ai-message">
            „Åì„Çì„Å´„Å°„ÅØÔºÅAI„Ç≥„Éº„ÉÅ„ÅÆFitBot„Åß„Åô„ÄÇ„ÅÇ„Å™„Åü„ÅÆ‰ªäÊó•„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„Å´ÊúÄÈÅ©„Å™„É°„Éã„É•„Éº„ÇíÊèêÊ°à„Åó„Åæ„ÅôÔºÅ
			„Äå„Åì„Çì„Å´„Å°„ÅØ„Äç„Å®ÂÖ•Âäõ„Åô„Çã„Å®Âßã„Åæ„Çä„Åæ„Åô„ÄÇ
        </div>
    </div>
    
    <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
    <div class="chat-input-area">
        <input type="text" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." id="messageInput" onkeydown="handleKey(event)">
        <button type="button" class="button chat-send" onclick="sendMessage()">ÈÄÅ‰ø°</button>
    </div>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const messageInput = document.getElementById('messageInput');
        
        // ‚òÖ ‰øÆÊ≠£: JavaScript„Åß„É°„Çø„Çø„Ç∞„Åã„ÇâCSRF„Éà„Éº„ÇØ„É≥„ÇíÂÆâÂÖ®„Å´ÂèñÂæó
        const csrfMetaToken = document.querySelector('meta[name="_csrf"]');
        const csrfMetaHeader = document.querySelector('meta[name="_csrf_header"]');

        const csrfToken = csrfMetaToken ? csrfMetaToken.content : null;
        const csrfHeader = csrfMetaHeader ? csrfMetaHeader.content : null;

        function handleKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                sendMessage();
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            displayMessage(message, 'user');
            messageInput.value = '';
            
            const loadingBubble = displayMessage('AI„Åå„Éà„É¨„Éº„Éã„É≥„Ç∞„Éó„É©„É≥„Çí‰ΩúÊàê‰∏≠„Åß„Åô...', 'ai', true);

            try {
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                };
                
                // CSRF„Éà„Éº„ÇØ„É≥„Çí„Éò„ÉÉ„ÉÄ„Éº„Å´ËøΩÂä†
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken; 
                }
                
                // APIÂëº„Å≥Âá∫„Åó
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers,
                    body: new URLSearchParams({ 'message': message })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    // 500„Ç®„É©„Éº„ÇÑ400„Ç®„É©„Éº„ÅÆË©≥Á¥∞„Çí„ÉÅ„É£„ÉÉ„Éà„Éê„Éñ„É´„Å´Ë°®Á§∫
                    throw new Error(`APIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº: ${response.status}. Ë©≥Á¥∞: ${errorText.substring(0, 300)}`);
                }
                
                const aiResponseText = await response.text();
                
                const formattedResponse = formatAiResponse(aiResponseText);
                
                loadingBubble.textContent = '';
                loadingBubble.innerHTML = formattedResponse;
                loadingBubble.classList.remove('loading');
                
            } catch (error) {
                loadingBubble.textContent = 'Ëá¥ÂëΩÁöÑ„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ' + error.message;
                console.error('API Error:', error);
            }
            
            scrollToBottom();
        }

        function displayMessage(text, sender, isLoading = false) {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${sender}-message ${isLoading ? 'loading' : ''}`;
            bubble.innerHTML = text; 
            chatHistory.appendChild(bubble);
            scrollToBottom();
            return bubble;
        }

        function scrollToBottom() {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        function formatAiResponse(text) {
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            return formattedText;
        }

        scrollToBottom();
    </script>
</div>
</body>
</html>


























