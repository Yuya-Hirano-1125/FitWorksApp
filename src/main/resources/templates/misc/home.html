<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éõ„Éº„É† | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&family=M+PLUS+Rounded+1c:wght@500;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link rel="stylesheet" th:href="@{/css/title.css}">
    
    <script th:src="@{/js/theme.js}"></script>
    <style>
        /* --- HTMLÂÜÖ„Çπ„Çø„Ç§„É´ (CSS„Éï„Ç°„Ç§„É´Âåñ„Åó„Å¶„ÅÑ„Å™„ÅÑÂãïÁöÑÈÉ®ÂàÜ„ÅÆ„Åø) --- */
        .xp-bar { width: 100%; height: 25px; background: #e3f2fd; border-radius: 12px; overflow: hidden; margin-top: 8px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .xp-progress { height: 100%; background: linear-gradient(90deg, #42a5f5, #2196f3); color: #fff; font-size: 12px; font-weight: bold; text-align: center; line-height: 25px; border-radius: 12px; transition: width 1s ease-in-out; }
        
        .character-section { position: relative; display: flex; justify-content: center; margin-top: 0px; }
        
        .character-wrapper { position: relative; width: 400px; height: 400px; max-width: 100%; margin: 0 auto; overflow: visible; }

        .character-display { 
            display: flex; justify-content: center; align-items: flex-end; 
            width: 100%; height: 100%;  
            background-repeat: no-repeat; background-position: center; background-size: cover; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.25); 
            text-decoration: none; padding-bottom: 10px; box-sizing: border-box; 
            border: 4px solid rgba(255,255,255,0.8);
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-50px); } 100% { transform: translateY(0px); } }
        .character-display img { width: auto; height: 85%; max-width: 95%; object-fit: contain; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 20px 15px rgba(0,0,0,0.9)); }
        
        /* „Çµ„Ç§„Éâ„Éú„Çø„É≥„Ç≥„É≥„ÉÜ„Éä: ‰∏≠Â§ÆÊèÉ„Åà */
        .character-side-buttons { position: absolute; display: flex; flex-direction: column; align-items: center; gap: 12px; z-index: 10; top: 40px; right: -125px; }
        @media (max-width: 650px) { .character-side-buttons { right: 10px; top: 50px; } }

        .side-action-btn { 
            color: white; padding: 10px 0; border-radius: 15px; text-decoration: none; 
            font-weight: bold; font-size: 0.85em; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center; 
            gap: 6px; width: 110px; backdrop-filter: blur(4px);
        }
        .side-action-btn:hover { transform: scale(1.05); }
        
        .title-button { background: linear-gradient(135deg, #9c27b0, #ba68c8); border: 2px solid rgba(255,255,255,0.3); }

        /* ‚òÖ‰øÆÊ≠£: „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥Áî®„ÅÆÊ≠£ÊñπÂΩ¢„Éú„Çø„É≥ÔºàÂ§ßÔºâ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .mission-side-btn {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4); /* „Éî„É≥„ÇØ„Éª„Ç™„É¨„É≥„Ç∏Á≥ª */
            width: 110px !important;  /* Áß∞Âè∑„Éú„Çø„É≥(110px)„Å®Âêå„ÅòÂπÖ */
            height: 110px;            /* ÂπÖ„Å´Âêà„Çè„Åõ„Å¶È´ò„Åï„ÇÇ110pxÔºàÊ≠£ÊñπÂΩ¢Ôºâ */
            padding: 0 !important;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
            display: flex;
            flex-direction: column;   /* Á∏¶‰∏¶„Å≥ */
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 20px;      /* Â∞ë„Åó‰∏∏„Åø„ÇíÂ§ß„Åç„Åè */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            text-decoration: none;
            transition: transform 0.1s;
            gap: 5px;                 /* „Ç¢„Ç§„Ç≥„É≥„Å®ÊñáÂ≠ó„ÅÆÈñìÈöî */
        }
        .mission-side-btn:hover { transform: scale(1.05); }
        
        /* „Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫Ë™øÊï¥ */
        .mission-side-btn i {
            font-size: 2.2rem;
            margin-bottom: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* ÊñáÂ≠ó„Çπ„Çø„Ç§„É´ */
        .mission-side-btn span {
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .help-menu-dropdown { display: none; position: absolute; top: 60px; right: 20px; left: auto; background: rgba(255, 255, 255, 0.95); border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 10px; z-index: 2000; width: 220px; flex-direction: column; gap: 10px; }
        .help-menu-dropdown.active { display: flex; }
        
        .help-menu-item { display: block; padding: 10px; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold; font-size: 0.9em; transition: transform 0.2s; border: none; width: 100%; cursor: pointer; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box; }
        .help-menu-item:hover { transform: scale(1.03); }

        .tutorial-pointer { position: absolute; z-index: 10000; font-size: 2.5rem; color: #f1c40f; display: none; animation: point-move 1s infinite alternate; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .tutorial-pointer::before { content: '\f0a6'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
        @keyframes point-move { from { transform: translateY(0); } to { transform: translateY(-10px); } }
        
        .home-greeting-container { text-align: center; margin-top: 30px; margin-bottom: 15px; }
        .home-greeting-text { font-family: 'Noto Sans JP', sans-serif; color: #555; font-size: 1.1rem; font-weight: 700; margin-top: 0; line-height: 1.6; }
        .home-username { color: #0288d1; font-size: 1.3rem; font-weight: 900; margin: 0 3px; text-decoration: underline wavy #4facfe; text-underline-offset: 4px; }

        /* ËÉåÊôØËß£Êîæ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó (ÁúÅÁï•„Å™„Åó) */
        .background-unlock-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .background-unlock-content { background: linear-gradient(180deg, #fffef7 0%, #faf8f0 100%); border: 6px solid #d4a373; border-radius: 30px; padding: 0; max-width: 520px; width: 90%; box-shadow: 0 0 0 3px #f5e6d3, 0 0 0 9px #d4a373, 0 15px 35px rgba(0, 0, 0, 0.3); animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); position: relative; overflow: hidden; }
        @keyframes popIn { 0% { transform: scale(0.5) rotate(-5deg); opacity: 0; } 60% { transform: scale(1.05) rotate(2deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .leaf-decoration { position: absolute; font-size: 2rem; opacity: 0.15; pointer-events: none; animation: leafFloat 4s ease-in-out infinite; }
        .leaf-decoration::before { content: 'üçÉ'; }
        .leaf-decoration:nth-child(1) { top: 15px; left: 15px; animation-delay: 0s; }
        .leaf-decoration:nth-child(2) { top: 15px; right: 15px; animation-delay: 1s; }
        .leaf-decoration:nth-child(3) { bottom: 15px; left: 15px; animation-delay: 2s; }
        .leaf-decoration:nth-child(4) { bottom: 15px; right: 15px; animation-delay: 3s; }
        @keyframes leafFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(5deg); } }
        .ff-header { background: linear-gradient(180deg, #9bcc7a 0%, #7db85e 100%); border-bottom: 5px solid #6a9c4f; border-radius: 24px 24px 0 0; padding: 25px 20px; position: relative; box-shadow: inset 0 2px 0 rgba(255, 255, 255, 0.4), 0 3px 0 rgba(106, 156, 79, 0.3); }
        .ff-header::before { content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 60px; height: 4px; background: rgba(255, 255, 255, 0.5); border-radius: 2px; }
        .background-unlock-title { color: #ffffff; font-size: 1.35rem; font-weight: bold; margin: 0; text-align: center; letter-spacing: 0.5px; font-family: Arial, sans-serif; text-shadow: 2px 2px 0 rgba(106, 156, 79, 0.8), -1px -1px 0 rgba(106, 156, 79, 0.3); }
        .ff-content { padding: 30px 25px; position: relative; }
        .background-unlock-list { background: #ffffff; border: 4px solid #e8d5b7; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: inset 0 2px 0 rgba(0, 0, 0, 0.03), 0 3px 10px rgba(0, 0, 0, 0.1); position: relative; }
        .background-unlock-item { background: linear-gradient(135deg, #fff9f0 0%, #fef5e7 100%); border: 3px solid #f4d9a6; border-radius: 15px; color: #5a4a3a; font-size: 1.05rem; font-weight: bold; margin: 12px 0; padding: 14px 18px; position: relative; animation: itemBounce 0.5s ease-out forwards; opacity: 0; box-shadow: 0 4px 0 #e8c78e, 0 5px 10px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; }
        .background-unlock-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 7px 0 #e8c78e, 0 8px 15px rgba(0, 0, 0, 0.15); }
        @keyframes itemBounce { 0% { transform: scale(0.3) translateY(-20px); opacity: 0; } 50% { transform: scale(1.1) translateY(0); opacity: 1; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        .background-unlock-item:nth-child(1) { animation-delay: 0.1s; }
        .background-unlock-item:nth-child(2) { animation-delay: 0.2s; }
        .background-unlock-item:nth-child(3) { animation-delay: 0.3s; }
        .background-unlock-item:nth-child(4) { animation-delay: 0.4s; }
        .background-unlock-item::before { content: '‚úø'; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); color: #9bcc7a; font-size: 1.3rem; animation: flowerSpin 3s ease-in-out infinite; }
        @keyframes flowerSpin { 0%, 100% { transform: translateY(-50%) rotate(0deg); } 50% { transform: translateY(-50%) rotate(180deg); } }
        .background-unlock-item i { color: #f4a460; margin-right: 10px; font-size: 1.1rem; }
        .background-unlock-item strong { color: #6a5a4a; }
        .background-unlock-buttons { display: flex; gap: 12px; justify-content: center; padding: 0 25px 30px; position: relative; }
        .background-unlock-buttons button, .background-unlock-buttons a { padding: 14px 26px; border: 4px solid #d4a373; border-radius: 50px; font-weight: bold; font-size: 0.95rem; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; position: relative; transition: all 0.2s ease; font-family: Arial, sans-serif; box-shadow: 0 5px 0 #b8906a, 0 6px 12px rgba(0, 0, 0, 0.15); }
        .background-unlock-buttons button:active, .background-unlock-buttons a:active { transform: translateY(3px); box-shadow: 0 2px 0 #b8906a, 0 3px 6px rgba(0, 0, 0, 0.15); }
        .background-unlock-buttons button:hover, .background-unlock-buttons a:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #b8906a, 0 8px 16px rgba(0, 0, 0, 0.2); }
        .btn-later { background: linear-gradient(180deg, #f4e4c1 0%, #e8d5b7 100%); color: #6a5a4a; border-color: #d4a373; }
        .btn-go-backgrounds { background: linear-gradient(180deg, #9bcc7a 0%, #7db85e 100%); color: #ffffff; border-color: #6a9c4f; box-shadow: 0 5px 0 #5a8c3f, 0 6px 12px rgba(0, 0, 0, 0.15); }
        .btn-go-backgrounds:active { box-shadow: 0 2px 0 #5a8c3f, 0 3px 6px rgba(0, 0, 0, 0.15); }
        .btn-go-backgrounds:hover { box-shadow: 0 7px 0 #5a8c3f, 0 8px 16px rgba(0, 0, 0, 0.2); }
        .btn-go-backgrounds i { color: #f4d9a6; }
        
        .tutorial-backdrop, .tutorial-spotlight, .tutorial-pointer, .tutorial-rpg-box { pointer-events: none; }
        .tutorial-backdrop.active, .tutorial-rpg-box.active { pointer-events: auto; }
        .interactive-bg, .mouse-follower-cloud, .bg-cloud { pointer-events: none !important; z-index: -1; }
        #tutorial-rpg-box { z-index: 10001; }
        
        .menu-item-spacing { margin-top: 20px !important; width: 100%; box-sizing: border-box; display: block; }
        .care-section { text-align: center; }
        @media (max-width: 600px) { #tutorial-ai-btn { margin-bottom: 110px !important; } }
        
        @media (min-width: 601px) {
            .main-container { padding-bottom: 150px !important; }
            .bottom-nav { display: flex; justify-content: space-evenly; align-items: center; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 800px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 10px 15px; box-sizing: border-box; z-index: 1000; }
            .nav-item { display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; max-width: 100px; height: auto; min-height: 60px; text-decoration: none; color: #555; border-radius: 12px; transition: transform 0.2s ease, background 0.2s; padding: 5px 0; margin: 0 5px; }
            .nav-item i { display: block; font-size: 22px; margin-bottom: 5px; line-height: 1; color: var(--primary-color, #ff69b4); }
            .nav-item span { display: block; font-size: 11px; font-weight: bold; white-space: nowrap; line-height: 1.2; width: 100%; text-align: center; }
            .nav-item:hover { background-color: #f0f8ff; transform: translateY(-3px); }
        }
        
        .btn-record, .btn-care, .home-action-btn { border: none !important; outline: none !important; }
        .side-action-btn, .title-button { border: none !important; outline: none !important; }
        /* Ê≠£ÊñπÂΩ¢„Éú„Çø„É≥„ÅÆ„Éï„ÉÅ„Å™„ÅóË®≠ÂÆö */
        .mission-side-btn { border: none !important; outline: none !important; }
		
   </style>
</head>
<body class="home-page">

<div class="interactive-bg">
    <div class="mouse-follower-cloud"></div>
    <div class="bg-cloud cloud-1"></div>
    <div class="bg-cloud cloud-2"></div>
    <div class="bg-cloud cloud-3"></div>
    <div class="bg-cloud cloud-4"></div>
</div>

<div class="main-container" style="position: relative;"> 
    <div id="real-time-clock" class="real-time-clock">00:00:00</div>

    <button id="help-btn" class="help-label-btn" onclick="toggleHelpMenu()">
        <span style="font-size: 1.2em;">üì∞</span>„Éò„É´„Éó
    </button>
    
    <div id="help-menu" class="help-menu-dropdown">
        <button class="help-menu-item tutorial-opt" onclick="startRpgTutorial(true); toggleHelpMenu();">
            <i class="fa-solid fa-play"></i> „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´
        </button>
        <a th:href="@{/supplement-guide}" class="help-menu-item supple-opt">
            <i class="fa-solid fa-book-medical"></i> „Çµ„Éó„É™„ÅÆÈ£≤„ÅøÊñπ
        </a>
        
        <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1);">
            <p style="margin: 0 0 5px 0; font-size: 0.85rem; font-weight: 800; color: #06c755; text-shadow: 0 1px 1px rgba(255,255,255,0.8);">
                <i class="fa-brands fa-line"></i> ÂÖ¨ÂºèLINE„ÅØ„Åì„Å°„Çâ
            </p>
            <a href="https://lin.ee/nUEWQkq">
                <img src="https://scdn.line-apps.com/n/line_add_friends/btn/ja.png" alt="Âèã„Å†„Å°ËøΩÂä†" height="36" border="0">
            </a>
        </div>
    </div>

    <div class="app-logo-display">
        <img th:src="@{/img/applogo-new.png}" alt="App Logo" />
        <div id="tutorial-xp-area">
            <div class="xp-daily-header"></div>
            <div class="xp-bar-container">
                <span th:text="'„É¨„Éô„É´ ' + ${level} + ' (XP: ' + ${experiencePoints} + '/' + ${requiredXp} + ')'"></span>
                <div class="xp-bar">
                    <div class="xp-progress" th:style="'width:' + ${progressPercent} + '%;'" th:text="${progressPercent} + '%'"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="tutorial-title-display" style="text-align: center; margin-top: 5px; min-height: 30px;">
        <th:block th:if="${userTitle != null and userTitle != '„Å™„Åó'}">
            <th:block th:each="enumT : ${T(com.example.demo.entity.AppTitle).values()}" 
                      th:if="${enumT.displayName == userTitle}">
                <div class="title-badge" th:classappend="${enumT.rarity}">
                    <i class="fa-solid fa-crown"></i> <span th:text="${userTitle}"></span>
                </div>
            </th:block>
        </th:block>
    </div>
    
    <div class="character-section">
        <div class="character-wrapper">
			<div id="tutorial-char-display" class="character-display"
							th:style="'background-image: url(/img/background/' + ${selectedBackground} + '.png);'">
			                <img th:src="@{'/img/character/' + ${(level / 10) * 10} + '.png'}" alt="Character" />
			            </div>
            
            <div class="character-side-buttons">
                <a id="tutorial-title-btn" th:href="@{/titles}" class="side-action-btn title-button">
                    <i class="fa-solid fa-crown"></i> Áß∞Âè∑
                </a>
                <a id="tutorial-mission-btn" th:href="@{/daily-mission}" class="mission-side-btn" aria-label="„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥">
                    <i class="fa-solid fa-list-check"></i>
                    <span>„Éü„ÉÉ„Ç∑„Éß„É≥</span>
                </a>
            </div>
        </div>
    </div>
    
    <div class="home-greeting-container">
        <p class="home-greeting-text">
            „Åì„Çì„Å´„Å°„ÅØ„ÄÅ<span class="home-username" th:text="${username}"></span>„Åï„Çì!
        </p>
    </div>
    
    <div class="ai-home-advice-container">
        <div class="ai-avatar-small">
            <img th:src="@{/img/AIcoach.png}" alt="AI">
        </div>
        <div class="ai-bubble-content">
             <p id="ai-home-message">„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥Ë®∫Êñ≠‰∏≠<span class="loading-dots">...</span></p>
        </div>
    </div>
    
	<a id="tutorial-training-btn" th:href="@{/training}" class="home-action-btn btn-training menu-item-spacing">
	       <i class="fa-solid fa-dumbbell"></i> „Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÈñãÂßã 
	    </a>

	    <div id="tutorial-record-btn" class="record-container menu-item-spacing">
	        <button onclick="toggleRecordMenu()" class="home-action-btn btn-record" style="width: 100%;">
	           <i class="fa-solid fa-pen-to-square"></i> Ë®òÈå≤„Çí„Å§„Åë„Çã
	        </button>
	        
	        <div id="record-options" class="record-options">
	            <a th:href="@{/training-log}" class="record-option-item training-log-opt">
	                <i class="fa-solid fa-calendar-days"></i><br>Á≠ã„Éà„É¨Â±•Ê≠¥
	            </a>
	            <a th:href="@{/log/meal}" class="record-option-item meal-opt">
	                <i class="fa-solid fa-utensils"></i><br>È£ü‰∫ãË®òÈå≤
	            </a>
	            <a th:href="@{/training-log/form/body-weight}" class="record-option-item weight-opt">
	                <i class="fa-solid fa-weight-scale"></i><br>‰ΩìÈáçË®òÈå≤
	            </a>
	        </div>
	    </div>
	    
	    <div class="care-section menu-item-spacing">
	        <a id="tutorial-care-btn" th:href="@{/training/care}" class="home-action-btn btn-care">
	            <i class="fa-solid fa-mug-hot"></i> AI„É™„Éï„É¨„ÉÉ„Ç∑„É•&„Ç±„Ç¢
	        </a>
	    </div>

	    <a id="tutorial-map-btn" th:href="@{/training/map}" class="home-action-btn btn-map menu-item-spacing">
	       <i class="fa-solid fa-map-location-dot"></i> Ëøë„Åè„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞ÊñΩË®≠ 
	    </a>
	    
	    <a id="tutorial-ai-btn" th:href="@{/ai-coach}" class="home-action-btn btn-ai menu-item-spacing">
		   <i class="fa-solid fa-robot"></i> AI„ÉÅ„É£„ÉÉ„Éà 
		</a>

    <nav id="tutorial-menu-nav" class="bottom-nav">
        <a id="nav-gacha" th:href="@{/gacha}" class="nav-item"><i class="fa-solid fa-gift"></i><span>„Ç¨„ÉÅ„É£„ÄÄ</span></a>
        <a id="tutorial-friends-btn" th:href="@{/friends}" class="nav-item"><i class="fa-solid fa-user-group"></i><span>„Éï„É¨„É≥„Éâ</span></a>
        <a id="nav-community" th:href="@{/community}" class="nav-item"><i class="fa-solid fa-comments"></i><span>Êé≤Á§∫Êùø„ÄÄ</span></a>
        <a id="nav-char" th:href="@{/characters/menu/CharactersMenu}" class="nav-item"><i class="fa-solid fa-user-astronaut"></i><span>„Ç≠„É£„É©„ÄÄ</span></a>    
        <a id="tutorial-muscles-btn" th:href="@{/muscles}" class="nav-item"><i class="fa-solid fa-child-reaching"></i><span>Á≠ãËÇâ„ÄÄ</span></a>
        <a id="nav-settings" th:href="@{/settings}" class="nav-item"><i class="fa-solid fa-gear"></i><span>Ë®≠ÂÆö</span></a>
    </nav>
</div>

<div id="tutorial-spotlight" class="tutorial-spotlight"></div>
<div id="tutorial-pointer" class="tutorial-pointer"></div>
<div id="tutorial-rpg-box" class="tutorial-rpg-box">
    <div class="rpg-char-area"><img id="rpg-char-img" th:src="@{/img/AIcoach.png}" alt="AI Coach"></div>
    <div class="rpg-content">
        <div class="rpg-name-tag">AI„Ç≥„Éº„ÉÅ</div>
        <div class="rpg-text-area" id="rpg-text"></div>
        <div class="rpg-controls">
            <button class="rpg-btn rpg-btn-skip" onclick="endRpgTutorial()">„Çπ„Ç≠„ÉÉ„Éó</button>
            <button class="rpg-btn rpg-btn-next" id="rpg-next-btn" onclick="nextRpgStep()">Ê¨°„Å∏</button>
        </div>
    </div>
</div>

<div id="background-unlock-popup" class="background-unlock-overlay" style="display: none;">
    <div class="background-unlock-content">
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>

        <div class="ff-header">
            <h2 class="background-unlock-title">„ÅÇ„Åü„Çâ„Åó„ÅÑËÉåÊôØ„ÅåÊâã„Å´ÂÖ•„Å£„Åü„Çà!</h2>
        </div>

        <div class="ff-content">
            <div id="background-unlock-list" class="background-unlock-list">
                </div>
        </div>

        <div class="background-unlock-buttons">
            <button onclick="closeBackgroundUnlockPopup()" class="btn-later">
                <i class="fa-solid fa-clock"></i>
                „ÅÇ„Å®„ÅßË¶ã„Çã
            </button>
            <a href="/characters/menu/Backgrounds" class="btn-go-backgrounds">
                <i class="fa-solid fa-image"></i>
                ËÉåÊôØ‰∏ÄË¶ß„Å∏
            </a>
        </div>
    </div>
</div>

<div id="tutorial-backdrop" class="tutorial-backdrop"></div>

<script th:inline="javascript">
	/*<![CDATA[*/
	document.addEventListener('DOMContentLoaded', function() {
	    // ËÉåÊôØËß£Êîæ„Éá„Éº„Çø„ÇíÂèñÂæó
	    const backgroundUnlocks = /*[[${backgroundUnlocks}]]*/ null;
	    
	    console.log('========== ËÉåÊôØËß£Êîæ„ÉÅ„Çß„ÉÉ„ÇØ ==========');
	    console.log('backgroundUnlocks:', backgroundUnlocks);
	    console.log('====================================');
	    
	    if (backgroundUnlocks && backgroundUnlocks.hasNewUnlocks) {
	        const unlockedBackgrounds = backgroundUnlocks.unlockedBackgrounds || [];
	        
	        if (unlockedBackgrounds.length > 0) {
	            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
	            const popup = document.getElementById('background-unlock-popup');
	            const listContainer = document.getElementById('background-unlock-list');
	            
	            // „É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
	            listContainer.innerHTML = '';
	            
	            // Ëß£Êîæ„Åï„Çå„ÅüËÉåÊôØ„ÇíË°®Á§∫
	            unlockedBackgrounds.forEach(bg => {
	                const item = document.createElement('div');
	                item.className = 'background-unlock-item';
	                item.innerHTML = `
	                    <i class="fa-solid fa-unlock-keyhole"></i>
	                    <strong>${bg.name}</strong> (Lv.${bg.requiredLevel}„ÅßËß£Êîæ)
	                `;
	                listContainer.appendChild(item);
	            });
	            
	            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
	            popup.style.display = 'flex';
	            
	            console.log('ËÉåÊôØËß£Êîæ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫:', unlockedBackgrounds);
	        }
	    }
	    
	    // AI„Ç¢„Éâ„Éê„Ç§„ÇπÂèñÂæó
	    const aiMessageEl = document.getElementById('ai-home-message');
	    if (aiMessageEl) {
	        fetch('/api/ai-coach/home-advice')
	            .then(res => res.text())
	            .then(text => {
	                // „Çø„Ç§„Éî„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥È¢®„Å´Ë°®Á§∫
	                aiMessageEl.innerHTML = '';
	                let i = 0;
	                const speed = 40; 
	                function typeWriter() {
	                    if (i < text.length) {
	                        aiMessageEl.textContent += text.charAt(i);
	                        i++;
	                        setTimeout(typeWriter, speed);
	                    }
	                }
	                typeWriter();
	            })
	            .catch(err => {
	                console.error("AI Advice Error:", err);
	                aiMessageEl.textContent = "‰ªäÊó•„ÇÇ‰∏ÄÁ∑í„Å´È†ëÂºµ„Çã„É†„Ç≠ÔºÅ";
	            });
	    }

        // ‚òÖÊôÇË®àÊõ¥Êñ∞Âá¶ÁêÜ: Êó•‰ªò„ÉªÊõúÊó•„ÉªÊôÇÂàª„ÇíË°®Á§∫
        function updateRealTimeClock() {
            const now = new Date();
            
            // Êó•‰ªò„Å®ÊõúÊó•„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥ (‰æã: 2023/12/23(Âúü))
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' };
            const dateString = now.toLocaleDateString('ja-JP', dateOptions);
            
            // ÊôÇÂàª„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥ (‰æã: 10:00:00)
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const timeString = now.toLocaleTimeString('ja-JP', timeOptions);
            
            const clockEl = document.getElementById('real-time-clock');
            if (clockEl) {
                // Êó•‰ªò„Å®ÊôÇÂàª„Çí„Çπ„Éö„Éº„Çπ„ÅßÁπã„ÅÑ„ÅßË°®Á§∫
                clockEl.textContent = `${dateString} ${timeString}`;
            }
        }
        setInterval(updateRealTimeClock, 1000);
        updateRealTimeClock(); // ÂàùÂõûÂÆüË°å
	});

	function closeBackgroundUnlockPopup() {
	    const popup = document.getElementById('background-unlock-popup');
	    popup.style.display = 'none';
	}

	// Escape„Ç≠„Éº„Åß„ÇÇÈñâ„Åò„Çâ„Çå„Çã„Çà„ÅÜ„Å´
	document.addEventListener('keydown', (e) => {
	    if (e.key === 'Escape') {
	        closeBackgroundUnlockPopup();
	    }
	});
	/*]]>*/

    // Ë®òÈå≤„É°„Éã„É•„Éº„ÅÆ„Éà„Ç∞„É´
    function toggleRecordMenu() {
        const options = document.getElementById('record-options');
        options.classList.toggle('open');
    }

    // „Éò„É´„Éó„É°„Éã„É•„Éº„ÅÆ„Éà„Ç∞„É´
    function toggleHelpMenu() {
        const menu = document.getElementById('help-menu');
        menu.classList.toggle('active');
    }

    // „Éò„É´„Éó„É°„Éã„É•„ÉºÂ§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('help-menu');
        const btn = document.getElementById('help-btn');
        if (!menu.contains(event.target) && !btn.contains(event.target) && menu.classList.contains('active')) {
            menu.classList.remove('active');
        }
    });

    // RPG„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÂÆöÁæ©
    const rpgSteps = [
        { targetId: null, text: "FitWorks„Å∏„Çà„ÅÜ„Åì„Åù!\n„Åì„ÅÆ„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´„Åß„ÅØ„ÄÅ„Ç¢„Éó„É™„ÅÆÂÖ®Ê©üËÉΩ„Çí„ÅîÁ¥π‰ªã„Åó„Åæ„Åô!" },
        { targetId: 'help-btn', text: "„Åæ„Åö„ÅØÁîªÈù¢Â∑¶‰∏ä„ÄÇ„Äå„Éò„É´„Éó„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅ\n„Åì„ÅÆ„Ç¨„Ç§„Éâ„ÅÆÂÜçÁîü„ÇÑ„ÄÅ„Çµ„Éó„É™„É°„É≥„Éà„ÅÆÁü•Ë≠ò„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-xp-area', text: "ÁîªÈù¢‰∏äÈÉ®„Å´„ÅØ„ÅÇ„Å™„Åü„ÅÆ„Äå„É¨„Éô„É´„Äç„Å®„ÄåXP(ÁµåÈ®ìÂÄ§)„Äç„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ\n„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíË®òÈå≤„Åó„Å¶„É¨„Éô„É´„Çí‰∏ä„Åí„Åæ„Åó„Çá„ÅÜ!" },
        { targetId: 'tutorial-mission-btn', text: "„Äå„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„Äç„ÅØÊØéÊó•Êõ¥Êñ∞„Åï„Çå„Åæ„Åô„ÄÇ\n„ÇØ„É™„Ç¢„Åó„Å¶Â†±ÈÖ¨„ÇÑXP„ÇíÂäπÁéá„Çà„Åè„Ç≤„ÉÉ„Éà„Åó„Åæ„Åó„Çá„ÅÜ!" },
        { targetId: 'tutorial-title-display', text: "„Åì„Åì„Å´„ÅØÁèæÂú®Ë£ÖÂÇô„Åó„Å¶„ÅÑ„Çã„ÄåÁß∞Âè∑„Äç„ÅåËºù„Åç„Åæ„Åô„ÄÇ\n„É¨„Ç¢„Å™Áß∞Âè∑„ÇíÊâã„Å´ÂÖ•„Çå„Å¶„ÄÅÂº∑„Åï„Çí„Ç¢„Éî„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ!" },
        { targetId: 'tutorial-char-display', text: "„ÅÇ„Å™„Åü„ÅÆ„Éë„Éº„Éà„Éä„Éº„Ç≠„É£„É©„ÇØ„Çø„Éº„Åß„Åô„ÄÇ\n„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Å®ÂÖ±„Å´ÈÄ≤Âåñ„Åó„Å¶„ÅÑ„ÅèÂßø„ÇíË¶ãÂÆà„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ" },
        { targetId: 'tutorial-title-btn', text: "„ÄåÁß∞Âè∑„Äç„Éú„Çø„É≥„Åã„Çâ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÁîªÈù¢„Å∏„ÄÇ\nÁç≤Âæó„Åó„ÅüÁß∞Âè∑„Çí‰ªò„ÅëÊõø„Åà„Å¶„ÄÅÂÄãÊÄß„ÇíÂá∫„Åõ„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-training-btn', text: "„É°„Ç§„É≥Ê©üËÉΩ„ÅØ„Åì„Çå!„Äå„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÈñãÂßã„Äç„Éú„Çø„É≥„ÄÇ\n„Åì„Åì„Åã„ÇâÊó•„ÄÖ„ÅÆÈÅãÂãï„É°„Éã„É•„Éº„Çí‰ΩúÊàê„ÉªË®òÈå≤„Åó„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-record-btn', text: "„ÄåË®òÈå≤„Çí„Å§„Åë„Çã„Äç„É°„Éã„É•„Éº„ÇíÈñã„Åè„Å®„ÄÅ\nÈÅéÂéª„ÅÆÂ±•Ê≠¥Á¢∫Ë™ç„ÇÑ„ÄÅÈ£ü‰∫ã„Éª‰ΩìÈáç„ÅÆË®òÈå≤„ÅåÂÄãÂà•„Å´„Åß„Åç„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-care-btn', text: "Áñ≤„Çå„ÅüÊôÇ„ÅØ„ÄåAI„É™„Éï„É¨„ÉÉ„Ç∑„É•&„Ç±„Ç¢„Äç„ÄÇ\n‰ΩìË™ø„Å´Âêà„Çè„Åõ„Åü„Çπ„Éà„É¨„ÉÉ„ÉÅ„ÇÑ‰ºëÊÅØÊ≥ï„ÇíAI„ÅåÊèêÊ°à„Åó„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-map-btn', text: "„Äå„Éû„ÉÉ„Éó„ÄçÊ©üËÉΩ„Çí‰Ωø„Åà„Å∞„ÄÅ\nËøë„Åè„ÅÆ„Ç∏„É†„ÇÑÂÖ¨Âúí„ÄÅ„Éà„É¨„Éº„Éã„É≥„Ç∞ÊñΩË®≠„Çí„Åô„Åê„Å´Êé¢„Åõ„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-ai-btn', text: "„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇÑÈ£ü‰∫ã„ÅÆÊÇ©„Åø„ÅØ„ÄåAI„ÉÅ„É£„ÉÉ„Éà„Äç„Å∏„ÄÇ\nÂ∞ÇÂ±û„ÅÆAI„Ç≥„Éº„ÉÅ„Åå24ÊôÇÈñì„ÅÑ„Å§„Åß„ÇÇÁõ∏Ë´á„Å´‰πó„Çä„Åæ„Åô!" },
        { targetId: 'nav-gacha', text: "„Åì„Åì„Åã„Çâ„ÅØ‰∏ã„ÅÆ„É°„Éã„É•„Éº„Åß„Åô„ÄÇ\n„Äå„Ç¨„ÉÅ„É£„Äç„ÅßÊñ∞„Åó„ÅÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇÑ„Ç¢„Ç§„ÉÜ„É†„Çí„Ç≤„ÉÉ„Éà!" },
        { targetId: 'tutorial-friends-btn', text: "„Äå„Éï„É¨„É≥„Éâ„ÄçÊ©üËÉΩ„ÅßÂèãÈÅî„Å®„Å§„Å™„Åå„Çä„ÄÅ\n„Åä‰∫í„ÅÑ„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞Áä∂Ê≥Å„ÇíÁ¢∫Ë™ç„Åó„Å¶Âä±„Åæ„ÅóÂêà„Åà„Åæ„Åô„ÄÇ" },
        { targetId: 'nav-community', text: "„ÄåÊé≤Á§∫Êùø„Äç„Åß„ÅØ„ÄÅÂÖ®„É¶„Éº„Ç∂„Éº„Å®ÊÉÖÂ†±‰∫§Êèõ„Åó„Åü„Çä„ÄÅ\n„É©„É≥„Ç≠„É≥„Ç∞„Åß‰∏ä‰Ωç„ÇíÁõÆÊåá„Åó„Å¶Á´∂„ÅÑÂêà„Å£„Åü„Çä„Åß„Åç„Åæ„Åô„ÄÇ" },
        { targetId: 'nav-char', text: "„Äå„Ç≠„É£„É©„Äç„É°„Éã„É•„Éº„Åß„ÅØ„ÄÅ\nÁç≤Âæó„Åó„Åü„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÁÆ°ÁêÜ„ÇÑÈÄ≤Âåñ„ÇíË°å„Åà„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-muscles-btn', text: "„ÄåÁ≠ãËÇâ„ÄçÂõ≥Èëë„ÄÇ\nÈçõ„Åà„ÅüÈÉ®‰Ωç„ÅåË®òÈå≤„Åï„Çå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂä™Âäõ„ÅåÂèØË¶ñÂåñ„Åï„Çå„Åæ„Åô!" },
        { targetId: 'nav-settings', text: "ÊúÄÂæå„Å´„ÄåË®≠ÂÆö„Äç„ÄÇ\n„Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±„ÅÆÂ§âÊõ¥„ÇÑÈÄöÁü•Ë®≠ÂÆö„ÅØ„Åì„Å°„Çâ„Åã„Çâ„ÄÇ" },
        { targetId: null, text: "Ë™¨Êòé„ÅØ‰ª•‰∏ä„Åß„Åô„ÄÇ\n„Åï„ÅÇ„ÄÅFitWorks„ÅßÁêÜÊÉ≥„ÅÆ‰Ωì„ÇíÁõÆÊåá„Åó„Å¶„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ!" }
    ];

    let currentRpgStep = 0;

    function startRpgTutorial(forceStart) {
        // ÂàùÂõû„É≠„Ç∞„Ç§„É≥Âà§ÂÆö (localStorage„Çí‰ΩøÁî®)
        const hasSeenTutorial = localStorage.getItem('hasSeenFitWorksTutorial_v2');
        if (!forceStart && hasSeenTutorial) {
            return; // Êó¢„Å´Ë¶ã„ÅüÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        }

        currentRpgStep = 0;
        document.getElementById('tutorial-backdrop').classList.add('active');
        document.getElementById('tutorial-rpg-box').classList.add('active');
        showRpgStep();
    }

    function showRpgStep() {
        if (currentRpgStep >= rpgSteps.length) {
            endRpgTutorial();
            return;
        }

        const step = rpgSteps[currentRpgStep];
        const textField = document.getElementById('rpg-text');
        const spotlight = document.getElementById('tutorial-spotlight');
        const pointer = document.getElementById('tutorial-pointer');

        // „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫ (ÊîπË°å„Ç≥„Éº„Éâ„Çí<br>„Å´Â§âÊèõ)
        textField.innerHTML = step.text.replace(/\n/g, '<br>');

        // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„Éè„Ç§„É©„Ç§„Éà
        if (step.targetId) {
            const target = document.getElementById(step.targetId);
            if (target) {
                const rect = target.getBoundingClientRect();
                
                // „Çπ„Éù„ÉÉ„Éà„É©„Ç§„Éà„ÅÆ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫Ë™øÊï¥
                const pad = 10;
                spotlight.style.width = (rect.width + pad * 2) + 'px';
                spotlight.style.height = (rect.height + pad * 2) + 'px';
                spotlight.style.top = (rect.top + window.scrollY - pad) + 'px';
                spotlight.style.left = (rect.left + window.scrollX - pad) + 'px';
                spotlight.style.display = 'block';
                
                // „Éù„Ç§„É≥„Çø„Éº„ÅÆË°®Á§∫ („Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ‰∏ä)
                pointer.style.top = (rect.top + window.scrollY - 60) + 'px';
                pointer.style.left = (rect.left + window.scrollX + rect.width / 2 - 20) + 'px';
                pointer.style.display = 'block';
                
                // „Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶Ë¶ÅÁ¥†„ÇíË°®Á§∫
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà (ÈùûË°®Á§∫Ë¶ÅÁ¥†„Å™„Å©)
                spotlight.style.display = 'none';
                pointer.style.display = 'none';
            }
        } else {
            // „Çø„Éº„Ç≤„ÉÉ„Éà„Å™„Åó (ÂÖ®‰ΩìË™¨Êòé„Å™„Å©)
            spotlight.style.display = 'none';
            pointer.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ÊúÄÂæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å™„Çâ„Éú„Çø„É≥„ÅÆÊñáÂ≠ó„ÇíÂ§â„Åà„Çã
        const nextBtn = document.getElementById('rpg-next-btn');
        if (currentRpgStep === rpgSteps.length - 1) {
            nextBtn.textContent = "ÂÆå‰∫Ü";
        } else {
            nextBtn.textContent = "Ê¨°„Å∏";
        }
    }

    function nextRpgStep() {
        currentRpgStep++;
        showRpgStep();
    }

    function endRpgTutorial() {
        document.getElementById('tutorial-backdrop').classList.remove('active');
        document.getElementById('tutorial-rpg-box').classList.remove('active');
        document.getElementById('tutorial-spotlight').style.display = 'none';
        document.getElementById('tutorial-pointer').style.display = 'none';
        
        // „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´ÂÆå‰∫Ü„ÇíË®òÈå≤
        localStorage.setItem('hasSeenFitWorksTutorial_v2', 'true');
    }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Ëá™ÂãïÈñãÂßã„ÉÅ„Çß„ÉÉ„ÇØ
    window.addEventListener('load', function() {
        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÈñãÂßã (ÁîªÈù¢ÊèèÁîªÂÆâÂÆöÂæÖ„Å°)
        setTimeout(() => startRpgTutorial(false), 800);
    });

</script>
</body>
</html>