<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éõ„Éº„É† | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link rel="stylesheet" th:href="@{/css/title.css}">
    
    <script th:src="@{/js/theme.js}"></script>
    <style>
        /* HTMLÂÜÖ„Çπ„Çø„Ç§„É´„ÅØ„ÄÅhome.css„Åß„Ç´„Éê„Éº„Åß„Åç„Å™„ÅÑÂãïÁöÑ„Å™„ÇÇ„ÅÆ„ÇÑÂæÆË™øÊï¥„ÅÆ„ÅøÊÆã„Åó„Åæ„Åô */
        
        .xp-bar { width: 100%; height: 25px; background: #e3f2fd; border-radius: 12px; overflow: hidden; margin-top: 8px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .xp-progress { height: 100%; background: linear-gradient(90deg, #42a5f5, #2196f3); color: #fff; font-size: 12px; font-weight: bold; text-align: center; line-height: 25px; border-radius: 12px; transition: width 1s ease-in-out; }
        
        .character-section { position: relative; display: flex; justify-content: center; margin-top: 0px; }
        
        .daily-mission-button { margin-bottom: 5px !important; }

        .character-wrapper {
            position: relative;
            width: 400px;
            height: 400px;
            max-width: 100%;
            margin: 0 auto;
            overflow: visible;
        }

        .character-display { 
            display: flex; 
            justify-content: center; 
            align-items: flex-end; 
            width: 100%; 
            height: 100%; 
            background-image: url('/img/background/fire-original.png'); 
            background-repeat: no-repeat; 
            background-position: center; 
            background-size: cover; 
            border-radius: 25px; 
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3); 
            text-decoration: none; 
            padding-bottom: 10px; 
            box-sizing: border-box; 
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-50px); } 100% { transform: translateY(0px); } }
        .character-display img { width: auto; height: 85%; max-width: 95%; object-fit: contain; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 20px 15px rgba(0,0,0,0.9)); }
        
        .character-side-buttons {
            position: absolute;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
            top: 40px;
            right: -125px; 
        }

        @media (max-width: 650px) {
            .character-side-buttons {
                right: 10px;
                top: 50px; 
            }
        }

        .side-action-btn { 
            color: white; 
            padding: 10px 0; 
            border-radius: 15px; 
            text-decoration: none; 
            font-weight: bold; 
            font-size: 0.85em; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
            transition: transform 0.1s; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 110px; 
            backdrop-filter: blur(4px);
        }
        .side-action-btn:hover { transform: scale(1.05); }
        
        .customize-button { background: linear-gradient(135deg, #ffb300, #ffca28); }
        .title-button { background: linear-gradient(135deg, #9c27b0, #ba68c8); }

        .help-menu-dropdown {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            left: auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            padding: 10px;
            z-index: 2000;
            width: 220px;
            flex-direction: column;
            gap: 10px;
        }
        .help-menu-dropdown.active { display: flex; }
        
        .help-menu-item { display: block; padding: 10px; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold; font-size: 0.9em; transition: transform 0.2s; border: none; width: 100%; cursor: pointer; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box; }
        .help-menu-item:hover { transform: scale(1.03); }

        /* TutorialÈñ¢ÈÄ£„ÅÆCSS„ÅØ home.css „Å´ÁßªÂãï„Åó„Åæ„Åó„Åü„ÄÇ„Åì„Åì„Åß„ÅØÁ´∂Âêà„ÇíÈÅø„Åë„Çã„Åü„ÇÅÂâäÈô§„Åó„Å¶„ÅÑ„Åæ„Åô */
        .tutorial-pointer { position: absolute; z-index: 10000; font-size: 2.5rem; color: #f1c40f; display: none; animation: point-move 1s infinite alternate; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .tutorial-pointer::before { content: '\f0a6'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
        @keyframes point-move { from { transform: translateY(0); } to { transform: translateY(-10px); } }
        
        /* Êå®Êã∂Êñá„ÅÆ„Çπ„Çø„Ç§„É´ */
        .home-greeting-container {
            text-align: center;
            margin-top: 60px;
            margin-bottom: 25px;
        }
        .home-app-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 900;
            font-size: 2.8rem;
            font-style: italic;
            margin: 0;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            text-shadow: 2px 4px 10px rgba(0, 198, 251, 0.2);
            letter-spacing: -1px;
            line-height: 1.1;
        }
        .home-greeting-text {
            font-family: 'Noto Sans JP', sans-serif;
            color: #555;
            font-size: 1rem;
            font-weight: 700;
            margin-top: 8px;
            line-height: 1.6;
        }
        .home-username {
            color: #0288d1;
            font-size: 1.2rem;
            font-weight: 900;
            margin: 0 2px;
            text-decoration: underline wavy #4facfe;
            text-underline-offset: 3px;
        }
    </style>
</head>
<body class="home-page">

<div class="interactive-bg">
    <div class="mouse-follower-cloud"></div>
    <div class="bg-cloud cloud-1"></div>
    <div class="bg-cloud cloud-2"></div>
    <div class="bg-cloud cloud-3"></div>
    <div class="bg-cloud cloud-4"></div>
</div>

<div class="main-container" style="position: relative;"> 
    <button id="help-btn" class="help-label-btn" onclick="toggleHelpMenu()">
        <span style="font-size: 1.2em;">üî∞</span> „Éò„É´„Éó
    </button>
    
    <div id="help-menu" class="help-menu-dropdown">
        <button class="help-menu-item tutorial-opt" onclick="startRpgTutorial(true); toggleHelpMenu();">
            <i class="fa-solid fa-play"></i> „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´
        </button>
        <a th:href="@{/supplement-guide}" class="help-menu-item supple-opt">
            <i class="fa-solid fa-book-medical"></i> „Çµ„Éó„É™„ÅÆÈ£≤„ÅøÊñπ
        </a>
    </div>

    <div class="app-logo-display">
        <img th:src="@{/img/applogo-new.png}" alt="App Logo" />
        <div id="tutorial-xp-area">
            <div class="xp-daily-header"></div>
            <div class="xp-bar-container">
                <span th:text="'„É¨„Éô„É´ ' + ${level} + ' (XP: ' + ${experiencePoints} + '/' + ${requiredXp} + ')'"></span>
                <div class="xp-bar">
                    <div class="xp-progress" th:style="'width:' + ${progressPercent} + '%;'" th:text="${progressPercent} + '%'"></div>
                </div>
            </div>
        </div>
    </div>
    
    <a id="tutorial-mission-btn" th:href="@{/daily-mission}" class="daily-mission-button">
       <i class="fa-solid fa-list-check"></i> „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥
    </a>
    
    <div id="tutorial-title-display" style="text-align: center; margin-top: 5px; min-height: 30px;">
        <th:block th:if="${userTitle != null and userTitle != '„Å™„Åó'}">
            <th:block th:each="enumT : ${T(com.example.demo.entity.AppTitle).values()}" 
                      th:if="${enumT.displayName == userTitle}">
                <div class="title-badge" th:classappend="${enumT.rarity}">
                    <i class="fa-solid fa-crown"></i> <span th:text="${userTitle}"></span>
                </div>
            </th:block>
        </th:block>
    </div>
    
    <div class="character-section">
        <div class="character-wrapper">
            <a id="tutorial-char-display" th:href="@{/character}" class="character-display">
                <img th:src="@{'/img/character/' + ${(level / 10) * 10} + '.png'}" alt="Character" />
            </a>
            
            <div class="character-side-buttons">
                <a id="tutorial-title-btn" th:href="@{/titles}" class="side-action-btn title-button">
                    <i class="fa-solid fa-crown"></i> Áß∞Âè∑
                </a>
                <a id="tutorial-customize-btn" th:href="@{/gacha/customize}" class="side-action-btn customize-button">
                    <i class="fa-solid fa-shirt"></i> ÁùÄ„ÅõÊõø„Åà
                </a>
            </div>
        </div>
    </div>
    
    <div class="home-greeting-container">
        <h1 class="home-app-title">FitWorks</h1>
        <p class="home-greeting-text">
            „Åì„Çì„Å´„Å°„ÅØ„ÄÅ<span class="home-username" th:text="${username}"></span>„Åï„ÇìÔºÅ
        </p>
    </div>
    
    <a id="tutorial-training-btn" th:href="@{/training}" class="daily-mission-button" style="background: linear-gradient(45deg, #ff9966, #ff5e62); box-shadow: 0 6px 20px rgba(255, 94, 98, 0.4); margin-top: 20px;">
       <i class="fa-solid fa-dumbbell" style="margin-left: 5px;"></i> „Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÈñãÂßã 
    </a>

    <div id="tutorial-record-btn" class="record-container" style="margin-top: 15px;">
        <button onclick="toggleRecordMenu()" class="daily-mission-button main-record-btn" style="width: 100%; cursor: pointer; background: linear-gradient(45deg, #2196F3, #03A9F4); box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);">
           <i class="fa-solid fa-pen-to-square" style="margin-left: 5px;"></i> Ë®òÈå≤„Çí„Å§„Åë„Çã
        </button>
        
        <div id="record-options" class="record-options">
            <a th:href="@{/training-log}" class="record-option-item training-log-opt">
                <i class="fa-solid fa-calendar-days"></i><br>Á≠ã„Éà„É¨Â±•Ê≠¥
            </a>
            <a th:href="@{/log/meal}" class="record-option-item meal-opt">
                <i class="fa-solid fa-utensils"></i><br>È£ü‰∫ãË®òÈå≤
            </a>
            <a th:href="@{/training-log/form/body-weight}" class="record-option-item weight-opt">
                <i class="fa-solid fa-weight-scale"></i><br>‰ΩìÈáçË®òÈå≤
            </a>
        </div>
    </div>
    
    <div class="care-section" style="margin-top: 15px; text-align: center; margin-bottom: 15px;">
        <a id="tutorial-care-btn" th:href="@{/training/care}" class="btn-care" style="
            display: inline-block; width: 95%; padding: 12px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #555; font-weight: bold; text-decoration: none;
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        ">
            ‚òïÔ∏è AI„É™„Éï„É¨„ÉÉ„Ç∑„É•ÔºÜ„Ç±„Ç¢
        </a>
    </div>

    <a id="tutorial-map-btn" th:href="@{/training/map}" class="daily-mission-button" style="background: linear-gradient(45deg, #4CAF50, #8BC34A); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); margin-top: 15px;">
       <i class="fa-solid fa-map-location-dot" style="margin-left: 5px;"></i> Ëøë„Åè„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞ÊñΩË®≠ 
    </a>
	<a id="tutorial-ai-btn" th:href="@{/ai-coach}" class="daily-mission-button" style="background: linear-gradient(45deg, #6a11cb, #2575fc); box-shadow: 0 6px 20px rgba(37, 117, 252, 0.4); margin-top: 15px; margin-bottom: 20px;">
	   <i class="fa-solid fa-robot" style="margin-left: 5px;"></i> AI„ÉÅ„É£„ÉÉ„Éà 
	</a>

    <nav id="tutorial-menu-nav" class="bottom-nav">
        <a id="nav-gacha" th:href="@{/gacha}" class="nav-item"><i class="fa-solid fa-gift"></i><span>„Ç¨„ÉÅ„É£„ÄÄ</span></a>
        <a id="tutorial-friends-btn" th:href="@{/friends}" class="nav-item"><i class="fa-solid fa-user-group"></i><span>„Éï„É¨„É≥„Éâ</span></a>
        <a id="nav-community" th:href="@{/community}" class="nav-item"><i class="fa-solid fa-comments"></i><span>Êé≤Á§∫Êùø</span></a>
        <a id="nav-char" th:href="@{/characters/menu/CharactersMenu}" class="nav-item"><i class="fa-solid fa-user-astronaut"></i><span>„Ç≠„É£„É©„ÄÄ</span></a>    
        <a id="tutorial-muscles-btn" th:href="@{/muscles}" class="nav-item"><i class="fa-solid fa-child-reaching"></i><span>Á≠ãËÇâ</span></a>
        <a id="nav-settings" th:href="@{/settings}" class="nav-item"><i class="fa-solid fa-gear"></i><span>Ë®≠ÂÆö</span></a>
    </nav>
</div>

<div id="tutorial-spotlight" class="tutorial-spotlight"></div>
<div id="tutorial-pointer" class="tutorial-pointer"></div>
<div id="tutorial-rpg-box" class="tutorial-rpg-box">
    <div class="rpg-char-area"><img id="rpg-char-img" th:src="@{/img/AIcoach.png}" alt="AI Coach"></div>
    <div class="rpg-content">
        <div class="rpg-name-tag">AI„Ç≥„Éº„ÉÅ</div>
        <div class="rpg-text-area" id="rpg-text"></div>
        <div class="rpg-controls">
            <button class="rpg-btn rpg-btn-skip" onclick="endRpgTutorial()">„Çπ„Ç≠„ÉÉ„Éó</button>
            <button class="rpg-btn rpg-btn-next" id="rpg-next-btn" onclick="nextRpgStep()">Ê¨°„Å∏</button>
        </div>
    </div>
</div>
<div id="tutorial-backdrop" class="tutorial-backdrop"></div>

<script>
    // ... (Êó¢Â≠ò„ÅÆJavaScript„É≠„Ç∏„ÉÉ„ÇØ„Å´Â§âÊõ¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì) ...
    function toggleRecordMenu() {
        const options = document.getElementById('record-options');
        options.classList.toggle('open');
    }

    function toggleHelpMenu() {
        const menu = document.getElementById('help-menu');
        menu.classList.toggle('active');
    }

    document.addEventListener('click', function(event) {
        const menu = document.getElementById('help-menu');
        const btn = document.getElementById('help-btn');
        if (!menu.contains(event.target) && !btn.contains(event.target) && menu.classList.contains('active')) {
            menu.classList.remove('active');
        }
    });

    const rpgSteps = [
        { targetId: null, text: "FitWorks„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ\n„Åì„ÅÆ„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´„Åß„ÅØ„ÄÅ„Ç¢„Éó„É™„ÅÆÂÖ®Ê©üËÉΩ„Çí„ÅîÁ¥π‰ªã„Åó„Åæ„ÅôÔºÅ" },
        { targetId: 'help-btn', text: "„Åæ„Åö„ÅØÁîªÈù¢Â∑¶‰∏ä„ÄÇ„Äå„Éò„É´„Éó„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅ\n„Åì„ÅÆ„Ç¨„Ç§„Éâ„ÅÆÂÜçÁîü„ÇÑ„ÄÅ„Çµ„Éó„É™„É°„É≥„Éà„ÅÆÁü•Ë≠ò„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-xp-area', text: "ÁîªÈù¢‰∏äÈÉ®„Å´„ÅØ„ÅÇ„Å™„Åü„ÅÆ„Äå„É¨„Éô„É´„Äç„Å®„ÄåXP(ÁµåÈ®ìÂÄ§)„Äç„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ\n„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíË®òÈå≤„Åó„Å¶„É¨„Éô„É´„Çí‰∏ä„Åí„Åæ„Åó„Çá„ÅÜÔºÅ" },
        { targetId: 'tutorial-mission-btn', text: "„Äå„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„Äç„ÅØÊØéÊó•Êõ¥Êñ∞„Åï„Çå„Åæ„Åô„ÄÇ\n„ÇØ„É™„Ç¢„Åó„Å¶Â†±ÈÖ¨„ÇÑXP„ÇíÂäπÁéá„Çà„Åè„Ç≤„ÉÉ„Éà„Åó„Åæ„Åó„Çá„ÅÜÔºÅ" },
        { targetId: 'tutorial-title-display', text: "„Åì„Åì„Å´„ÅØÁèæÂú®Ë£ÖÂÇô„Åó„Å¶„ÅÑ„Çã„ÄåÁß∞Âè∑„Äç„ÅåËºù„Åç„Åæ„Åô„ÄÇ\n„É¨„Ç¢„Å™Áß∞Âè∑„ÇíÊâã„Å´ÂÖ•„Çå„Å¶„ÄÅÂº∑„Åï„Çí„Ç¢„Éî„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ" },
        { targetId: 'tutorial-char-display', text: "„ÅÇ„Å™„Åü„ÅÆ„Éë„Éº„Éà„Éä„Éº„Ç≠„É£„É©„ÇØ„Çø„Éº„Åß„Åô„ÄÇ\n„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Å®ÂÖ±„Å´ÈÄ≤Âåñ„Åó„Å¶„ÅÑ„ÅèÂßø„ÇíË¶ãÂÆà„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ" },
        { targetId: 'tutorial-title-btn', text: "„ÄåÁß∞Âè∑„Äç„Éú„Çø„É≥„Åã„Çâ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÁîªÈù¢„Å∏„ÄÇ\nÁç≤Âæó„Åó„ÅüÁß∞Âè∑„Çí‰ªò„ÅëÊõø„Åà„Å¶„ÄÅÂÄãÊÄß„ÇíÂá∫„Åõ„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-customize-btn', text: "„ÄåÁùÄ„ÅõÊõø„Åà„Äç„Éú„Çø„É≥„Åß„ÅØ„ÄÅ„Ç¨„ÉÅ„É£„ÅßÂÖ•Êâã„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„Çí\n„Ç≠„É£„É©„ÇØ„Çø„Éº„Å´Ë£ÖÂÇô„Åï„Åõ„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-training-btn', text: "„É°„Ç§„É≥Ê©üËÉΩ„ÅØ„Åì„ÇåÔºÅ„Äå„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÈñãÂßã„Äç„Éú„Çø„É≥„ÄÇ\n„Åì„Åì„Åã„ÇâÊó•„ÄÖ„ÅÆÈÅãÂãï„É°„Éã„É•„Éº„Çí‰ΩúÊàê„ÉªË®òÈå≤„Åó„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-record-btn', text: "„ÄåË®òÈå≤„Çí„Å§„Åë„Çã„Äç„É°„Éã„É•„Éº„ÇíÈñã„Åè„Å®„ÄÅ\nÈÅéÂéª„ÅÆÂ±•Ê≠¥Á¢∫Ë™ç„ÇÑ„ÄÅÈ£ü‰∫ã„Éª‰ΩìÈáç„ÅÆË®òÈå≤„ÅåÂÄãÂà•„Å´„Åß„Åç„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-care-btn', text: "Áñ≤„Çå„ÅüÊôÇ„ÅØ„ÄåAI„É™„Éï„É¨„ÉÉ„Ç∑„É•ÔºÜ„Ç±„Ç¢„Äç„ÄÇ\n‰ΩìË™ø„Å´Âêà„Çè„Åõ„Åü„Çπ„Éà„É¨„ÉÉ„ÉÅ„ÇÑ‰ºëÊÅØÊ≥ï„ÇíAI„ÅåÊèêÊ°à„Åó„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-map-btn', text: "„Äå„Éû„ÉÉ„Éó„ÄçÊ©üËÉΩ„Çí‰Ωø„Åà„Å∞„ÄÅ\nËøë„Åè„ÅÆ„Ç∏„É†„ÇÑÂÖ¨Âúí„ÄÅ„Éà„É¨„Éº„Éã„É≥„Ç∞ÊñΩË®≠„Çí„Åô„Åê„Å´Êé¢„Åõ„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-ai-btn', text: "„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇÑÈ£ü‰∫ã„ÅÆÊÇ©„Åø„ÅØ„ÄåAI„ÉÅ„É£„ÉÉ„Éà„Äç„Å∏„ÄÇ\nÂ∞ÇÂ±û„ÅÆAI„Ç≥„Éº„ÉÅ„Åå24ÊôÇÈñì„ÅÑ„Å§„Åß„ÇÇÁõ∏Ë´á„Å´‰πó„Çä„Åæ„ÅôÔºÅ" },
        { targetId: 'nav-gacha', text: "„Åì„Åì„Åã„Çâ„ÅØ‰∏ã„ÅÆ„É°„Éã„É•„Éº„Åß„Åô„ÄÇ\n„Äå„Ç¨„ÉÅ„É£„Äç„Åß„ÅØ„ÄÅÁùÄ„ÅõÊõø„Åà„Ç¢„Ç§„ÉÜ„É†„Å™„Å©„ÅÆÂ†±ÈÖ¨„ÅåÊâã„Å´ÂÖ•„Çä„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-friends-btn', text: "„Äå„Éï„É¨„É≥„Éâ„ÄçÊ©üËÉΩ„Åß‰ª≤Èñì„Å®„Å§„Å™„Åå„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ\n„Åä‰∫í„ÅÑ„Å´Âä±„Åæ„ÅóÂêà„Å£„Åü„Çä„ÄÅ„É©„É≥„Ç≠„É≥„Ç∞„ÅßÁ´∂„Åà„Åæ„Åô„ÄÇ" },
        { targetId: 'nav-community', text: "„ÄåÊé≤Á§∫Êùø„Äç„ÅØ„É¶„Éº„Ç∂„ÉºÂêåÂ£´„ÅÆ‰∫§ÊµÅ„Çπ„Éö„Éº„Çπ„ÄÇ\nÁ≠ã„Éà„É¨ÊÉÖÂ†±„ÅÆ‰∫§Êèõ„ÇÑ„ÄÅÈõëË´á„ÅßÁõõ„Çä‰∏ä„Åå„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ" },
        { targetId: 'nav-char', text: "„Äå„Ç≠„É£„É©„Äç„É°„Éã„É•„Éº„Åß„ÅØ„ÄÅ„Ç≠„É£„É©„ÇØ„Çø„ÉºÂõ≥Èëë„ÇíË¶ã„Åü„Çä„ÄÅ\n„Éë„Éº„Éà„Éä„Éº„ÅÆË©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ" },
        { targetId: 'tutorial-muscles-btn', text: "„ÄåÁ≠ãËÇâ„Äç„Çø„Éñ„Åß„ÅØ„ÄÅÈçõ„Åà„ÅüÈÉ®‰Ωç„ÅåÂÖâ„Çã„Äå„Éû„ÉÉ„Çπ„É´„Éë„Éº„Éà„Éä„Éº„Äç„ÇíË°®Á§∫„ÄÇ\nËá™ÂàÜ„ÅÆÊàêÈï∑ÁÆáÊâÄ„Åå‰∏ÄÁõÆ„Åß„Çè„Åã„Çä„Åæ„ÅôÔºÅ" },
        { targetId: 'nav-settings', text: "ÊúÄÂæå„Å´„ÄåË®≠ÂÆö„Äç„ÄÇ„Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±„ÅÆÂ§âÊõ¥„ÇÑÈÄöÁü•Ë®≠ÂÆö„ÄÅ\nÁîü‰ΩìË™çË®º(FaceID/TouchID)„ÅÆÁôªÈå≤„ÇÇ„Åì„Åì„Åã„ÇâË°å„Åà„Åæ„Åô„ÄÇ" },
        { targetId: null, text: "Ê©üËÉΩË™¨Êòé„ÅØ‰ª•‰∏ä„Åß„Åô„ÄÇ\n„Åï„ÅÇ„ÄÅFitWorks„ÅßÊúÄÈ´ò„ÅÆ„Éï„Ç£„ÉÉ„Éà„Éç„Çπ„É©„Ç§„Éï„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ" }
    ];
    
    let currentRpgStep = 0;
    let typeWriterInterval;
    let updateLoopId; 
    const STORAGE_KEY_RPG = 'fitworks_rpg_tutorial_v16'; 

    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem(STORAGE_KEY_RPG)) { setTimeout(() => startRpgTutorial(), 800); }
        window.addEventListener('resize', updateSpotlightPosition);
        window.addEventListener('scroll', updateSpotlightPosition);
    });

    function startRpgTutorial(isManual) {
        currentRpgStep = 0;
        document.getElementById('tutorial-spotlight').classList.add('active');
        document.getElementById('tutorial-rpg-box').classList.add('active');
        document.getElementById('tutorial-backdrop').classList.add('active');
        updateRpgView();
        startUpdateLoop();
    }

    function updateRpgView() {
        const step = rpgSteps[currentRpgStep];
        const textBox = document.getElementById('rpg-text');
        const charImg = document.getElementById('rpg-char-img');
        const nextBtn = document.getElementById('rpg-next-btn');
        textBox.innerHTML = '';
        if (typeWriterInterval) clearInterval(typeWriterInterval);
        charImg.classList.add('talking');
        let i = 0;
        const chars = [...step.text]; 
        typeWriterInterval = setInterval(() => {
            if (i < chars.length) { textBox.innerHTML += (chars[i] === '\n') ? '<br>' : chars[i]; i++; } 
            else { clearInterval(typeWriterInterval); charImg.classList.remove('talking'); }
        }, 40);
        nextBtn.innerHTML = (currentRpgStep === rpgSteps.length - 1) ? 'ÂÆå‰∫Ü' : 'Ê¨°„Å∏';
        moveSpotlight(step.targetId);
    }

    function startUpdateLoop() {
        if (updateLoopId) cancelAnimationFrame(updateLoopId);
        const loop = () => { updateSpotlightPosition(); updateLoopId = requestAnimationFrame(loop); };
        loop();
    }
    function stopUpdateLoop() { if (updateLoopId) cancelAnimationFrame(updateLoopId); }

    function moveSpotlight(targetId) {
        const spotlight = document.getElementById('tutorial-spotlight');
        const pointer = document.getElementById('tutorial-pointer');
        let targetEl = null;
        if (targetId) {
            targetEl = document.getElementById(targetId);
        }
        if (!targetId || !targetEl) {
            pointer.style.display = 'none';
            spotlight.style.width = '0'; spotlight.style.height = '0';
            spotlight.style.top = (window.pageYOffset + window.innerHeight/2) + 'px';
            spotlight.style.left = (window.pageXOffset + window.innerWidth/2) + 'px';
            const msgBox = document.getElementById('tutorial-rpg-box');
            msgBox.style.top = (window.pageYOffset + window.innerHeight/2 + 50) + 'px';
            msgBox.style.left = (window.pageXOffset + window.innerWidth/2) + 'px';
        } else {
            pointer.style.display = 'block';
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    function updateSpotlightPosition() {
        const step = rpgSteps[currentRpgStep];
        const msgBox = document.getElementById('tutorial-rpg-box');
        if (!step || !step.targetId) {
             const scrollY = window.pageYOffset; 
             const scrollX = window.pageXOffset;
             msgBox.style.top = (scrollY + window.innerHeight/2 + 50) + 'px';
             msgBox.style.left = (scrollX + window.innerWidth/2) + 'px';
             return;
        }
        const targetEl = document.getElementById(step.targetId);
        if(!targetEl) return;
        const rect = targetEl.getBoundingClientRect();
        const scrollY = window.pageYOffset; const scrollX = window.pageXOffset;
        const spotlight = document.getElementById('tutorial-spotlight');
        const pointer = document.getElementById('tutorial-pointer');
        spotlight.style.width = (rect.width + 20) + 'px';
        spotlight.style.height = (rect.height + 20) + 'px';
        spotlight.style.top = (rect.top + scrollY - 10) + 'px';
        spotlight.style.left = (rect.left + scrollX - 10) + 'px';
        pointer.style.top = (rect.bottom + scrollY + 10) + 'px';
        pointer.style.left = (rect.left + scrollX + rect.width/2 - 20) + 'px';
        
        let boxTop = rect.top + scrollY - msgBox.offsetHeight - 20;
        if (boxTop < scrollY + 10 || (step.targetId.startsWith('nav-')) || step.targetId.startsWith('tutorial-friends') || step.targetId.startsWith('tutorial-muscles')) {
             boxTop = rect.bottom + scrollY + 30;
        }
        msgBox.style.top = boxTop + 'px';
        msgBox.style.left = (rect.left + scrollX + rect.width/2) + 'px';
    }

    function nextRpgStep() {
        if (currentRpgStep < rpgSteps.length - 1) { currentRpgStep++; updateRpgView(); }
        else { endRpgTutorial(); }
    }

    function endRpgTutorial() {
        document.getElementById('tutorial-rpg-box').classList.remove('active');
        document.getElementById('tutorial-spotlight').classList.remove('active');
        document.getElementById('tutorial-backdrop').classList.remove('active');
        document.getElementById('tutorial-pointer').style.display = 'none';
        stopUpdateLoop();
        localStorage.setItem(STORAGE_KEY_RPG, 'true');
    }

    document.addEventListener('mousemove', (e) => {
        const x = e.clientX / window.innerWidth;
        const y = e.clientY / window.innerHeight;
        document.body.style.setProperty('--mouse-x', x);
        document.body.style.setProperty('--mouse-y', y);
    });
</script>
</body>
</html>