<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éõ„Éº„É† | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&family=M+PLUS+Rounded+1c:wght@500;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link rel="stylesheet" th:href="@{/css/title.css}">
    <script th:src="@{/js/theme.js}"></script>
	<style>
	    :root { --primary-color: #ff69b4; }
	    .xp-bar { width: 100%; height: 25px; background: #e3f2fd; border-radius: 12px; overflow: hidden; margin-top: 8px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
	    .xp-progress { height: 100%; background: linear-gradient(90deg, #42a5f5, #2196f3); color: #fff; font-size: 12px; font-weight: bold; text-align: center; line-height: 25px; border-radius: 12px; transition: width 1s ease-in-out; }
	    .character-section { position: relative; display: flex; justify-content: center; margin-top: 0px; }
	    .character-wrapper { position: relative; width: 400px; max-width: 100%; margin: 0 auto; overflow: visible; display: block; }
	    .character-display { display: flex; justify-content: center; align-items: flex-end; width: 100%; height: 400px; background-repeat: no-repeat; background-position: center; background-size: cover; border-radius: 25px; box-shadow: 0 10px 30px rgba(33, 150, 243, 0.25); text-decoration: none; padding-bottom: 10px; box-sizing: border-box; border: 4px solid rgba(255,255,255,0.8); z-index: 1; }
	    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-50px); } 100% { transform: translateY(0px); } }
	    .character-display img { width: auto; height: 85%; max-width: 95%; object-fit: contain; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 20px 15px rgba(0,0,0,0.9)); }
	    .character-side-buttons { position: absolute; display: flex; flex-direction: column; gap: 15px; z-index: 10; top: 80px; right: -115px; }
	    .side-action-btn { color: white; padding: 10px 0; border-radius: 15px; text-decoration: none; font-weight: bold; font-size: 0.9em; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 6px; width: 100px; backdrop-filter: blur(4px); }
	    .side-action-btn:hover { transform: scale(1.05); }
	    .title-button { background: linear-gradient(135deg, #9c27b0, #ba68c8); border: 2px solid rgba(255,255,255,0.3); }
	    .mission-square-btn { height: 100px; flex-direction: column; background: linear-gradient(135deg, #ff9800, #f57c00); border: 2px solid rgba(255,255,255,0.3); font-size: 0.95em; }
	    .mission-square-btn i { font-size: 2.0rem; margin-bottom: 5px; }
	    .record-option-item { transition: all 0.3s ease-out !important; transform: translateY(0); }
	    .record-option-item:hover { transform: translateY(-3px) !important; box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important; z-index: 10; filter: brightness(1.05); }
	    .record-option-item:active { transform: translateY(1px) !important; box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; transition: all 0.1s ease !important; }
	    .help-menu-dropdown { display: none; position: absolute; top: 60px; right: 20px; left: auto; background: rgba(255, 255, 255, 0.98); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); padding: 15px; z-index: 2000; width: 260px; flex-direction: column; gap: 8px; max-height: 80vh; overflow-y: auto; }
	    .help-menu-dropdown.active { display: flex; animation: fadeInDown 0.3s ease; }
	    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
	    .help-section-label { font-size: 0.8rem; color: #888; font-weight: bold; margin: 5px 0 2px 5px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
	    .help-menu-item { display: flex; align-items: center; gap: 10px; padding: 12px; text-decoration: none; border-radius: 10px; text-align: left; font-weight: bold; font-size: 0.95em; transition: all 0.2s; border: none; width: 100%; cursor: pointer; color: #444; background: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05); box-sizing: border-box; }
	    .help-menu-item:hover { transform: translateX(5px); background: #e3f2fd; color: #0288d1; }
	    .help-menu-item i { width: 20px; text-align: center; color: #0288d1; }
	    .tutorial-pointer { position: absolute; z-index: 10000; font-size: 2.5rem; color: #f1c40f; display: none; animation: point-move 1s infinite alternate; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
	    .tutorial-pointer::before { content: '\f0a6'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
	    @keyframes point-move { from { transform: translateY(0); } to { transform: translateY(-10px); } }
	    .rpg-text-area { font-size: 1.25rem; font-weight: bold; line-height: 1.6; color: #333; }
	    /* ‚òÖ‰øÆÊ≠£: „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éû„Éº„Ç∏„É≥„Çí10px„Å´Á∏ÆÂ∞è */
	    .home-greeting-container { text-align: center; margin-top: 10px; margin-bottom: 15px; }
	    .home-greeting-text { font-family: 'Noto Sans JP', sans-serif; color: #555; font-size: 1.1rem; font-weight: 700; margin-top: 0; line-height: 1.6; }
	    .home-username { color: #0288d1; font-size: 1.3rem; font-weight: 900; margin: 0 3px; text-decoration: underline wavy #4facfe; text-underline-offset: 4px; }
	    .background-unlock-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; animation: fadeIn 0.3s ease-in-out; }
	    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
	    .background-unlock-content { background: linear-gradient(180deg, #fffef7 0%, #faf8f0 100%); border: 6px solid #d4a373; border-radius: 30px; padding: 0; max-width: 520px; width: 90%; box-shadow: 0 0 0 3px #f5e6d3, 0 0 0 9px #d4a373, 0 15px 35px rgba(0, 0, 0, 0.3); animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); position: relative; overflow: hidden; }
	    @keyframes popIn { 0% { transform: scale(0.5) rotate(-5deg); opacity: 0; } 60% { transform: scale(1.05) rotate(2deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
	    .leaf-decoration { position: absolute; font-size: 2rem; opacity: 0.15; pointer-events: none; animation: leafFloat 4s ease-in-out infinite; }
	    .leaf-decoration::before { content: 'üçÉ'; }
	    .leaf-decoration:nth-child(1) { top: 15px; left: 15px; animation-delay: 0s; }
	    .leaf-decoration:nth-child(2) { top: 15px; right: 15px; animation-delay: 1s; }
	    .leaf-decoration:nth-child(3) { bottom: 15px; left: 15px; animation-delay: 2s; }
	    .leaf-decoration:nth-child(4) { bottom: 15px; right: 15px; animation-delay: 3s; }
	    @keyframes leafFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(5deg); } }
	    .ff-header { background: linear-gradient(180deg, #9bcc7a 0%, #7db85e 100%); border-bottom: 5px solid #6a9c4f; border-radius: 24px 24px 0 0; padding: 25px 20px; position: relative; box-shadow: inset 0 2px 0 rgba(255, 255, 255, 0.4), 0 3px 0 rgba(106, 156, 79, 0.3); }
	    .ff-header::before { content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 60px; height: 4px; background: rgba(255, 255, 255, 0.5); border-radius: 2px; }
	    .background-unlock-title { color: #ffffff; font-size: 1.35rem; font-weight: bold; margin: 0; text-align: center; letter-spacing: 0.5px; font-family: Arial, sans-serif; text-shadow: 2px 2px 0 rgba(106, 156, 79, 0.8), -1px -1px 0 rgba(106, 156, 79, 0.3); }
	    .ff-content { padding: 30px 25px; position: relative; }
	    .background-unlock-list { background: #ffffff; border: 4px solid #e8d5b7; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: inset 0 2px 0 rgba(0, 0, 0, 0.03), 0 3px 10px rgba(0, 0, 0, 0.1); position: relative; }
	    .background-unlock-item { background: linear-gradient(135deg, #fff9f0 0%, #fef5e7 100%); border: 3px solid #f4d9a6; border-radius: 15px; color: #5a4a3a; font-size: 1.05rem; font-weight: bold; margin: 12px 0; padding: 14px 18px; position: relative; animation: itemBounce 0.5s ease-out forwards; opacity: 0; box-shadow: 0 4px 0 #e8c78e, 0 5px 10px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; }
	    .background-unlock-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 7px 0 #e8c78e, 0 8px 15px rgba(0, 0, 0, 0.15); }
	    @keyframes itemBounce { 0% { transform: scale(0.3) translateY(-20px); opacity: 0; } 50% { transform: scale(1.1) translateY(0); opacity: 1; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
	    .background-unlock-item:nth-child(1) { animation-delay: 0.1s; } .background-unlock-item:nth-child(2) { animation-delay: 0.2s; }
	    .background-unlock-item:nth-child(3) { animation-delay: 0.3s; } .background-unlock-item:nth-child(4) { animation-delay: 0.4s; }
	    .background-unlock-item::before { content: '‚úø'; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); color: #9bcc7a; font-size: 1.3rem; animation: flowerSpin 3s ease-in-out infinite; }
	    @keyframes flowerSpin { 0%, 100% { transform: translateY(-50%) rotate(0deg); } 50% { transform: translateY(-50%) rotate(180deg); } }
	    .background-unlock-item i { color: #f4a460; margin-right: 10px; font-size: 1.1rem; }
	    .background-unlock-item strong { color: #6a5a4a; }
	    .background-unlock-buttons { display: flex; gap: 12px; justify-content: center; padding: 0 25px 30px; position: relative; }
	    .background-unlock-buttons button, .background-unlock-buttons a { padding: 14px 26px; border: 4px solid #d4a373; border-radius: 50px; font-weight: bold; font-size: 0.95rem; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; position: relative; transition: all 0.2s ease; font-family: Arial, sans-serif; box-shadow: 0 5px 0 #b8906a, 0 6px 12px rgba(0, 0, 0, 0.15); }
	    .background-unlock-buttons button:active, .background-unlock-buttons a:active { transform: translateY(3px); box-shadow: 0 2px 0 #b8906a, 0 3px 6px rgba(0, 0, 0, 0.15); }
	    .background-unlock-buttons button:hover, .background-unlock-buttons a:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #b8906a, 0 8px 16px rgba(0, 0, 0, 0.2); }
	    .btn-later { background: linear-gradient(180deg, #f4e4c1 0%, #e8d5b7 100%); color: #6a5a4a; border-color: #d4a373; }
	    .btn-go-backgrounds { background: linear-gradient(180deg, #9bcc7a 0%, #7db85e 100%); color: #ffffff; border-color: #6a9c4f; box-shadow: 0 5px 0 #5a8c3f, 0 6px 12px rgba(0, 0, 0, 0.15); }
	    .btn-go-backgrounds:active { box-shadow: 0 2px 0 #5a8c3f, 0 3px 6px rgba(0, 0, 0, 0.15); }
	    .btn-go-backgrounds:hover { box-shadow: 0 7px 0 #5a8c3f, 0 8px 16px rgba(0, 0, 0, 0.2); }
	    .btn-go-backgrounds i { color: #f4d9a6; }
	    .tutorial-backdrop, .tutorial-spotlight, .tutorial-pointer, .tutorial-rpg-box { pointer-events: none; }
	    .tutorial-backdrop.active, .tutorial-rpg-box.active { pointer-events: auto; }
	    .interactive-bg, .mouse-follower-cloud, .bg-cloud { pointer-events: none !important; z-index: -1; }
	    #tutorial-rpg-box { z-index: 10001; }
	    .menu-item-spacing { margin-top: 20px !important; width: 100%; box-sizing: border-box; display: block; }
	    .care-section { text-align: center; }
	    .btn-record, .btn-care, .home-action-btn, .side-action-btn, .title-button { border: none !important; outline: none !important; }
	    .main-container { padding-bottom: 150px !important; }
	    #tutorial-menu-nav.bottom-nav { display: flex !important; justify-content: space-evenly; align-items: center; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 800px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 10px 15px; box-sizing: border-box; z-index: 1000; visibility: visible !important; opacity: 1 !important; }
	    #tutorial-menu-nav .nav-item { display: flex; flex-direction: column; justify-content: center; align-items: center; flex: 1; height: auto; min-height: 60px; text-decoration: none; color: #555; border-radius: 12px; transition: transform 0.2s ease, background 0.2s; padding: 5px 0; margin: 0 5px; }
	    #tutorial-menu-nav .nav-item i { display: block; font-size: 22px; margin-bottom: 5px; line-height: 1; color: var(--primary-color, #ff69b4); }
	    #tutorial-menu-nav .nav-item span { display: block; font-size: 11px; font-weight: bold; white-space: nowrap; line-height: 1.2; width: 100%; text-align: center; }
	    #tutorial-menu-nav .nav-item:hover { background-color: #f0f8ff; transform: translateY(-3px); }
	    .mission-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #ff9800, #f57c00); color: white; padding: 15px 30px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 20000; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; animation: slideDownFade 0.5s ease-out forwards; pointer-events: none; }
	    @keyframes slideDownFade { from { top: -50px; opacity: 0; } to { top: 20px; opacity: 1; } }
	    .mission-notification.fade-out { animation: fadeOutUp 0.5s ease-in forwards; }
	    @keyframes fadeOutUp { from { top: 20px; opacity: 1; } to { top: -50px; opacity: 0; } }
	    
	    /* „É°„Éá„Ç£„Ç¢„ÇØ„Ç®„É™ */
	    @media (max-width: 750px) {
	        .main-container { padding-bottom: 120px !important; }
	        #tutorial-ai-btn { margin-bottom: 40px !important; }
	        .character-wrapper { display: flex; flex-direction: column; height: auto; width: 95%; overflow: visible; margin-top: 10px; }
	        .character-display { width: 80%; margin: 0 auto; height: auto; aspect-ratio: 1 / 1; order: 3; }
	        .character-side-buttons { position: static; display: flex; flex-direction: row; justify-content: space-between; width: 100%; margin: -10px 0 20px 0; gap: 10px; order: 1; top: auto; right: auto; }
	        /* „Çπ„Éû„ÉõÊôÇ„ÅÆ„Éû„Éº„Ç∏„É≥Ë®≠ÂÆö */
	        #tutorial-title-display { order: 2; margin-top: 5px !important; margin-bottom: 15px !important; }
	        .side-action-btn { width: 48%; height: 45px; font-size: 1.0rem; margin: 0; display: flex; align-items: center; justify-content: center; flex-direction: row; }
	        .mission-square-btn { height: 45px; flex-direction: row; }
	        .mission-square-btn i { font-size: 1.1rem; margin-bottom: 0; margin-right: 6px; }
	        /* ‚òÖËøΩÂä†: „Çπ„Éû„ÉõÊôÇ„ÅØÊå®Êã∂„Éû„Éº„Ç∏„É≥„ÇíÂÖÉ„Å´Êàª„Åô */
	        .home-greeting-container { margin-top: 30px !important; }
	    }
	    @media (max-width: 600px) {
	        #tutorial-ai-btn { margin-bottom: 15px !important; }
	        .app-logo-display img { width: 220px !important; max-width: 90%; }
	    }
	</style>
</head>
<body class="home-page">

<div th:if="${missionAchieved}" id="mission-notification" class="mission-notification">
    <i class="fa-solid fa-trophy"></i> „Éü„ÉÉ„Ç∑„Éß„É≥ÈÅîÊàêÔºÅÂ†±ÈÖ¨„ÇíÂèó„ÅëÂèñ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ
</div>

<div class="interactive-bg">
    <div class="mouse-follower-cloud"></div>
    <div class="bg-cloud cloud-1"></div>
    <div class="bg-cloud cloud-2"></div>
    <div class="bg-cloud cloud-3"></div>
    <div class="bg-cloud cloud-4"></div>
</div>

<div class="main-container" style="position: relative;"> 
    <div id="real-time-clock" class="real-time-clock">0000/00/00(Êúà) 00:00</div>

    <button id="help-btn" class="help-label-btn" onclick="toggleHelpMenu()">
        <i class="fa-solid fa-circle-question" style="font-size: 1.2em;"></i> „Éò„É´„Éó
    </button>
    
    <div id="help-menu" class="help-menu-dropdown">
        <div class="help-section-label">üî∞ „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´</div>
        <button class="help-menu-item tutorial-opt" onclick="startRpgTutorial('all'); toggleHelpMenu();">
            <i class="fa-solid fa-star"></i> ÂÖ®Ê©üËÉΩ„ÉÑ„Ç¢„Éº
        </button>
        <button class="help-menu-item" onclick="startRpgTutorial('training'); toggleHelpMenu();">
            <i class="fa-solid fa-dumbbell"></i> „Éà„É¨„Éº„Éã„É≥„Ç∞„ÅÆÂßã„ÇÅÊñπ
        </button>
        <button class="help-menu-item" onclick="startRpgTutorial('record'); toggleHelpMenu();">
            <i class="fa-solid fa-pen-to-square"></i> Ë®òÈå≤„ÅÆ‰ªò„ÅëÊñπ„Éª„Ç±„Ç¢
        </button>
        <button class="help-menu-item" onclick="startRpgTutorial('gacha'); toggleHelpMenu();">
            <i class="fa-solid fa-gift"></i> „Ç¨„ÉÅ„É£„Éª„Ç≠„É£„É©„Å´„Å§„ÅÑ„Å¶
        </button>
        <button class="help-menu-item" onclick="startRpgTutorial('social'); toggleHelpMenu();">
            <i class="fa-solid fa-users"></i> ‰∫§ÊµÅ„ÉªAI„Éª„Åù„ÅÆ‰ªñ
        </button>

        <div class="help-section-label">üìò „Ç¨„Ç§„Éâ</div>
        <a th:href="@{/supplement-guide}" class="help-menu-item supple-opt">
            <i class="fa-solid fa-book-medical"></i> „Çµ„Éó„É™„ÅÆÈ£≤„ÅøÊñπ
        </a>
        
        <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1);">
            <p style="margin: 0 0 5px 0; font-size: 0.85rem; font-weight: 800; color: #06c755; text-shadow: 0 1px 1px rgba(255,255,255,0.8);">
                <i class="fa-brands fa-line"></i> ÂÖ¨ÂºèLINE„ÅØ„Åì„Å°„Çâ
            </p>
            <a href="https://lin.ee/nUEWQkq">
                <img src="https://scdn.line-apps.com/n/line_add_friends/btn/ja.png" alt="Âèã„Å†„Å°ËøΩÂä†" height="36" border="0">
            </a>
        </div>
    </div>

    <div class="app-logo-display">
        <img th:src="@{/img/applogo-new.png}" alt="App Logo" />
        <div id="tutorial-xp-area">
            <div class="xp-daily-header"></div>
            <div class="xp-bar-container">
                <span th:text="'„É¨„Éô„É´ ' + ${level} + ' (XP: ' + ${experiencePoints} + '/' + ${requiredXp} + ')'"></span>
                <div class="xp-bar">
                    <div class="xp-progress" th:style="'width:' + ${progressPercent} + '%;'" th:text="${progressPercent} + '%'"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="character-section">
        <div class="character-wrapper">
            <div id="tutorial-title-display" style="text-align: center; margin-top: 5px; min-height: 30px;">
                <th:block th:if="${userTitle != null and userTitle != '„Å™„Åó'}">
                    <th:block th:each="enumT : ${T(com.example.demo.entity.AppTitle).values()}" 
                              th:if="${enumT.displayName == userTitle}">
                        <div class="title-badge" th:classappend="${enumT.rarity}">
                            <i class="fa-solid fa-crown"></i> <span th:text="${userTitle}"></span>
                        </div>
                    </th:block>
                </th:block>
            </div>

            <div id="tutorial-char-display" class="character-display"
                            th:style="'background-image: url(/img/background/' + ${selectedBackground} + '.png);'">
                <img th:src="@{'/img/character/' + ${(level / 10) * 10} + '.png'}" alt="Character" />
            </div>
            
            <div class="character-side-buttons">
                <a id="tutorial-title-btn" th:href="@{/titles}" class="side-action-btn title-button">
                    <i class="fa-solid fa-crown"></i> Áß∞Âè∑
                </a>
                
                <a id="tutorial-mission-btn" th:href="@{/daily-mission}" class="side-action-btn mission-square-btn">
                   <i class="fa-solid fa-list-check"></i> „Éü„ÉÉ„Ç∑„Éß„É≥
                </a>
            </div>
        </div>
    </div>
    
    <div class="home-greeting-container">
        <p class="home-greeting-text">
            „Åì„Çì„Å´„Å°„ÅØ„ÄÅ<span class="home-username" th:text="${username}"></span>„Åï„Çì!
        </p>
    </div>
    
    <div class="ai-home-advice-container">
        <div class="ai-avatar-small">
            <img th:src="@{/img/AIcoach.png}" alt="AI">
        </div>
        <div class="ai-bubble-content">
             <p id="ai-home-message">„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„É≥Ë®∫Êñ≠‰∏≠<span class="loading-dots">...</span></p>
        </div>
    </div>
    
    <a id="tutorial-training-btn" th:href="@{/training}" class="home-action-btn btn-training menu-item-spacing">
           <i class="fa-solid fa-dumbbell"></i> „Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÈñãÂßã 
        </a>

        <div id="tutorial-record-btn" class="record-container menu-item-spacing">
            <button id="tutorial-record-toggle" onclick="toggleRecordMenu()" class="home-action-btn btn-record" style="width: 100%;">
               <i class="fa-solid fa-pen-to-square"></i> Ë®òÈå≤„Çí„Å§„Åë„Çã
            </button>
            
            <div id="record-options" class="record-options">
                <a id="tutorial-record-log" th:href="@{/training-log}" class="record-option-item training-log-opt">
                    <i class="fa-solid fa-calendar-days"></i><br>Á≠ã„Éà„É¨Â±•Ê≠¥
                </a>
                <a id="tutorial-record-meal" th:href="@{/log/meal}" class="record-option-item meal-opt">
                    <i class="fa-solid fa-utensils"></i><br>È£ü‰∫ãË®òÈå≤
                </a>
                <a id="tutorial-record-weight" th:href="@{/training-log/form/body-weight}" class="record-option-item weight-opt">
                    <i class="fa-solid fa-weight-scale"></i><br>‰ΩìÈáçË®òÈå≤
                </a>
            </div>
        </div>
        
        <div class="care-section menu-item-spacing">
            <a id="tutorial-care-btn" th:href="@{/training/care}" class="home-action-btn btn-care">
                <i class="fa-solid fa-mug-hot"></i> AI„É™„Éï„É¨„ÉÉ„Ç∑„É•&„Ç±„Ç¢
            </a>
        </div>

        <a id="tutorial-map-btn" th:href="@{/training/map}" class="home-action-btn btn-map menu-item-spacing">
           <i class="fa-solid fa-map-location-dot"></i> Ëøë„Åè„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞ÊñΩË®≠ 
        </a>
        
        <a id="tutorial-ai-btn" th:href="@{/ai-coach}" class="home-action-btn btn-ai menu-item-spacing">
           <i class="fa-solid fa-robot"></i> AI„ÉÅ„É£„ÉÉ„Éà 
        </a>

    <nav id="tutorial-menu-nav" class="bottom-nav">
        <a id="nav-gacha" th:href="@{/gacha}" class="nav-item"><i class="fa-solid fa-gift"></i><span>„Ç¨„ÉÅ„É£„ÄÄ</span></a>
        <a id="tutorial-friends-btn" th:href="@{/friends}" class="nav-item"><i class="fa-solid fa-user-group"></i><span>„Éï„É¨„É≥„Éâ</span></a>
        <a id="nav-community" th:href="@{/community}" class="nav-item"><i class="fa-solid fa-comments"></i><span>Êé≤Á§∫Êùø„ÄÄ</span></a>
        <a id="nav-char" th:href="@{/characters/menu/CharactersMenu}" class="nav-item"><i class="fa-solid fa-user-astronaut"></i><span>„Ç≠„É£„É©„ÄÄ</span></a>    
        <a id="tutorial-muscles-btn" th:href="@{/muscles}" class="nav-item"><i class="fa-solid fa-child-reaching"></i><span>Á≠ãËÇâ„ÄÄ</span></a>
        <a id="nav-settings" th:href="@{/settings}" class="nav-item"><i class="fa-solid fa-gear"></i><span>Ë®≠ÂÆö</span></a>
    </nav>
</div>

<div id="tutorial-spotlight" class="tutorial-spotlight"></div>
<div id="tutorial-pointer" class="tutorial-pointer"></div>
<div id="tutorial-rpg-box" class="tutorial-rpg-box">
    <div class="rpg-char-area"><img id="rpg-char-img" th:src="@{/img/AIcoach.png}" alt="AI Coach"></div>
    <div class="rpg-content">
        <div class="rpg-name-tag">AI„Ç≥„Éº„ÉÅ</div>
        <div class="rpg-text-area" id="rpg-text"></div>
        <div class="rpg-controls">
            <button class="rpg-btn rpg-btn-skip" onclick="endRpgTutorial()">ÁµÇ‰∫Ü</button>
            <button class="rpg-btn rpg-btn-next" id="rpg-next-btn" onclick="nextRpgStep()">Ê¨°„Å∏</button>
        </div>
    </div>
</div>

<div id="background-unlock-popup" class="background-unlock-overlay" style="display: none;">
    <div class="background-unlock-content">
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>

        <div class="ff-header">
            <h2 class="background-unlock-title">„ÅÇ„Åü„Çâ„Åó„ÅÑËÉåÊôØ„ÅåÊâã„Å´ÂÖ•„Å£„Åü„Çà!</h2>
        </div>

        <div class="ff-content">
            <div id="background-unlock-list" class="background-unlock-list">
                </div>
        </div>

        <div class="background-unlock-buttons">
            <button onclick="closeBackgroundUnlockPopup()" class="btn-later">
                <i class="fa-solid fa-clock"></i>
                „ÅÇ„Å®„ÅßË¶ã„Çã
            </button>
            <a href="/characters/menu/Backgrounds" class="btn-go-backgrounds">
                <i class="fa-solid fa-image"></i>
                ËÉåÊôØ‰∏ÄË¶ß„Å∏
            </a>
        </div>
    </div>
</div>

<div id="tutorial-backdrop" class="tutorial-backdrop"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        const backgroundUnlocks = /*[[${backgroundUnlocks}]]*/ null;
        
        console.log('========== ËÉåÊôØËß£Êîæ„ÉÅ„Çß„ÉÉ„ÇØ ==========');
        console.log('backgroundUnlocks:', backgroundUnlocks);
        console.log('====================================');
        
        if (backgroundUnlocks && backgroundUnlocks.hasNewUnlocks) {
            const unlockedBackgrounds = backgroundUnlocks.unlockedBackgrounds || [];
            if (unlockedBackgrounds.length > 0) {
                const popup = document.getElementById('background-unlock-popup');
                const listContainer = document.getElementById('background-unlock-list');
                listContainer.innerHTML = '';
                unlockedBackgrounds.forEach(bg => {
                    const item = document.createElement('div');
                    item.className = 'background-unlock-item';
                    item.innerHTML = `<i class="fa-solid fa-unlock-keyhole"></i><strong>${bg.name}</strong> (Lv.${bg.requiredLevel}„ÅßËß£Êîæ)`;
                    listContainer.appendChild(item);
                });
                popup.style.display = 'flex';
            }
        }
        
        const notification = document.getElementById('mission-notification');
        if (notification) {
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode) notification.parentNode.removeChild(notification);
                }, 500); 
            }, 4000); 
        }
        
        const aiMessageEl = document.getElementById('ai-home-message');
        if (aiMessageEl) {
            fetch('/api/ai-coach/home-advice')
                .then(res => res.text())
                .then(text => {
                    aiMessageEl.innerHTML = '';
                    let i = 0;
                    const speed = 40; 
                    function typeWriter() {
                        if (i < text.length) { aiMessageEl.textContent += text.charAt(i); i++; setTimeout(typeWriter, speed); }
                    }
                    typeWriter();
                })
                .catch(err => { console.error("AI Advice Error:", err); aiMessageEl.textContent = "‰ªäÊó•„ÇÇ‰∏ÄÁ∑í„Å´È†ëÂºµ„Çã„É†„Ç≠ÔºÅ"; });
        }

        function updateRealTimeClock() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const days = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            const dayOfWeek = days[now.getDay()];
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeString = `${year}/${month}/${day}(${dayOfWeek}) ${hours}:${minutes}`;
            const clockEl = document.getElementById('real-time-clock');
            if (clockEl) { clockEl.textContent = timeString; }
        }
        
        setInterval(updateRealTimeClock, 1000);
        updateRealTimeClock();
    });

    function closeBackgroundUnlockPopup() {
        document.getElementById('background-unlock-popup').style.display = 'none';
    }
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeBackgroundUnlockPopup(); });
    /*]]>*/

    function toggleRecordMenu() {
        const options = document.getElementById('record-options');
        options.classList.toggle('open');
    }
    function openRecordMenu() {
        const options = document.getElementById('record-options');
        if (!options.classList.contains('open')) options.classList.add('open');
    }
    function closeRecordMenu() {
        const options = document.getElementById('record-options');
        if (options.classList.contains('open')) options.classList.remove('open');
    }

    function toggleHelpMenu() {
        const menu = document.getElementById('help-menu');
        menu.classList.toggle('active');
    }

    document.addEventListener('click', function(event) {
        const menu = document.getElementById('help-menu');
        const btn = document.getElementById('help-btn');
        if (!menu.contains(event.target) && !btn.contains(event.target) && menu.classList.contains('active')) {
            menu.classList.remove('active');
        }
    });

    const scenarios = {
        'all': [
            { text: "FitWorks„Å∏„Çà„ÅÜ„Åì„Åù!\n„Åì„ÅÆ„ÉÅ„É•„Éº„Éà„É™„Ç¢„É´„Åß„ÅØ„ÄÅ„Ç¢„Éó„É™„ÅÆÂÖ®Ê©üËÉΩ„Çí„ÅîÁ¥π‰ªã„Åó„Åæ„Åô!" },
            { targetId: 'help-btn', text: "„Åæ„Åö„ÅØÁîªÈù¢Â∑¶‰∏ä„ÄÇ„Äå„Éò„É´„Éó„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅ\nÂêÑÊ©üËÉΩ„ÅÆË©≥„Åó„ÅÑ‰Ωø„ÅÑÊñπ„ÇÑ„ÄÅ„Çµ„Éó„É™„É°„É≥„Éà„ÅÆÁü•Ë≠ò„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ" },
            { targetId: 'tutorial-xp-area', text: "ÁîªÈù¢‰∏äÈÉ®„Å´„ÅØ„ÅÇ„Å™„Åü„ÅÆ„Äå„É¨„Éô„É´„Äç„Å®„ÄåXP(ÁµåÈ®ìÂÄ§)„Äç„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ\n„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíË®òÈå≤„Åó„Å¶„É¨„Éô„É´„Çí‰∏ä„Åí„Åæ„Åó„Çá„ÅÜ!" },
            { targetId: 'tutorial-mission-btn', text: "„Äå„Éü„ÉÉ„Ç∑„Éß„É≥„Äç„Éú„Çø„É≥„ÅØ„Åì„Åì„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü„ÄÇ\nÊØéÊó•Êõ¥Êñ∞„Åï„Çå„Çã„Éü„ÉÉ„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢„Åó„Å¶„ÄÅÂ†±ÈÖ¨„Çí„Ç≤„ÉÉ„Éà„Åó„Åæ„Åó„Çá„ÅÜ!" },
            { targetId: 'tutorial-title-display', text: "„Åì„Åì„Å´„ÅØÁèæÂú®Ë£ÖÂÇô„Åó„Å¶„ÅÑ„Çã„ÄåÁß∞Âè∑„Äç„ÅåËºù„Åç„Åæ„Åô„ÄÇ\n„É¨„Ç¢„Å™Áß∞Âè∑„ÇíÊâã„Å´ÂÖ•„Çå„Å¶„ÄÅÂº∑„Åï„Çí„Ç¢„Éî„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ!" },
            { targetId: 'tutorial-char-display', text: "„ÅÇ„Å™„Åü„ÅÆ„Éë„Éº„Éà„Éä„Éº„Ç≠„É£„É©„ÇØ„Çø„Éº„Åß„Åô„ÄÇ\n„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Å®ÂÖ±„Å´ÈÄ≤Âåñ„Åó„Å¶„ÅÑ„ÅèÂßø„ÇíË¶ãÂÆà„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ" },
            { targetId: 'tutorial-training-btn', text: "„É°„Ç§„É≥Ê©üËÉΩ„ÅØ„Åì„Çå!„Äå„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÈñãÂßã„Äç„Éú„Çø„É≥„ÄÇ\n„Åì„Åì„Åã„ÇâÊó•„ÄÖ„ÅÆÈÅãÂãï„É°„Éã„É•„Éº„Çí‰ΩúÊàê„ÉªË®òÈå≤„Åó„Åæ„Åô„ÄÇ" },
            { targetId: 'tutorial-record-btn', text: "„ÄåË®òÈå≤„Çí„Å§„Åë„Çã„Äç„É°„Éã„É•„Éº„Åã„Çâ„ÅØ„ÄÅ\nÈÅéÂéª„ÅÆÂ±•Ê≠¥Á¢∫Ë™ç„ÇÑ„ÄÅÈ£ü‰∫ã„Éª‰ΩìÈáç„ÅÆË®òÈå≤„ÅåÂÄãÂà•„Å´„Åß„Åç„Åæ„Åô„ÄÇ" },
            { targetId: 'tutorial-care-btn', text: "Áñ≤„Çå„ÅüÊôÇ„ÅØ„ÄåAI„É™„Éï„É¨„ÉÉ„Ç∑„É•&„Ç±„Ç¢„Äç„ÄÇ\n‰ΩìË™ø„Å´Âêà„Çè„Åõ„Åü„Çπ„Éà„É¨„ÉÉ„ÉÅ„ÇÑ‰ºëÊÅØÊ≥ï„ÇíAI„ÅåÊèêÊ°à„Åó„Åæ„Åô„ÄÇ" },
            { targetId: 'nav-gacha', text: "„Åì„Åì„Åã„Çâ„ÅØ‰∏ã„ÅÆ„É°„Éã„É•„Éº„Åß„Åô„ÄÇ\n„Äå„Ç¨„ÉÅ„É£„Äç„Åß„ÅØ„ÄÅÁùÄ„ÅõÊõø„Åà„Ç¢„Ç§„ÉÜ„É†„Å™„Å©„ÅÆÂ†±ÈÖ¨„ÅåÊâã„Å´ÂÖ•„Çä„Åæ„Åô„ÄÇ" },
            { targetId: 'tutorial-friends-btn', text: "„Äå„Éï„É¨„É≥„Éâ„ÄçÊ©üËÉΩ„Åß‰ª≤Èñì„Å®„Å§„Å™„Åå„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ\n„Åä‰∫í„ÅÑ„Å´Âä±„Åæ„ÅóÂêà„Å£„Åü„Çä„ÄÅ„É©„É≥„Ç≠„É≥„Ç∞„ÅßÁ´∂„Åà„Åæ„Åô„ÄÇ" },
            { targetId: 'nav-community', text: "„ÄåÊé≤Á§∫Êùø„Äç„ÅØ„É¶„Éº„Ç∂„ÉºÂêåÂ£´„ÅÆ‰∫§ÊµÅ„Çπ„Éö„Éº„Çπ„ÄÇ\nÁ≠ã„Éà„É¨ÊÉÖÂ†±„ÅÆ‰∫§Êèõ„ÇÑ„ÄÅÈõëË´á„ÅßÁõõ„Çä‰∏ä„Åå„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ" },
            { targetId: null, text: "Ê©üËÉΩË™¨Êòé„ÅØ‰ª•‰∏ä„Åß„Åô„ÄÇ\nÊ∞ó„Å´„Å™„ÇãÊ©üËÉΩ„ÅÆË©≥Á¥∞„ÅØ„ÄÅ„Éò„É´„Éó„É°„Éã„É•„Éº„ÅÆÂÄãÂà•„Ç¨„Ç§„Éâ„ÇÇË¶ã„Å¶„Å≠ÔºÅ" }
        ],
        'training': [
            { text: "„Éà„É¨„Éº„Éã„É≥„Ç∞„ÅÆÂßã„ÇÅÊñπ„Å´„Å§„ÅÑ„Å¶Ëß£Ë™¨„Åô„Çã„ÇàÔºÅ\nÊ∫ñÂÇô„ÅØ„ÅÑ„ÅÑ„Åã„Å™Ôºü" },
            { targetId: 'tutorial-training-btn', text: "„Åæ„Åö„ÅØ„Åì„ÅÆ„Äå„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÈñãÂßã„Äç„Éú„Çø„É≥„Çí„Çø„ÉÉ„ÉóÔºÅ\n„Åì„Åì„Åã„Çâ„Åù„ÅÆÊó•„ÅÆ„É°„Éã„É•„Éº„Çí‰Ωú„Çã„Åì„Å®„Åå„Åß„Åç„Çã„Çà„ÄÇ" },
            { targetId: 'tutorial-training-btn', text: "‰∏≠„Å´ÂÖ•„Çã„Å®„Äå„É°„Éã„É•„Éº‰ΩúÊàê„ÄçÁîªÈù¢„Å´„Å™„Çã„Çà„ÄÇ\nÈÉ®‰Ωç„ÇíÈÅ∏„Çì„ÅßÁ®ÆÁõÆ„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åì„ÅÜÔºÅ" },
            { targetId: 'tutorial-record-log', preAction: openRecordMenu, text: "ÈÅéÂéª„Å´„ÇÑ„Å£„ÅüÁ≠ã„Éà„É¨„ÅÆÂ±•Ê≠¥„ÇíË¶ã„Åü„ÅÑÊôÇ„ÅØ„Åì„ÅìÔºÅ\n„ÄåÁ≠ã„Éà„É¨Â±•Ê≠¥„Äç„Åã„ÇâÂâçÂõûÈáçÈáè„Å™„Å©„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åß„Åç„Çã„Çà„ÄÇ" },
            { targetId: 'tutorial-map-btn', preAction: closeRecordMenu, text: "„Åæ„Å†„Ç∏„É†„ÅåÊ±∫„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑÊôÇ„ÅØ„Åì„ÅìÔºÅ\nËøë„Åè„ÅÆ„Ç∏„É†„ÇÑÂÖ¨Âúí„Çí„Éû„ÉÉ„Éó„ÅßÊé¢„Åõ„Çã‰æøÂà©Ê©üËÉΩ„Å†„Çà„ÄÇ" },
            { text: "„Éà„É¨„Éº„Éã„É≥„Ç∞„ÅØÁ∂ôÁ∂ö„ÅåÂ§ß‰∫ãÔºÅ\n„Åæ„Åö„ÅØËªΩ„ÅÑ„É°„Éã„É•„Éº„Åã„ÇâÂßã„ÇÅ„Å¶„Åø„Çà„ÅÜÔºÅ" }
        ],
        'record': [
            { text: "Ë®òÈå≤„Å®„Éú„Éá„Ç£„Ç±„Ç¢„Å´„Å§„ÅÑ„Å¶Ë™¨Êòé„Åô„Çã„ÇàÔºÅ" },
            { targetId: 'tutorial-record-btn', text: "Ë®òÈå≤„Çí„Å§„Åë„Çã„Å®„Åç„ÅØ„ÄÅ„Åì„ÅÆ„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó„Åó„Å¶„É°„Éã„É•„Éº„ÇíÈñã„Åì„ÅÜ„ÄÇ" },
            { targetId: 'tutorial-record-log', preAction: openRecordMenu, text: "„ÄêÁ≠ã„Éà„É¨Â±•Ê≠¥„Äë\nÊó•„ÄÖ„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞ÁµêÊûú„ÅØ„Åì„Åì„Å´Ëá™Âãï„Åß‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åè„Çà„ÄÇ" },
            { targetId: 'tutorial-record-meal', preAction: openRecordMenu, text: "„ÄêÈ£ü‰∫ãË®òÈå≤„Äë\nÈ£ü„Åπ„Åü„ÇÇ„ÅÆ„ÇíË®òÈå≤„Åó„Å¶„ÄÅPFC„Éê„É©„É≥„ÇπÔºà„Çø„É≥„Éë„ÇØË≥™„Å™„Å©Ôºâ„ÇíÁÆ°ÁêÜ„Åó„Çà„ÅÜÔºÅ" },
            { targetId: 'tutorial-record-weight', preAction: openRecordMenu, text: "„Äê‰ΩìÈáçË®òÈå≤„Äë\n‰ΩìÈáç„ÇÑ‰ΩìËÑÇËÇ™Áéá„ÅÆÂ§âÂåñ„Çí„Ç∞„É©„Éï„ÅßÁ¢∫Ë™ç„Åß„Åç„Çã„Çà„ÄÇ" },
            { targetId: 'tutorial-care-btn', preAction: closeRecordMenu, text: "„Éà„É¨„Éº„Éã„É≥„Ç∞„ÅÆÂæå„ÅØ„Ç±„Ç¢„ÇÇÂøò„Çå„Åö„Å´ÔºÅ\nAI„ÅåÁñ≤„ÇåÂÖ∑Âêà„Å´Âêà„Çè„Åõ„Å¶„ÄÅÊúÄÈÅ©„Å™„Çπ„Éà„É¨„ÉÉ„ÉÅ„ÇíÊïô„Åà„Å¶„Åè„Çå„Çã„Çà„ÄÇ" },
            { text: "„Åó„Å£„Åã„ÇäË®òÈå≤„Åó„Å¶„ÄÅËá™ÂàÜ„ÅÆÊàêÈï∑„ÇíÂèØË¶ñÂåñ„Åó„Çà„ÅÜÔºÅ" }
        ],
        'gacha': [
            { text: "„ÅäÊ•Ω„Åó„ÅøË¶ÅÁ¥†„ÄÅ„Ç¨„ÉÅ„É£„Å®„Ç≠„É£„É©„ÇØ„Çø„Éº„Å´„Å§„ÅÑ„Å¶Á¥π‰ªã„Åô„Çã„ÇàÔºÅ" },
            { targetId: 'nav-gacha', text: "„Åæ„Åö„ÅØ„Äå„Ç¨„ÉÅ„É£„ÄçÔºÅ\n„Éà„É¨„Éº„Éã„É≥„Ç∞„ÅßË≤Ø„ÇÅ„Åü„Ç≥„Ç§„É≥„ÇÑ„ÉÅ„Ç±„ÉÉ„Éà„Çí‰Ωø„Å£„Å¶„Ç¢„Ç§„ÉÜ„É†„Çí„Ç≤„ÉÉ„ÉàÔºÅ" },
            { targetId: 'tutorial-char-display', text: "„Ç≤„ÉÉ„Éà„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„Åß„ÄÅ„Ç≠„É£„É©„ÇíÁùÄ„ÅõÊõø„Åà„Åü„ÇäËÉåÊôØ„ÇíÂ§â„Åà„Åü„Çä„Åß„Åç„Çã„Çà„ÄÇ\n„É¨„Éô„É´„Åå‰∏ä„Åå„Çã„Å®„Ç≠„É£„É©„ÅåÈÄ≤Âåñ„Åô„Çã„Åì„Å®„ÇÇ‚Ä¶ÔºÅÔºü" },
            { targetId: 'tutorial-title-btn', text: "„ÄåÁß∞Âè∑„Äç„ÇÇÂ§ß‰∫ã„Å™„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Ë¶ÅÁ¥†„ÄÇ\nÊù°‰ª∂„ÇíÈÅîÊàê„Åó„Å¶„ÄÅ„É¨„Ç¢„Å™Áß∞Âè∑„Çí„Çª„ÉÉ„Éà„Åó„Çà„ÅÜÔºÅ" },
            { targetId: 'nav-char', text: "„Äå„Ç≠„É£„É©„Äç„É°„Éã„É•„Éº„Åß„ÅØ„ÄÅÂõ≥Èëë„ÇíË¶ã„Åü„Çä„ÄÅ\nÊâÄÊåÅ„Åó„Å¶„ÅÑ„Çã„Ç¢„Ç§„ÉÜ„É†„ÅÆÁ¢∫Ë™ç„Åå„Åß„Åç„Çã„Çà„ÄÇ" },
            { text: "Ëá™ÂàÜ„Å†„Åë„ÅÆÊúÄÂº∑„Åß„Ç´„ÉØ„Ç§„Ç§Áõ∏Ê£í„Å´ËÇ≤„Å¶‰∏ä„Åí„Çà„ÅÜÔºÅ" }
        ],
        'social': [
            { text: "‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„Å®„ÅÆ‰∫§ÊµÅ„ÇÑ„ÄÅAIÊ©üËÉΩ„Å´„Å§„ÅÑ„Å¶Ë™¨Êòé„Åô„Çã„ÇàÔºÅ" },
            { targetId: 'tutorial-friends-btn', text: "„Äå„Éï„É¨„É≥„Éâ„Äç„Åß„ÅØÂèãÈÅî„ÇíÊ§úÁ¥¢„Åó„Å¶„Éï„Ç©„É≠„Éº„Åß„Åç„Çã„Çà„ÄÇ\n„É©„É≥„Ç≠„É≥„Ç∞„ÅßÁ´∂„ÅÑÂêà„ÅÜ„Å®„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥UPÔºÅ" },
            { targetId: 'nav-community', text: "„ÄåÊé≤Á§∫Êùø„Äç„ÅØ„Åø„Çì„Å™„ÅÆÂ∫ÉÂ†¥„ÄÇ\nË≥™Âïè„Åó„Åü„Çä„ÄÅÊàêÊûú„ÇíÂ†±Âëä„ÅóÂêà„Å£„Åü„Çä„Åó„Å¶Ê•Ω„Åó„ÇÇ„ÅÜÔºÅ" },
            { targetId: 'tutorial-ai-btn', text: "ÊÇ©„Åø‰∫ã„Åå„ÅÇ„Çå„Å∞„ÄåAI„ÉÅ„É£„ÉÉ„Éà„Äç„Å∏„ÄÇ\n„Éà„É¨„Éº„Éã„É≥„Ç∞„É°„Éã„É•„Éº„ÅÆÁõ∏Ë´á„Åã„ÇâÈõëË´á„Åæ„Åß‰Ωï„Åß„ÇÇOKÔºÅ" },
            { targetId: 'tutorial-muscles-btn', text: "„ÄåÁ≠ãËÇâ„Äç„Çø„Éñ„Åß„ÅØ„Äå„Éû„ÉÉ„Çπ„É´„Éë„Éº„Éà„Éä„Éº„Äç„ÅåË¶ã„Çâ„Çå„Çã„Çà„ÄÇ\nÈçõ„Åà„ÅüÈÉ®‰Ωç„ÅåÂÖâ„Çã„Åã„Çâ„ÄÅÂÖ®Ë∫´„Ç≥„É≥„Éó„É™„Éº„Éà„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ" },
            { targetId: 'nav-settings', text: "ÈÄöÁü•Ë®≠ÂÆö„ÇÑ„Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜ„ÅØ„ÄåË®≠ÂÆö„Äç„Åã„Çâ„ÄÇ\nÊ©üÁ®ÆÂ§âÊõ¥ÊôÇ„ÅÆÂºï„ÅçÁ∂ô„ÅéË®≠ÂÆö„ÇÇÂøò„Çå„Åö„Å´„Å≠ÔºÅ" }
        ]
    };
    
    let currentRpgStep = 0;
    let typeWriterInterval;
    let updateLoopId; 
    let currentScenarioKey = 'all'; 
    const STORAGE_KEY_RPG = 'fitworks_rpg_tutorial_v16'; 

    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem(STORAGE_KEY_RPG)) { setTimeout(() => startRpgTutorial('all'), 800); }
        window.addEventListener('resize', updateSpotlightPosition);
        window.addEventListener('scroll', updateSpotlightPosition);
    });

    function startRpgTutorial(scenarioKey = 'all') {
        currentScenarioKey = scenarioKey;
        if (!scenarios[currentScenarioKey]) return;
        
        currentRpgStep = 0;
        document.getElementById('tutorial-spotlight').classList.add('active');
        document.getElementById('tutorial-rpg-box').classList.add('active');
        document.getElementById('tutorial-backdrop').classList.add('active');
        updateRpgView();
        startUpdateLoop();
    }

    function updateRpgView() {
        const step = scenarios[currentScenarioKey][currentRpgStep];
        
        if (step.preAction && typeof step.preAction === 'function') {
            step.preAction();
        }

        const textBox = document.getElementById('rpg-text');
        const charImg = document.getElementById('rpg-char-img');
        const nextBtn = document.getElementById('rpg-next-btn');
        textBox.innerHTML = '';
        if (typeWriterInterval) clearInterval(typeWriterInterval);
        charImg.classList.add('talking');
        let i = 0;
        const chars = [...step.text]; 
        typeWriterInterval = setInterval(() => {
            if (i < chars.length) { textBox.innerHTML += (chars[i] === '\n') ? '<br>' : chars[i]; i++; } 
            else { clearInterval(typeWriterInterval); charImg.classList.remove('talking'); }
        }, 40);
        
        nextBtn.innerHTML = (currentRpgStep === scenarios[currentScenarioKey].length - 1) ? 'ÂÆå‰∫Ü' : 'Ê¨°„Å∏';
        moveSpotlight(step.targetId);
    }

    function startUpdateLoop() {
        if (updateLoopId) cancelAnimationFrame(updateLoopId);
        const loop = () => { updateSpotlightPosition(); updateLoopId = requestAnimationFrame(loop); };
        loop();
    }
    function stopUpdateLoop() { if (updateLoopId) cancelAnimationFrame(updateLoopId); }

    function moveSpotlight(targetId) {
        const spotlight = document.getElementById('tutorial-spotlight');
        const pointer = document.getElementById('tutorial-pointer');
        let targetEl = null;
        if (targetId) {
            targetEl = document.getElementById(targetId);
        }
        if (!targetId || !targetEl) {
            pointer.style.display = 'none';
            spotlight.style.width = '0'; spotlight.style.height = '0';
            spotlight.style.top = (window.pageYOffset + window.innerHeight/2) + 'px';
            spotlight.style.left = (window.pageXOffset + window.innerWidth/2) + 'px';
            const msgBox = document.getElementById('tutorial-rpg-box');
            msgBox.style.top = (window.pageYOffset + window.innerHeight/2 - msgBox.offsetHeight/2) + 'px';
            msgBox.style.left = (window.pageXOffset + window.innerWidth/2) + 'px';
        } else {
            pointer.style.display = 'block';
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    function updateSpotlightPosition() {
        const step = scenarios[currentScenarioKey][currentRpgStep];
        const msgBox = document.getElementById('tutorial-rpg-box');
        if (!step || !step.targetId) {
             const scrollY = window.pageYOffset; 
             const scrollX = window.pageXOffset;
             msgBox.style.top = (scrollY + window.innerHeight/2 - msgBox.offsetHeight/2) + 'px';
             msgBox.style.left = (scrollX + window.innerWidth/2) + 'px';
             return;
        }
        const targetEl = document.getElementById(step.targetId);
        if(!targetEl) return;
        
        if (targetEl.offsetParent === null && !step.targetId.startsWith('nav-')) return;

        const rect = targetEl.getBoundingClientRect();
        const scrollY = window.pageYOffset; const scrollX = window.pageXOffset;
        const spotlight = document.getElementById('tutorial-spotlight');
        const pointer = document.getElementById('tutorial-pointer');
        spotlight.style.width = (rect.width + 20) + 'px';
        spotlight.style.height = (rect.height + 20) + 'px';
        spotlight.style.top = (rect.top + scrollY - 10) + 'px';
        spotlight.style.left = (rect.left + scrollX - 10) + 'px';
        pointer.style.top = (rect.bottom + scrollY + 10) + 'px';
        pointer.style.left = (rect.left + scrollX + rect.width/2 - 20) + 'px';
        
        let boxTop = rect.top + scrollY - msgBox.offsetHeight - 20;
        
        const forceBelowIds = ['help-btn', 'tutorial-xp-area', 'tutorial-mission-btn', 'tutorial-title-display', 'real-time-clock'];
        const isForceBelow = forceBelowIds.includes(step.targetId) || (rect.top < 120);

        if (isForceBelow) {
             boxTop = rect.bottom + scrollY + 30;
        }
        
        msgBox.style.top = boxTop + 'px';
        msgBox.style.left = (rect.left + scrollX + rect.width/2) + 'px';
    }

    function nextRpgStep() {
        if (currentRpgStep < scenarios[currentScenarioKey].length - 1) { 
            currentRpgStep++; 
            updateRpgView(); 
        } else { 
            endRpgTutorial(); 
        }
    }

    function endRpgTutorial() {
        closeRecordMenu();
        
        document.getElementById('tutorial-rpg-box').classList.remove('active');
        document.getElementById('tutorial-spotlight').classList.remove('active');
        document.getElementById('tutorial-backdrop').classList.remove('active');
        document.getElementById('tutorial-pointer').style.display = 'none';
        stopUpdateLoop();
        localStorage.setItem(STORAGE_KEY_RPG, 'true');
    }

    document.addEventListener('mousemove', (e) => {
        const x = e.clientX / window.innerWidth;
        const y = e.clientY / window.innerHeight;
        document.body.style.setProperty('--mouse-x', x);
        document.body.style.setProperty('--mouse-y', y);
    });
</script>
</body>
</html>