<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ›ãƒ¼ãƒ  | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&family=M+PLUS+Rounded+1c:wght@500;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link rel="stylesheet" th:href="@{/css/title.css}">
    
    <script th:src="@{/js/theme.js}"></script>
    <style>
        /* --- HTMLå†…ã‚¹ã‚¿ã‚¤ãƒ« (CSSãƒ•ã‚¡ã‚¤ãƒ«åŒ–ã—ã¦ã„ãªã„å‹•çš„éƒ¨åˆ†ã®ã¿) --- */
        .xp-bar { width: 100%; height: 25px; background: #e3f2fd; border-radius: 12px; overflow: hidden; margin-top: 8px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .xp-progress { height: 100%; background: linear-gradient(90deg, #42a5f5, #2196f3); color: #fff; font-size: 12px; font-weight: bold; text-align: center; line-height: 25px; border-radius: 12px; transition: width 1s ease-in-out; }
        
        .character-section { position: relative; display: flex; justify-content: center; margin-top: 0px; }
        
        .character-wrapper { position: relative; width: 400px; height: 400px; max-width: 100%; margin: 0 auto; overflow: visible; }

        .character-display { 
            display: flex; justify-content: center; align-items: flex-end; 
            width: 100%; height: 100%;  
            background-repeat: no-repeat; background-position: center; background-size: cover; 
            border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.25); /* å½±ã‚’èª¿æ•´ */
            text-decoration: none; padding-bottom: 10px; box-sizing: border-box; 
            border: 4px solid rgba(255,255,255,0.8); /* ç™½æ è¿½åŠ ã§ãƒãƒƒãƒ—ã« */
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-50px); } 100% { transform: translateY(0px); } }
        .character-display img { width: auto; height: 85%; max-width: 95%; object-fit: contain; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 20px 15px rgba(0,0,0,0.9)); }
        
        .character-side-buttons { position: absolute; display: flex; flex-direction: column; gap: 12px; z-index: 10; top: 40px; right: -125px; }
        @media (max-width: 650px) { .character-side-buttons { right: 10px; top: 50px; } }

        .side-action-btn { 
            color: white; padding: 10px 0; border-radius: 15px; text-decoration: none; 
            font-weight: bold; font-size: 0.85em; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center; 
            gap: 6px; width: 110px; backdrop-filter: blur(4px);
        }
        .side-action-btn:hover { transform: scale(1.05); }
        
        .title-button { background: linear-gradient(135deg, #9c27b0, #ba68c8); border: 2px solid rgba(255,255,255,0.3); }

        .help-menu-dropdown { display: none; position: absolute; top: 60px; right: 20px; left: auto; background: rgba(255, 255, 255, 0.95); border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 10px; z-index: 2000; width: 220px; flex-direction: column; gap: 10px; }
        .help-menu-dropdown.active { display: flex; }
        
        .help-menu-item { display: block; padding: 10px; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold; font-size: 0.9em; transition: transform 0.2s; border: none; width: 100%; cursor: pointer; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box; }
        .help-menu-item:hover { transform: scale(1.03); }

        .tutorial-pointer { position: absolute; z-index: 10000; font-size: 2.5rem; color: #f1c40f; display: none; animation: point-move 1s infinite alternate; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .tutorial-pointer::before { content: '\f0a6'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
        @keyframes point-move { from { transform: translateY(0); } to { transform: translateY(-10px); } }
        
        .home-greeting-container { text-align: center; margin-top: 30px; margin-bottom: 15px; }
        .home-greeting-text { font-family: 'Noto Sans JP', sans-serif; color: #555; font-size: 1.1rem; font-weight: 700; margin-top: 0; line-height: 1.6; }
        .home-username { color: #0288d1; font-size: 1.3rem; font-weight: 900; margin: 0 3px; text-decoration: underline wavy #4facfe; text-underline-offset: 4px; }

        /* èƒŒæ™¯è§£æ”¾ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— (CSSçœç•¥ãªã—) */
        .background-unlock-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .background-unlock-content { background: linear-gradient(180deg, #fffef7 0%, #faf8f0 100%); border: 6px solid #d4a373; border-radius: 30px; padding: 0; max-width: 520px; width: 90%; box-shadow: 0 0 0 3px #f5e6d3, 0 0 0 9px #d4a373, 0 15px 35px rgba(0, 0, 0, 0.3); animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); position: relative; overflow: hidden; }
        @keyframes popIn { 0% { transform: scale(0.5) rotate(-5deg); opacity: 0; } 60% { transform: scale(1.05) rotate(2deg); } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .leaf-decoration { position: absolute; font-size: 2rem; opacity: 0.15; pointer-events: none; animation: leafFloat 4s ease-in-out infinite; }
        .leaf-decoration::before { content: 'ğŸƒ'; }
        .leaf-decoration:nth-child(1) { top: 15px; left: 15px; animation-delay: 0s; }
        .leaf-decoration:nth-child(2) { top: 15px; right: 15px; animation-delay: 1s; }
        .leaf-decoration:nth-child(3) { bottom: 15px; left: 15px; animation-delay: 2s; }
        .leaf-decoration:nth-child(4) { bottom: 15px; right: 15px; animation-delay: 3s; }
        @keyframes leafFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(5deg); } }
        .ff-header { background: linear-gradient(180deg, #9bcc7a 0%, #7db85e 100%); border-bottom: 5px solid #6a9c4f; border-radius: 24px 24px 0 0; padding: 25px 20px; position: relative; box-shadow: inset 0 2px 0 rgba(255, 255, 255, 0.4), 0 3px 0 rgba(106, 156, 79, 0.3); }
        .ff-header::before { content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 60px; height: 4px; background: rgba(255, 255, 255, 0.5); border-radius: 2px; }
        .background-unlock-title { color: #ffffff; font-size: 1.35rem; font-weight: bold; margin: 0; text-align: center; letter-spacing: 0.5px; font-family: Arial, sans-serif; text-shadow: 2px 2px 0 rgba(106, 156, 79, 0.8), -1px -1px 0 rgba(106, 156, 79, 0.3); }
        .ff-content { padding: 30px 25px; position: relative; }
        .background-unlock-list { background: #ffffff; border: 4px solid #e8d5b7; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: inset 0 2px 0 rgba(0, 0, 0, 0.03), 0 3px 10px rgba(0, 0, 0, 0.1); position: relative; }
        .background-unlock-item { background: linear-gradient(135deg, #fff9f0 0%, #fef5e7 100%); border: 3px solid #f4d9a6; border-radius: 15px; color: #5a4a3a; font-size: 1.05rem; font-weight: bold; margin: 12px 0; padding: 14px 18px; position: relative; animation: itemBounce 0.5s ease-out forwards; opacity: 0; box-shadow: 0 4px 0 #e8c78e, 0 5px 10px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; }
        .background-unlock-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 7px 0 #e8c78e, 0 8px 15px rgba(0, 0, 0, 0.15); }
        @keyframes itemBounce { 0% { transform: scale(0.3) translateY(-20px); opacity: 0; } 50% { transform: scale(1.1) translateY(0); opacity: 1; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        .background-unlock-item:nth-child(1) { animation-delay: 0.1s; }
        .background-unlock-item:nth-child(2) { animation-delay: 0.2s; }
        .background-unlock-item:nth-child(3) { animation-delay: 0.3s; }
        .background-unlock-item:nth-child(4) { animation-delay: 0.4s; }
        .background-unlock-item::before { content: 'âœ¿'; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); color: #9bcc7a; font-size: 1.3rem; animation: flowerSpin 3s ease-in-out infinite; }
        @keyframes flowerSpin { 0%, 100% { transform: translateY(-50%) rotate(0deg); } 50% { transform: translateY(-50%) rotate(180deg); } }
        .background-unlock-item i { color: #f4a460; margin-right: 10px; font-size: 1.1rem; }
        .background-unlock-item strong { color: #6a5a4a; }
        .background-unlock-buttons { display: flex; gap: 12px; justify-content: center; padding: 0 25px 30px; position: relative; }
        .background-unlock-buttons button, .background-unlock-buttons a { padding: 14px 26px; border: 4px solid #d4a373; border-radius: 50px; font-weight: bold; font-size: 0.95rem; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; position: relative; transition: all 0.2s ease; font-family: Arial, sans-serif; box-shadow: 0 5px 0 #b8906a, 0 6px 12px rgba(0, 0, 0, 0.15); }
        .background-unlock-buttons button:active, .background-unlock-buttons a:active { transform: translateY(3px); box-shadow: 0 2px 0 #b8906a, 0 3px 6px rgba(0, 0, 0, 0.15); }
        .background-unlock-buttons button:hover, .background-unlock-buttons a:hover { transform: translateY(-2px); box-shadow: 0 7px 0 #b8906a, 0 8px 16px rgba(0, 0, 0, 0.2); }
        .btn-later { background: linear-gradient(180deg, #f4e4c1 0%, #e8d5b7 100%); color: #6a5a4a; border-color: #d4a373; }
        .btn-go-backgrounds { background: linear-gradient(180deg, #9bcc7a 0%, #7db85e 100%); color: #ffffff; border-color: #6a9c4f; box-shadow: 0 5px 0 #5a8c3f, 0 6px 12px rgba(0, 0, 0, 0.15); }
        .btn-go-backgrounds:active { box-shadow: 0 2px 0 #5a8c3f, 0 3px 6px rgba(0, 0, 0, 0.15); }
        .btn-go-backgrounds:hover { box-shadow: 0 7px 0 #5a8c3f, 0 8px 16px rgba(0, 0, 0, 0.2); }
        .btn-go-backgrounds i { color: #f4d9a6; }
        
        .tutorial-backdrop, .tutorial-spotlight, .tutorial-pointer, .tutorial-rpg-box { pointer-events: none; }
        .tutorial-backdrop.active, .tutorial-rpg-box.active { pointer-events: auto; }
        .interactive-bg, .mouse-follower-cloud, .bg-cloud { pointer-events: none !important; z-index: -1; }
        #tutorial-rpg-box { z-index: 10001; }
		/* â–¼â–¼â–¼ ãƒœã‚¿ãƒ³é–“ã®ä½™ç™½ã‚’çµ±ä¸€ã™ã‚‹ã‚¯ãƒ©ã‚¹ â–¼â–¼â–¼ */
	        .menu-item-spacing {
	            margin-top: 20px !important; /* å…¨ã¦ã®ãƒœã‚¿ãƒ³ã®é–“éš”ã‚’ã€Œ20pxã€ã«çµ±ä¸€ */
	            width: 100%;                 /* å¹…ã‚’æƒãˆã‚‹ */
	            box-sizing: border-box;
	            display: block;
	        }
	        /* ã‚±ã‚¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­å¤®æƒãˆç”¨ */
	        .care-section {
	            text-align: center; 
	        }
	/* â–¼â–¼â–¼ ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºï¼ˆå¹…600pxä»¥ä¸‹ï¼‰ã®æ™‚ã ã‘ä½™ç™½ã‚’å¤§ããã™ã‚‹ â–¼â–¼â–¼ */
	        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼ˆ601pxä»¥ä¸Šï¼‰ã‚„PCã¯ã€å…ƒã®è¨­å®šï¼ˆ20pxï¼‰ãŒé©ç”¨ã•ã‚Œã¾ã™ */
	        @media (max-width: 600px) {
	            #tutorial-ai-btn {
	                margin-bottom: 110px !important; 
	            }
	        }
			/* â–¼â–¼â–¼ PCãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè¡¨ç¤º (601pxä»¥ä¸Š) ç”¨ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Œå…¨ç‰ˆ â–¼â–¼â–¼ */
			        @media (min-width: 601px) {
						/* â˜…è¿½åŠ : ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ä¸‹ã«ä½™ç™½ã‚’ä½œã£ã¦ã€ãƒœã‚¿ãƒ³ãŒéš ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
						            .main-container {
						                padding-bottom: 150px !important; /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã®å¾Œã‚ã«éš ã‚Œãªã„ã‚ˆã†åº•ä¸Šã’ */
						            }
			            /* 1. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®ç®±ï¼ˆç™½ã„èƒŒæ™¯ï¼‰ */
			            .bottom-nav {
			                display: flex;
			                justify-content: space-evenly; /* ãƒœã‚¿ãƒ³åŒå£«ã®é–“éš”ã‚’å‡ç­‰ã« */
			                align-items: center;
			                
			                /* ç”»é¢ä¸‹éƒ¨ã«æµ®ã‹ã›ã¦è¡¨ç¤º */
			                position: fixed;
			                bottom: 20px;
			                left: 50%;
			                transform: translateX(-50%); /* ç”»é¢ä¸­å¤®ã«é…ç½® */
			                
			                width: 95%;            /* ç”»é¢å¹…ã®95%ã‚’ä½¿ã† */
			                max-width: 800px;      /* æ¨ªã«åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
			                
			                background: rgba(255, 255, 255, 0.95); /* ç™½èƒŒæ™¯ï¼ˆå°‘ã—é€éï¼‰ */
			                backdrop-filter: blur(10px);
			                border-radius: 50px;   /* è§’ã‚’ä¸¸ãã—ã¦ã‚«ãƒ—ã‚»ãƒ«å‹ã« */
			                box-shadow: 0 5px 20px rgba(0,0,0,0.15); /* å½±ã‚’ã¤ã‘ã¦æµ®ã‹ã›ã‚‹ */
			                
			                padding: 10px 15px;    /* å†…å´ã®ä½™ç™½ã‚’ç¢ºä¿ã—ã¦è¦‹åˆ‡ã‚Œã‚’é˜²ã */
			                box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã‚µã‚¤ã‚ºã«å«ã‚ã‚‹ */
			                z-index: 1000;
			            }
				            /* 2. å„ãƒœã‚¿ãƒ³ã®å…±é€šè¨­å®š */
			            .nav-item {
			                display: flex;
			                flex-direction: column; /* ã‚¢ã‚¤ã‚³ãƒ³ä¸Šã€æ–‡å­—ä¸‹ã®ç¸¦ä¸¦ã³ */
			                justify-content: center;
			                align-items: center;
			                
			                flex: 1;               /* å…¨ãƒœã‚¿ãƒ³ã‚’åŒã˜å¹…ã«å¼•ãä¼¸ã°ã™ */
			                max-width: 100px;      /* ãƒœã‚¿ãƒ³1ã¤ã®æœ€å¤§å¹… */
			                height: auto;          /* é«˜ã•ã¯ä¸­èº«ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´ */
			                min-height: 60px;      /* æœ€ä½é™ã®é«˜ã•ã‚’ç¢ºä¿ */
			                
			                text-decoration: none;
			                color: #555;
			                border-radius: 12px;
			                transition: transform 0.2s ease, background 0.2s;
			                padding: 5px 0;        /* ãƒœã‚¿ãƒ³å†…éƒ¨ã®ä¸Šä¸‹ä½™ç™½ */
			                margin: 0 5px;         /* ãƒœã‚¿ãƒ³åŒå£«ã®éš™é–“ */
			            }
				            /* 3. 1è¡Œç›®ï¼šã‚¢ã‚¤ã‚³ãƒ³ï¼ˆ<i>ã‚¿ã‚°ï¼‰ã®è¨­å®š */
			            .nav-item i {
			                display: block;        /* ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã¨ã—ã¦æ‰±ã† */
			                font-size: 22px;       /* è¦‹ã‚„ã™ã„ã‚µã‚¤ã‚º */
			                margin-bottom: 5px;    /* æ–‡å­—ã¨ã®é–“éš” */
			                line-height: 1;        /* è¡Œé–“ã‚’è©°ã‚ã¦è¦‹åˆ‡ã‚Œé˜²æ­¢ */
			                color: var(--primary-color, #ff69b4);
			            }
				            /* 4. 2è¡Œç›®ï¼šæ–‡å­—ï¼ˆ<span>ã‚¿ã‚°ï¼‰ã®è¨­å®š */
			            .nav-item span {
			                display: block;        /* ç¢ºå®Ÿã«2è¡Œç›®ã«ã™ã‚‹ */
			                font-size: 11px;       /* å…¨è§’æ–‡å­—ãŒåã¾ã‚‹ã‚µã‚¤ã‚º */
			                font-weight: bold;
			                white-space: nowrap;   /* æŠ˜ã‚Šè¿”ã—ç¦æ­¢ï¼ˆ1è¡Œã«åã‚ã‚‹ï¼‰ */
			                line-height: 1.2;
			                width: 100%;
			                text-align: center;
			            }
				            /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
			            .nav-item:hover {
			                background-color: #f0f8ff;
			                transform: translateY(-3px);
			            }
			        }
					/* â–¼â–¼â–¼ ãƒœã‚¿ãƒ³ã®æ ç·šï¼ˆãƒ•ãƒã®è‰²ï¼‰ã‚’ä¿®æ­£ â–¼â–¼â–¼ */
					        .btn-record, 
					        .btn-care,
					        .home-action-btn {
					            border: none !important;       /* æ ç·šã‚’å®Œå…¨ã«æ¶ˆã™ */
					            outline: none !important;      /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®é’ã„æ ç·šãªã©ã‚‚æ¶ˆã™ */
					        }
					/* ç§°å·ãƒœã‚¿ãƒ³ã®ãƒ•ãƒï¼ˆæ ç·šï¼‰ã‚’æ¶ˆã™ */
							.side-action-btn, .title-button {
							    border: none !important;
							    outline: none !important;
							}
		
   </style>
</head>
<body class="home-page">

<div class="interactive-bg">
    <div class="mouse-follower-cloud"></div>
    <div class="bg-cloud cloud-1"></div>
    <div class="bg-cloud cloud-2"></div>
    <div class="bg-cloud cloud-3"></div>
    <div class="bg-cloud cloud-4"></div>
</div>

<div class="main-container" style="position: relative;"> 
    <div id="real-time-clock" class="real-time-clock">00:00:00</div>

    <button id="help-btn" class="help-label-btn" onclick="toggleHelpMenu()">
        <span style="font-size: 1.2em;">ğŸ“°</span>ãƒ˜ãƒ«ãƒ—
    </button>
    
    <div id="help-menu" class="help-menu-dropdown">
        <button class="help-menu-item tutorial-opt" onclick="startRpgTutorial(true); toggleHelpMenu();">
            <i class="fa-solid fa-play"></i> ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
        </button>
        <a th:href="@{/supplement-guide}" class="help-menu-item supple-opt">
            <i class="fa-solid fa-book-medical"></i> ã‚µãƒ—ãƒªã®é£²ã¿æ–¹
        </a>
        
        <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed rgba(0,0,0,0.1);">
            <p style="margin: 0 0 5px 0; font-size: 0.85rem; font-weight: 800; color: #06c755; text-shadow: 0 1px 1px rgba(255,255,255,0.8);">
                <i class="fa-brands fa-line"></i> å…¬å¼LINEã¯ã“ã¡ã‚‰
            </p>
            <a href="https://lin.ee/nUEWQkq">
                <img src="https://scdn.line-apps.com/n/line_add_friends/btn/ja.png" alt="å‹ã ã¡è¿½åŠ " height="36" border="0">
            </a>
        </div>
    </div>

    <div class="app-logo-display">
        <img th:src="@{/img/applogo-new.png}" alt="App Logo" />
        <div id="tutorial-xp-area">
            <div class="xp-daily-header"></div>
            <div class="xp-bar-container">
                <span th:text="'ãƒ¬ãƒ™ãƒ« ' + ${level} + ' (XP: ' + ${experiencePoints} + '/' + ${requiredXp} + ')'"></span>
                <div class="xp-bar">
                    <div class="xp-progress" th:style="'width:' + ${progressPercent} + '%;'" th:text="${progressPercent} + '%'"></div>
                </div>
            </div>
        </div>
    </div>
    
    <a id="tutorial-mission-btn" th:href="@{/daily-mission}" class="home-action-btn btn-mission">
       <i class="fa-solid fa-list-check"></i> ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³
    </a>
    
    <div id="tutorial-title-display" style="text-align: center; margin-top: 5px; min-height: 30px;">
        <th:block th:if="${userTitle != null and userTitle != 'ãªã—'}">
            <th:block th:each="enumT : ${T(com.example.demo.entity.AppTitle).values()}" 
                      th:if="${enumT.displayName == userTitle}">
                <div class="title-badge" th:classappend="${enumT.rarity}">
                    <i class="fa-solid fa-crown"></i> <span th:text="${userTitle}"></span>
                </div>
            </th:block>
        </th:block>
    </div>
    
    <div class="character-section">
        <div class="character-wrapper">
			<div id="tutorial-char-display" class="character-display"
							th:style="'background-image: url(/img/background/' + ${selectedBackground} + '.png);'">
			                <img th:src="@{'/img/character/' + ${(level / 10) * 10} + '.png'}" alt="Character" />
			            </div>
            
            <div class="character-side-buttons">
                <a id="tutorial-title-btn" th:href="@{/titles}" class="side-action-btn title-button">
                    <i class="fa-solid fa-crown"></i> ç§°å·
                </a>
            </div>
        </div>
    </div>
    
    <div class="home-greeting-container">
        <p class="home-greeting-text">
            ã“ã‚“ã«ã¡ã¯ã€<span class="home-username" th:text="${username}"></span>ã•ã‚“!
        </p>
    </div>
    
    <div class="ai-home-advice-container">
        <div class="ai-avatar-small">
            <img th:src="@{/img/AIcoach.png}" alt="AI">
        </div>
        <div class="ai-bubble-content">
             <p id="ai-home-message">ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³è¨ºæ–­ä¸­<span class="loading-dots">...</span></p>
        </div>
    </div>
    
	<a id="tutorial-training-btn" th:href="@{/training}" class="home-action-btn btn-training menu-item-spacing">
	       <i class="fa-solid fa-dumbbell"></i> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ 
	    </a>

	    <div id="tutorial-record-btn" class="record-container menu-item-spacing">
	        <button onclick="toggleRecordMenu()" class="home-action-btn btn-record" style="width: 100%;">
	           <i class="fa-solid fa-pen-to-square"></i> è¨˜éŒ²ã‚’ã¤ã‘ã‚‹
	        </button>
	        
	        <div id="record-options" class="record-options">
	            <a th:href="@{/training-log}" class="record-option-item training-log-opt">
	                <i class="fa-solid fa-calendar-days"></i><br>ç­‹ãƒˆãƒ¬å±¥æ­´
	            </a>
	            <a th:href="@{/log/meal}" class="record-option-item meal-opt">
	                <i class="fa-solid fa-utensils"></i><br>é£Ÿäº‹è¨˜éŒ²
	            </a>
	            <a th:href="@{/training-log/form/body-weight}" class="record-option-item weight-opt">
	                <i class="fa-solid fa-weight-scale"></i><br>ä½“é‡è¨˜éŒ²
	            </a>
	        </div>
	    </div>
	    
	    <div class="care-section menu-item-spacing">
	        <a id="tutorial-care-btn" th:href="@{/training/care}" class="home-action-btn btn-care">
	            <i class="fa-solid fa-mug-hot"></i> AIãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥&ã‚±ã‚¢
	        </a>
	    </div>

	    <a id="tutorial-map-btn" th:href="@{/training/map}" class="home-action-btn btn-map menu-item-spacing">
	       <i class="fa-solid fa-map-location-dot"></i> è¿‘ãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ 
	    </a>
	    
	    <a id="tutorial-ai-btn" th:href="@{/ai-coach}" class="home-action-btn btn-ai menu-item-spacing">
		   <i class="fa-solid fa-robot"></i> AIãƒãƒ£ãƒƒãƒˆ 
		</a>

    <nav id="tutorial-menu-nav" class="bottom-nav">
        <a id="nav-gacha" th:href="@{/gacha}" class="nav-item"><i class="fa-solid fa-gift"></i><span>ã‚¬ãƒãƒ£ã€€</span></a>
        <a id="tutorial-friends-btn" th:href="@{/friends}" class="nav-item"><i class="fa-solid fa-user-group"></i><span>ãƒ•ãƒ¬ãƒ³ãƒ‰</span></a>
        <a id="nav-community" th:href="@{/community}" class="nav-item"><i class="fa-solid fa-comments"></i><span>æ²ç¤ºæ¿ã€€</span></a>
        <a id="nav-char" th:href="@{/characters/menu/CharactersMenu}" class="nav-item"><i class="fa-solid fa-user-astronaut"></i><span>ã‚­ãƒ£ãƒ©ã€€</span></a>    
        <a id="tutorial-muscles-btn" th:href="@{/muscles}" class="nav-item"><i class="fa-solid fa-child-reaching"></i><span>ç­‹è‚‰ã€€</span></a>
        <a id="nav-settings" th:href="@{/settings}" class="nav-item"><i class="fa-solid fa-gear"></i><span>è¨­å®š</span></a>
    </nav>
</div>

<div id="tutorial-spotlight" class="tutorial-spotlight"></div>
<div id="tutorial-pointer" class="tutorial-pointer"></div>
<div id="tutorial-rpg-box" class="tutorial-rpg-box">
    <div class="rpg-char-area"><img id="rpg-char-img" th:src="@{/img/AIcoach.png}" alt="AI Coach"></div>
    <div class="rpg-content">
        <div class="rpg-name-tag">AIã‚³ãƒ¼ãƒ</div>
        <div class="rpg-text-area" id="rpg-text"></div>
        <div class="rpg-controls">
            <button class="rpg-btn rpg-btn-skip" onclick="endRpgTutorial()">ã‚¹ã‚­ãƒƒãƒ—</button>
            <button class="rpg-btn rpg-btn-next" id="rpg-next-btn" onclick="nextRpgStep()">æ¬¡ã¸</button>
        </div>
    </div>
</div>

<div id="background-unlock-popup" class="background-unlock-overlay" style="display: none;">
    <div class="background-unlock-content">
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>
        <div class="leaf-decoration"></div>

        <div class="ff-header">
            <h2 class="background-unlock-title">ã‚ãŸã‚‰ã—ã„èƒŒæ™¯ãŒæ‰‹ã«å…¥ã£ãŸã‚ˆ!</h2>
        </div>

        <div class="ff-content">
            <div id="background-unlock-list" class="background-unlock-list">
                </div>
        </div>

        <div class="background-unlock-buttons">
            <button onclick="closeBackgroundUnlockPopup()" class="btn-later">
                <i class="fa-solid fa-clock"></i>
                ã‚ã¨ã§è¦‹ã‚‹
            </button>
            <a href="/characters/menu/Backgrounds" class="btn-go-backgrounds">
                <i class="fa-solid fa-image"></i>
                èƒŒæ™¯ä¸€è¦§ã¸
            </a>
        </div>
    </div>
</div>

<div id="tutorial-backdrop" class="tutorial-backdrop"></div>

<script th:inline="javascript">
	/*<![CDATA[*/
	document.addEventListener('DOMContentLoaded', function() {
	    // èƒŒæ™¯è§£æ”¾ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
	    const backgroundUnlocks = /*[[${backgroundUnlocks}]]*/ null;
	    
	    console.log('========== èƒŒæ™¯è§£æ”¾ãƒã‚§ãƒƒã‚¯ ==========');
	    console.log('backgroundUnlocks:', backgroundUnlocks);
	    console.log('====================================');
	    
	    if (backgroundUnlocks && backgroundUnlocks.hasNewUnlocks) {
	        const unlockedBackgrounds = backgroundUnlocks.unlockedBackgrounds || [];
	        
	        if (unlockedBackgrounds.length > 0) {
	            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
	            const popup = document.getElementById('background-unlock-popup');
	            const listContainer = document.getElementById('background-unlock-list');
	            
	            // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
	            listContainer.innerHTML = '';
	            
	            // è§£æ”¾ã•ã‚ŒãŸèƒŒæ™¯ã‚’è¡¨ç¤º
	            unlockedBackgrounds.forEach(bg => {
	                const item = document.createElement('div');
	                item.className = 'background-unlock-item';
	                item.innerHTML = `
	                    <i class="fa-solid fa-unlock-keyhole"></i>
	                    <strong>${bg.name}</strong> (Lv.${bg.requiredLevel}ã§è§£æ”¾)
	                `;
	                listContainer.appendChild(item);
	            });
	            
	            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
	            popup.style.display = 'flex';
	            
	            console.log('èƒŒæ™¯è§£æ”¾ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º:', unlockedBackgrounds);
	        }
	    }
	    
	    // AIã‚¢ãƒ‰ãƒã‚¤ã‚¹å–å¾—
	    const aiMessageEl = document.getElementById('ai-home-message');
	    if (aiMessageEl) {
	        fetch('/api/ai-coach/home-advice')
	            .then(res => res.text())
	            .then(text => {
	                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¢¨ã«è¡¨ç¤º
	                aiMessageEl.innerHTML = '';
	                let i = 0;
	                const speed = 40; 
	                function typeWriter() {
	                    if (i < text.length) {
	                        aiMessageEl.textContent += text.charAt(i);
	                        i++;
	                        setTimeout(typeWriter, speed);
	                    }
	                }
	                typeWriter();
	            })
	            .catch(err => {
	                console.error("AI Advice Error:", err);
	                aiMessageEl.textContent = "ä»Šæ—¥ã‚‚ä¸€ç·’ã«é ‘å¼µã‚‹ãƒ ã‚­ï¼";
	            });
	    }

        // â˜…æ™‚è¨ˆæ›´æ–°å‡¦ç†: æ—¥ä»˜ãƒ»æ›œæ—¥ãƒ»æ™‚åˆ»ã‚’è¡¨ç¤º
        function updateRealTimeClock() {
            const now = new Date();
            
            // æ—¥ä»˜ã¨æ›œæ—¥ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ (ä¾‹: 2023/12/23(åœŸ))
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' };
            const dateString = now.toLocaleDateString('ja-JP', dateOptions);
            
            // æ™‚åˆ»ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ (ä¾‹: 10:00:00)
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const timeString = now.toLocaleTimeString('ja-JP', timeOptions);
            
            const clockEl = document.getElementById('real-time-clock');
            if (clockEl) {
                // æ—¥ä»˜ã¨æ™‚åˆ»ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã§ç¹‹ã„ã§è¡¨ç¤º
                clockEl.textContent = `${dateString} ${timeString}`;
            }
        }
        setInterval(updateRealTimeClock, 1000);
        updateRealTimeClock(); // åˆå›å®Ÿè¡Œ
	});

	function closeBackgroundUnlockPopup() {
	    const popup = document.getElementById('background-unlock-popup');
	    popup.style.display = 'none';
	}

	// Escapeã‚­ãƒ¼ã§ã‚‚é–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«
	document.addEventListener('keydown', (e) => {
	    if (e.key === 'Escape') {
	        closeBackgroundUnlockPopup();
	    }
	});
	/*]]>*/

    // è¨˜éŒ²ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒˆã‚°ãƒ«
    function toggleRecordMenu() {
        const options = document.getElementById('record-options');
        options.classList.toggle('open');
    }

    // ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒˆã‚°ãƒ«
    function toggleHelpMenu() {
        const menu = document.getElementById('help-menu');
        menu.classList.toggle('active');
    }

    // ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('help-menu');
        const btn = document.getElementById('help-btn');
        if (!menu.contains(event.target) && !btn.contains(event.target) && menu.classList.contains('active')) {
            menu.classList.remove('active');
        }
    });

    // RPGãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©
    const rpgSteps = [
        { targetId: null, text: "FitWorksã¸ã‚ˆã†ã“ã!\nã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€ã‚¢ãƒ—ãƒªã®å…¨æ©Ÿèƒ½ã‚’ã”ç´¹ä»‹ã—ã¾ã™!" },
        { targetId: 'help-btn', text: "ã¾ãšã¯ç”»é¢å·¦ä¸Šã€‚ã€Œãƒ˜ãƒ«ãƒ—ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€\nã“ã®ã‚¬ã‚¤ãƒ‰ã®å†ç”Ÿã‚„ã€ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆã®çŸ¥è­˜ã‚’ç¢ºèªã§ãã¾ã™ã€‚" },
        { targetId: 'tutorial-xp-area', text: "ç”»é¢ä¸Šéƒ¨ã«ã¯ã‚ãªãŸã®ã€Œãƒ¬ãƒ™ãƒ«ã€ã¨ã€ŒXP(çµŒé¨“å€¤)ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚\nãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¨˜éŒ²ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã¾ã—ã‚‡ã†!" },
        { targetId: 'tutorial-mission-btn', text: "ã€Œãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€ã¯æ¯æ—¥æ›´æ–°ã•ã‚Œã¾ã™ã€‚\nã‚¯ãƒªã‚¢ã—ã¦å ±é…¬ã‚„XPã‚’åŠ¹ç‡ã‚ˆãã‚²ãƒƒãƒˆã—ã¾ã—ã‚‡ã†!" },
        { targetId: 'tutorial-title-display', text: "ã“ã“ã«ã¯ç¾åœ¨è£…å‚™ã—ã¦ã„ã‚‹ã€Œç§°å·ã€ãŒè¼ãã¾ã™ã€‚\nãƒ¬ã‚¢ãªç§°å·ã‚’æ‰‹ã«å…¥ã‚Œã¦ã€å¼·ã•ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ã¦ãã ã•ã„!" },
        { targetId: 'tutorial-char-display', text: "ã‚ãªãŸã®ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚\nãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã¨å…±ã«é€²åŒ–ã—ã¦ã„ãå§¿ã‚’è¦‹å®ˆã‚Šã¾ã—ã‚‡ã†ã€‚" },
        { targetId: 'tutorial-title-btn', text: "ã€Œç§°å·ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç”»é¢ã¸ã€‚\nç²å¾—ã—ãŸç§°å·ã‚’ä»˜ã‘æ›¿ãˆã¦ã€å€‹æ€§ã‚’å‡ºã›ã¾ã™ã€‚" },
        { targetId: 'tutorial-customize-btn', text: "ã€Œç€ã›æ›¿ãˆã€ãƒœã‚¿ãƒ³ã§ã¯ã€ã‚¬ãƒãƒ£ã§å…¥æ‰‹ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’\nã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«è£…å‚™ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚" },
        { targetId: 'tutorial-training-btn', text: "ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã¯ã“ã‚Œ!ã€Œãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã€‚\nã“ã“ã‹ã‚‰æ—¥ã€…ã®é‹å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆãƒ»è¨˜éŒ²ã—ã¾ã™ã€‚" },
        { targetId: 'tutorial-record-btn', text: "ã€Œè¨˜éŒ²ã‚’ã¤ã‘ã‚‹ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¨ã€\néå»ã®å±¥æ­´ç¢ºèªã‚„ã€é£Ÿäº‹ãƒ»ä½“é‡ã®è¨˜éŒ²ãŒå€‹åˆ¥ã«ã§ãã¾ã™ã€‚" },
        { targetId: 'tutorial-care-btn', text: "ç–²ã‚ŒãŸæ™‚ã¯ã€ŒAIãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥&ã‚±ã‚¢ã€ã€‚\nä½“èª¿ã«åˆã‚ã›ãŸã‚¹ãƒˆãƒ¬ãƒƒãƒã‚„ä¼‘æ¯æ³•ã‚’AIãŒææ¡ˆã—ã¾ã™ã€‚" },
        { targetId: 'tutorial-map-btn', text: "ã€Œãƒãƒƒãƒ—ã€æ©Ÿèƒ½ã‚’ä½¿ãˆã°ã€\nè¿‘ãã®ã‚¸ãƒ ã‚„å…¬åœ’ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ã‚’ã™ãã«æ¢ã›ã¾ã™ã€‚" },
        { targetId: 'tutorial-ai-btn', text: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„é£Ÿäº‹ã®æ‚©ã¿ã¯ã€ŒAIãƒãƒ£ãƒƒãƒˆã€ã¸ã€‚\nå°‚å±ã®AIã‚³ãƒ¼ãƒãŒ24æ™‚é–“ã„ã¤ã§ã‚‚ç›¸è«‡ã«ä¹—ã‚Šã¾ã™!" },
        { targetId: 'nav-gacha', text: "ã“ã“ã‹ã‚‰ã¯ä¸‹ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã™ã€‚\nã€Œã‚¬ãƒãƒ£ã€ã§ã¯ã€ç€ã›æ›¿ãˆã‚¢ã‚¤ãƒ†ãƒ ãªã©ã®å ±é…¬ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚" },
        { targetId: 'tutorial-friends-btn', text: "ã€Œãƒ•ãƒ¬ãƒ³ãƒ‰ã€æ©Ÿèƒ½ã§ä»²é–“ã¨ã¤ãªãŒã‚Šã¾ã—ã‚‡ã†ã€‚\nãŠäº’ã„ã«åŠ±ã¾ã—åˆã£ãŸã‚Šã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ç«¶ãˆã¾ã™ã€‚" },
        { targetId: 'nav-community', text: "ã€Œæ²ç¤ºæ¿ã€ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒå£«ã®äº¤æµã‚¹ãƒšãƒ¼ã‚¹ã€‚\nç­‹ãƒˆãƒ¬æƒ…å ±ã®äº¤æ›ã‚„ã€é›‘è«‡ã§ç››ã‚Šä¸ŠãŒã‚Šã¾ã—ã‚‡ã†ã€‚" },
        { targetId: 'nav-char', text: "ã€Œã‚­ãƒ£ãƒ©ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›³é‘‘ã‚’è¦‹ãŸã‚Šã€\nãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚" },
        { targetId: 'tutorial-muscles-btn', text: "ã€Œç­‹è‚‰ã€ã‚¿ãƒ–ã§ã¯ã€é›ãˆãŸéƒ¨ä½ãŒå…‰ã‚‹ã€Œãƒãƒƒã‚¹ãƒ«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€ã‚’è¡¨ç¤ºã€‚\nè‡ªåˆ†ã®æˆé•·ç®‡æ‰€ãŒä¸€ç›®ã§ã‚ã‹ã‚Šã¾ã™!" },
        { targetId: 'nav-settings', text: "æœ€å¾Œã«ã€Œè¨­å®šã€ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã®å¤‰æ›´ã‚„é€šçŸ¥è¨­å®šã€\nç”Ÿä½“èªè¨¼(FaceID/TouchID)ã®ç™»éŒ²ã‚‚ã“ã“ã‹ã‚‰è¡Œãˆã¾ã™ã€‚" },
        { targetId: null, text: "æ©Ÿèƒ½èª¬æ˜ã¯ä»¥ä¸Šã§ã™ã€‚\nã•ã‚ã€FitWorksã§æœ€é«˜ã®ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ãƒ©ã‚¤ãƒ•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†!" }
    ];
    
    let currentRpgStep = 0;
    let typeWriterInterval;
    let updateLoopId; 
    const STORAGE_KEY_RPG = 'fitworks_rpg_tutorial_v16'; 

    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem(STORAGE_KEY_RPG)) { setTimeout(() => startRpgTutorial(), 800); }
        window.addEventListener('resize', updateSpotlightPosition);
        window.addEventListener('scroll', updateSpotlightPosition);
    });

    function startRpgTutorial(isManual) {
        currentRpgStep = 0;
        document.getElementById('tutorial-spotlight').classList.add('active');
        document.getElementById('tutorial-rpg-box').classList.add('active');
        document.getElementById('tutorial-backdrop').classList.add('active');
        updateRpgView();
        startUpdateLoop();
    }

    function updateRpgView() {
        const step = rpgSteps[currentRpgStep];
        const textBox = document.getElementById('rpg-text');
        const charImg = document.getElementById('rpg-char-img');
        const nextBtn = document.getElementById('rpg-next-btn');
        textBox.innerHTML = '';
        if (typeWriterInterval) clearInterval(typeWriterInterval);
        charImg.classList.add('talking');
        let i = 0;
        const chars = [...step.text]; 
        typeWriterInterval = setInterval(() => {
            if (i < chars.length) { textBox.innerHTML += (chars[i] === '\n') ? '<br>' : chars[i]; i++; } 
            else { clearInterval(typeWriterInterval); charImg.classList.remove('talking'); }
        }, 40);
        nextBtn.innerHTML = (currentRpgStep === rpgSteps.length - 1) ? 'å®Œäº†' : 'æ¬¡ã¸';
        moveSpotlight(step.targetId);
    }

    function startUpdateLoop() {
        if (updateLoopId) cancelAnimationFrame(updateLoopId);
        const loop = () => { updateSpotlightPosition(); updateLoopId = requestAnimationFrame(loop); };
        loop();
    }
    function stopUpdateLoop() { if (updateLoopId) cancelAnimationFrame(updateLoopId); }

    function moveSpotlight(targetId) {
        const spotlight = document.getElementById('tutorial-spotlight');
        const pointer = document.getElementById('tutorial-pointer');
        let targetEl = null;
        if (targetId) {
            targetEl = document.getElementById(targetId);
        }
        if (!targetId || !targetEl) {
            pointer.style.display = 'none';
            spotlight.style.width = '0'; spotlight.style.height = '0';
            spotlight.style.top = (window.pageYOffset + window.innerHeight/2) + 'px';
            spotlight.style.left = (window.pageXOffset + window.innerWidth/2) + 'px';
            const msgBox = document.getElementById('tutorial-rpg-box');
            msgBox.style.top = (window.pageYOffset + window.innerHeight/2 + 50) + 'px';
            msgBox.style.left = (window.pageXOffset + window.innerWidth/2) + 'px';
        } else {
            pointer.style.display = 'block';
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    function updateSpotlightPosition() {
        const step = rpgSteps[currentRpgStep];
        const msgBox = document.getElementById('tutorial-rpg-box');
        if (!step || !step.targetId) {
             const scrollY = window.pageYOffset; 
             const scrollX = window.pageXOffset;
             msgBox.style.top = (scrollY + window.innerHeight/2 + 50) + 'px';
             msgBox.style.left = (scrollX + window.innerWidth/2) + 'px';
             return;
        }
        const targetEl = document.getElementById(step.targetId);
        if(!targetEl) return;
        const rect = targetEl.getBoundingClientRect();
        const scrollY = window.pageYOffset; const scrollX = window.pageXOffset;
        const spotlight = document.getElementById('tutorial-spotlight');
        const pointer = document.getElementById('tutorial-pointer');
        spotlight.style.width = (rect.width + 20) + 'px';
        spotlight.style.height = (rect.height + 20) + 'px';
        spotlight.style.top = (rect.top + scrollY - 10) + 'px';
        spotlight.style.left = (rect.left + scrollX - 10) + 'px';
        pointer.style.top = (rect.bottom + scrollY + 10) + 'px';
        pointer.style.left = (rect.left + scrollX + rect.width/2 - 20) + 'px';
        
        let boxTop = rect.top + scrollY - msgBox.offsetHeight - 20;
        if (boxTop < scrollY + 10 || (step.targetId.startsWith('nav-')) || step.targetId.startsWith('tutorial-friends') || step.targetId.startsWith('tutorial-muscles')) {
             boxTop = rect.bottom + scrollY + 30;
        }
        msgBox.style.top = boxTop + 'px';
        msgBox.style.left = (rect.left + scrollX + rect.width/2) + 'px';
    }

    function nextRpgStep() {
        if (currentRpgStep < rpgSteps.length - 1) { currentRpgStep++; updateRpgView(); }
        else { endRpgTutorial(); }
    }

    function endRpgTutorial() {
        document.getElementById('tutorial-rpg-box').classList.remove('active');
        document.getElementById('tutorial-spotlight').classList.remove('active');
        document.getElementById('tutorial-backdrop').classList.remove('active');
        document.getElementById('tutorial-pointer').style.display = 'none';
        stopUpdateLoop();
        localStorage.setItem(STORAGE_KEY_RPG, 'true');
    }

    // ãƒã‚¦ã‚¹è¿½å¾“ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    document.addEventListener('mousemove', (e) => {
        const x = e.clientX / window.innerWidth;
        const y = e.clientY / window.innerHeight;
        document.body.style.setProperty('--mouse-x', x);
        document.body.style.setProperty('--mouse-y', y);
    });
</script>
</body>
</html>