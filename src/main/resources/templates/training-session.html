<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${trainingTitle}"></title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght!important(400);700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <style>
        .session-page .main-container { max-width: 650px; padding: 30px; }
        .program-card {
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            background: #2a2a2a;
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
            text-align: center;
        }
        .program-card h2 { color: var(--primary-color); font-size: 28px; margin-top: 0; }
        .program-card p.exercise-type {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .program-list { list-style: none; padding: 0; text-align: left; }
        .program-list li { 
            padding: 10px 0; 
            border-bottom: 1px dashed #444; 
            color: #ddd; 
            font-weight: 500;
        }
        .control-buttons { margin-top: 40px; display: flex; flex-direction: column; gap: 15px; }
        .control-buttons a, .control-buttons button { flex-grow: 1; }
        
        .log-placeholder {
            background-color: #1e1e1e;
            border: 1px dashed #555;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            color: #888;
        }
        
        /* === NEW TIMER STYLES === */
        .timer-section {
            background-color: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid #333;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
        }
        .timer-display {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 3px;
            color: #fff;
            margin: 10px 0 20px;
            font-family: 'Poppins', monospace;
        }
        .timer-interval {
            color: var(--primary-color); /* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒãƒ¼ã¯ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼ã‚’ä½¿ç”¨ */
        }
        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .timer-controls button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            flex-grow: 1;
        }
        .timer-button-primary {
            background-color: var(--primary-color);
            color: #1a1a1a;
        }
        .timer-button-secondary {
            background-color: #444;
            color: #ddd;
        }
        .timer-button-tertiary {
            background-color: #555;
            color: #fff;
            font-size: 14px;
            padding: 8px 15px;
        }
        .timer-controls button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .timer-settings {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            color: #ddd;
        }
        .timer-settings input {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
            text-align: center;
            font-size: 16px;
        }
    </style>
</head>
<body class="session-page">
<div class="main-container">
    <h1 th:text="${trainingTitle}"><i class="fa-solid fa-bolt-lightning header-icon"></i>ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</h1>
    <p class="sub-heading">é¸æŠã—ãŸç¨®ç›®ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™ã€‚è¨˜éŒ²ã‚’å–ã‚Šå§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>

    <div class="program-card">
        <h2 th:text="${selectedExercise}">ç¨®ç›®å</h2>

        <p class="exercise-type" th:if="${trainingType == 'free-weight'}"><i class="fa-solid fa-weight-hanging"></i> ãƒ•ãƒªãƒ¼ã‚¦ã‚§ã‚¤ãƒˆ (é‡é‡ãƒ»å›æ•°è¨˜éŒ²)</p>
        <p class="exercise-type" th:if="${trainingType == 'cardio'}"><i class="fa-solid fa-running"></i> æœ‰é…¸ç´ é‹å‹• (æ™‚é–“ãƒ»è·é›¢è¨˜éŒ²)</p>
        <p class="exercise-type" th:if="${trainingType == 'ai-suggested'}"><i class="fa-solid fa-star"></i> AIãŠã™ã™ã‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ </p>
        
        <div class="timer-section">
            <div class="countdown-container">
                <h3 style="color: #ffcc00; margin-bottom: 5px;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒãƒ¼</h3>
                <div id="countdown-display" class="timer-display">05:00</div>
                 <div class="timer-settings">
                    <input type="number" id="countdown-minutes" value="5" min="0" max="99" style="width: 50px;"> åˆ†
                    <input type="number" id="countdown-seconds" value="0" min="0" max="59" style="width: 50px;"> ç§’
                    <button id="countdown-set" class="button timer-button-tertiary"><i class="fa-solid fa-clock"></i> è¨­å®š</button>
                </div>
                <div class="timer-controls">
                    <button id="countdown-start-pause" class="button timer-button-primary"><i class="fa-solid fa-play"></i> é–‹å§‹</button>
                    <button id="countdown-reset" class="button timer-button-secondary"><i class="fa-solid fa-rotate-left"></i> ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>

            <hr style="border-top: 1px solid #333; margin: 30px 0;">

            <div class="interval-container">
                <h3 style="color: var(--primary-color); margin-bottom: 5px; margin-top: 20px;">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒãƒ¼</h3>
                <div id="interval-display" class="timer-display timer-interval">01:00</div>
                <div class="timer-settings">
                    <input type="number" id="interval-minutes" value="1" min="0" max="59" style="width: 50px;"> åˆ†
                    <input type="number" id="interval-seconds" value="0" min="0" max="59" style="width: 50px;"> ç§’
                    <button id="interval-set" class="button timer-button-tertiary"><i class="fa-solid fa-clock"></i> è¨­å®š</button>
                </div>
                <div class="timer-controls">
                    <button id="interval-start-pause" class="button timer-button-primary"><i class="fa-solid fa-play"></i> é–‹å§‹</button>
                    <button id="interval-reset" class="button timer-button-secondary"><i class="fa-solid fa-rotate-left"></i> ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
        <div th:if="${trainingType == 'free-weight' or trainingType == 'cardio'}">
            <div class="log-placeholder">
                <p>âš ï¸ **ã“ã“ã«ã€é¸æŠã•ã‚ŒãŸç¨®ç›®ï¼ˆ<span th:text="${selectedExercise}"></span>ï¼‰ã®å®Ÿéš›ã®è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ãŒå…¥ã‚Šã¾ã™ã€‚**</p>
                <p th:if="${trainingType == 'free-weight'}">ä¾‹ï¼šã‚»ãƒƒãƒˆæ•°ã€é‡é‡ (kg)ã€å›æ•° (Reps) ã‚’å…¥åŠ›ã—ã¦è¿½åŠ </p>
                <p th:if="${trainingType == 'cardio'}">ä¾‹ï¼šæ™‚é–“ (åˆ†) ã¾ãŸã¯ è·é›¢ (km) ã‚’å…¥åŠ›ã—ã¦ç¢ºå®š</p>
                <i th:if="${trainingType == 'free-weight'}" class="fa-solid fa-cash-register" style="font-size: 30px; color: #00e676;"></i>
                <i th:if="${trainingType == 'cardio'}" class="fa-solid fa-stopwatch" style="font-size: 30px; color: #00e676;"></i>
            </div>
            
            <div class="control-buttons">
                <a th:href="@{/training-log}" class="button primary">ã“ã®è¨˜éŒ²ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†</a>
            </div>
        </div>

        <div th:if="${trainingType == 'ai-suggested'}">
             <div class="log-placeholder" style="border-color: var(--ai-accent-color); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);">
                <p style="color: var(--ai-accent-color); font-weight: 600;">FitBotã®ææ¡ˆå†…å®¹:</p>
                <ul class="program-list">
                    <li><i class="fa-solid fa-circle-right" style="color:#00c8c8;"></i> 1. ç¨®ç›®A: 4ã‚»ãƒƒãƒˆ x 10å› (70kg) (AIãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¾‹)</li>
                    <li><i class="fa-solid fa-circle-right" style="color:#00c8c8;"></i> 2. ç¨®ç›®B: 3ã‚»ãƒƒãƒˆ x 12å› (20kg)</li>
                    <li><i class="fa-solid fa-circle-right" style="color:#00c8c8;"></i> 3. ç¨®ç›®C: 3ã‚»ãƒƒãƒˆ x 15å›</li>
                </ul>
                <p style="margin-top: 20px; color: var(--primary-color);">ç›®æ¨™æ™‚é–“: 45åˆ† / ä¼‘æ†©æ™‚é–“: 60ç§’</p>
            </div>
            <div class="control-buttons">
                 <a th:href="@{/training-log}" class="button primary">ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† (AIãƒ—ãƒ­ã‚°ãƒ©ãƒ )</a>
            </div>
        </div>
    </div>

    <div class="control-buttons" style="margin-top: 40px;">
        <a th:href="@{/training}" class="button secondary">
            ä¸­æ–­ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã«æˆ»ã‚‹ <i class="fa-solid fa-arrow-rotate-left"></i>
        </a>
    </div>

    <div class="button-container" style="margin-top: 20px;">
        <a th:href="@{/ai-coach}" class="button ai-coach-button">
            ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å†…å®¹ã‚’AIã‚³ãƒ¼ãƒã«ç›¸è«‡ ğŸ¤–
        </a>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Utility function for formatting time (Minutes:Seconds) ---
        const formatTime = (ms) => {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(seconds)}`;
        };

        // =======================================================
        // 1. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ (Countdown Timer)
        // =======================================================
        const cdDisplay = document.getElementById('countdown-display');
        const cdMinInput = document.getElementById('countdown-minutes');
        const cdSecInput = document.getElementById('countdown-seconds');
        const cdSetBtn = document.getElementById('countdown-set');
        const cdStartPauseBtn = document.getElementById('countdown-start-pause');
        const cdResetBtn = document.getElementById('countdown-reset');

        let cdInitialTime = 300000; // åˆæœŸå€¤: 5åˆ† (5 * 60000ms)
        let cdRemainingTime = cdInitialTime;
        let cdTimer = null;
        let isCdRunning = false;
        
        const updateCdDisplay = () => {
            cdDisplay.textContent = formatTime(cdRemainingTime);

            // æ®‹ã‚Š10ç§’ä»¥ä¸‹ã§èµ¤ãã™ã‚‹
            if (cdRemainingTime <= 10000 && cdRemainingTime > 0) {
                 cdDisplay.style.color = '#ff0000'; 
            } else {
                 cdDisplay.style.color = '#ffcc00'; // é»„è‰²ã«æˆ»ã™
            }
        };

        const handleCdFinish = () => {
            clearInterval(cdTimer);
            isCdRunning = false;
            cdStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> é–‹å§‹';
            cdStartPauseBtn.classList.remove('timer-button-secondary');
            cdStartPauseBtn.classList.add('timer-button-primary');

            alert('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†ï¼');
        };

        const startCountdown = () => {
            if (cdRemainingTime <= 0) {
                // ã‚¿ã‚¤ãƒãƒ¼ãŒã‚¼ãƒ­ã®å ´åˆã¯ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é–‹å§‹
                resetCountdown();
                return;
            }
            
            if (!isCdRunning) {
                isCdRunning = true;
                cdStartPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> åœæ­¢';
                cdStartPauseBtn.classList.remove('timer-button-primary');
                cdStartPauseBtn.classList.add('timer-button-secondary');

                // çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã¦ã€å†é–‹æ™‚ã«æ­£ç¢ºãªæ™‚é–“ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                const startTime = Date.now() - (cdInitialTime - cdRemainingTime);
                
                cdTimer = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    cdRemainingTime = cdInitialTime - elapsedTime;
                    
                    if (cdRemainingTime <= 0) {
                        cdRemainingTime = 0;
                        updateCdDisplay();
                        handleCdFinish();
                        return;
                    }
                    updateCdDisplay();
                }, 100);
            } else {
                // ä¸€æ™‚åœæ­¢
                clearInterval(cdTimer);
                isCdRunning = false;
                
                // å†é–‹æ™‚ã«ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ç¾åœ¨ã®æ®‹ã‚Šæ™‚é–“ã‚’æ–°ã—ã„åˆæœŸæ™‚é–“ã¨ã—ã¦è¨­å®š
                cdInitialTime = cdRemainingTime; 

                cdStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> å†é–‹';
                cdStartPauseBtn.classList.remove('timer-button-secondary');
                cdStartPauseBtn.classList.add('timer-button-primary');
            }
        };

        const resetCountdown = () => {
            clearInterval(cdTimer);
            isCdRunning = false;
            
            const minutes = parseInt(cdMinInput.value) || 0;
            const seconds = parseInt(cdSecInput.value) || 0;
            
            const newInitialTime = (minutes * 60000) + (seconds * 1000);

            // 00:00 è¨­å®šã‚’é˜²ã (æœ€ä½1ç§’)
            if (newInitialTime < 1000) {
                cdInitialTime = 300000; // 5åˆ†ã«ãƒªã‚»ãƒƒãƒˆ
                cdMinInput.value = 5;
                cdSecInput.value = 0;
            } else {
                cdInitialTime = newInitialTime;
            }

            cdRemainingTime = cdInitialTime;
            
            updateCdDisplay();
            cdStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> é–‹å§‹';
            cdStartPauseBtn.classList.remove('timer-button-secondary');
            cdStartPauseBtn.classList.add('timer-button-primary');
        };
        
        cdSetBtn.addEventListener('click', resetCountdown); // è¨­å®šãƒœã‚¿ãƒ³ã¯ãƒªã‚»ãƒƒãƒˆã‚’å…¼ã­ã‚‹
        cdStartPauseBtn.addEventListener('click', startCountdown);
        cdResetBtn.addEventListener('click', resetCountdown);
        
        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        resetCountdown(); 


        // =======================================================
        // 2. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ (Interval Timer)
        // =======================================================
        // â€»ã“ã®æ©Ÿèƒ½ã¯ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã¨ã—ã¦å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¼•ãç¶™ãŒã‚Œã¦ã„ã¾ã™ã€‚

        const ivDisplay = document.getElementById('interval-display');
        const ivMinInput = document.getElementById('interval-minutes');
        const ivSecInput = document.getElementById('interval-seconds');
        const ivSetBtn = document.getElementById('interval-set');
        const ivStartPauseBtn = document.getElementById('interval-start-pause');
        const ivResetBtn = document.getElementById('interval-reset');

        let ivInitialTime = 60000; // åˆæœŸå€¤: 1åˆ† (1000ms * 60s)
        let ivRemainingTime = ivInitialTime;
        let ivTimer = null;
        let isIvRunning = false;

        const updateIvDisplay = () => {
            ivDisplay.textContent = formatTime(ivRemainingTime);

            if (ivRemainingTime <= 10000 && ivRemainingTime > 0) {
                 ivDisplay.style.color = '#ff0000'; // æ®‹ã‚Š10ç§’ã§èµ¤ãã™ã‚‹
            } else {
                 ivDisplay.style.color = 'var(--primary-color)';
            }
        };
        
        // åˆæœŸè¡¨ç¤ºã‚’æ›´æ–°
        updateIvDisplay();


        const handleIvFinish = () => {
            clearInterval(ivTimer);
            isIvRunning = false;
            ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> é–‹å§‹';
            ivStartPauseBtn.classList.remove('timer-button-secondary');
            ivStartPauseBtn.classList.add('timer-button-primary');

            alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«çµ‚äº†ï¼æ¬¡ã®ã‚»ãƒƒãƒˆã«ç§»ã‚Šã¾ã—ã‚‡ã†ï¼');
        };

        const startInterval = () => {
            if (ivRemainingTime <= 0) {
                // ã‚¿ã‚¤ãƒãƒ¼ãŒã‚¼ãƒ­ã®å ´åˆã¯ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é–‹å§‹
                resetInterval();
                return;
            }
            
            if (!isIvRunning) {
                isIvRunning = true;
                ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> åœæ­¢';
                ivStartPauseBtn.classList.remove('timer-button-primary');
                ivStartPauseBtn.classList.add('timer-button-secondary');

                // çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã¦ã€å†é–‹æ™‚ã«æ­£ç¢ºãªæ™‚é–“ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                const startTime = Date.now() - (ivInitialTime - ivRemainingTime);

                ivTimer = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    ivRemainingTime = ivInitialTime - elapsedTime;
                    
                    if (ivRemainingTime <= 0) {           
                        ivRemainingTime = 0;
                        updateIvDisplay();
                        handleIvFinish();
                        return;
                    }
                    updateIvDisplay();
                }, 100);
            } else {
                // ä¸€æ™‚åœæ­¢
                clearInterval(ivTimer);
                isIvRunning = false;

                // å†é–‹æ™‚ã«ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ç¾åœ¨ã®æ®‹ã‚Šæ™‚é–“ã‚’æ–°ã—ã„åˆæœŸæ™‚é–“ã¨ã—ã¦è¨­å®š     
                ivInitialTime = ivRemainingTime;
                
                ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> å†é–‹';
                ivStartPauseBtn.classList.remove('timer-button-secondary');
                ivStartPauseBtn.classList.add('timer-button-primary');
            }
        };

        // è¨­å®šãƒœã‚¿ãƒ³ã¨ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã§åŒã˜ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ
        const resetInterval = () => {
            clearInterval(ivTimer);
            isIvRunning = false;

            const minutes = parseInt(ivMinInput.value) || 0;
            const seconds = parseInt(ivSecInput.value) || 0;
            
            const newInitialTime = (minutes * 60000) + (seconds * 1000);
            
            // 00:00 è¨­å®šã‚’é˜²ã (æœ€ä½1ç§’)
            if (newInitialTime < 1000) {
                ivInitialTime = 60000; // 1åˆ†ã«ãƒªã‚»ãƒƒãƒˆ
                ivMinInput.value = 1;
                ivSecInput.value = 0;
            } else {
                ivInitialTime = newInitialTime;
            }

            ivRemainingTime = ivInitialTime;
            
            updateIvDisplay();
            ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> é–‹å§‹';
            ivStartPauseBtn.classList.remove('timer-button-secondary');
            ivStartPauseBtn.classList.add('timer-button-primary');
        };

        ivSetBtn.addEventListener('click', resetInterval);
        ivStartPauseBtn.addEventListener('click', startInterval);
        ivResetBtn.addEventListener('click', resetInterval);

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        resetInterval();
    });
</script>
</body>
</html>