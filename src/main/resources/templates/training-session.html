<div class="main-container">
    <h1>セッション開始</h1>

    <!-- トレーニング選択 -->
    <div>
        <select id="musclePartSelect">
            <option value="">部位選択</option>
            <option value="胸">胸</option>
            <option value="背中">背中</option>
            <option value="脚">脚</option>
        </select>

        <select id="exerciseSelect">
            <option value="">種目選択</option>
            <option value="ベンチプレス">ベンチプレス</option>
            <option value="スクワット">スクワット</option>
            <option value="デッドリフト">デッドリフト</option>
        </select>

        <input type="number" id="weightInput" placeholder="重量(kg)">
        <input type="number" id="repsInput" placeholder="回数">
        <input type="number" id="setsInput" placeholder="セット数" value="1">
        <button id="addBtn">追加</button>
    </div>

    <!-- 追加されたトレーニング一覧 -->
    <ul id="sessionList">
        <li id="emptyNotice">追加されたトレーニングはここに表示されます</li>
    </ul>

    <!-- タイマー機能はここに残す（省略可） -->

    <button id="finishBtn" class="btn-finish">セッション完了</button>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
const sessionExercises = [];

const musclePartSelect = document.getElementById('musclePartSelect');
const exerciseSelect = document.getElementById('exerciseSelect');
const addBtn = document.getElementById('addBtn');

function renderSessionList(){
    const list = document.getElementById('sessionList');
    list.innerHTML='';
    if(sessionExercises.length===0){
        list.innerHTML='<li id="emptyNotice">追加されたトレーニングはここに表示されます</li>';
        return;
    }

    sessionExercises.forEach((ex, idx)=>{
        const li = document.createElement('li');
        li.style.marginBottom='10px';

        const info = document.createElement('div');
        info.textContent = `${ex.musclePart} - ${ex.exerciseName}`;
        info.style.fontWeight='600';
        li.appendChild(info);

        ['weight','reps','sets'].forEach(key=>{
            const container = document.createElement('div');
            container.style.display='inline-flex';
            container.style.alignItems='center';
            container.style.marginRight='10px';

            const decBtn = document.createElement('button');
            decBtn.textContent='-';
            decBtn.addEventListener('click', ()=>{
                if(Number(sessionExercises[idx][key])>0){
                    sessionExercises[idx][key]--;
                    inp.value = sessionExercises[idx][key];
                }
            });

            const inp = document.createElement('input');
            inp.type='number';
            inp.value=ex[key];
            inp.style.width='50px';
            inp.style.textAlign='center';
            inp.addEventListener('change', e=>{
                sessionExercises[idx][key] = e.target.value;
            });

            const incBtn = document.createElement('button');
            incBtn.textContent='+';
            incBtn.addEventListener('click', ()=>{
                sessionExercises[idx][key]++;
                inp.value = sessionExercises[idx][key];
            });

            const span = document.createElement('span');
            span.textContent= key==='weight' ? 'kg ' : key==='reps' ? '回 ' : 'セット';
            span.style.marginLeft='3px';

            container.appendChild(decBtn);
            container.appendChild(inp);
            container.appendChild(incBtn);
            container.appendChild(span);

            li.appendChild(container);
        });

        const delBtn = document.createElement('button');
        delBtn.textContent='削除';
        delBtn.style.marginLeft='10px';
        delBtn.addEventListener('click', ()=>{
            sessionExercises.splice(idx,1);
            renderSessionList();
        });
        li.appendChild(delBtn);

        list.appendChild(li);
    });
}

addBtn.addEventListener('click', ()=>{
    const part = musclePartSelect.value;
    const ex = exerciseSelect.value;
    const weight = document.getElementById('weightInput').value;
    const reps = document.getElementById('repsInput').value;
    const sets = document.getElementById('setsInput').value;

    if(!part || !ex || !weight || !reps || !sets){
        alert('すべて入力してください'); return;
    }

    sessionExercises.push({ musclePart:part, exerciseName:ex, weight:Number(weight), reps:Number(reps), sets:Number(sets) });
    renderSessionList();

    exerciseSelect.value=''; document.getElementById('weightInput').value='';
    document.getElementById('repsInput').value=''; document.getElementById('setsInput').value=1;
});

// --- セッション完了ボタン ---
document.getElementById('finishBtn').addEventListener('click', ()=>{
    if(sessionExercises.length===0){
        alert('追加したトレーニングがありません');
        return;
    }

    // POST送信
    fetch('/training-log/saveSession', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(sessionExercises)
    }).then(res=>{
        if(res.ok){
            window.location.href='/training-log'; // カレンダー画面に遷移
        } else {
            alert('送信エラー');
        }
    }).catch(err=>{
        console.error(err);
        alert('通信エラー');
    });
});
/*]]>*/
</script>
