<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³ | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
    
    <script th:src="@{/js/theme.js}"></script>
    
    <style>
        /* =========================================================
           ğŸŒŒ SPLIT LAYOUT LOGIN SCREEN (æ¨ªé•·ãƒ¯ã‚¤ãƒ‰ç‰ˆ)
           ========================================================= */
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f8ff;
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* -----------------------------------------------------------
           ğŸŒŒ BACKGROUND: AURORA
           ----------------------------------------------------------- */
        .interactive-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1);
            background-size: 400% 400%;
            animation: auroraFlow 20s ease infinite;
        }

        @keyframes auroraFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ã‚ªãƒ¼ãƒ– & ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é–¢é€£ã¯å…±é€š */
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; z-index: 0; }
        .orb-1 { width: 60vh; height: 60vh; background: #a18cd1; top: -10%; left: -10%; animation: floatOrb 30s infinite alternate; }
        .orb-2 { width: 50vh; height: 50vh; background: #00f2fe; bottom: -10%; right: -10%; animation: floatOrb 30s infinite alternate-reverse; }
        
        @keyframes floatOrb { to { transform: translate(50px, 30px); } }

        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; mix-blend-mode: screen; }
        .mouse-flare { position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(200,240,255,0.8) 30%, rgba(64,150,255,0) 70%); transform: translate(-50%, -50%); pointer-events: none; mix-blend-mode: screen; z-index: 20; filter: blur(15px); }
        .mega-sparkle { position: fixed; pointer-events: none; z-index: 99999; box-shadow: 0 0 8px rgba(255, 255, 255, 0.8); }

        /* -----------------------------------------------------------
           ğŸ“¦ MAIN CONTAINER (SPLIT LAYOUT)
           ----------------------------------------------------------- */
        .center-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px;
            box-sizing: border-box;
        }

        .main-container {
            /* å·¦å³åˆ†å‰²ç”¨ã«Flexboxã‚’ä½¿ç”¨ */
            display: flex;
            flex-direction: row;
            
            /* æ¨ªå¹…ã‚’ã‚¬ãƒ„ãƒ³ã¨åºƒã’ã‚‹ */
            width: 100%;
            max-width: 1100px; 
            min-height: 600px; /* ã‚ã‚‹ç¨‹åº¦ã®é«˜ã•ã‚’ç¢ºä¿ */

            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 30px 60px rgba(100, 149, 237, 0.2);
            
            overflow: hidden; /* è§’ä¸¸ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
            position: relative;
            z-index: 10;
        }

        /* --- å·¦å´ï¼šã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚¨ãƒªã‚¢ --- */
        .login-left {
            flex: 1; /* 1:1ã®æ¯”ç‡ã€ã¾ãŸã¯ width: 45% ç­‰ */
            width: 45%;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            border-right: 1px solid rgba(255, 255, 255, 0.5);
            color: #333;
            text-align: center;
        }

        .login-left h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8rem;
            font-weight: 900;
            margin: 0 0 10px 0;
            color: #333;
        }
        .login-left .welcome-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: rgb(0, 0, 0);
            margin-bottom: 30px;
        }
        .login-logo {
            width: 200px;
            height: 200px;
            object-fit: contain;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1));
            margin-bottom: 20px;
            animation: floatLogo 6s ease-in-out infinite;
        }
        @keyframes floatLogo {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* --- å³å´ï¼šãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ --- */
        .login-right {
            flex: 1.3; /* å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’å°‘ã—åºƒã */
            width: 55%;
            padding: 50px 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: rgba(255, 255, 255, 0.4);
        }

        .login-header { text-align: left; margin-bottom: 25px; }
        .login-header h2 { font-size: 1.8rem; margin: 0; color: #333; font-weight: 800; }
        .login-header p { margin: 5px 0 0; color: #666; font-size: 0.95rem; }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group { margin-bottom: 20px; }
        label { font-weight: 700; color: #555; font-size: 0.9rem; margin-bottom: 6px; display: block; }
        input[type="text"], input[type="password"], input[type="tel"] {
            width: 100%; padding: 15px 18px; border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.7);
            font-size: 1rem; transition: all 0.3s; box-sizing: border-box;
        }
        input:focus {
            border-color: #4facfe; background: #fff; outline: none;
            box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.2);
        }

        /* Remember Me & Forgot Password */
        .form-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; font-size: 0.9rem;
        }
        .remember-me {
            display: flex; align-items: center; gap: 8px; cursor: pointer; color: #555; font-weight: 600; margin: 0;
        }
        .remember-me input { width: 18px; height: 18px; accent-color: #4facfe; cursor: pointer; }
        .forgot-link { color: #4facfe; font-weight: 700; text-decoration: none; }
        .forgot-link:hover { text-decoration: underline; }

        /* ãƒœã‚¿ãƒ³ */
        .button {
            padding: 16px; font-size: 1.1rem; font-weight: 800; border-radius: 30px; width: 100%;
            display: block; text-align: center; border: none; cursor: pointer;
            position: relative; overflow: hidden; transition: transform 0.1s;
        }
        .button.primary {
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            color: white;
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }
        .button.primary:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(79, 172, 254, 0.6); }

        .separator-container { display: flex; align-items: center; margin: 25px 0; color: #888; font-size: 0.9rem; }
        .separator-container::before, .separator-container::after { content: ''; flex: 1; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .separator-container span { padding: 0 15px; }

        /* ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒœã‚¿ãƒ³ (ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«æ¨ªä¸¦ã³) */
        .social-login-group { display: flex; gap: 15px; }
        .social-btn {
            flex: 1; display: flex; align-items: center; justify-content: center; padding: 12px;
            border-radius: 15px; font-weight: 700; color: white; text-decoration: none;
            transition: transform 0.2s; border: none; cursor: pointer; font-size: 0.95rem;
        }
        .social-btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-line { background: #06C755; }
        .btn-apple { background: #000; }
        .btn-bio { background: #333; width: 100%; margin-bottom: 15px; }
        .social-btn i { margin-right: 8px; font-size: 1.1rem; }

        /* SMSã‚¨ãƒªã‚¢ */
        .sms-login-section { margin-top: 20px; padding-top: 20px; border-top: 1px dashed rgba(0,0,0,0.1); }
        .sms-input-group { display: flex; gap: 10px; margin-top: 10px; }
        .sms-action-btn { background: #4facfe; color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }

        .register-link { text-align: center; margin-top: 30px; font-size: 0.9rem; color: #666; }
        .register-link a { color: #4facfe; font-weight: 800; text-decoration: none; }
        
        .error-message { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; text-align: center; font-size: 0.9rem; }

        /* ğŸ“± ã‚¹ãƒãƒ›å¯¾å¿œ: ç¸¦ä¸¦ã³ã«æˆ»ã™ */
        @media (max-width: 900px) {
            .main-container { flex-direction: column; max-width: 500px; height: auto; }
            .login-left { width: 100%; padding: 30px 20px; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.5); }
            .login-right { width: 100%; padding: 40px 30px; }
            .login-logo { width: 80px; height: 80px; }
            .login-left h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

<div class="interactive-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <canvas id="bg-canvas"></canvas>
    <div id="mouse-flare" class="mouse-flare"></div>
</div>

<div class="center-wrapper">
    <div class="main-container">
        
        <div class="login-left">
            <img th:src="@{/img/icon.png}" alt="FitWorks Logo" class="login-logo" />
            <h1>FitWorks</h1>
            <p class="welcome-text">ãŠã‹ãˆã‚Šãªã•ã„ï¼<br>ä»Šæ—¥ã‚‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†!</p>
        </div>

        <div class="login-right">
            <div class="login-header">
                <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <p th:if="${param.error}" class="error-message">
                <i class="fa-solid fa-circle-exclamation"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™
            </p>

            <form th:action="@{/login}" method="post">
                <div class="form-group">
                    <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å / ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="text" id="username" name="username" required placeholder="example@fitworks.com" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <div style="position: relative;">
                        <input type="password" id="password" name="password" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="off">
                        <i class="fa-solid fa-eye toggle-password-icon" onclick="togglePasswordVisibility('password', this)" 
                           style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #aaa; cursor: pointer;"></i>
                    </div>
                </div>

                <div class="form-footer">
                    <label class="remember-me">
                        <input type="checkbox" name="remember-me"> 
                        ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿æŒ
                    </label>
                    <a th:href="@{/forgot-password}" class="forgot-link">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹</a>
                </div>

                <button type="submit" class="button primary">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </form>

            <div class="separator-container"><span>ã¾ãŸã¯</span></div>

            <button type="button" id="biometric-login-btn" class="social-btn btn-bio button">
                <i class="fa-solid fa-fingerprint"></i> ç”Ÿä½“èªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>

            <div class="social-login-group">
                <a th:href="@{/oauth2/authorization/line}" class="social-btn btn-line">
                    <i class="fa-brands fa-line"></i> LINE
                </a>
                <a th:href="@{/oauth2/authorization/apple}" class="social-btn btn-apple">
                    <i class="fa-brands fa-apple"></i> Apple
                </a>
            </div>

            <div class="sms-login-section">
                <span style="font-size: 0.85rem; font-weight:700; color:#666;">é›»è©±ç•ªå·èªè¨¼</span>
                <div id="sms-step-1">
                    <div class="sms-input-group">
                        <input type="tel" id="phone-number" placeholder="+8190...">
                        <button type="button" id="btn-send-otp" class="sms-action-btn">é€ä¿¡</button>
                    </div>
                </div>
                <div id="sms-step-2" style="display: none;">
                    <div class="sms-input-group">
                        <input type="text" id="otp-code" placeholder="ã‚³ãƒ¼ãƒ‰(6æ¡)">
                        <button type="button" id="btn-verify-otp" class="sms-action-btn">èªè¨¼</button>
                    </div>
                    <button type="button" onclick="resetSmsForm()" style="background:none; border:none; text-decoration:underline; font-size:0.8rem; color:#666; margin-top:5px; cursor:pointer;">æˆ»ã‚‹</button>
                </div>
                <div id="sms-message" style="font-size: 0.8rem; margin-top: 5px;"></div>
            </div>

            <p class="register-link">
                ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ <a th:href="@{/register}">æ–°è¦ç™»éŒ²</a>
            </p>
        </div>
    </div>
</div>

<input type="hidden" id="csrf-token-val" th:value="${_csrf.token}" />
<script th:src="@{/js/password.js}"></script>
<script>
    // === ğŸŒŸ CANVAS PARTICLE SYSTEM (è»½é‡åŒ–) ===
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    const flare = document.getElementById('mouse-flare');
    let particlesArray = [];
    
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    window.addEventListener('mousemove', (e) => {
        flare.style.transform = `translate(${e.clientX}px, ${e.clientY}px) translate(-50%, -50%)`;
    });
    
    // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    document.addEventListener('click', (e) => {
        const x = e.clientX, y = e.clientY;
        for(let i=0; i<8; i++) {
            const spark = document.createElement('div');
            spark.className = 'mega-sparkle';
            spark.style.left = x + 'px'; spark.style.top = y + 'px';
            spark.style.width = spark.style.height = (Math.random()*10+5)+'px';
            spark.style.background = '#00f2fe';
            document.body.appendChild(spark);
            spark.animate([{transform:'translate(-50%,-50%) scale(1)', opacity:1}, {transform:`translate(${Math.random()*200-100}px, ${Math.random()*200-100}px) scale(0)`, opacity:0}], {duration: 600, fill:'forwards'}).onfinish = () => spark.remove();
        }
    });

    // SMS & WebAuthn Logic
    function bufferToBase64url(b){ 
        const s = String.fromCharCode(...new Uint8Array(b)); 
        return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); 
    }
    
    // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°è£œå®Œä»˜ããƒ‡ã‚³ãƒ¼ãƒ‰
    function base64urlToBuffer(s){ 
        const b64 = s.replace(/-/g, '+').replace(/_/g, '/');
        const padding = b64.length % 4 === 0 ? '' : '='.repeat(4 - (b64.length % 4));
        return Uint8Array.from(atob(b64 + padding), c => c.charCodeAt(0)).buffer; 
    }

    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = document.getElementById('csrf-token-val').value;
        const btnSend = document.getElementById('btn-send-otp');
        const btnVerify = document.getElementById('btn-verify-otp');
        const inputPhone = document.getElementById('phone-number');
        const inputCode = document.getElementById('otp-code');
        const step1 = document.getElementById('sms-step-1');
        const step2 = document.getElementById('sms-step-2');
        const msgArea = document.getElementById('sms-message');
        const btnBio = document.getElementById('biometric-login-btn');

        function showMessage(msg, isError=false){ msgArea.textContent = msg; msgArea.style.color = isError?'#ff6b6b':'#4facfe'; }

        if(btnBio) {
            btnBio.addEventListener('click', async () => {
                if(!window.PublicKeyCredential){ alert('ç”Ÿä½“èªè¨¼æœªå¯¾å¿œ'); return; }
                try {
                    const opt = await (await fetch('/api/webauthn/login/options')).json();
                    // ä¿®æ­£: rpId ã‚’å‰Šé™¤ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•åˆ¤å®šã«ä»»ã›ã‚‹
                    const cred = await navigator.credentials.get({ 
                        publicKey: { 
                            challenge: base64urlToBuffer(opt.challenge), 
                            userVerification: 'preferred' 
                        } 
                    });
                    
                    const res = await fetch('/api/webauthn/login', { method:'POST', headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken}, body: JSON.stringify({
                        credentialId: bufferToBase64url(cred.rawId),
                        clientDataJSON: bufferToBase64url(cred.response.clientDataJSON),
                        authenticatorData: bufferToBase64url(cred.response.authenticatorData),
                        signature: bufferToBase64url(cred.response.signature),
                        userHandle: cred.response.userHandle ? bufferToBase64url(cred.response.userHandle) : null
                    })});
                    if(res.ok) window.location.href='/home'; else alert('èªè¨¼å¤±æ•—');
                } catch(e){ console.error(e); alert('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ'); }
            });
        }

        if(btnSend) {
            btnSend.addEventListener('click', () => {
                const ph = inputPhone.value.trim();
                if(!/^[+\d]{8,15}$/.test(ph)){ showMessage("é›»è©±ç•ªå·ã‚’ç¢ºèªã—ã¦ãã ã•ã„",true); return; }
                btnSend.disabled=true; btnSend.textContent="...";
                fetch('/api/auth/send-otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRF-TOKEN':csrfToken}, body:'phoneNumber='+encodeURIComponent(ph)})
                .then(r=>{ if(r.ok){ step1.style.display='none'; step2.style.display='block'; showMessage("ã‚³ãƒ¼ãƒ‰é€ä¿¡æ¸ˆ"); } else throw new Error(); })
                .catch(()=>{ showMessage("é€ä¿¡å¤±æ•—",true); btnSend.disabled=false; btnSend.textContent="é€ä¿¡"; });
            });
        }
        if(btnVerify) {
            btnVerify.addEventListener('click', () => {
                const ph=inputPhone.value.trim(), cd=inputCode.value.trim();
                btnVerify.disabled=true; btnVerify.textContent="...";
                fetch('/api/auth/verify-otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRF-TOKEN':csrfToken}, body:`phoneNumber=${encodeURIComponent(ph)}&code=${encodeURIComponent(cd)}`})
                .then(r=>{ if(r.ok) window.location.href='/home'; else throw new Error(); })
                .catch(()=>{ showMessage("èªè¨¼å¤±æ•—",true); btnVerify.disabled=false; btnVerify.textContent="èªè¨¼"; });
            });
        }
        window.resetSmsForm = () => { step1.style.display='block'; step2.style.display='none'; btnSend.disabled=false; btnSend.textContent="é€ä¿¡"; btnVerify.disabled=false; btnVerify.textContent="èªè¨¼"; showMessage(""); };
    });
</script>
</body>
</html>