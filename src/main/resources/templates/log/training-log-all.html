<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨è¨˜éŒ²ä¸€è¦§ | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/theme.js}"></script>
    
    <style>
        /* ==========================================================================
           1. å…±é€šè¨­å®š & èƒŒæ™¯
           ========================================================================== */
        body { margin: 0; padding: 0; background-color: #f0f8ff; min-height: 100vh; overflow-x: hidden; font-family: 'Noto Sans JP', sans-serif; color: #333; }
        .interactive-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1); background-size: 400% 400%; animation: auroraFlow 20s ease infinite; }
        @keyframes auroraFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatOrb 30s infinite alternate ease-in-out; z-index: 0; }
        .orb-1 { width: 60vh; height: 60vh; background: #a18cd1; top: -10%; left: -10%; }
        .orb-2 { width: 50vh; height: 50vh; background: #00f2fe; bottom: -10%; right: -10%; animation-delay: -5s; }
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; mix-blend-mode: screen; }

        /* ==========================================================================
           2. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ (ã‚µã‚¤ã‚ºèª¿æ•´ç‰ˆ)
           ========================================================================== */
        .main-container {
            max-width: 800px; /* â˜…ä¿®æ­£: 1000pxã‹ã‚‰800pxã«ç¸®å° */
            width: 92%; 
            margin: 40px auto; 
            padding: 30px; /* â˜…ä¿®æ­£: ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°‘ã—æ¸›ã‚‰ã—ã¦ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹ */
            
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 40px; /* è§’ä¸¸ã‚’å°‘ã—å°ã•ã */
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 30px 60px rgba(100, 149, 237, 0.2), 0 0 0 2px rgba(255, 255, 255, 0.6) inset;
            position: relative; z-index: 10;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .page-header-container { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 10px; gap: 15px; }
        .page-title { color: #343a40; font-size: 1.8rem; /* å°‘ã—å°ã•ã */ margin: 0; flex-grow: 1; text-align: left; font-weight: 700; }
        .home-link-icon {
            display: flex; align-items: center; justify-content: center;
            width: 45px; height: 45px; /* å°‘ã—å°ã•ã */
            background-color: white; color: #667eea;
            border: 2px solid #667eea; border-radius: 50%; text-decoration: none;
            transition: all 0.3s ease; font-size: 1.3rem; flex-shrink: 0;
        }
        .home-link-icon:hover { background-color: #667eea; color: white; transform: scale(1.1); }

        /* çµ±è¨ˆã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .stats-summary {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px; padding: 12px; text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5);
        }
        .stat-label { font-size: 0.8rem; color: #666; font-weight: bold; }
        .stat-value { font-size: 1.3rem; color: #333; font-weight: 800; margin: 4px 0; font-family: 'Poppins', sans-serif; }
        .stat-trend { font-size: 0.75rem; }
        .trend-up { color: #ff6b6b; }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px; padding: 20px; margin-bottom: 25px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5);
        }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .chart-title { font-size: 1rem; font-weight: bold; color: #444; }

        .chart-options .button { padding: 5px 14px; font-size: 0.85rem; border-radius: 15px; transition: all 0.3s; text-decoration: none; display: inline-block;}
        .button.secondary { background: #fff; color: #666; border: 1px solid #ddd; }
        .button.secondary:hover { background: #f0f0f0; }
        .button.primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3); }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ  */
        .filter-form {
            background: rgba(255,255,255,0.6); padding: 10px 15px; border-radius: 15px;
            margin-bottom: 20px; display: flex; justify-content: center;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .filter-select {
            width: 100%; max-width: 300px; border: none; background: transparent;
            font-size: 1rem; font-weight: bold; color: #555; outline: none; cursor: pointer; text-align: center;
        }

        /* ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .record-card {
            background: rgba(255,255,255,0.9);
            border-radius: 12px; padding: 12px 18px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.2s;
        }
        .record-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .record-card.type-weight { border-left-color: #667eea; }
        .record-card.type-cardio { border-left-color: #4facfe; }
        
        .badge-weight { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; }
        .badge-cardio { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; }

        @media (max-width: 600px) {
            .main-container { padding: 15px; padding-top: 25px; width: 95%; border-radius: 30px; }
            .home-link-icon { width: 40px; height: 40px; font-size: 1.2rem; }
            .page-title { font-size: 1.4rem; }
            .record-card { flex-direction: column; align-items: flex-start; gap: 5px; }
        }
    </style>
</head>
<body>

<div class="interactive-bg">
    <canvas id="bg-canvas"></canvas>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
</div>

<div class="main-container">
    
    <div class="page-header-container">
        <a th:href="@{/training-log}" class="home-link-icon" title="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h1 class="page-title"><i class="fa-solid fa-chart-line" style="color:#667eea; margin-right:10px;"></i>æˆé•·ã®è¨˜éŒ²</h1>
    </div>
    
    <div class="stats-summary">
        <div class="stat-card">
            <div class="stat-label">ç·ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“</div>
            <div class="stat-value" id="total-time">0<span style="font-size:0.5em">åˆ†</span></div>
            <div class="stat-trend trend-up"><i class="fa-solid fa-arrow-trend-up"></i> ç©ã¿ä¸Šã’</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ç¾åœ¨ã®ä½“é‡</div>
            <div class="stat-value" id="current-weight">--<span style="font-size:0.5em">kg</span></div>
            <div class="stat-trend" style="color:#888;">æœ€æ–°è¨˜éŒ²</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">è¨˜éŒ²æ—¥æ•°</div>
            <div class="stat-value" th:text="${records.size()}">0</div>
            <div class="stat-trend" style="color:#667eea;">Days</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <div class="chart-title">æ¨ç§»ã‚°ãƒ©ãƒ•</div>
            <div class="chart-options">
                <a th:href="@{/training-log/all(period='day', part=${selectedPart})}" 
                   class="button" th:classappend="${period == 'day' or period == null} ? 'primary' : 'secondary'">æ—¥æ¬¡</a>
                <a th:href="@{/training-log/all(period='week', part=${selectedPart})}" 
                   class="button" th:classappend="${period == 'week'} ? 'primary' : 'secondary'">é€±æ¬¡</a>
                <a th:href="@{/training-log/all(period='month', part=${selectedPart})}" 
                   class="button" th:classappend="${period == 'month'} ? 'primary' : 'secondary'">æœˆæ¬¡</a>
            </div>
        </div>
        
        <div class="filter-form">
            <form th:action="@{/training-log/all}" method="get" style="width: 100%;">
                <input type="hidden" name="period" th:value="${period}">
                <select name="part" class="filter-select" onchange="this.form.submit()">
                    <option value="">ğŸ“Š å…¨ç¨®ç›®ã‚’è¡¨ç¤º</option>
                    <option th:each="p : ${allParts}" 
                            th:value="${p}" 
                            th:text="${p}" 
                            th:selected="${selectedPart == p}">éƒ¨ä½å</option>
                    <option value="æœ‰é…¸ç´ " th:selected="${selectedPart == 'æœ‰é…¸ç´ '}">ğŸƒ æœ‰é…¸ç´ é‹å‹•</option>
                </select>
            </form>
        </div>

        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="trainingChart"></canvas>
        </div>
    </div>

    <div th:if="${records.empty}" class="no-records" style="text-align:center; padding:30px; background:rgba(255,255,255,0.6); border-radius:15px;">
        <i class="fa-solid fa-clipboard-list" style="font-size:3rem; color:#ccc; margin-bottom:10px;"></i>
        <p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã£ã¦ã‚°ãƒ©ãƒ•ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼</p>
        <a th:href="@{/training}" class="button primary" style="display:inline-block; margin-top:10px; padding:10px 20px; text-decoration:none; border-radius:20px;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å§‹ã‚ã‚‹</a>
    </div>

    <div th:each="record : ${records}">
        <div th:if="${record.type == 'WEIGHT'}" class="record-card type-weight">
            <div>
                <div class="record-date"><i class="fa-regular fa-clock"></i> <span th:text="${record.recordDate}"></span></div>
                <div class="record-title">
                    <span th:text="${record.exerciseName}"></span> <span class="badge-weight">ç­‹ãƒˆãƒ¬</span>
                </div>
                <div class="record-details">
                    <span th:text="${record.weight}"></span>kg Ã— <span th:text="${record.reps}"></span>å› Ã— <span th:text="${record.sets}"></span>ã‚»ãƒƒãƒˆ
                </div>
            </div>
        </div>
        <div th:if="${record.type == 'CARDIO'}" class="record-card type-cardio">
            <div>
                <div class="record-date"><i class="fa-regular fa-clock"></i> <span th:text="${record.recordDate}"></span></div>
                <div class="record-title">
                    <span th:text="${record.cardioType}"></span> <span class="badge-cardio">æœ‰é…¸ç´ </span>
                </div>
                <div class="record-details">
                    <span th:text="${record.durationMinutes}"></span>åˆ† 
                    <span th:if="${record.distanceKm != null}"> / <span th:text="${record.distanceKm}"></span>km</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const rawData = /*[[${chartDataJson}]]*/ '[]';
    let chartData = [];
    try { chartData = JSON.parse(rawData); } catch(e) { console.error(e); }

    if(chartData && chartData.length > 0) {
        let totalMins = 0;
        let latestWeight = "--";
        chartData.forEach(d => {
            totalMins += (d.cardioMinutes || 0) + (d.weightMinutes || 0);
            if(d.bodyWeight > 0) latestWeight = d.bodyWeight;
        });
        document.getElementById('total-time').innerHTML = totalMins + '<span style="font-size:0.5em">åˆ†</span>';
        document.getElementById('current-weight').innerHTML = latestWeight + '<span style="font-size:0.5em">kg</span>';

        const ctx = document.getElementById('trainingChart').getContext('2d');
        let gradientWeight = ctx.createLinearGradient(0, 0, 0, 400);
        gradientWeight.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
        gradientWeight.addColorStop(1, 'rgba(118, 75, 162, 0.1)');

        let gradientCardio = ctx.createLinearGradient(0, 0, 0, 400);
        gradientCardio.addColorStop(0, 'rgba(79, 172, 254, 0.8)');
        gradientCardio.addColorStop(1, 'rgba(0, 242, 254, 0.1)');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(d => d.date),
                datasets: [
                    {
                        label: 'ä½“é‡ (kg)',
                        data: chartData.map(d => d.bodyWeight),
                        type: 'line',
                        borderColor: '#ff9a9e',
                        backgroundColor: '#ff9a9e',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#ff9a9e',
                        pointRadius: 4,
                        yAxisID: 'y1',
                        tension: 0.3, order: 0
                    },
                    {
                        label: 'æœ‰é…¸ç´  (åˆ†)',
                        data: chartData.map(d => d.cardioMinutes),
                        backgroundColor: gradientCardio,
                        borderRadius: 4,
                        stack: 'Stack 0', yAxisID: 'y', order: 1
                    },
                    {
                        label: 'ç­‹ãƒˆãƒ¬ (åˆ†)',
                        data: chartData.map(d => d.weightMinutes),
                        backgroundColor: gradientWeight,
                        borderRadius: 4,
                        stack: 'Stack 0', yAxisID: 'y', order: 1
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    x: { grid: { display: false } },
                    y: { position: 'left', stacked: true, grid: { borderDash: [5, 5] } },
                    y1: { position: 'right', grid: { display: false } }
                }
            }
        });
    }

    const canvas = document.getElementById('bg-canvas');
    const ctxCanvas = canvas.getContext('2d');
    let width, height;
    function resizeCanvas() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
</script>
</body>
</html>