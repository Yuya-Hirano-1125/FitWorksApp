<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食事記録 | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/training-log.css}"> 
	
	<script th:src="@{/js/theme.js}"></script>
    <style>
        /* 食事画面特有のアイコン色調整 */
        .header-icon-meal {
            color: #4CAF50; /* 緑色 */
        }
        /* 記録済みマーカーの色変更 */
        .log-indicator-meal {
            color: #4CAF50 !important;
        }
    </style>
</head>
<body class="training-log-page"> <div class="main-container">
    
    <h1 style="margin-bottom: 5px;">
        <i class="header-icon header-icon-meal fa-solid fa-utensils"></i> 食事記録
    </h1>
    <p class="sub-heading" th:text="${username} + 'さんの食事を管理しましょう。'">
        食事記録カレンダー
    </p>

    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
    
    <div class="calendar-nav-container">
        <a th:href="@{/log/meal(year=${prevYear}, month=${prevMonth})}" class="nav-arrow">
            <i class="fa-solid fa-chevron-left"></i>
        </a>
        
        <h2 class="calendar-title" th:text="${currentYearMonth.year} + '年 ' + ${currentYearMonth.monthValue} + '月'"></h2>
        
        <a th:href="@{/log/meal(year=${nextYear}, month=${nextMonth})}" class="nav-arrow">
            <i class="fa-solid fa-chevron-right"></i>
        </a>
    </div>

    <div class="calendar-grid">
        <div class="calendar-day-header" th:each="dayLabel : ${dayLabels}" th:text="${dayLabel}" 
             th:classappend="${dayLabel == '土'} ? 'sat' : ((${dayLabel == '日'} ? 'sun' : ''))">
             曜日
        </div>
        
        <th:block th:each="date : ${calendarDays}">
            <div th:with="dateNumber=${date != null ? date.dayOfMonth : ''},
                          dayOfWeek=${date != null ? date.dayOfWeek.name() : ''},
                          isToday=${date != null and date.isEqual(currentDate)},
                          isLogged=${date != null and loggedDates.containsKey(date)}"
                 class="calendar-day-cell"
                 th:classappend="${date == null} ? 'empty-day' : ((${isToday} ? 'today' : '') + 
                                                                    ((${dayOfWeek == 'SATURDAY'} ? ' sat' : '') + 
                                                                     ((${dayOfWeek == 'SUNDAY'} ? ' sun' : ''))))"
                 th:attr="data-date=${date != null ? date.toString() : ''}"
                 th:onclick="${date != null} ? 'openLogModal(this.getAttribute(\'data-date\'), ' + ${isLogged} + ')' : ''">

                <span class="day-number" th:text="${dateNumber}">1</span>
                
                <span th:if="${isLogged}" class="log-indicator log-indicator-meal">
                    <i class="fa-solid fa-utensils"></i>
                </span>
            </div>
        </th:block>
    </div>

    <div style="text-align: center; margin: 20px 0;">
        <a th:href="@{/log/meal/all}" class="button" style="background-color: #555; color: white; width: 100%; display: block; text-align: center;">
            <i class="fa-solid fa-list"></i> 全記録をリストで見る
        </a>
    </div>

</div>

<div id="logModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLogModal()">&times;</span>
        <h2 id="modalDateTitle" class="modal-title"></h2>
        
        <div id="logViewArea">
             </div>

        <p class="modal-instruction">食事内容を記録：</p>
        
        <input type="hidden" id="selectedDateInput" name="date" value="">
        
        <div id="formContainer">
            <p>フォームを読み込んでいます...</p>
        </div>

        <a th:href="@{/log/meal/all}" class="button secondary view-all-button">
            全記録を見る
        </a>
    </div>
</div>

<div style="max-width: 450px; margin: 30px auto 70px auto; padding: 0 10px;">
    <a th:href="@{/home}" class="button secondary">
        <i class="fa-solid fa-house"></i>
        <span>ホームに戻る</span>
    </a>
</div>

<script th:inline="javascript">
    // ★変更点: 食事フォームを読み込む関数 (種類分岐なし)
    function loadMealForm(date) {
        let url = /*[[@{/log/meal/form}]]*/ '/log/meal/form';
        url += '?date=' + date;

        fetch(url)
            .then(response => response.text())
            .then(html => {
                document.getElementById('formContainer').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('formContainer').innerHTML = '<p class="error-message">フォームの読み込みに失敗しました。</p>';
                console.error('Form load error:', error);
            });
    }

    // 記録モーダルを開く関数
    function openLogModal(dateString, isLogged) {
        const [year, month, day] = dateString.split('-');
        const displayDate = `${year}年${month}月${day}日`;
        
        // 日付をセット
        document.getElementById('selectedDateInput').value = dateString;
        document.getElementById('modalDateTitle').innerText = displayDate;
        
        const modal = document.getElementById('logModal');
        const formContainer = document.getElementById('formContainer');

        // フォームのリセットと読み込み開始
        formContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fa-solid fa-spinner fa-spin"></i> 読み込み中...</div>';
        
        // ★変更点: 常に食事フォームをロード
        loadMealForm(dateString);

        // 記録済みメッセージの表示切り替え
        const logViewArea = document.getElementById('logViewArea');
        if (isLogged) {
            logViewArea.innerHTML = '<p style="font-weight: 700; color: #4CAF50; margin-bottom: 10px;">✅ この日は記録済みです。</p>';
        } else {
            logViewArea.innerHTML = '<p style="color: #999; margin-bottom: 10px;">この日はまだ記録がありません。</p>';
        }

        modal.classList.add('is-active');
    }

    // 記録モーダルを閉じる関数
    function closeLogModal() {
        const modal = document.getElementById('logModal');
        modal.classList.remove('is-active');
        
        // リセット
        document.getElementById('formContainer').innerHTML = '<p>フォームを読み込んでいます...</p>';
    }

    // モーダル外クリックで閉じる処理
    window.onclick = function(event) {
        const modal = document.getElementById('logModal');
        if (modal.classList.contains('is-active') && event.target === modal) {
            closeLogModal();
        }
    }
</script>

</body>
</html>






















