<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>体重記録カレンダー | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/training-log.css}">
    <script th:src="@{/js/theme.js}"></script>
    <style>
        /* 体重カレンダー独自の上書き */
        .header-icon-weight { color: #009688; }
        .calendar-day-cell.weight-logged {
            background-color: #e0f2f1; /* 薄いティール */
            border-color: #009688;
        }
        .weight-value-display {
            font-size: 0.85em;
            color: #00796b;
            font-weight: 800;
            display: block;
            margin-top: 2px;
        }
    </style>
</head>
<body class="training-log-page">

<div th:replace="fragments/header :: header"></div>

<div class="main-container">
    
    <h1 style="margin-bottom: 5px; text-align: center; color: #444;">
        <i class="header-icon-weight fa-solid fa-weight-scale"></i> 体重記録
    </h1>
    <p class="sub-heading" style="text-align: center;">日々の変化を記録しましょう</p>

    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>

    <div class="calendar-nav-container">
        <a th:href="@{/training-log/form/body-weight(year=${prevYear}, month=${prevMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-left"></i></a>
        <h2 class="calendar-title" th:text="${currentYearMonth.year} + '年 ' + ${currentYearMonth.monthValue} + '月'"></h2>
        <a th:href="@{/training-log/form/body-weight(year=${nextYear}, month=${nextMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-right"></i></a>
    </div>

    <div class="calendar-grid">
        <div class="calendar-day-header" 
             th:each="dayLabel : ${dayLabels}" 
             th:text="${dayLabel}" 
             th:classappend="${dayLabel == '土'} ? 'sat' : (${dayLabel == '日'} ? 'sun' : 'weekday')">
        </div>
        
        <th:block th:each="date : ${calendarDays}">
            <div th:with="dateNumber=${date != null ? date.dayOfMonth : ''},
                          dayOfWeek=${date != null ? date.dayOfWeek.name() : ''},
                          isToday=${date != null and date.isEqual(currentDate)},
                          record=${date != null ? weightMap.get(date) : null}"
                 class="calendar-day-cell"
                 th:classappend="${date == null} ? 'empty-day' : ((${isToday} ? 'today' : '') + 
                                                                    ((${dayOfWeek == 'SATURDAY'} ? ' sat' : '') + 
                                                                     ((${dayOfWeek == 'SUNDAY'} ? ' sun' : ''))) +
                                                                    (${record != null} ? ' weight-logged' : ''))"
                 th:attr="data-date=${date != null ? date.toString() : ''}, 
                          data-weight=${record != null ? record.weight : ''}"
                 onclick="openWeightModal(this)">

                <span class="day-number" th:text="${dateNumber}">1</span>
                
                <span th:if="${record != null}" class="weight-value-display">
                    <span th:text="${record.weight}"></span>kg
                </span>
                <span th:if="${record == null and isToday}" class="log-indicator" style="color:#ccc; font-size:0.8em;">
                    <i class="fa-solid fa-plus"></i>
                </span>
            </div>
        </th:block>
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
        <a th:href="@{/training-log/all(period='month')}" class="button secondary" style="border-radius: 50px;">
            <i class="fa-solid fa-chart-line"></i> グラフで推移を確認
        </a>
    </div>
</div>

<div style="max-width: 450px; margin: 30px auto 70px auto; padding: 0 10px;">
    <a th:href="@{/home}" class="button secondary">
        <i class="fa-solid fa-house"></i> <span>ホームに戻る</span>
    </a>
</div>

<div id="weightModal" class="modal">
    <div class="modal-content" style="max-width: 400px; padding: 25px;">
        <span class="close-button" onclick="closeWeightModal()">&times;</span>
        
        <h3 id="modalDateTitle" class="modal-title" style="color: #009688;">2025/12/15</h3>
        <p class="sub-heading" style="margin-bottom: 20px;">の体重を入力</p>

        <form th:action="@{/training-log/save}" method="post" class="weight-record-form" style="padding: 0;">
            <input type="hidden" id="recordDateInput" name="recordDate" />
            <input type="hidden" name="type" value="BODY_WEIGHT" />
            
            <div class="scale-display-area" style="margin-bottom: 20px;">
                <label for="weightInput" class="scale-label">CURRENT WEIGHT</label>
                <div class="scale-input-wrapper">
                    <input type="number" id="weightInput" name="weight" class="scale-input" 
                           step="0.1" min="10" max="300" placeholder="00.0" required 
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '');"/>
                    <span class="scale-unit">kg</span>
                </div>
            </div>
            
            <button type="submit" class="btn-submit-weight">
                <i class="fa-solid fa-check"></i> 保存する
            </button>
        </form>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">
    // モーダル操作
    function openWeightModal(element) {
        const dateStr = element.getAttribute('data-date');
        if (!dateStr) return; // 空白セル対策

        const currentWeight = element.getAttribute('data-weight');
        
        document.getElementById('recordDateInput').value = dateStr;
        document.getElementById('modalDateTitle').innerText = dateStr.replace(/-/g, '/');
        
        const weightInput = document.getElementById('weightInput');
        if (currentWeight) {
            weightInput.value = currentWeight;
        } else {
            weightInput.value = '';
        }

        document.getElementById('weightModal').classList.add('is-active');
        // 少し遅らせてフォーカス
        setTimeout(() => weightInput.focus(), 100);
    }

    function closeWeightModal() {
        document.getElementById('weightModal').classList.remove('is-active');
    }

    // 背景クリックで閉じる
    window.onclick = function(event) {
        const modal = document.getElementById('weightModal');
        if (event.target === modal) {
            closeWeightModal();
        }
    }

    // 初期ロード時に指定日付があればモーダルを開く
    document.addEventListener('DOMContentLoaded', function() {
        const selectedDate = /*[[${selectedDate}]]*/ null;
        if (selectedDate) {
            // データ属性を持つセルを探してクリックイベントを発火させる
            const targetCell = document.querySelector(`.calendar-day-cell[data-date='${selectedDate}']`);
            if (targetCell) {
                openWeightModal(targetCell);
            }
        }
    });
</script>

</body>
</html>