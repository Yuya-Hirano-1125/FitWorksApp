<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿäº‹è¨˜éŒ² | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/training-log.css}"> 
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script th:src="@{/js/theme.js}"></script>
    <style>
		.header-icon-meal { color: #4CAF50; }
		.log-indicator-meal { color: #4CAF50 !important; }
		.meal-form-container { text-align: left; padding: 0 5px; }
		.form-row { display: flex; gap: 15px; margin-bottom: 15px; }
		.form-group { margin-bottom: 15px; }
		.form-group label { display: block; margin-bottom: 6px; font-weight: 700; color: #555; font-size: 0.9em; }
		.form-group.half { flex: 1; }
		.form-control { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; background-color: #fff; }
		.form-control:focus { border-color: #4CAF50; outline: none; }
		.form-control[readonly] { background-color: #f3f3f3; color: #777; cursor: not-allowed; }
		.macro-section { background-color: #f9f9f9; border: 1px dashed #ccc; border-radius: 10px; padding: 15px; }
		.macro-row { display: flex; gap: 10px; justify-content: space-between; }
		.macro-item { flex: 1; text-align: center; }
		.macro-item label { font-size: 0.85em; color: #777; margin-bottom: 3px; }
		.macro-input { text-align: center; font-weight: bold; }
		.p-input:focus { border-color: #3498db !important; }
		.f-input:focus { border-color: #e74c3c !important; }
		.c-input:focus { border-color: #f1c40f !important; }
		.btn-submit { width: 100%; margin-top: 20px; padding: 12px; font-size: 1.1em; background-color: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
		.btn-submit:hover { background-color: #45a049; }
		.sns-buttons-container { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
		.btn-sns { color: #fff; padding: 10px 15px; border-radius: 20px; text-decoration: none; font-weight: bold; font-size: 0.85em; cursor: pointer; transition: opacity 0.2s, transform 0.1s; display: inline-flex; align-items: center; border: none; }
		.btn-sns:hover { opacity: 0.9; transform: translateY(-1px); color: white; }
		.btn-sns i { margin-right: 5px; font-size: 1.1em; }
		.btn-sns-x { background-color: #000; }
		.btn-sns-line { background-color: #06C755; }
		.btn-sns-insta { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }

		/* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */

		/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã«æ ç·šã‚’è¿½åŠ  */
		.calendar-day-header {
		    border: 1px solid #ccc;
		    padding: 5px;
		    text-align: center;
		    background-color: #f9f9f9;
		    font-weight: bold;
		}

		/* æ—¥ä»˜ã‚»ãƒ«ã«æ ç·šã‚’è¿½åŠ  */
		.calendar-day-cell {
		    border: 1px solid #ccc;
		    min-height: 60px;
		    text-align: center;
		    vertical-align: top;
		    background-color: #fff;
		}
		/* å¹³æ—¥ã¯é»’æ–‡å­— */
		.calendar-day-header.weekday,
		.calendar-day-cell.weekday .day-number {
		    color: #000;   /* é»’æ–‡å­— */
		    background-color: #fff; /* ç™½èƒŒæ™¯ï¼ˆå¿…è¦ãªã‚‰ï¼‰ */
		}

		/* æ—¥æ›œã¯èµ¤ */
		.calendar-day-header.sun,
		.calendar-day-cell.sun .day-number {
		    color: #FF3B30;
		}

		/* åœŸæ›œã¯é’ */
		.calendar-day-header.sat,
		.calendar-day-cell.sat .day-number {
		    color: #007BFF;
		}

		/* å¹³æ—¥ã¯ç™½èƒŒæ™¯ï¼‹é»’æ–‡å­— (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒç™½ã®ãŸã‚ã€ã»ã¨ã‚“ã©ã®è¦ç´ ã§ã¯ä¸è¦ã ãŒæ˜ç¤ºçš„ã«å®šç¾©) */
		.calendar-day-header.weekday,
		.calendar-day-cell.weekday .day-number {
		    background-color: #fff;
		    color: #000;
		}

		/* ä»Šæ—¥ã®ã‚»ãƒ«ã‚’å¼·èª¿ */
		.calendar-day-cell.today {
		    background-color: #ffeeba;
		    border: 2px solid #ff9800;
		}

		/* ãƒ­ã‚°è¨˜éŒ²æ¸ˆã¿ã®å° */
		/* é£Ÿäº‹è¨˜éŒ²ç”¨ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è‰²ãŒå„ªå…ˆã•ã‚Œã‚‹ãŸã‚ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯é£Ÿäº‹è¨˜éŒ²ãƒšãƒ¼ã‚¸ã§ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ãŒã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ãƒšãƒ¼ã‚¸ã§ã¯é©ç”¨ã•ã‚Œã¾ã™ã€‚ */
		.log-indicator {
		    color: gold;
		}
    </style>
</head>
<body class="training-log-page">
<div class="main-container">
    
    <h1 style="margin-bottom: 5px;">
        <i class="header-icon header-icon-meal fa-solid fa-utensils"></i> é£Ÿäº‹è¨˜éŒ²
    </h1>
    <p class="sub-heading" th:text="${username} + 'ã•ã‚“ã®é£Ÿäº‹ã‚’ç®¡ç†ã—ã¾ã—ã‚‡ã†ã€‚'">é£Ÿäº‹è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</p>

    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
    <div th:if="${error}" class="error-message" style="color:red; text-align:center; margin-bottom:10px;" th:text="${error}"></div>
    
    <div class="calendar-nav-container">
        <a th:href="@{/log/meal(year=${prevYear}, month=${prevMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-left"></i></a>
        <h2 class="calendar-title" th:text="${currentYearMonth.year} + 'å¹´ ' + ${currentYearMonth.monthValue} + 'æœˆ'"></h2>
        <a th:href="@{/log/meal(year=${nextYear}, month=${nextMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-right"></i></a>
    </div>

    <div class="calendar-grid">
		<div class="calendar-day-header" 
		     th:each="dayLabel : ${dayLabels}" 
		     th:text="${dayLabel}" 
		     th:classappend="${dayLabel == 'åœŸ'} ? 'sat' : (${dayLabel == 'æ—¥'} ? 'sun' : 'weekday')">
		    æ›œæ—¥
		</div>
        
        <th:block th:each="date : ${calendarDays}">
            <div th:with="dateNumber=${date != null ? date.dayOfMonth : ''},
                          dayOfWeek=${date != null ? date.dayOfWeek.name() : ''},
                          isToday=${date != null and date.isEqual(currentDate)},
                          isLogged=${date != null and loggedDates.containsKey(date)}"
                 class="calendar-day-cell"
                 th:classappend="${date == null} ? 'empty-day' : ((${isToday} ? 'today' : '') + 
                                                                    ((${dayOfWeek == 'SATURDAY'} ? ' sat' : '') + 
                                                                     ((${dayOfWeek == 'SUNDAY'} ? ' sun' : ''))))"
                 th:attr="data-date=${date != null ? date.toString() : ''}"
                 th:onclick="${date != null} ? 'openLogModal(this.getAttribute(\'data-date\'), ' + ${isLogged} + ')' : ''">

                <span class="day-number" th:text="${dateNumber}">1</span>
                <span th:if="${isLogged}" class="log-indicator log-indicator-meal"><i class="fa-solid fa-utensils"></i></span>
            </div>
        </th:block>
    </div>

    <div style="text-align: center; margin: 20px 0;">
        <a th:href="@{/log/meal/all}" class="button" style="background-color: #555; color: white; width: 100%; display: block; text-align: center; margin-bottom: 10px;">
            <i class="fa-solid fa-list"></i> å…¨è¨˜éŒ²ã‚’ãƒªã‚¹ãƒˆã§è¦‹ã‚‹
        </a>
        
        <div style="display: flex; gap: 10px;">
            <form th:action="@{/log/meal/analyze-month}" method="post" onsubmit="showLoading(this)" style="flex: 1;">
                <input type="hidden" name="year" th:value="${currentYearMonth.year}" />
                <input type="hidden" name="month" th:value="${currentYearMonth.monthValue}" />
                <button type="submit" class="button" style="background-color: #e67e22; color: white; width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    <i class="fa-solid fa-chart-pie"></i> æœˆé–“åˆ†æ
                </button>
            </form>
            
            <form th:action="@{/log/meal/analyze-week}" method="post" onsubmit="showLoading(this)" style="flex: 1;">
                <button type="submit" class="button" style="background-color: #9b59b6; color: white; width: 100%; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    <i class="fa-solid fa-calendar-week"></i> ä»Šé€±ã®åˆ†æ
                </button>
            </form>
        </div>
    </div>
</div>

<div id="logModal" class="modal" th:classappend="${mealLogForm.date != null} ? 'is-active' : ''">
    <div class="modal-content">
        <span class="close-button" onclick="closeLogModal()">&times;</span>
        <h2 id="modalDateTitle" class="modal-title" th:text="${mealLogForm.date}"></h2>
        
        <div id="logViewArea"></div>

        <div style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed #4CAF50;">
            <h3 style="font-size: 1rem; margin-top: 0; color: #2e7d32;"><i class="fa-solid fa-camera"></i> å†™çœŸã‹ã‚‰è‡ªå‹•å…¥åŠ›</h3>
            <form th:action="@{/log/meal/analyze}" method="post" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: center;" onsubmit="showLoading(this)">
                <input type="file" name="mealImage" accept="image/*" class="form-control" style="font-size: 0.9em; padding: 8px;" required>
                <button type="submit" class="button" style="background-color: #2e7d32; color: white; border: none; font-size: 0.9em; padding: 10px 15px; white-space: nowrap;">
                    è§£æ
                </button>
            </form>
            <p style="font-size: 0.8em; color: #666; margin: 5px 0 0 0;">â€»å†™çœŸã‚’é¸æŠã—ã¦ã€Œè§£æã€ã‚’æŠ¼ã™ã¨ã€å†…å®¹ãƒ»ã‚«ãƒ­ãƒªãƒ¼ç­‰ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</p>
            <div th:if="${aiComment}" style="margin-top: 10px; font-weight: bold; color: #e65100;">
                <i class="fa-solid fa-comment-dots"></i> <span th:text="${aiComment}"></span>
            </div>
        </div>

        <p class="modal-instruction">é£Ÿäº‹å†…å®¹ã‚’è¨˜éŒ²ï¼š</p>
        
        <div class="meal-form-container">
            <form th:action="@{/log/meal/save}" th:object="${mealLogForm}" method="post" onsubmit="showLoading(this)">
                
                <div class="form-group">
                    <label for="dateInput"><i class="fa-regular fa-calendar"></i> æ—¥ä»˜</label>
                    <input type="date" id="dateInput" th:field="*{date}" class="form-control" required>
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label for="time"><i class="fa-regular fa-clock"></i> æ™‚åˆ»</label>
                        <input type="time" id="time" th:field="*{time}" class="form-control" required>
                    </div>
                    <div class="form-group half">
                        <label for="mealType"><i class="fa-solid fa-utensils"></i> ç¨®é¡</label>
                        <select id="mealType" th:field="*{mealType}" class="form-control" required>
                            <option value="æœé£Ÿ">æœé£Ÿ</option>
                            <option value="æ˜¼é£Ÿ">æ˜¼é£Ÿ</option>
                            <option value="å¤•é£Ÿ">å¤•é£Ÿ</option>
                            <option value="é–“é£Ÿ">é–“é£Ÿ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="content">é£Ÿäº‹å†…å®¹</label>
                    <textarea id="content" th:field="*{content}" class="form-control" rows="2" placeholder="ä¾‹: ã”é£¯ã€ç„¼ãé­šã€å‘³å™Œæ±" required></textarea>
                    
                    <button type="submit" th:formaction="@{/log/meal/analyze-text}" formnovalidate 
                            class="button" style="background-color: #3498db; color: white; width: 100%; margin-top: 10px; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        <i class="fa-solid fa-robot"></i> å†…å®¹ã‹ã‚‰æ „é¤Šè¨ˆç®—ï¼†ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ææ¡ˆ
                    </button>
                </div>

                <div class="form-group">
                    <label for="calories">ğŸ”¥ ç·ã‚«ãƒ­ãƒªãƒ¼ (kcal)</label>
                    <input type="number" id="calories" th:field="*{calories}" class="form-control" placeholder="0" min="0" max="5000" required>
                </div>

                <div class="form-group">
                    <label>PFCãƒãƒ©ãƒ³ã‚¹ (g) <span style="font-size:0.8em; font-weight:normal; color:#888;">â€»ä»»æ„</span></label>
                    <div class="macro-section">
                        <div class="macro-row">
                            <div class="macro-item">
                                <label for="protein">P (ã‚¿ãƒ³ãƒ‘ã‚¯è³ª)</label>
                                <input type="number" id="protein" th:field="*{protein}" class="form-control macro-input p-input" step="0.1" min="0" max="500" placeholder="0.0">
                            </div>
                            <div class="macro-item">
                                <label for="fat">F (è„‚è³ª)</label>
                                <input type="number" id="fat" th:field="*{fat}" class="form-control macro-input f-input" step="0.1" min="0" max="500" placeholder="0.0">
                            </div>
                            <div class="macro-item">
                                <label for="carbohydrate">C (ç‚­æ°´åŒ–ç‰©)</label>
                                <input type="number" id="carbohydrate" th:field="*{carbohydrate}" class="form-control macro-input c-input" step="0.1" min="0" max="500" placeholder="0.0">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-check"></i> è¨˜éŒ²ã‚’ä¿å­˜
                </button>
            </form>
        </div>

        <a th:href="@{/log/meal/all}" class="button secondary view-all-button" style="margin-top: 20px;">å…¨è¨˜éŒ²ã‚’è¦‹ã‚‹</a>
    </div>
</div>

<div style="max-width: 450px; margin: 30px auto 70px auto; padding: 0 10px;">
    <a th:href="@{/home}" class="button secondary">
        <i class="fa-solid fa-house"></i> <span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span>
    </a>
</div>

<div th:if="${aiAdvice}" id="aiAdviceModal" class="modal is-active" style="z-index: 2000;">
    <div id="shareTarget" class="modal-content" style="max-width: 400px; text-align: center; background: #fff; border-radius: 15px; padding: 30px; position: relative; overflow: hidden;">
        
        <span class="close-button no-capture" onclick="document.getElementById('aiAdviceModal').style.display='none'">&times;</span>
        
        <div style="margin-bottom: 15px;">
            <img th:src="@{/img/AIcoach.png}" alt="AI Coach" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4CAF50; padding: 2px;">
        </div>
        
        <h3 style="color: #4CAF50; margin-bottom: 15px; font-weight: bold;">AI Trainer's Advice!</h3>
        
        <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; text-align: left; margin-bottom: 20px; position: relative;">
            <i class="fa-solid fa-quote-left" style="color: #bcdbf3; font-size: 1.5em; position: absolute; top: 10px; left: 10px;"></i>
            <p id="aiAdviceText" th:text="${aiAdvice}" style="margin: 0; padding: 5px 10px; color: #333; font-weight: 500; line-height: 1.6;">
                ã“ã“ã«AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
        </div>

        <div style="margin-top: 10px; margin-bottom: 10px; font-size: 0.8em; color: #aaa; font-weight: bold;">
            FitWorks Meal Log
        </div>

        <div class="sns-buttons-container no-capture">
            <button onclick="shareScreenImage()" class="btn-sns" style="background: linear-gradient(135deg, #4CAF50, #2E7D32); width: 100%; justify-content: center; font-size: 1em; margin-bottom: 10px; padding: 12px;">
                <i class="fa-solid fa-share-nodes"></i> ç”»åƒã¨ã—ã¦ã‚·ã‚§ã‚¢ã™ã‚‹
            </button>
            
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="shareToX()" class="btn-sns btn-sns-x" style="font-size: 0.8em; padding: 8px 12px;">
                    <i class="fa-brands fa-x-twitter"></i> Text
                </button>
                <button onclick="shareToLine()" class="btn-sns btn-sns-line" style="font-size: 0.8em; padding: 8px 12px;">
                    <i class="fa-brands fa-line"></i> Text
                </button>
                <button onclick="shareToInstagram()" class="btn-sns btn-sns-insta" style="font-size: 0.8em; padding: 8px 12px;">
                    <i class="fa-brands fa-instagram"></i> Copy
                </button>
                <button onclick="document.getElementById('aiAdviceModal').style.display='none'" class="btn-sns" style="background-color: #777; font-size: 0.8em; padding: 8px 12px;">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>



<script th:inline="javascript">
    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
    function openLogModal(dateString, isLogged) {
        document.getElementById('dateInput').value = dateString;
        document.getElementById('modalDateTitle').innerText = dateString.replace(/-/g, '/');
        
        const logViewArea = document.getElementById('logViewArea');
        if (isLogged) {
            logViewArea.innerHTML = '<p style="font-weight: 700; color: #4CAF50; margin-bottom: 10px;">âœ… ã“ã®æ—¥ã¯è¨˜éŒ²æ¸ˆã¿ã§ã™ã€‚</p>';
        } else {
            logViewArea.innerHTML = '<p style="color: #999; margin-bottom: 10px;">ã“ã®æ—¥ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }

        // ç¾åœ¨æ™‚åˆ»ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆ
        if(!document.getElementById('time').value) {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('time').value = timeString;
            
            // æ™‚é–“å¸¯ã§ç¨®é¡ã‚’è‡ªå‹•é¸æŠ
            const hour = now.getHours();
            const mealTypeSelect = document.getElementById('mealType');
            if(hour >= 4 && hour < 10) mealTypeSelect.value = "æœé£Ÿ";
            else if(hour >= 10 && hour < 16) mealTypeSelect.value = "æ˜¼é£Ÿ";
            else if(hour >= 16 || hour < 4) mealTypeSelect.value = "å¤•é£Ÿ";
        }

        document.getElementById('logModal').classList.add('is-active');
    }

    function closeLogModal() {
        document.getElementById('logModal').classList.remove('is-active');
    }

    window.onclick = function(event) {
        const modal = document.getElementById('logModal');
        const adviceModal = document.getElementById('aiAdviceModal');
        if (modal && modal.classList.contains('is-active') && event.target === modal) {
            closeLogModal();
        }
        if (adviceModal && event.target === adviceModal) {
            adviceModal.style.display = 'none';
        }
    }

    // â–¼â–¼â–¼ ä¿®æ­£: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–¢æ•° â–¼â–¼â–¼
    function showLoading(form) {
        const overlay = document.getElementById('global-loading-overlay');
        const mainText = document.getElementById('loading-main-text');
        const action = form.getAttribute('action');
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³URLã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (action && (action.includes('analyze') || action.includes('calculate'))) {
            mainText.innerText = 'AIãŒåˆ†æä¸­ã§ã™...';
            // ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’AIã£ã½ãé’ç³»ã«ã™ã‚‹
            overlay.querySelector('.loading-spinner').style.color = '#87ceeb';
        } else {
            mainText.innerText = 'è¨˜éŒ²ã‚’ä¿å­˜ä¸­ã§ã™...';
            overlay.querySelector('.loading-spinner').style.color = '#4CAF50';
        }

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        overlay.style.display = 'flex';

        // ãƒœã‚¿ãƒ³ã®äºŒé‡é€ä¿¡é˜²æ­¢ï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
        const btn = form.querySelector('button[type="submit"]');
        if (btn) {
            btn.disabled = true;
        }
        
        // ä¸‡ãŒä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¸°ã£ã¦ã“ãªã‹ã£ãŸå ´åˆã®å®‰å…¨ç­–ã¯
        // AIå‡¦ç†ãŒé•·ã„å ´åˆã‚’è€ƒæ…®ã—ã¦ä»Šå›ã¯å…¥ã‚Œã¾ã›ã‚“
    }
    
    // ----------------------------------------------------
    //  ç”»é¢ï¼ˆç”»åƒï¼‰ã‚·ã‚§ã‚¢æ©Ÿèƒ½
    // ----------------------------------------------------
    async function shareScreenImage() {
        const target = document.getElementById('shareTarget');
        const hideElements = target.querySelectorAll('.no-capture');
        
        hideElements.forEach(el => el.style.display = 'none');
        
        const originalBtn = document.querySelector('button[onclick="shareScreenImage()"]');
        const originalText = originalBtn ? originalBtn.innerHTML : '';
        if(originalBtn) originalBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';

        try {
            const canvas = await html2canvas(target, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff'
            });

            canvas.toBlob(async (blob) => {
                const file = new File([blob], "fitworks_meal_log.png", { type: "image/png" });
                
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'FitWorks Record',
                            text: getShareText(),
                        });
                    } catch (err) {
                        console.log('Share canceled or failed', err);
                    }
                } else {
                    const link = document.createElement('a');
                    link.download = 'fitworks_meal_log.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    alert("ç”»åƒã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚\nSNSã‚¢ãƒ—ãƒªã‹ã‚‰æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚");
                }
                
                hideElements.forEach(el => el.style.display = '');
                if(originalBtn) originalBtn.innerHTML = originalText;

            }, 'image/png');

        } catch (error) {
            console.error('Capture failed:', error);
            alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            hideElements.forEach(el => el.style.display = '');
            if(originalBtn) originalBtn.innerHTML = originalText;
        }
    }

    // --- SNSã‚·ã‚§ã‚¢æ©Ÿèƒ½ï¼ˆãƒ†ã‚­ã‚¹ãƒˆç”¨ï¼‰ ---
    function getShareText() {
        const adviceText = document.getElementById('aiAdviceText').innerText;
        return `ã€FitWorksã€‘é£Ÿäº‹è¨˜éŒ²å®Œäº†ï¼ğŸ¥—\nAIãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã€Œ${adviceText}ã€\n\n#FitWorks #é£Ÿäº‹ç®¡ç† #ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ`;
    }

    function shareToX() {
        const text = getShareText();
        const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank');
    }

    function shareToLine() {
        const text = getShareText();
        const shareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank');
    }

    function shareToInstagram() {
        const text = getShareText();
        navigator.clipboard.writeText(text).then(() => {
            alert("æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ğŸ“‹\nInstagramã‚’é–‹ãã¾ã™ã€‚æŠ•ç¨¿ã‚„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
            window.open('https://www.instagram.com/', '_blank');
        }).catch(err => {
            console.error('Copy failed', err);
            alert("æ–‡ç« ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n(æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)");
            window.open('https://www.instagram.com/', '_blank');
        });
    }
</script>

</body>
</html>