<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿäº‹è¨˜éŒ² | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/training-log.css}"> 
	
	<script th:src="@{/js/theme.js}"></script>
    <style>
        .header-icon-meal { color: #4CAF50; }
        .log-indicator-meal { color: #4CAF50 !important; }
        
        /* åŸ‹ã‚è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .meal-form-container { text-align: left; padding: 0 5px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 700; color: #555; font-size: 0.9em; }
        .form-group.half { flex: 1; }
        .form-control { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; background-color: #fff; }
        .form-control:focus { border-color: #4CAF50; outline: none; }
        .form-control[readonly] { background-color: #f3f3f3; color: #777; cursor: not-allowed; }
        .macro-section { background-color: #f9f9f9; border: 1px dashed #ccc; border-radius: 10px; padding: 15px; }
        .macro-row { display: flex; gap: 10px; justify-content: space-between; }
        .macro-item { flex: 1; text-align: center; }
        .macro-item label { font-size: 0.85em; color: #777; margin-bottom: 3px; }
        .macro-input { text-align: center; font-weight: bold; }
        .p-input:focus { border-color: #3498db !important; }
        .f-input:focus { border-color: #e74c3c !important; }
        .c-input:focus { border-color: #f1c40f !important; }
        .text-danger { color: #e74c3c; font-size: 0.85em; display: block; margin-top: 5px; }
        .btn-submit { width: 100%; margin-top: 20px; padding: 12px; font-size: 1.1em; background-color: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-submit:hover { background-color: #45a049; }

        /* --- SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .sns-buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .btn-sns {
            color: #fff;
            padding: 10px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.85em;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            border: none;
        }
        .btn-sns:hover { opacity: 0.9; transform: translateY(-1px); color: white; }
        .btn-sns i { margin-right: 5px; font-size: 1.1em; }

        /* X (Twitter) */
        .btn-sns-x { background-color: #000; }
        
        /* LINE */
        .btn-sns-line { background-color: #06C755; }
        
        /* Instagram (ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³) */
        .btn-sns-insta { 
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); 
        }
    </style>
</head>
<body class="training-log-page">
<div class="main-container">
    
    <h1 style="margin-bottom: 5px;">
        <i class="header-icon header-icon-meal fa-solid fa-utensils"></i> é£Ÿäº‹è¨˜éŒ²
    </h1>
    <p class="sub-heading" th:text="${username} + 'ã•ã‚“ã®é£Ÿäº‹ã‚’ç®¡ç†ã—ã¾ã—ã‚‡ã†ã€‚'">é£Ÿäº‹è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</p>

    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
    
    <div class="calendar-nav-container">
        <a th:href="@{/log/meal(year=${prevYear}, month=${prevMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-left"></i></a>
        <h2 class="calendar-title" th:text="${currentYearMonth.year} + 'å¹´ ' + ${currentYearMonth.monthValue} + 'æœˆ'"></h2>
        <a th:href="@{/log/meal(year=${nextYear}, month=${nextMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-right"></i></a>
    </div>

    <div class="calendar-grid">
        <div class="calendar-day-header" th:each="dayLabel : ${dayLabels}" th:text="${dayLabel}" 
             th:classappend="${dayLabel == 'åœŸ'} ? 'sat' : ((${dayLabel == 'æ—¥'} ? 'sun' : ''))">æ›œæ—¥</div>
        
        <th:block th:each="date : ${calendarDays}">
            <div th:with="dateNumber=${date != null ? date.dayOfMonth : ''},
                          dayOfWeek=${date != null ? date.dayOfWeek.name() : ''},
                          isToday=${date != null and date.isEqual(currentDate)},
                          isLogged=${date != null and loggedDates.containsKey(date)}"
                 class="calendar-day-cell"
                 th:classappend="${date == null} ? 'empty-day' : ((${isToday} ? 'today' : '') + 
                                                                    ((${dayOfWeek == 'SATURDAY'} ? ' sat' : '') + 
                                                                     ((${dayOfWeek == 'SUNDAY'} ? ' sun' : ''))))"
                 th:attr="data-date=${date != null ? date.toString() : ''}"
                 th:onclick="${date != null} ? 'openLogModal(this.getAttribute(\'data-date\'), ' + ${isLogged} + ')' : ''">

                <span class="day-number" th:text="${dateNumber}">1</span>
                <span th:if="${isLogged}" class="log-indicator log-indicator-meal"><i class="fa-solid fa-utensils"></i></span>
            </div>
        </th:block>
    </div>

    <div style="text-align: center; margin: 20px 0;">
        <a th:href="@{/log/meal/all}" class="button" style="background-color: #555; color: white; width: 100%; display: block; text-align: center;">
            <i class="fa-solid fa-list"></i> å…¨è¨˜éŒ²ã‚’ãƒªã‚¹ãƒˆã§è¦‹ã‚‹
        </a>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLogModal()">&times;</span>
        <h2 id="modalDateTitle" class="modal-title"></h2>
        
        <div id="logViewArea"></div>

        <p class="modal-instruction">é£Ÿäº‹å†…å®¹ã‚’è¨˜éŒ²ï¼š</p>
        
        <div class="meal-form-container">
            <form th:action="@{/log/meal/save}" th:object="${mealLogForm}" method="post">
                
                <div class="form-group">
                    <label for="dateInput"><i class="fa-regular fa-calendar"></i> æ—¥ä»˜</label>
                    <input type="date" id="dateInput" th:field="*{date}" class="form-control" readonly>
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label for="time"><i class="fa-regular fa-clock"></i> æ™‚åˆ»</label>
                        <input type="time" id="time" th:field="*{time}" class="form-control" required>
                    </div>
                    <div class="form-group half">
                        <label for="mealType"><i class="fa-solid fa-utensils"></i> ç¨®é¡</label>
                        <select id="mealType" th:field="*{mealType}" class="form-control" required>
                            <option value="æœé£Ÿ">æœé£Ÿ</option>
                            <option value="æ˜¼é£Ÿ">æ˜¼é£Ÿ</option>
                            <option value="å¤•é£Ÿ">å¤•é£Ÿ</option>
                            <option value="é–“é£Ÿ">é–“é£Ÿ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="content">é£Ÿäº‹å†…å®¹</label>
                    <textarea id="content" th:field="*{content}" class="form-control" rows="2" placeholder="ä¾‹: ã”é£¯ã€ç„¼ãé­šã€å‘³å™Œæ±" required></textarea>
                </div>

                <div class="form-group">
                    <label for="calories">ğŸ”¥ ç·ã‚«ãƒ­ãƒªãƒ¼ (kcal)</label>
                    <input type="number" id="calories" th:field="*{calories}" class="form-control" placeholder="0" min="0" required>
                </div>

                <div class="form-group">
                    <label>PFCãƒãƒ©ãƒ³ã‚¹ (g) <span style="font-size:0.8em; font-weight:normal; color:#888;">â€»ä»»æ„</span></label>
                    <div class="macro-section">
                        <div class="macro-row">
                            <div class="macro-item">
                                <label for="protein">P (ã‚¿ãƒ³ãƒ‘ã‚¯è³ª)</label>
                                <input type="number" id="protein" th:field="*{protein}" class="form-control macro-input p-input" step="0.1" min="0" placeholder="0.0">
                            </div>
                            <div class="macro-item">
                                <label for="fat">F (è„‚è³ª)</label>
                                <input type="number" id="fat" th:field="*{fat}" class="form-control macro-input f-input" step="0.1" min="0" placeholder="0.0">
                            </div>
                            <div class="macro-item">
                                <label for="carbohydrate">C (ç‚­æ°´åŒ–ç‰©)</label>
                                <input type="number" id="carbohydrate" th:field="*{carbohydrate}" class="form-control macro-input c-input" step="0.1" min="0" placeholder="0.0">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-check"></i> è¨˜éŒ²ã‚’ä¿å­˜
                </button>
            </form>
        </div>

        <a th:href="@{/log/meal/all}" class="button secondary view-all-button" style="margin-top: 20px;">å…¨è¨˜éŒ²ã‚’è¦‹ã‚‹</a>
    </div>
</div>

<div style="max-width: 450px; margin: 30px auto 70px auto; padding: 0 10px;">
    <a th:href="@{/home}" class="button secondary">
        <i class="fa-solid fa-house"></i> <span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span>
    </a>
</div>

<div th:if="${aiAdvice}" id="aiAdviceModal" class="modal is-active" style="z-index: 2000;">
    <div class="modal-content" style="max-width: 400px; text-align: center; background: #fff; border-radius: 15px; padding: 30px;">
        <span class="close-button" onclick="document.getElementById('aiAdviceModal').style.display='none'">&times;</span>
        
        <div style="margin-bottom: 15px;">
            <img th:src="@{/img/AIcoach.png}" alt="AI Coach" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4CAF50; padding: 2px;">
        </div>
        
        <h3 style="color: #4CAF50; margin-bottom: 15px; font-weight: bold;">ç™»éŒ²å®Œäº†ï¼</h3>
        
        <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; text-align: left; margin-bottom: 20px; position: relative;">
            <i class="fa-solid fa-quote-left" style="color: #bcdbf3; font-size: 1.5em; position: absolute; top: 10px; left: 10px;"></i>
            <p id="aiAdviceText" th:text="${aiAdvice}" style="margin: 0; padding: 5px 10px; color: #333; font-weight: 500; line-height: 1.6;">
                ã“ã“ã«AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
        </div>

        <div class="sns-buttons-container">
            
            <button onclick="shareToX()" class="btn-sns btn-sns-x">
                <i class="fa-brands fa-x-twitter"></i> X
            </button>

            <button onclick="shareToLine()" class="btn-sns btn-sns-line">
                <i class="fa-brands fa-line"></i> LINE
            </button>
            
            <button onclick="shareToInstagram()" class="btn-sns btn-sns-insta">
                <i class="fa-brands fa-instagram"></i> Insta
            </button>

            <button onclick="document.getElementById('aiAdviceModal').style.display='none'" class="btn-submit" style="width: auto; padding: 10px 20px; margin-top: 0; margin-bottom: 0; background-color: #777; border-radius:20px;">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
    function openLogModal(dateString, isLogged) {
        const [year, month, day] = dateString.split('-');
        const displayDate = `${year}å¹´${month}æœˆ${day}æ—¥`;
        
        // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
        document.getElementById('dateInput').value = dateString;
        document.getElementById('modalDateTitle').innerText = displayDate;
        
        // è¨˜éŒ²æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆ
        const logViewArea = document.getElementById('logViewArea');
        if (isLogged) {
            logViewArea.innerHTML = '<p style="font-weight: 700; color: #4CAF50; margin-bottom: 10px;">âœ… ã“ã®æ—¥ã¯è¨˜éŒ²æ¸ˆã¿ã§ã™ã€‚</p>';
        } else {
            logViewArea.innerHTML = '<p style="color: #999; margin-bottom: 10px;">ã“ã®æ—¥ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        document.getElementById('logModal').classList.add('is-active');
    }

    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeLogModal() {
        document.getElementById('logModal').classList.remove('is-active');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹å‡¦ç†
    window.onclick = function(event) {
        const logModal = document.getElementById('logModal');
        const adviceModal = document.getElementById('aiAdviceModal');
        
        if (logModal && logModal.classList.contains('is-active') && event.target === logModal) {
            closeLogModal();
        }
        // AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
        if (adviceModal && event.target === adviceModal) {
            adviceModal.style.display = 'none';
        }
    }

    // ----------------------------------------------------
    //  SNSã‚·ã‚§ã‚¢æ©Ÿèƒ½ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ----------------------------------------------------

    // å…±é€šã®æŠ•ç¨¿æ–‡ç”Ÿæˆ
    function getShareText() {
        const adviceText = document.getElementById('aiAdviceText').innerText;
        return `ã€FitWorksã€‘é£Ÿäº‹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼\nAIã‚³ãƒ¼ãƒã€Œ${adviceText}ã€\n\n#FitWorks #é£Ÿäº‹è¨˜éŒ² #ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ`;
    }

    // X (Twitter) ã«ã‚·ã‚§ã‚¢
    function shareToX() {
        const text = getShareText();
        const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank');
    }

    // LINE ã«ã‚·ã‚§ã‚¢
    function shareToLine() {
        const text = getShareText();
        // LINEã¯ msg/text/?{text} å½¢å¼
        const shareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank');
    }

    // Instagram ã«ã‚·ã‚§ã‚¢ (ã‚³ãƒ”ãƒ¼ã—ã¦ã‚¢ãƒ—ãƒªã‚’é–‹ã)
    function shareToInstagram() {
        const text = getShareText();
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        navigator.clipboard.writeText(text).then(() => {
            // æˆåŠŸæ™‚
            alert("æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ğŸ“‹\nInstagramã‚’é–‹ãã¾ã™ã€‚æŠ•ç¨¿ã‚„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
            window.open('https://www.instagram.com/', '_blank');
        }).catch(err => {
            // å¤±æ•—æ™‚ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ãªã©ï¼‰
            console.error('Copy failed', err);
            alert("æ–‡ç« ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n(æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)");
            // ãã‚Œã§ã‚‚ä¸€å¿œé–‹ã
            window.open('https://www.instagram.com/', '_blank');
        });
    }
</script>

</body>
</html>