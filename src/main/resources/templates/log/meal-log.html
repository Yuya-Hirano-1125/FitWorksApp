<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿäº‹è¨˜éŒ² | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/training-log.css}"> 
	
	<script th:src="@{/js/theme.js}"></script>
    <style>
        .header-icon-meal { color: #4CAF50; }
        .log-indicator-meal { color: #4CAF50 !important; }
        
        /* åŸ‹ã‚è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .meal-form-container { text-align: left; padding: 0 5px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 700; color: #555; font-size: 0.9em; }
        .form-group.half { flex: 1; }
        .form-control { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; background-color: #fff; }
        .form-control:focus { border-color: #4CAF50; outline: none; }
        .form-control[readonly] { background-color: #f3f3f3; color: #777; cursor: not-allowed; }
        .macro-section { background-color: #f9f9f9; border: 1px dashed #ccc; border-radius: 10px; padding: 15px; }
        .macro-row { display: flex; gap: 10px; justify-content: space-between; }
        .macro-item { flex: 1; text-align: center; }
        .macro-item label { font-size: 0.85em; color: #777; margin-bottom: 3px; }
        .macro-input { text-align: center; font-weight: bold; }
        .p-input:focus { border-color: #3498db !important; }
        .f-input:focus { border-color: #e74c3c !important; }
        .c-input:focus { border-color: #f1c40f !important; }
        .text-danger { color: #e74c3c; font-size: 0.85em; display: block; margin-top: 5px; }
        .btn-submit { width: 100%; margin-top: 20px; padding: 12px; font-size: 1.1em; background-color: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-submit:hover { background-color: #45a049; }

        /* â˜…è¿½åŠ : AIãƒœã‚¿ãƒ³ã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ai-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; text-align: center; }
        .btn-ai-camera {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white; padding: 12px 20px; border-radius: 50px;
            cursor: pointer; display: inline-block; width: 90%;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        .btn-ai-camera:active { transform: scale(0.98); }
        .btn-ai-camera i { margin-right: 8px; }
        .ai-loading-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10;
            flex-direction: column; align-items: center; justify-content: center;
            border-radius: 15px;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #2575fc; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-comment-box {
            background-color: #f0f8ff; border-left: 4px solid #2575fc;
            padding: 10px; margin-bottom: 15px; font-size: 0.9em; color: #333;
            border-radius: 4px; display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
    </style>
</head>
<body class="training-log-page">
<div class="main-container">
    
    <h1 style="margin-bottom: 5px;">
        <i class="header-icon header-icon-meal fa-solid fa-utensils"></i> é£Ÿäº‹è¨˜éŒ²
    </h1>
    <p class="sub-heading" th:text="${username} + 'ã•ã‚“ã®é£Ÿäº‹ã‚’ç®¡ç†ã—ã¾ã—ã‚‡ã†ã€‚'">é£Ÿäº‹è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</p>

    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
    <div th:if="${error}" class="success-message" style="background-color: #ffebee; color: #c62828;" th:text="${error}"></div>
    
    <div class="calendar-nav-container">
        <a th:href="@{/log/meal(year=${prevYear}, month=${prevMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-left"></i></a>
        <h2 class="calendar-title" th:text="${currentYearMonth.year} + 'å¹´ ' + ${currentYearMonth.monthValue} + 'æœˆ'"></h2>
        <a th:href="@{/log/meal(year=${nextYear}, month=${nextMonth})}" class="nav-arrow"><i class="fa-solid fa-chevron-right"></i></a>
    </div>

    <div class="calendar-grid">
        <div class="calendar-day-header" th:each="dayLabel : ${dayLabels}" th:text="${dayLabel}" 
             th:classappend="${dayLabel == 'åœŸ'} ? 'sat' : ((${dayLabel == 'æ—¥'} ? 'sun' : ''))">æ›œæ—¥</div>
        
        <th:block th:each="date : ${calendarDays}">
            <div th:with="dateNumber=${date != null ? date.dayOfMonth : ''},
                          dayOfWeek=${date != null ? date.dayOfWeek.name() : ''},
                          isToday=${date != null and date.isEqual(currentDate)},
                          isLogged=${date != null and loggedDates.containsKey(date)}"
                 class="calendar-day-cell"
                 th:classappend="${date == null} ? 'empty-day' : ((${isToday} ? 'today' : '') + 
                                                                    ((${dayOfWeek == 'SATURDAY'} ? ' sat' : '') + 
                                                                     ((${dayOfWeek == 'SUNDAY'} ? ' sun' : ''))))"
                 th:attr="data-date=${date != null ? date.toString() : ''}"
                 th:onclick="${date != null} ? 'openLogModal(this.getAttribute(\'data-date\'), ' + ${isLogged} + ')' : ''">

                <span class="day-number" th:text="${dateNumber}">1</span>
                <span th:if="${isLogged}" class="log-indicator log-indicator-meal"><i class="fa-solid fa-utensils"></i></span>
            </div>
        </th:block>
    </div>

    <div style="text-align: center; margin: 20px 0;">
        <a th:href="@{/log/meal/all}" class="button" style="background-color: #555; color: white; width: 100%; display: block; text-align: center;">
            <i class="fa-solid fa-list"></i> å…¨è¨˜éŒ²ã‚’ãƒªã‚¹ãƒˆã§è¦‹ã‚‹
        </a>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content" style="position: relative;"> <span class="close-button" onclick="closeLogModal()">&times;</span>
        <h2 id="modalDateTitle" class="modal-title"></h2>
        
        <div id="logViewArea"></div>

        <div id="aiLoading" class="ai-loading-overlay">
            <div class="spinner"></div>
            <p style="color: #2575fc; font-weight: bold;">AIãŒç”»åƒã‚’è§£æä¸­...<br><span style="font-size: 0.8em; color: #666;">ã“ã‚Œã«ã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™</span></p>
        </div>

        <div class="ai-section">
            <form id="aiAnalyzeForm" th:action="@{/log/meal/analyze}" method="post" enctype="multipart/form-data">
                <label class="btn-ai-camera">
                    <i class="fa-solid fa-camera"></i> AIã‚«ãƒ¡ãƒ©ã§è‡ªå‹•å…¥åŠ›
                    <input type="file" name="mealImage" accept="image/*" capture="environment" style="display:none;" onchange="submitAiForm()">
                </label>
                <input type="hidden" name="targetDate" id="aiTargetDate">
            </form>
        </div>

        <div id="aiCommentArea" class="ai-comment-box"></div>

        <p class="modal-instruction" style="margin-bottom: 10px;">é£Ÿäº‹å†…å®¹ã‚’è¨˜éŒ²ï¼š</p>
        
        <div class="meal-form-container">
            <form th:action="@{/log/meal/save}" th:object="${mealLogForm}" method="post">
                
                <div class="form-group">
                    <label for="dateInput"><i class="fa-regular fa-calendar"></i> æ—¥ä»˜</label>
                    <input type="date" id="dateInput" th:field="*{date}" class="form-control" readonly>
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label for="time"><i class="fa-regular fa-clock"></i> æ™‚åˆ»</label>
                        <input type="time" id="time" th:field="*{time}" class="form-control" required>
                    </div>
                    <div class="form-group half">
                        <label for="mealType"><i class="fa-solid fa-utensils"></i> ç¨®é¡</label>
                        <select id="mealType" th:field="*{mealType}" class="form-control" required>
                            <option value="æœé£Ÿ">æœé£Ÿ</option>
                            <option value="æ˜¼é£Ÿ">æ˜¼é£Ÿ</option>
                            <option value="å¤•é£Ÿ">å¤•é£Ÿ</option>
                            <option value="é–“é£Ÿ">é–“é£Ÿ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="content">é£Ÿäº‹å†…å®¹</label>
                    <textarea id="content" th:field="*{content}" class="form-control" rows="2" placeholder="ä¾‹: ã”é£¯ã€ç„¼ãé­šã€å‘³å™Œæ±" required></textarea>
                </div>

                <div class="form-group">
                    <label for="calories">ğŸ”¥ ç·ã‚«ãƒ­ãƒªãƒ¼ (kcal)</label>
                    <input type="number" id="calories" th:field="*{calories}" class="form-control" placeholder="0" min="0" required>
                </div>

                <div class="form-group">
                    <label>PFCãƒãƒ©ãƒ³ã‚¹ (g) <span style="font-size:0.8em; font-weight:normal; color:#888;">â€»ä»»æ„</span></label>
                    <div class="macro-section">
                        <div class="macro-row">
                            <div class="macro-item">
                                <label for="protein">P (ã‚¿ãƒ³ãƒ‘ã‚¯è³ª)</label>
                                <input type="number" id="protein" th:field="*{protein}" class="form-control macro-input p-input" step="0.1" min="0" placeholder="0.0">
                            </div>
                            <div class="macro-item">
                                <label for="fat">F (è„‚è³ª)</label>
                                <input type="number" id="fat" th:field="*{fat}" class="form-control macro-input f-input" step="0.1" min="0" placeholder="0.0">
                            </div>
                            <div class="macro-item">
                                <label for="carbohydrate">C (ç‚­æ°´åŒ–ç‰©)</label>
                                <input type="number" id="carbohydrate" th:field="*{carbohydrate}" class="form-control macro-input c-input" step="0.1" min="0" placeholder="0.0">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-check"></i> è¨˜éŒ²ã‚’ä¿å­˜
                </button>
            </form>
        </div>

        <a th:href="@{/log/meal/all}" class="button secondary view-all-button" style="margin-top: 20px;">å…¨è¨˜éŒ²ã‚’è¦‹ã‚‹</a>
    </div>
</div>

<div style="max-width: 450px; margin: 30px auto 70px auto; padding: 0 10px;">
    <a th:href="@{/home}" class="button secondary">
        <i class="fa-solid fa-house"></i> <span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span>
    </a>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®AIè§£æçµæœã‚’å–å¾— (Thymeleafå¤‰æ•°)
    const analyzedData = /*[[${analyzedData}]]*/ null;
    const analyzedDate = /*[[${analyzedDate}]]*/ null; // Controllerã‹ã‚‰æ—¥ä»˜ã‚‚è¿”ã—ã¦ã‚‚ã‚‰ã†æƒ³å®š
    /*]]>*/

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', function() {
        // AIè§£æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€è‡ªå‹•ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦å€¤ã‚’ã‚»ãƒƒãƒˆ
        if (analyzedData) {
            // æ—¥ä»˜ã¯Controllerã‹ã‚‰æ¸¡ã•ã‚ŒãŸã‚‚ã®ã€ãªã‘ã‚Œã°ä»Šæ—¥
            let targetDate = analyzedDate || new Date().toISOString().split('T')[0];
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆisLoggedã¯ã¨ã‚Šã‚ãˆãšfalseã§ï¼‰
            openLogModal(targetDate, false);

            // å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
            if (analyzedData.content) document.getElementById('content').value = analyzedData.content;
            if (analyzedData.calories) document.getElementById('calories').value = analyzedData.calories;
            if (analyzedData.protein) document.getElementById('protein').value = analyzedData.protein;
            if (analyzedData.fat) document.getElementById('fat').value = analyzedData.fat;
            if (analyzedData.carbohydrate) document.getElementById('carbohydrate').value = analyzedData.carbohydrate;

            // AIã‚³ãƒ¡ãƒ³ãƒˆã®è¡¨ç¤º
            if (analyzedData.comment) {
                const commentBox = document.getElementById('aiCommentArea');
                commentBox.innerHTML = '<strong>ğŸ¤– AIã‚³ãƒ¼ãƒ:</strong> ' + analyzedData.comment;
                commentBox.style.display = 'block';
            }
        }
    });

    // AIè§£æãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    function submitAiForm() {
        document.getElementById('aiLoading').style.display = 'flex';
        document.getElementById('aiAnalyzeForm').submit();
    }

    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
    function openLogModal(dateString, isLogged) {
        const [year, month, day] = dateString.split('-');
        const displayDate = `${year}å¹´${month}æœˆ${day}æ—¥`;
        
        // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
        document.getElementById('dateInput').value = dateString;
        document.getElementById('modalDateTitle').innerText = displayDate;
        
        // â˜…AIãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®hiddenæ—¥ä»˜ã«ã‚‚ã‚»ãƒƒãƒˆ
        document.getElementById('aiTargetDate').value = dateString;
        
        // è¨˜éŒ²æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆ
        const logViewArea = document.getElementById('logViewArea');
        if (isLogged) {
            logViewArea.innerHTML = '<p style="font-weight: 700; color: #4CAF50; margin-bottom: 10px;">âœ… ã“ã®æ—¥ã¯è¨˜éŒ²æ¸ˆã¿ã§ã™ã€‚</p>';
        } else {
            logViewArea.innerHTML = '<p style="color: #999; margin-bottom: 10px;">ã“ã®æ—¥ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        document.getElementById('logModal').classList.add('is-active');
    }

    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeLogModal() {
        document.getElementById('logModal').classList.remove('is-active');
        // AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('aiCommentArea').style.display = 'none';
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹å‡¦ç†
    window.onclick = function(event) {
        const modal = document.getElementById('logModal');
        if (modal.classList.contains('is-active') && event.target === modal) {
            closeLogModal();
        }
    }
</script>

</body>
</html>