<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ² | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/training-log.css}"> 
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script th:src="@{/js/theme.js}"></script>
    <style>
        /* SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .sns-buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .btn-sns {
            color: #fff;
            padding: 10px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.85em;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            border: none;
        }
        .btn-sns:hover { opacity: 0.9; transform: translateY(-1px); color: white; }
        .btn-sns i { margin-right: 5px; font-size: 1.1em; }

        /* X (Twitter) */
        .btn-sns-x { background-color: #000; }
        
        /* LINE */
        .btn-sns-line { background-color: #06C755; }
        
        /* Instagram (ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³) */
        .btn-sns-insta { 
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); 
        }
    </style>
</head>
<body class="training-log-page">
<div class="main-container">
    
    <h1 style="margin-bottom: 5px;"><i class="header-icon fa-solid fa-calendar-days"></i>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</h1>
    <p class="sub-heading" th:text="${username} + 'ã•ã‚“ã®é ‘å¼µã‚Šã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ã€‚'">
        ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    </p>

    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
    
    <div class="calendar-nav-container">
        <a th:href="@{/training-log(year=${prevYear}, month=${prevMonth})}" class="nav-arrow">
            <i class="fa-solid fa-chevron-left"></i>
        </a>
        
        <h2 class="calendar-title" th:text="${currentYearMonth.year} + 'å¹´ ' + ${currentYearMonth.monthValue} + 'æœˆ'"></h2>
        
        <a th:href="@{/training-log(year=${nextYear}, month=${nextMonth})}" class="nav-arrow">
            <i class="fa-solid fa-chevron-right"></i>
        </a>
    </div>

    <div class="calendar-grid">
        <div class="calendar-day-header" th:each="dayLabel : ${dayLabels}" th:text="${dayLabel}" 
             th:classappend="${dayLabel == 'åœŸ'} ? 'sat' : ((${dayLabel == 'æ—¥'} ? 'sun' : ''))">
             æ›œæ—¥
        </div>
        
        <th:block th:each="date : ${calendarDays}">
            <div th:with="dateNumber=${date != null ? date.dayOfMonth : ''},
                          dayOfWeek=${date != null ? date.dayOfWeek.name() : ''},
                          isToday=${date != null and date.isEqual(currentDate)},
                          isLogged=${date != null and loggedDates.containsKey(date)}"
                 class="calendar-day-cell"
                 th:classappend="${date == null} ? 'empty-day' : ((${isToday} ? 'today' : '') + 
                                                                    ((${dayOfWeek == 'SATURDAY'} ? ' sat' : '') + 
                                                                     ((${dayOfWeek == 'SUNDAY'} ? ' sun' : ''))))"
                 th:attr="data-date=${date != null ? date.toString() : ''}"
                 th:onclick="${date != null} ? 'openLogModal(this.getAttribute(\'data-date\'), ' + ${isLogged} + ')' : ''">

                <span class="day-number" th:text="${dateNumber}">1</span>
                
                <span th:if="${isLogged}" class="log-indicator">
                    <i class="fa-solid fa-star"></i>
                </span>
            </div>
        </th:block>
    </div>

    <div style="text-align: center; margin: 20px 0;">
        <a th:href="@{/training-log/all}" class="button" style="background-color: #555; color: white; width: 100%; display: block; text-align: center;">
            <i class="fa-solid fa-list"></i> å…¨è¨˜éŒ²ã‚’ãƒªã‚¹ãƒˆã§è¦‹ã‚‹
        </a>
    </div>

</div>

<div id="logModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLogModal()">&times;</span>
        <h2 id="modalDateTitle" class="modal-title"></h2>
        
        <div id="logViewArea">
             </div>

        <p class="modal-instruction">æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ ï¼š</p>
        
        <div class="form-group">
            <label for="trainingType">è¨˜éŒ²ã®ç¨®é¡:</label>
            <select id="trainingType" class="form-control" onchange="loadTrainingForm(this.value, document.getElementById('selectedDateInput').value)">
                <option value="WEIGHT">ãƒ•ãƒªãƒ¼ã‚¦ã‚§ã‚¤ãƒˆ (ç­‹ãƒˆãƒ¬)</option>
                <option value="CARDIO">æœ‰é…¸ç´ é‹å‹• (ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãªã©)</option>
                <option value="BODY_WEIGHT">ä½“é‡è¨˜éŒ²</option>
            </select>
        </div>
        
        <input type="hidden" id="selectedDateInput" name="date" value="">
        
        <div id="formContainer">
            <p>ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>

        <a th:href="@{/training-log/all}" class="button secondary view-all-button">
            å…¨è¨˜éŒ²ã‚’è¦‹ã‚‹
        </a>
    </div>
</div>

<div style="max-width: 450px; margin: 30px auto 70px auto; padding: 0 10px;">
    <a th:href="@{/home}" class="button secondary">
        <i class="fa-solid fa-house"></i>
        <span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span>
    </a>
</div>

<div th:if="${aiAdvice}" id="aiAdviceModal" class="modal is-active" style="z-index: 2000;">
    <div id="shareTarget" class="modal-content" style="max-width: 400px; text-align: center; background: #fff; border-radius: 15px; padding: 30px; position: relative; overflow: hidden;">
        
        <span class="close-button no-capture" onclick="document.getElementById('aiAdviceModal').style.display='none'">&times;</span>
        
        <div style="margin-bottom: 15px;">
            <img th:src="@{/img/AIcoach.png}" alt="AI Coach" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4CAF50; padding: 2px;">
        </div>
        
        <h3 style="color: #4CAF50; margin-bottom: 15px; font-weight: bold;">Good Job!</h3>
        
        <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; text-align: left; margin-bottom: 20px; position: relative;">
            <i class="fa-solid fa-quote-left" style="color: #bcdbf3; font-size: 1.5em; position: absolute; top: 10px; left: 10px;"></i>
            <p id="aiAdviceText" th:text="${aiAdvice}" style="margin: 0; padding: 5px 10px; color: #333; font-weight: 500; line-height: 1.6;">
                ã“ã“ã«AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
        </div>

        <div style="margin-top: 10px; margin-bottom: 10px; font-size: 0.8em; color: #aaa; font-weight: bold;">
            FitWorks Training Log
        </div>

        <div class="sns-buttons-container no-capture">
            <button onclick="shareScreenImage()" class="btn-sns" style="background: linear-gradient(135deg, #4CAF50, #2E7D32); width: 100%; justify-content: center; font-size: 1em; margin-bottom: 10px; padding: 12px;">
                <i class="fa-solid fa-share-nodes"></i> ç”»åƒã¨ã—ã¦ã‚·ã‚§ã‚¢ã™ã‚‹
            </button>
            
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="shareToX()" class="btn-sns btn-sns-x" style="font-size: 0.8em; padding: 8px 12px;">
                    <i class="fa-brands fa-x-twitter"></i> Text
                </button>
                <button onclick="shareToLine()" class="btn-sns btn-sns-line" style="font-size: 0.8em; padding: 8px 12px;">
                    <i class="fa-brands fa-line"></i> Text
                </button>
                <button onclick="shareToInstagram()" class="btn-sns btn-sns-insta" style="font-size: 0.8em; padding: 8px 12px;">
                    <i class="fa-brands fa-instagram"></i> Copy
                </button>
                <button onclick="document.getElementById('aiAdviceModal').style.display='none'" class="btn-sns" style="background-color: #777; font-size: 0.8em; padding: 8px 12px;">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ ã‚’éåŒæœŸã§èª­ã¿è¾¼ã‚€é–¢æ•°
    function loadTrainingForm(type, date) {
        let url = '';
        if (type === 'WEIGHT') {
            url = /*[[@{/training-log/form/weight}]]*/ '/training-log/form/weight';
        } else if (type === 'CARDIO') {
            url = /*[[@{/training-log/form/cardio}]]*/ '/training-log/form/cardio';
        } else if (type === 'BODY_WEIGHT') {
            url = /*[[@{/training-log/form/body-weight}]]*/ '/training-log/form/body-weight';
        }
        url += '?date=' + date;

        fetch(url)
            .then(response => response.text())
            .then(html => {
                document.getElementById('formContainer').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('formContainer').innerHTML = '<p class="error-message">ãƒ•ã‚©ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                console.error('Form load error:', error);
            });
    }

    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
    function openLogModal(dateString, isLogged) {
        const [year, month, day] = dateString.split('-');
        const displayDate = `${year}å¹´${month}æœˆ${day}æ—¥`;
        
        // æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('selectedDateInput').value = dateString;
        document.getElementById('modalDateTitle').innerText = displayDate;
        
        const modal = document.getElementById('logModal');
        const trainingTypeSelect = document.getElementById('trainingType');
        const formContainer = document.getElementById('formContainer');

        // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        trainingTypeSelect.value = 'WEIGHT';
        formContainer.innerHTML = '<p>ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>';
        loadTrainingForm('WEIGHT', dateString);

        // è¨˜éŒ²æ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        const logViewArea = document.getElementById('logViewArea');
        if (isLogged) {
            logViewArea.innerHTML = '<p style="font-weight: 700; color: var(--primary-color); margin-bottom: 10px;">âœ… ã“ã®æ—¥ã¯è¨˜éŒ²æ¸ˆã¿ã§ã™ã€‚æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ ã™ã‚‹ã‹ã€å…¨è¨˜éŒ²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
        } else {
            logViewArea.innerHTML = '<p style="color: #999; margin-bottom: 10px;">ã“ã®æ—¥ã¯ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }

        modal.classList.add('is-active');
    }

    // è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeLogModal() {
        const modal = document.getElementById('logModal');
        modal.classList.remove('is-active');
        
        // ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('formContainer').innerHTML = '<p>ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>';
        document.getElementById('trainingType').value = 'WEIGHT'; 
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹å‡¦ç†
    window.onclick = function(event) {
        const modal = document.getElementById('logModal');
        const adviceModal = document.getElementById('aiAdviceModal');
        
        if (modal && modal.classList.contains('is-active') && event.target === modal) {
            closeLogModal();
        }
        // AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
        if (adviceModal && event.target === adviceModal) {
            adviceModal.style.display = 'none';
        }
    }

    // ----------------------------------------------------
    //  ç”»é¢ï¼ˆç”»åƒï¼‰ã‚·ã‚§ã‚¢æ©Ÿèƒ½
    // ----------------------------------------------------
    async function shareScreenImage() {
        const target = document.getElementById('shareTarget');
        const hideElements = target.querySelectorAll('.no-capture');
        
        // 1. ã‚­ãƒ£ãƒ—ãƒãƒ£ä¸­ã¯ãƒœã‚¿ãƒ³ãªã©ã‚’ä¸€æ™‚çš„ã«éš ã™
        hideElements.forEach(el => el.style.display = 'none');
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        const originalBtn = document.querySelector('button[onclick="shareScreenImage()"]');
        const originalText = originalBtn ? originalBtn.innerHTML : '';
        if(originalBtn) originalBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';

        try {
            // 2. html2canvasã§ç”»åƒã‚’ç”Ÿæˆ
            // scale: 2 ã«ã™ã‚‹ã¨ãã‚Œã„ãªç”»åƒã«ãªã‚Šã¾ã™
            const canvas = await html2canvas(target, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff' // èƒŒæ™¯è‰²ã‚’ç™½ã§å›ºå®š
            });

            // 3. Canvasã‚’Blobå½¢å¼ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã«å¤‰æ›
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "fitworks_training_log.png", { type: "image/png" });
                
                // 4. Web Share API (navigator.share) ã§ã‚·ã‚§ã‚¢
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'FitWorks Record',
                            text: getShareText(), // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆå–å¾—é–¢æ•°ã‚’åˆ©ç”¨
                        });
                    } catch (err) {
                        console.log('Share canceled or failed', err);
                    }
                } else {
                    // PCãªã©Web Share APIéå¯¾å¿œã®å ´åˆã¯ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹
                    const link = document.createElement('a');
                    link.download = 'fitworks_training_log.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    alert("ç”»åƒã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚\nSNSã‚¢ãƒ—ãƒªã‹ã‚‰æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚");
                }
                
                // å¾©å¸°å‡¦ç†
                hideElements.forEach(el => el.style.display = '');
                if(originalBtn) originalBtn.innerHTML = originalText;

            }, 'image/png');

        } catch (error) {
            console.error('Capture failed:', error);
            alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            hideElements.forEach(el => el.style.display = '');
            if(originalBtn) originalBtn.innerHTML = originalText;
        }
    }

    // ----------------------------------------------------
    //  SNSã‚·ã‚§ã‚¢æ©Ÿèƒ½ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆç”¨ï¼‰
    // ----------------------------------------------------
    function getShareText() {
        const adviceText = document.getElementById('aiAdviceText').innerText;
        return `ã€FitWorksã€‘ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†ï¼ğŸ”¥\nAIãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã€Œ${adviceText}ã€\n\n#FitWorks #ç­‹ãƒˆãƒ¬ #ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆ`;
    }

    function shareToX() {
        const text = getShareText();
        const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank');
    }

    function shareToLine() {
        const text = getShareText();
        const shareUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank');
    }

    function shareToInstagram() {
        const text = getShareText();
        navigator.clipboard.writeText(text).then(() => {
            alert("æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ğŸ“‹\nInstagramã‚’é–‹ãã¾ã™ã€‚æŠ•ç¨¿ã‚„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
            window.open('https://www.instagram.com/', '_blank');
        }).catch(err => {
            console.error('Copy failed', err);
            alert("æ–‡ç« ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n(æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„)");
            window.open('https://www.instagram.com/', '_blank');
        });
    }

    // ----------------------------------------------------
    //  ä¿å­˜ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    // ----------------------------------------------------
    document.addEventListener('submit', function(e) {
        // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿå…ƒãŒ #formContainer å†…ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
        const form = e.target;
        if (form.closest('#formContainer')) {
            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
                // äºŒé‡é€ä¿¡é˜²æ­¢ & ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                btn.disabled = true;
                const originalText = btn.textContent;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
                
                // ä¸‡ãŒä¸€ã®ãŸã‚ã«æ•°ç§’å¾Œã«æˆ»ã™ï¼ˆç”»é¢é·ç§»ã—ãªã„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ãªã©ã®å®‰å…¨ç­–ï¼‰
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 10000);
            }
        }
    });
</script>

</body>
</html>