<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トレーニング記録 | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/training-log.css}"> 
</head>
<body class="training-log-page">
<div class="main-container">
    
    <h1 style="margin-bottom: 5px;"><i class="header-icon fa-solid fa-calendar-days"></i>トレーニング記録</h1>
    <p class="sub-heading" th:text="${username} + 'さんの頑張りをチェックしましょう。'">
        トレーニング記録カレンダー
    </p>

    <div th:if="${successMessage}" class="success-message" th:text="${successMessage}"></div>
    
    <div class="calendar-nav-container">
        <a th:href="@{/training-log(year=${prevYear}, month=${prevMonth})}" class="nav-arrow">
            <i class="fa-solid fa-chevron-left"></i>
        </a>
        
        <h2 class="calendar-title" th:text="${currentYearMonth.year} + '年 ' + ${currentYearMonth.monthValue} + '月'"></h2>
        
        <a th:href="@{/training-log(year=${nextYear}, month=${nextMonth})}" class="nav-arrow">
            <i class="fa-solid fa-chevron-right"></i>
        </a>
    </div>

    <div class="calendar-grid">
        <div class="calendar-day-header" th:each="dayLabel : ${dayLabels}" th:text="${dayLabel}" 
             th:classappend="${dayLabel == '土'} ? 'sat' : ((${dayLabel == '日'} ? 'sun' : ''))">
             曜日
        </div>
        
        <th:block th:each="date : ${calendarDays}">
            <div th:with="dateNumber=${date != null ? date.dayOfMonth : ''},
                          dayOfWeek=${date != null ? date.dayOfWeek.name() : ''},
                          isToday=${date != null and date.isEqual(currentDate)},
                          isLogged=${date != null and loggedDates.containsKey(date)}"
                 class="calendar-day-cell"
                 th:classappend="${date == null} ? 'empty-day' : ((${isToday} ? 'today' : '') + 
                                                                    ((${dayOfWeek == 'SATURDAY'} ? ' sat' : '') + 
                                                                     ((${dayOfWeek == 'SUNDAY'} ? ' sun' : ''))))"
                 th:attr="data-date=${date != null ? date.toString() : ''}"
                 th:onclick="${date != null} ? 'openLogModal(this.getAttribute(\'data-date\'), ' + ${isLogged} + ')' : ''">

                <span class="day-number" th:text="${dateNumber}">1</span>
                
                <span th:if="${isLogged}" class="log-indicator">
                    <i class="fa-solid fa-star"></i>
                </span>
            </div>
        </th:block>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLogModal()">&times;</span>
        <h2 id="modalDateTitle" class="modal-title"></h2>
        
        <div id="logViewArea">
             </div>

        <p class="modal-instruction">新しい記録を追加：</p>
        
        <div class="form-group">
            <label for="trainingType">トレーニングの種類:</label>
            <select id="trainingType" class="form-control" onchange="loadTrainingForm(this.value, document.getElementById('selectedDateInput').value)">
                <option value="WEIGHT">フリーウェイト (筋トレ)</option>
                <option value="CARDIO">有酸素運動 (ランニングなど)</option>
            </select>
        </div>
        
        <div id="formContainer">
            <input type="hidden" id="selectedDateInput" name="date" value="">
            <p>フォームを読み込んでいます...</p>
        </div>

        <button class="button secondary view-all-button" onclick="alert('全記録表示機能はまだ実装されていません。')">
            全記録を見る
        </button>
    </div>
</div>

<div style="max-width: 450px; margin: 30px auto 70px auto; padding: 0 10px;">
    <a th:href="@{/home}" class="button secondary">
        <i class="fa-solid fa-house"></i>
        <span>ホームに戻る</span>
    </a>
</div>

<script>
    // トレーニングフォームを非同期で読み込む関数
    function loadTrainingForm(type, date) {
        const url = type === 'WEIGHT' 
            ? /*[[@{/training-log/form/weight}]]*/ '/training-log/form/weight' + '?date=' + date
            : /*[[@{/training-log/form/cardio}]]*/ '/training-log/form/cardio' + '?date=' + date;

        fetch(url)
            .then(response => response.text())
            .then(html => {
                document.getElementById('formContainer').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('formContainer').innerHTML = '<p class="error-message">フォームの読み込みに失敗しました。</p>';
                console.error('Form load error:', error);
            });
    }

    // 記録モーダルを開く関数
    function openLogModal(dateString, isLogged) {
        // 日付のフォーマットを調整
        const [year, month, day] = dateString.split('-');
        const displayDate = `${year}年${month}月${day}日`;

        document.getElementById('selectedDateInput').value = dateString;
        document.getElementById('modalDateTitle').textContent = displayDate + ' の記録';
        
        // 初期フォームを読み込み (フリーウェイトから)
        document.getElementById('trainingType').value = 'WEIGHT';
        loadTrainingForm('WEIGHT', dateString); 
        
        // 記録済みメッセージの表示切り替え（簡易版）
        const logViewArea = document.getElementById('logViewArea');
        if (isLogged) {
            logViewArea.innerHTML = '<p style="font-weight: 700; color: var(--primary-color); margin-bottom: 10px;">✅ この日は記録済みです。新しい記録を追加するか、全記録を確認してください。</p>';
        } else {
            logViewArea.innerHTML = '<p style="color: #999; margin-bottom: 10px;">この日はまだ記録がありません。</p>';
        }

        document.getElementById('logModal').style.display = 'block';
    }

    // 記録モーダルを閉じる関数
    function closeLogModal() {
        document.getElementById('logModal').style.display = 'none';
        document.getElementById('formContainer').innerHTML = '<p>フォームを読み込んでいます...</p>';
    }

    // モーダル外クリックで閉じる処理
    window.onclick = function(event) {
        const modal = document.getElementById('logModal');
        if (event.target === modal) {
            closeLogModal();
        }
    }録を確認してください。</p>';
</script>

</body>
</html>





























