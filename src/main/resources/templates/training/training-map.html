<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>近くのトレーニング施設</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }
        .map-container {
            padding: 20px;
        }
        .search-status {
            margin-bottom: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<header th:replace="fragments/header :: header"></header>

<main>
    <div class="container map-container">
        <h1>近くのトレーニング施設を探す</h1>
        <p class="search-status" id="status-message">現在地を取得中です...</p>
        <div id="map"></div>
    </div>
</main>

<footer th:replace="fragments/footer :: footer"></footer>

<script>
    // MapTiler APIキー（クレカ不要で取得可能）
    const MAPTILER_KEY = "M0FirV3EG8W59d1VRG9d";

    let map;

    /** ページ読み込みで現在地取得 */
    window.onload = getLocationAndInit;

    function getLocationAndInit() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const position = {
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude
                    };
                    document.getElementById("status-message").textContent =
                        "現在地を取得しました。施設を検索中...";
                    initMap(position);
                    searchGyms(position);
                },
                () => initFallback()
            );
        } else {
            initFallback();
        }
    }

    /** 現在地取得失敗 → 東京駅 */
    function initFallback() {
        document.getElementById("status-message").textContent =
            "現在地を取得できませんでした。デフォルト位置で表示します。";
        const tokyo = { lat: 35.681236, lon: 139.767125 };
        initMap(tokyo);
        searchGyms(tokyo);
    }

    /** Leaflet + MapTiler で地図表示 */
    function initMap(position) {
        map = L.map("map").setView([position.lat, position.lon], 15);

        L.tileLayer(
            `https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
            {
                maxZoom: 19,
                attribution: "© MapTiler © OpenStreetMap contributors"
            }
        ).addTo(map);

        // 現在地マーカー
        L.marker([position.lat, position.lon], {
            title: "あなたの現在地"
        }).addTo(map);
    }

    /** Overpass API を使ってジムを検索 */
    function searchGyms(position) {
        const radius = 3000; // 半径3km（必要なら拡大可）

        // Overpass クエリ
        const query = `
            [out:json][timeout:25];
            (
              node["leisure"="fitness_centre"](around:${radius}, ${position.lat}, ${position.lon});
              node["leisure"="sports_centre"](around:${radius}, ${position.lat}, ${position.lon});
              node["sport"="fitness"](around:${radius}, ${position.lat}, ${position.lon});
              node["sport"="gymnastics"](around:${radius}, ${position.lat}, ${position.lon});
              node["sport"="dance"](around:${radius}, ${position.lat}, ${position.lon});
              node["sport"="martial_arts"](around:${radius}, ${position.lat}, ${position.lon});
            );
            out body;
        `;

        fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: query
        })
            .then((res) => res.json())
            .then((data) => {
                document.getElementById("status-message").textContent =
                    `${data.elements.length} 件のトレーニング施設が見つかりました`;
                addGymsToMap(data.elements);
            })
            .catch(() => {
                document.getElementById("status-message").textContent =
                    "施設検索中にエラーが発生しました。";
            });
    }

    /** 取得したジムを地図に追加 */
    function addGymsToMap(gyms) {
        gyms.forEach((gym) => {
            const lat = gym.lat;
            const lon = gym.lon;
            const name = gym.tags?.name || "名称不明の施設";

            L.marker([lat, lon]).addTo(map).bindPopup(`<b>${name}</b>`);
        });
    }
</script>

</body>
</html>



