<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>è¿‘ãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­</title>
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <style>
        /* åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 500px; /* åœ°å›³ã®é«˜ã•ã¯é©å®œèª¿æ•´ã—ã¦ãã ã•ã„ */
            width: 100%;
            margin-top: 20px;
        }
        .map-container {
            padding: 20px;
        }
        .search-status {
            margin-bottom: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header th:replace="fragments/header :: header"></header>

    <main>
        <div class="container map-container">
            <h1>è¿‘ãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ã‚’æ¢ã™</h1>

            <p class="search-status" id="status-message">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­ã§ã™...</p>

            <div id="map"></div>
        </div>
    </main>

    <footer th:replace="fragments/footer :: footer"></footer>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDgRmpnY4uXBsJJxn7csvq-4f7Rc2khd0&libraries=places" defer></script>

    <script>
        // ğŸŒŸ ä¿®æ­£ç‚¹ 2: ä¸è¦ã«ãªã£ãŸAPI_KEYã®å®šç¾©ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ ğŸŒŸ

        let map;
        let infoWindow;
        const statusMessage = document.getElementById('status-message');

        /**
         * åœ°å›³ã‚’åˆæœŸåŒ–
         * @param {Object} position - {lat: number, lng: number} ç¾åœ¨åœ°ã®ç·¯åº¦çµŒåº¦
         */
        function initMap(position) {
            map = new google.maps.Map(document.getElementById("map"), {
                center: position,
                zoom: 15, // åˆæœŸã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
            });

            // ç¾åœ¨åœ°ã®ãƒãƒ¼ã‚«ãƒ¼
            new google.maps.Marker({
                position: position,
                map: map,
                title: "ã‚ãªãŸã®ç¾åœ¨åœ°",
                icon: { // ç¾åœ¨åœ°ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³
                    url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            // è¿‘ãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ã‚’æ¤œç´¢
            searchNearbyPlaces(position);
        }

        /**
         * Places API ã‚’ä½¿ç”¨ã—ã¦è¿‘ãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ã‚’æ¤œç´¢
         * @param {Object} location - {lat: number, lng: number} æ¤œç´¢ä¸­å¿ƒã®ç·¯åº¦çµŒåº¦
         */
        function searchNearbyPlaces(location) {
            const request = {
                location: location,
                radius: '2000', // æ¤œç´¢ç¯„å›² (ãƒ¡ãƒ¼ãƒˆãƒ«), ä¾‹: 2km
                type: ['gym'], // ä½“è‚²é¤¨ã‚„ã‚¸ãƒ ãªã©ã®ã‚¿ã‚¤ãƒ—
                keyword: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ | ã‚¸ãƒ  | ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹', // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            };

            infoWindow = new google.maps.InfoWindow();
            const service = new google.maps.places.PlacesService(map);

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    statusMessage.textContent = `${results.length}ä»¶ã®è¿‘ãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`;
                    for (let i = 0; i < results.length; i++) {
                        createMarker(results[i]);
                    }
                } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    statusMessage.textContent = "è¿‘ãã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                } else {
                    statusMessage.textContent = `æ–½è¨­æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${status}`;
                    console.error('Nearby search failed:', status);
                }
            });
        }

        /**
         * åœ°å›³ä¸Šã«æ–½è¨­ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
         * @param {Object} place - Places API ã®æ¤œç´¢çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function createMarker(place) {
            if (!place.geometry || !place.geometry.location) return;

            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name
            });

            google.maps.event.addListener(marker, "click", () => {
                const content = `
                    <strong>${place.name}</strong><br>
                    ${place.vicinity || 'ä½æ‰€ä¸æ˜'}<br>
                    ${place.rating ? 'è©•ä¾¡: ' + place.rating : ''}
                `;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
        }

        /**
         * ãƒ–ãƒ©ã‚¦ã‚¶ã®Geolocation API ã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨åœ°ã‚’å–å¾—
         */
        function getLocationAndInitMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        statusMessage.textContent = "ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸã€‚æ–½è¨­ã‚’æ¤œç´¢ä¸­...";
                        initMap(pos);
                    },
                    () => {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½ç½®æƒ…å ±ã®å–å¾—ã‚’æ‹’å¦ã—ãŸå ´åˆã‚„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
                        handleLocationError(true);
                    }
                );
            } else {
                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒGeolocationã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆ
                handleLocationError(false);
            }
        }

        /**
         * ä½ç½®æƒ…å ±å–å¾—æ™‚ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
         * @param {boolean} browserHasGeolocation - ãƒ–ãƒ©ã‚¦ã‚¶ãŒGeolocationã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹
         */
        function handleLocationError(browserHasGeolocation) {
            statusMessage.textContent = browserHasGeolocation
                ? "ã‚¨ãƒ©ãƒ¼: ç¾åœ¨åœ°ã®å–å¾—ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
                : "ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚";

            // ã‚¨ãƒ©ãƒ¼æ™‚ã€ä»£ã‚ã‚Šã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ï¼ˆä¾‹: æ±äº¬é§…ï¼‰ã‚’è¡¨ç¤º
            const defaultPos = { lat: 35.681236, lng: 139.767125 };
            initMap(defaultPos);
        }

        // Google Maps APIã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
        window.onload = getLocationAndInitMap;
    </script>
</body>
</html>