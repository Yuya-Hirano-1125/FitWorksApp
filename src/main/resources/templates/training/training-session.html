<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${trainingTitle}"></title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700;900&family=M+PLUS+Rounded+1c:wght@500;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script th:src="@{/js/theme.js}"></script>
    
    <style>
        /* ==========================================================================
           üåå BACKGROUND & THEME
           ========================================================================== */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.9);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #00f2fe;
            --text-color: #333;
        }

        body {
            margin: 0; padding: 0;
            background-color: #f0f8ff;
            min-height: 100vh;
            font-family: 'M PLUS Rounded 1c', 'Noto Sans JP', sans-serif;
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .interactive-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1);
            background-size: 400% 400%; animation: auroraFlow 20s ease infinite;
        }
        @keyframes auroraFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatOrb 30s infinite alternate ease-in-out; z-index: 0; }
        .orb-1 { width: 60vh; height: 60vh; background: #a18cd1; top: -10%; left: -10%; }
        .orb-2 { width: 50vh; height: 50vh; background: #00f2fe; bottom: -10%; right: -10%; animation-delay: -5s; }
        
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; mix-blend-mode: screen; }
        .bg-cloud { position: absolute; background: #fff; border-radius: 50%; filter: blur(30px); opacity: 0.8; z-index: 2; pointer-events: none; }
        .cloud-1 { top: 5%; left: 5%; width: 300px; height: 300px; animation: floatCloud 25s infinite alternate ease-in-out; }
        .cloud-2 { bottom: 10%; right: -5%; width: 400px; height: 400px; animation: floatCloud 30s infinite alternate-reverse ease-in-out; }
        @keyframes floatCloud { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, -20px); } }
        @keyframes floatOrb { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 30px) scale(1.1); } }

        /* ==========================================================================
           üèó MAIN LAYOUT
           ========================================================================== */
        .main-container {
            max-width: 800px; width: 92%; margin: 40px auto 100px; padding: 30px 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 40px;
            border: 2px solid #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.5);
            position: relative; z-index: 10;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .session-header { 
            text-align: center; 
            margin-bottom: 30px; 
            position: relative; 
            padding: 0 40px;
        }
        .session-title {
            font-size: 1.8rem; font-weight: 900; margin: 0;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(100, 181, 246, 0.3);
            letter-spacing: 1px; line-height: 1.2;
        }
        .session-subtitle { font-size: 0.9rem; color: #666; font-weight: 700; margin-top: 5px; }

        /* Êàª„Çã„Éú„Çø„É≥ */
        .back-arrow-button {
            position: absolute; top: 25px; left: 20px;
            width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border: 2px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            text-decoration: none; color: #555; font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 100;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .back-arrow-button:hover { transform: scale(1.1); color: #4facfe; box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3); }
        
        @media (max-width: 600px) {
            .back-arrow-button { width: 45px; height: 45px; font-size: 1.2rem; top: 20px; left: 15px; }
            .session-header { padding-top: 50px; padding-left: 0; padding-right: 0; }
        }

        /* „Çø„Ç§„Éû„Éº & „Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅÂÖ±ÈÄö */
        .timer-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;
        }
        @media (max-width: 600px) { .timer-grid { grid-template-columns: 1fr; } }

        .timer-widget, .stopwatch-widget {
            border-radius: 25px; padding: 20px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 3px solid rgba(255,255,255,0.2);
            position: relative; overflow: hidden; color: #fff;
        }
        
        /* „Ç§„É≥„Çø„Éº„Éê„É´„Çø„Ç§„Éû„Éº (ÈªíËÉåÊôØ) */
        .timer-widget {
            background: #2d3436; 
            border-color: #636e72;
        }
        .timer-widget::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4);
        }

        /* „Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅÔºàÁôΩËÉåÊôØ„ÉªÈªíÊñáÂ≠óÔºâ */
        .stopwatch-widget {
            background: #ffffff;
            border-color: #dfe6e9;
            color: #2d3436;
        }
        .stopwatch-widget::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, #0984e3, #74b9ff);
        }
        .stopwatch-widget .widget-label { color: #636e72; }
        .stopwatch-widget .timer-display { color: #2d3436; text-shadow: none; }
        .stopwatch-widget .btn-reset { background: #dfe6e9; color: #636e72; }

        .widget-label { font-size: 0.8rem; font-weight: 800; letter-spacing: 1px; opacity: 0.9; margin-bottom: 5px; text-transform: uppercase; }
        
        .timer-display {
            font-family: 'Poppins', monospace; font-size: 2.8rem; font-weight: 700;
            letter-spacing: 2px; margin: 5px 0; text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .timer-controls { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-timer {
            padding: 8px 16px; border-radius: 15px; border: none; font-weight: 700; cursor: pointer;
            transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn-timer:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-start { background: #00b894; color: white; flex: 2; justify-content: center; }
        .btn-stop { background: #d63031; color: white; flex: 2; justify-content: center; }
        .btn-reset { background: rgba(255,255,255,0.2); color: white; flex: 1; justify-content: center; }

        .timer-input-group { display: flex; justify-content: center; align-items: center; gap: 5px; margin-bottom: 5px; color: #dfe6e9; font-size: 0.85rem; }
        .timer-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); color: white; width: 45px; text-align: center; border-radius: 8px; padding: 4px; font-weight: bold; }

        /* „Éï„Ç©„Éº„É† */
        .form-section {
            background: #fff; border-radius: 25px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #eee;
        }
        .section-heading {
            font-size: 1.2rem; font-weight: 800; color: #333; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between; /* Â∑¶Âè≥ÈÖçÁΩÆ */
            gap: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;
        }
        .section-heading i { color: #a18cd1; }

        /* Ëá™Èáç„É¢„Éº„Éâ„Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ */
        .bodyweight-toggle {
            display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 700; color: #555;
        }
        .switch {
            position: relative; display: inline-block; width: 40px; height: 22px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(18px); }

        .set-row-card {
            display: flex; align-items: center; gap: 10px;
            background: #f8f9fa; border: 2px solid #eee;
            padding: 12px; border-radius: 15px; margin-bottom: 12px; transition: all 0.2s;
        }
        .set-row-card:focus-within { border-color: #a18cd1; background: #fff; box-shadow: 0 5px 15px rgba(161, 140, 209, 0.2); }
        
        /* Ëá™Èáç„É¢„Éº„ÉâÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .set-row-card.bodyweight-mode .weight-group { display: none; }
        .set-row-card.bodyweight-mode .rep-group { flex: 2; } /* ÂõûÊï∞Ê¨Ñ„ÇíÂ∫É„Åí„Çã */
        
        .set-num {
            background: #333; color: #fff; width: 28px; height: 28px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: 800; font-size: 0.8rem; flex-shrink: 0;
        }
        .input-group { flex: 1; position: relative; }
        .input-group input {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd;
            font-size: 1.1rem; font-weight: bold; text-align: center; color: #333;
            background: #fff; box-sizing: border-box;
        }
        .input-group input:focus { outline: none; border-color: #a18cd1; }
        .unit-label {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            color: #999; font-size: 0.8rem; font-weight: 700; pointer-events: none;
        }
        .btn-remove { color: #ff7675; cursor: pointer; padding: 5px; transition: 0.2s; font-size: 1.1rem; }
        .btn-remove:hover { color: #d63031; transform: scale(1.2); }

        .btn-add-set {
            width: 100%; padding: 12px; border: 2px dashed #b2bec3;
            background: #f0f0f0; color: #636e72; border-radius: 15px;
            font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-add-set:hover { background: #dfe6e9; border-color: #636e72; color: #333; }

        .memo-area {
            width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #eee;
            background: #fdfdfd; font-family: inherit; font-size: 1rem; color: #333;
            resize: vertical; min-height: 80px; box-sizing: border-box; margin-top: 10px;
        }
        .memo-area:focus { outline: none; border-color: #a18cd1; background: #fff; }

        .btn-finish {
            width: 100%; padding: 18px; margin-top: 25px;
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: #fff; border: none; border-radius: 30px;
            font-size: 1.2rem; font-weight: 900; letter-spacing: 1px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0, 176, 155, 0.3);
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .btn-finish:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0, 176, 155, 0.4); }
        .btn-finish:active { transform: scale(0.98); }

        .ai-camera-section { margin-bottom: 25px; text-align: center; }
        .btn-ai-camera {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 25px; border-radius: 25px;
            font-weight: 800; cursor: pointer; box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
            display: inline-flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn-ai-camera:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(118, 75, 162, 0.5); }
        
        #ai-verification-container {
            margin-top: 15px; border-radius: 15px; overflow: hidden;
            border: 3px solid #764ba2; background: #000; position: relative; display: none;
        }
        #ai-status-overlay {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7);
            color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold;
        }
        #ai-rep-counter-overlay {
            position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7);
            color: #00e676; padding: 5px 15px; border-radius: 5px; font-size: 1.5rem; font-weight: 900;
        }

        @media (max-width: 600px) {
            .main-container { padding: 20px 15px; width: 95%; margin-top: 40px; }
            .session-title { font-size: 1.5rem; }
            .timer-display { font-size: 2.8rem; }
            .set-row-card { gap: 8px; padding: 10px; }
            .input-group input { font-size: 1rem; padding: 10px; }
        }
    </style>
</head>
<body>

    <div class="interactive-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <canvas id="bg-canvas"></canvas>
        <div class="bg-cloud cloud-1"></div>
        <div class="bg-cloud cloud-2"></div>
    </div>

    <div class="main-container">
        
        <a th:href="@{/training}" class="back-arrow-button" title="Êàª„Çã">
            <i class="fa-solid fa-arrow-left"></i>
        </a>

        <header class="session-header">
            <h1 class="session-title" th:text="${trainingTitle}">„Éà„É¨„Éº„Éã„É≥„Ç∞</h1>
            <p class="session-subtitle" th:if="${selectedExercise != null}">
                <i class="fa-solid fa-dumbbell"></i> <span th:text="${selectedExercise}">Á®ÆÁõÆÂêç</span>
            </p>
        </header>

        <div class="timer-grid">
            <div class="stopwatch-widget">
                <div class="widget-label"><i class="fa-solid fa-stopwatch"></i> SESSION TIME</div>
                <div id="sw-display" class="timer-display">00:00:00</div>
                <div class="timer-controls">
                    <button id="sw-start" class="btn-timer btn-start"><i class="fa-solid fa-play"></i> START</button>
                    <button id="sw-stop" class="btn-timer btn-stop" style="display:none;"><i class="fa-solid fa-pause"></i> STOP</button>
                    <button id="sw-reset" class="btn-timer btn-reset"><i class="fa-solid fa-rotate-left"></i></button>
                </div>
            </div>

            <div class="timer-widget">
                <div class="widget-label"><i class="fa-solid fa-hourglass-half"></i> INTERVAL</div>
                <div id="interval-display" class="timer-display">01:00</div>
                <div class="timer-input-group">
                    <input type="number" id="interval-minutes" class="timer-input" value="1" min="0" max="59"> ÂàÜ
                    <input type="number" id="interval-seconds" class="timer-input" value="0" min="0" max="59"> Áßí
                </div>
                <div class="timer-controls">
                    <button id="interval-start-pause" class="btn-timer btn-start"><i class="fa-solid fa-play"></i> START</button>
                    <button id="interval-reset" class="btn-timer btn-reset"><i class="fa-solid fa-rotate-left"></i></button>
                </div>
            </div>
        </div>

        <div th:if="${trainingType == 'free-weight'}" class="ai-camera-section">
            <button id="toggle-ai-camera" class="btn-ai-camera">
                <i class="fa-solid fa-robot"></i> AIËá™Âãï„Ç´„Ç¶„É≥„Éà (BETA)
            </button>
            <div id="ai-verification-container">
                <video id="input_video" style="display:none" playsinline></video>
                <canvas id="output_canvas"></canvas>
                <div id="ai-status-overlay">ÂæÖÊ©ü‰∏≠...</div>
                <div id="ai-rep-counter-overlay">0 Âõû</div>
            </div>
        </div>

        <div th:if="${trainingType == 'free-weight'}" class="form-section">
            <div class="section-heading">
                <div><i class="fa-solid fa-pen-to-square"></i> ÂÆüÁ∏æ„ÇíË®òÈå≤</div>
                
                <div class="bodyweight-toggle">
                    <span>Ëá™Èáç„Éà„É¨(ÈáçÈáè„Å™„Åó)</span>
                    <label class="switch">
                        <input type="checkbox" id="is-bodyweight">
                        <span class="slider"></span>
                    </label>
                </div>
                <span id="ai-verified-badge" style="display:none; margin-left:10px; background:#00e676; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">AIË®àÊ∏¨‰∏≠</span>
            </div>

            <form th:action="@{/training/log/save}" method="post" id="weight-form" onsubmit="return validateTrainingForm(this);">
                <input type="hidden" name="date" th:value="${today}">
                <input type="hidden" name="type" value="WEIGHT">
                <input type="hidden" name="exerciseName" th:value="${selectedExercise}">
                <input type="hidden" name="duration" id="hidden-duration-weight">
                
                <div id="sets-container"></div>

                <button type="button" id="add-set-btn" class="btn-add-set">
                    <i class="fa-solid fa-plus-circle"></i> „Çª„ÉÉ„Éà„ÇíËøΩÂä†
                </button>

                <div style="margin-top: 25px;">
                    <label style="font-weight: 700; color: #555; display:block; margin-bottom:5px;">
                        <i class="fa-regular fa-comment-dots"></i> „É°„É¢„ÉªÊÑüÊÉ≥
                    </label>
                    <textarea name="memo" id="weight-memo" class="memo-area" placeholder="Ë™øÂ≠ê„ÅØ„Å©„ÅÜ„Å†„Å£„ÅüÔºüÈáçÈáè„ÅÆÊÑüË¶ö„ÅØÔºü"></textarea>
                </div>
                
                <button type="submit" class="btn-finish">
                    Ë®òÈå≤„Åó„Å¶ÁµÇ‰∫Ü <i class="fa-solid fa-check"></i>
                </button>
            </form>
        </div>

        <div th:if="${trainingType == 'cardio'}" class="form-section">
            <div class="section-heading">
                <i class="fa-solid fa-person-running"></i> ÊúâÈÖ∏Á¥†ÈÅãÂãï
            </div>
            
            <div style="background: #f0f8ff; border: 1px dashed #4facfe; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                <div id="gps-status" style="color:#0288d1; font-weight:800; margin-bottom:10px;">
                    <i class="fa-solid fa-location-dot"></i> GPSÊú™Ë®àÊ∏¨
                </div>
                <button type="button" id="toggle-gps" class="btn-ai-camera" style="font-size:0.9rem; padding:8px 20px;">
                    <i class="fa-solid fa-play"></i> Ë®àÊ∏¨ÈñãÂßã
                </button>
            </div>

            <form th:action="@{/training/log/save}" method="post" id="cardio-form" onsubmit="return validateTrainingForm(this);">
                <input type="hidden" name="date" th:value="${today}">
                <input type="hidden" name="type" value="CARDIO">
                <input type="hidden" name="exerciseName" th:value="${selectedExercise}">
                
                <div class="set-row-card">
                    <div class="set-num"><i class="fa-regular fa-clock"></i></div>
                    <div class="input-group">
                        <input type="number" name="duration" id="cardio-duration" placeholder="0" required>
                        <span class="unit-label">ÂàÜ</span>
                    </div>
                </div>
                <div class="set-row-card">
                    <div class="set-num"><i class="fa-solid fa-route"></i></div>
                    <div class="input-group">
                        <input type="number" name="distance" id="cardio-distance" step="0.1" placeholder="0.0">
                        <span class="unit-label">km</span>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <label style="font-weight: 700; color: #555; display:block; margin-bottom:5px;">
                        <i class="fa-regular fa-comment-dots"></i> „É°„É¢„ÉªÊÑüÊÉ≥
                    </label>
                    <textarea name="memo" id="cardio-memo" class="memo-area" placeholder="„Ç≥„Éº„Çπ„ÅÆÁä∂Ê≥Å„ÇÑÊÑüÊÉ≥„ÇíË®òÈå≤..."></textarea>
                </div>
                
                <button type="submit" class="btn-finish">
                    Ë®òÈå≤„Åó„Å¶ÁµÇ‰∫Ü <i class="fa-solid fa-check"></i>
                </button>
            </form>
        </div>

        <div th:if="${trainingType == 'myset'}" class="form-section">
            <div class="section-heading">
                <i class="fa-solid fa-list-check"></i> „Éû„Ç§„Çª„ÉÉ„Éà‰∏ÄÊã¨Ë®òÈå≤
            </div>
            
            <form th:action="@{/training-log/save-batch}" method="post" onsubmit="return validateTrainingForm(this);">
                <input type="hidden" name="recordDate" th:value="${today}">
                
                <div th:each="exName, stat : ${mySetExercises}" style="background: #fdfdfd; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                    
                    <div th:if="${#lists.contains(cardioList, exName)}">
                        <h4 style="margin:0 0 10px; color:#4facfe;">
                            <i class="fa-solid fa-person-running"></i> <span th:text="${exName}">Run</span>
                        </h4>
                        <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                        <input type="hidden" th:name="|logs[${stat.index}].type|" value="CARDIO">
                        <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                        
                        <div class="set-row-card">
                            <div class="input-group">
                                <input type="number" th:name="|logs[${stat.index}].durationMinutes|" class="batch-duration-input" placeholder="ÊôÇÈñì">
                                <span class="unit-label">ÂàÜ</span>
                            </div>
                            <div class="input-group">
                                <input type="number" th:name="|logs[${stat.index}].distanceKm|" step="0.1" placeholder="Ë∑ùÈõ¢">
                                <span class="unit-label">km</span>
                            </div>
                        </div>
                        <textarea th:name="|logs[${stat.index}].memo|" class="memo-area batch-memo-area" style="min-height:50px; margin-top:5px;" placeholder="„É°„É¢..."></textarea>
                    </div>

                    <div th:unless="${#lists.contains(cardioList, exName)}">
                        <h4 style="margin:0 0 10px; color:#6a11cb;">
                            <i class="fa-solid fa-dumbbell"></i> <span th:text="${exName}">Bench Press</span>
                        </h4>
                        <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                        <input type="hidden" th:name="|logs[${stat.index}].type|" value="WEIGHT">
                        <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                        
                        <div th:id="|batch-sets-container-${stat.index}|">
                            </div>
                        
                        <button type="button" class="btn-add-set" style="padding: 8px; font-size: 0.9rem;" th:onclick="|addBatchSetRow(${stat.index})|">
                            <i class="fa-solid fa-plus"></i> ËøΩÂä†
                        </button>
                        
                        <textarea th:name="|logs[${stat.index}].memo|" class="memo-area batch-memo-area" style="min-height:50px; margin-top:10px;" placeholder="„É°„É¢..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn-finish">
                    ‰∏ÄÊã¨Ë®òÈå≤„Åó„Å¶ÁµÇ‰∫Ü <i class="fa-solid fa-check"></i>
                </button>
            </form>
        </div>

        <div th:if="${trainingType == 'ai-suggested'}" class="form-section">
            <div class="section-heading"><i class="fa-solid fa-wand-magic-sparkles"></i> FitBotÊèêÊ°à„É°„Éã„É•„Éº</div>
            <ul style="list-style: none; padding: 0;">
                <li th:each="program : ${programList}" style="padding: 10px 0; border-bottom: 1px dashed #eee; font-weight: bold; color: #555;">
                    <i class="fa-solid fa-check-circle" style="color: #00b894; margin-right: 8px;"></i>
                    <span th:text="${program}">„É°„Éã„É•„Éº</span>
                </li>
            </ul>
            <div style="margin-top: 20px; font-weight: bold; text-align: center; color: #666;">
                ÁõÆÊ®ôÊôÇÈñì: <span th:text="${targetTime}" style="color:#00b894; font-size:1.2rem;"></span>ÂàÜ / 
                ‰ºëÊÜ©: <span th:text="${restTime}" style="color:#0984e3; font-size:1.2rem;"></span>Áßí
            </div>
            <a th:href="@{/training-log}" class="btn-finish" style="display:block; text-align:center; text-decoration:none;">
                „Çª„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü
            </a>
        </div>

    </div>

    <script>
        // ËÉåÊôØ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 1; this.speedX = Math.random() * 1 - 0.5; this.speedY = Math.random() * 1 - 0.5;
            }
            update() { this.x+=this.speedX; this.y+=this.speedY; if(this.size>0.2) this.size-=0.01; }
            draw() { ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
        }
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if(particles.length<50) particles.push(new Particle());
            for(let i=0; i<particles.length; i++){
                particles[i].update(); particles[i].draw();
                if(particles[i].size<=0.2){ particles.splice(i,1); i--; }
            }
            requestAnimationFrame(animate);
        }
        animate();
    </script>

    <script th:inline="javascript">
        let sessionStartTime = Date.now();
        
        // --- „Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅÊ©üËÉΩ ---
        let stopwatchInterval = null;
        let stopwatchElapsed = 0; // ms
        let stopwatchRunning = false;
        let stopwatchStartTime = 0;

        function updateStopwatchDisplay() {
            const display = document.getElementById('sw-display');
            if(!display) return;
            
            let totalMs = stopwatchElapsed;
            if (stopwatchRunning) {
                const now = Date.now();
                totalMs += (now - stopwatchStartTime);
            }
            
            const hours = Math.floor(totalMs / 3600000);
            const minutes = Math.floor((totalMs % 3600000) / 60000);
            const seconds = Math.floor((totalMs % 60000) / 1000);
            
            display.textContent = 
                String(hours).padStart(2,'0') + ':' + 
                String(minutes).padStart(2,'0') + ':' + 
                String(seconds).padStart(2,'0');
        }

        // --- „Ç§„É≥„Çø„Éº„Éê„É´Ë®òÈå≤Áî® ---
        let totalIntervalTime = 0; // ms
        let intervalTimerStart = 0;

        document.addEventListener('DOMContentLoaded', () => {
            // „Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅ „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            const swStart = document.getElementById('sw-start');
            const swStop = document.getElementById('sw-stop');
            const swReset = document.getElementById('sw-reset');

            if(swStart) {
                swStart.addEventListener('click', () => {
                    stopwatchRunning = true;
                    stopwatchStartTime = Date.now();
                    stopwatchInterval = setInterval(updateStopwatchDisplay, 100);
                    swStart.style.display = 'none';
                    swStop.style.display = 'flex';
                });
            }
            if(swStop) {
                swStop.addEventListener('click', () => {
                    stopwatchRunning = false;
                    stopwatchElapsed += Date.now() - stopwatchStartTime;
                    clearInterval(stopwatchInterval);
                    updateStopwatchDisplay(); 
                    swStop.style.display = 'none';
                    swStart.style.display = 'flex';
                });
            }
            if(swReset) {
                swReset.addEventListener('click', () => {
                    stopwatchRunning = false;
                    clearInterval(stopwatchInterval);
                    stopwatchElapsed = 0;
                    updateStopwatchDisplay();
                    swStop.style.display = 'none';
                    swStart.style.display = 'flex';
                });
            }

            // „Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
            const formatTime = (ms) => {
                const s = Math.floor((ms/1000)%60);
                const m = Math.floor(ms/60000);
                return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            };

            // ‚òÖËá™Èáç„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„É≠„Ç∏„ÉÉ„ÇØ
            const bodyweightSwitch = document.getElementById('is-bodyweight');
            
            // Ë°å„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
            const updateRowVisibility = () => {
                const isBodyweight = bodyweightSwitch ? bodyweightSwitch.checked : false;
                const rows = document.querySelectorAll('.set-row-card');
                rows.forEach(row => {
                    const weightInput = row.querySelector('input[name*="weight"]');
                    if (isBodyweight) {
                        row.classList.add('bodyweight-mode');
                        if(weightInput) {
                            // Ëá™Èáç„É¢„Éº„Éâ„Å™„Çâ0„ÇíÂÖ•„Çå„Å¶„Åä„ÅèÔºàÈÄÅ‰ø°ÊôÇ„ÅÆ„Ç®„É©„ÉºÂõûÈÅøÔºâ
                            if(weightInput.value === '') weightInput.value = 0;
                        }
                    } else {
                        row.classList.remove('bodyweight-mode');
                        // ÂÖÉ„Å´Êàª„Åó„ÅüÊôÇ„Å´0„ÅåÂÖ•„Å£„Å¶„Åü„ÇâÁ©∫„Å´„Åô„ÇãÁ≠â„ÅÆÂá¶ÁêÜ„ÅØ„ÅäÂ•Ω„Åø„Åß
                    }
                });
            };

            if(bodyweightSwitch) {
                bodyweightSwitch.addEventListener('change', updateRowVisibility);
            }

            // „Çª„ÉÉ„ÉàËøΩÂä†„É≠„Ç∏„ÉÉ„ÇØ („Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´)
            const setsContainer = document.getElementById('sets-container');
            const addSetBtn = document.getElementById('add-set-btn');
            
            if (setsContainer && addSetBtn) {
                let setCounter = 0;
                const addSetRow = (w='', r='') => {
                    setCounter++;
                    const div = document.createElement('div');
                    // Ëá™Èáç„É¢„Éº„Éâ„Å™„ÇâÂàùÊúü„ÇØ„É©„Çπ„Çí‰ªò‰∏é
                    const isBodyweight = bodyweightSwitch ? bodyweightSwitch.checked : false;
                    div.className = isBodyweight ? 'set-row-card bodyweight-mode' : 'set-row-card';
                    
                    div.innerHTML = `
                        <div class="set-num">${setCounter}</div>
                        <div class="input-group weight-group">
                            <input type="number" name="weights" step="0.5" placeholder="0" value="${w}">
                            <span class="unit-label">kg</span>
                        </div>
                        <div class="input-group rep-group">
                            <input type="number" name="repsList" class="ai-rep-target" placeholder="0" value="${r}">
                            <span class="unit-label">Âõû</span>
                        </div>
                        <i class="fa-solid fa-trash btn-remove" onclick="this.parentElement.remove()"></i>
                    `;
                    setsContainer.appendChild(div);
                };
                addSetRow(); addSetRow(); addSetRow();
                addSetBtn.addEventListener('click', () => addSetRow());
            }

            // „Éê„ÉÉ„ÉÅË®òÈå≤Áî®„Çª„ÉÉ„ÉàËøΩÂä†
            window.addBatchSetRow = function(exIdx) {
                const container = document.getElementById(`batch-sets-container-${exIdx}`);
                const idx = container.children.length;
                const div = document.createElement('div');
                div.className = 'set-row-card';
                div.innerHTML = `
                    <div class="set-num">${idx+1}</div>
                    <div class="input-group weight-group">
                        <input type="number" name="logs[${exIdx}].setList[${idx}].weight" step="0.5" placeholder="kg">
                    </div>
                    <div class="input-group rep-group">
                        <input type="number" name="logs[${exIdx}].setList[${idx}].reps" placeholder="Âõû">
                    </div>
                    <i class="fa-solid fa-trash btn-remove" onclick="this.parentElement.remove()"></i>
                `;
                container.appendChild(div);
            }
            
            /*[# th:if="${trainingType == 'myset'}"]*/
            const mySetExercises = /*[[${mySetExercises}]]*/ [];
            const cardioList = /*[[${cardioList}]]*/ []; 
            if(mySetExercises) {
                mySetExercises.forEach((ex, i) => {
                    if(!cardioList.includes(ex)) addBatchSetRow(i);
                });
            }
            /*[/]*/

            // „Ç§„É≥„Çø„Éº„Éê„É´„Çø„Ç§„Éû„Éº„É≠„Ç∏„ÉÉ„ÇØ
            let timer = null;
            let remaining = 60000;
            const display = document.getElementById('interval-display');
            const btnStart = document.getElementById('interval-start-pause');
            
            const updateIntervalDisplay = () => {
                if(display) display.textContent = formatTime(remaining);
            };
            
            if(btnStart) {
                btnStart.addEventListener('click', () => {
                    if(timer) {
                        clearInterval(timer); timer = null;
                        if (intervalTimerStart > 0) {
                            totalIntervalTime += (Date.now() - intervalTimerStart);
                            intervalTimerStart = 0;
                        }
                        btnStart.innerHTML = '<i class="fa-solid fa-play"></i> START';
                        btnStart.style.background = '#00b894';
                    } else {
                        if(remaining <= 0) remaining = (document.getElementById('interval-minutes').value * 60000) + (document.getElementById('interval-seconds').value * 1000);
                        intervalTimerStart = Date.now();
                        btnStart.innerHTML = '<i class="fa-solid fa-pause"></i> STOP';
                        btnStart.style.background = '#e17055'; 
                        const end = Date.now() + remaining;
                        timer = setInterval(() => {
                            remaining = end - Date.now();
                            if(remaining <= 0) {
                                remaining = 0; clearInterval(timer); timer = null;
                                if (intervalTimerStart > 0) {
                                    totalIntervalTime += (Date.now() - intervalTimerStart);
                                    intervalTimerStart = 0;
                                }
                                alert("„Ç§„É≥„Çø„Éº„Éê„É´ÁµÇ‰∫ÜÔºÅ");
                                btnStart.innerHTML = '<i class="fa-solid fa-play"></i> START';
                                btnStart.style.background = '#00b894';
                            }
                            updateIntervalDisplay();
                        }, 100);
                    }
                });
                
                document.getElementById('interval-reset').addEventListener('click', () => {
                    if(timer) clearInterval(timer); timer = null;
                    if(intervalTimerStart > 0) {
                        totalIntervalTime += (Date.now() - intervalTimerStart);
                        intervalTimerStart = 0;
                    }
                    remaining = (document.getElementById('interval-minutes').value * 60000) + (document.getElementById('interval-seconds').value * 1000);
                    updateIntervalDisplay();
                    btnStart.innerHTML = '<i class="fa-solid fa-play"></i> START';
                    btnStart.style.background = '#00b894';
                });
            }
        });

        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÊôÇ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÔºÜÊôÇÈñì„Çª„ÉÉ„Éà
        window.validateTrainingForm = function(form) {
            // „Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅÊôÇÈñìÂèñÂæó
            let totalMs = stopwatchElapsed;
            if (stopwatchRunning) {
                totalMs += (Date.now() - stopwatchStartTime);
            }
            
            // ÊôÇÈñì„ÅÆË®àÁÆó
            const durationMinutes = Math.ceil(totalMs / 60000);
            
            // „Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÅÆË®àÁÆó
            const intervalSeconds = Math.floor(totalIntervalTime / 1000);
            const intervalMin = Math.floor(intervalSeconds / 60);
            const intervalSec = intervalSeconds % 60;
            const intervalString = `${intervalMin}ÂàÜ${intervalSec}Áßí`;

            // „É°„É¢„Å∏„ÅÆËøΩË®ò„ÉÜ„Ç≠„Çπ„Éà
            let autoLogMsg = "";
            if (durationMinutes > 0 || totalIntervalTime > 0) {
                autoLogMsg = `\n[Ëá™ÂãïË®òÈå≤] „Çª„ÉÉ„Ç∑„Éß„É≥: ${durationMinutes}ÂàÜ / „Ç§„É≥„Çø„Éº„Éê„É´: ${intervalString}`;
            }

            // Ëá™Èáç„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅÈö†„Çå„Å¶„ÅÑ„Çãinput„Å´0„ÇíÂÖ•„Çå„ÇãÂá¶ÁêÜ
            const bodyweightSwitch = document.getElementById('is-bodyweight');
            if(bodyweightSwitch && bodyweightSwitch.checked) {
                const hiddenWeights = form.querySelectorAll('.weight-group input');
                hiddenWeights.forEach(input => {
                    if(!input.value) input.value = 0;
                });
            }

            // Á≠ã„Éà„É¨Áî®„Éï„Ç©„Éº„É†
            const hiddenDuration = document.getElementById('hidden-duration-weight');
            const weightMemo = document.getElementById('weight-memo');
            if (hiddenDuration) {
                hiddenDuration.value = durationMinutes;
                if(weightMemo) weightMemo.value += autoLogMsg;
            }
            
            // ÊúâÈÖ∏Á¥†ÈÅãÂãïÁî®„Éï„Ç©„Éº„É†
            const cardioInput = document.getElementById('cardio-duration');
            const cardioMemo = document.getElementById('cardio-memo');
            if (cardioInput && (!cardioInput.value || cardioInput.value == 0)) {
                if(durationMinutes > 0) cardioInput.value = durationMinutes;
            }
            if (cardioMemo) cardioMemo.value += autoLogMsg;
            
            // „Éû„Ç§„Çª„ÉÉ„ÉàÁî®
            const batchCardioInputs = document.querySelectorAll('.batch-duration-input');
            if(batchCardioInputs.length > 0 && durationMinutes > 0) {
                batchCardioInputs.forEach(input => {
                    if(!input.value) input.value = durationMinutes; 
                });
            }
            const batchMemos = document.querySelectorAll('.batch-memo-area');
            if(batchMemos.length > 0 && autoLogMsg !== "") {
                batchMemos.forEach(memo => {
                    memo.value += autoLogMsg;
                });
            }

            // ÊôÇÈñì0„ÅÆÁ¢∫Ë™ç
            if (durationMinutes === 0 && (!cardioInput || cardioInput.value == 0)) {
                return confirm("„Éà„É¨„Éº„Éã„É≥„Ç∞ÊôÇÈñì„Åå0ÂàÜ„Åß„Åô„Åå„ÄÅË®òÈå≤„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Çπ„Éà„ÉÉ„Éó„Ç¶„Ç©„ÉÉ„ÉÅ„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅØ„ÄÅÊâãÂãï„ÅßÊôÇÈñì„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ");
            }
            return true;
        };
    </script>
</body>
</html>