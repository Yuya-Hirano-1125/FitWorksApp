<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${trainingTitle}"></title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script th:src="@{/js/theme.js}"></script>
    
    <style>
        /* ==========================================================================
           ğŸŒŒ èƒŒæ™¯ç”¨ã‚¹ã‚¿ã‚¤ãƒ«
           ========================================================================== */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f0f8ff; 
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Noto Sans JP', sans-serif;
            color: #333;
        }

        /* èƒŒæ™¯ã‚¨ãƒªã‚¢ */
        .interactive-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1);
            background-size: 400% 400%;
            animation: auroraFlow 20s ease infinite;
            overflow: hidden;
        }

        @keyframes auroraFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ã‚ªãƒ¼ãƒ– */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: floatOrb 30s infinite alternate ease-in-out;
            z-index: 0;
        }
        .orb-1 { width: 60vh; height: 60vh; background: #a18cd1; top: -10%; left: -10%; }
        .orb-2 { width: 50vh; height: 50vh; background: #00f2fe; bottom: -10%; right: -10%; animation-delay: -5s; }
        .orb-3 { width: 40vh; height: 40vh; background: #ff9a9e; top: 40%; left: 60%; animation-delay: -10s; opacity: 0.4; }

        @keyframes floatOrb {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, 30px) scale(1.1); }
        }

        /* Canvas */
        #bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
            mix-blend-mode: screen;
        }

        /* â˜ï¸ é›² */
        .bg-cloud {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.85;
            z-index: 2;
            pointer-events: none;
            box-shadow: 0 0 60px rgba(255,255,255,0.9);
        }
        .cloud-1 { top: 5%; left: 5%; width: 400px; height: 400px; animation: floatCloud 25s infinite alternate ease-in-out; }
        .cloud-2 { bottom: 5%; right: -5%; width: 550px; height: 550px; animation: floatCloud 30s infinite alternate-reverse ease-in-out; }
        .cloud-3 { top: 30%; left: 70%; width: 300px; height: 300px; opacity: 0.5; animation: breatheCloud 10s infinite alternate ease-in-out; }

        @keyframes floatCloud { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, -20px); } }
        @keyframes breatheCloud { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }

        /* ãƒã‚¦ã‚¹è¿½å¾“ãƒ©ã‚¤ãƒˆãƒ•ãƒ¬ã‚¢ */
        .mouse-flare {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(200,240,255,0.8) 30%, rgba(64,150,255,0) 70%);
            transform: translate(-50%, -50%);
            pointer-events: none;
            mix-blend-mode: screen;
            z-index: 20;
            filter: blur(15px);
            transition: transform 0.08s cubic-bezier(0.075, 0.82, 0.165, 1);
        }

        /* ==========================================================================
           ğŸ— ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ )
           ========================================================================== */
        
        .main-container {
            max-width: 800px;
            width: 95%;
            margin: 40px auto;
            padding: 40px 30px;
            
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 45px;
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 30px 60px rgba(100, 149, 237, 0.2), 
                0 0 0 2px rgba(255, 255, 255, 0.6) inset;
            
            /* ç›¸å¯¾é…ç½®ã«ã—ã¦å†…éƒ¨ã®absoluteè¦ç´ ã®åŸºæº–ã«ã™ã‚‹ */
            position: relative;
            z-index: 10;
            text-align: center;
        }

        h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 20px;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(255,255,255,0.5);
        }

        /* ==========================================================================
           â± ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
           ========================================================================== */
        
        .interval-container, .record-form-container, .myset-exercise-block, .log-placeholder {
            background: rgba(30, 30, 30, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            text-align: left;
            color: #eee;
        }

        .timer-display {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: #fff;
            margin: 10px 0 20px;
            font-family: 'Poppins', monospace;
            text-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
        }

        .button {
            padding: 15px 25px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .timer-button-primary {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #fff;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        .timer-button-secondary {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .timer-button-tertiary {
            background: rgba(255,255,255,0.1);
            color: #ccc;
            font-size: 0.9rem;
            padding: 8px 15px;
        }

        .form-label { color: #ccc; margin-bottom: 8px; font-weight: 600; }
        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }
        .form-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
            outline: none;
        }
        
        /* â˜…è¿½åŠ : ãƒ¡ãƒ¢å…¥åŠ›æ¬„ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .memo-area {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            margin-top: 5px;
        }
        .memo-area:focus {
            border-color: #4facfe;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
            outline: none;
        }

        table th { color: #aaa; font-weight: 600; padding-bottom: 10px; }
        table td { padding: 5px 0; }

        .btn-finish {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #00c853, #69f0ae);
            color: #003300;
            font-weight: 800;
            font-size: 1.2rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 200, 83, 0.3);
            transition: transform 0.2s;
            margin-top: 25px;
        }
        .btn-finish:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0, 200, 83, 0.4); }

        #ai-verification-container {
            margin-top: 20px;
            background: #000;
            border: 3px solid #00f2fe;
            border-radius: 15px;
            overflow: hidden;
            display: none;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.3);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        .control-buttons a { flex: 1; }
        .button.secondary {
            background: rgba(255,255,255,0.8);
            color: #555;
            border: 1px solid #ccc;
        }
        
        .timer-settings input {
            background: rgba(0,0,0,0.3);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-size: 1.1rem;
            width: 60px !important;
        }
        
        /* ğŸ”™ æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠå†…å·¦ä¸Šï¼‰ */
        .back-arrow-button {
            position: absolute; /* ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦çµ¶å¯¾é…ç½® */
            top: 25px;
            left: 25px;
            width: 80px;  /* å¤‰æ›´: 50px -> 80px */
            height: 80px; /* å¤‰æ›´: 50px -> 80px */
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            color: #555;
            font-size: 2.2rem; /* å¤‰æ›´: ãƒœã‚¿ãƒ³æ‹¡å¤§ã«åˆã‚ã›ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å¤§ãã */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .back-arrow-button:hover {
            transform: scale(1.1);
            background: #fff;
            color: #4facfe;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }
        
        /* ã‚¹ãƒãƒ›ç”¨èª¿æ•´ */
        @media (max-width: 600px) {
            .back-arrow-button {
                /* ã‚¹ãƒãƒ›ã§ã‚‚å¤§ãã‚ã‚’ç¶­æŒã—ã¾ã™ãŒã€å°‘ã—èª¿æ•´ */
                width: 60px; 
                height: 60px; 
                font-size: 1.5rem;
                top: 15px; 
                left: 15px;
            }
            .main-container {
                padding-top: 80px; /* ãƒœã‚¿ãƒ³ãŒé‡ãªã‚‰ãªã„ã‚ˆã†ã«ä¸Šéƒ¨ä½™ç™½ã‚’èª¿æ•´ */
            }
        }

    </style>
</head>
<body class="session-page">

<div class="interactive-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    <canvas id="bg-canvas"></canvas>
    <div id="mouse-flare" class="mouse-flare"></div>
    <div class="bg-cloud cloud-1"></div>
    <div class="bg-cloud cloud-2"></div>
    <div class="bg-cloud cloud-3"></div>
</div>

<div class="main-container">
    <a th:href="@{/training}" class="back-arrow-button" title="ä¸€ã¤æˆ»ã‚‹">
        <i class="fa-solid fa-arrow-left"></i>
    </a>

    <h1 th:text="${trainingTitle}"><i class="fa-solid fa-bolt-lightning header-icon"></i>ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</h1>

    <div class="interval-container">
        <h3 style="color: #4facfe; margin-bottom: 10px; margin-top: 0; text-align: center; font-weight:700;">
            <i class="fa-regular fa-clock"></i> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒãƒ¼
        </h3>
        <div id="interval-display" class="timer-display" style="text-align: center;">01:00</div>
        <div class="timer-settings">
            <input type="number" id="interval-minutes" value="1" min="0" max="59"> åˆ†
            <input type="number" id="interval-seconds" value="0" min="0" max="59"> ç§’
            <button id="interval-set" class="button timer-button-tertiary" style="margin-left:10px;"><i class="fa-solid fa-gear"></i> è¨­å®š</button>
        </div>
        <div class="timer-controls">
            <button id="interval-start-pause" class="button timer-button-primary" style="flex:2;"><i class="fa-solid fa-play"></i> é–‹å§‹</button>
            <button id="interval-reset" class="button timer-button-secondary" style="flex:1;"><i class="fa-solid fa-rotate-left"></i></button>
        </div>
    </div>

    <div th:if="${trainingType == 'free-weight'}" style="margin-top: 30px;">
        <button id="toggle-ai-camera" class="button" style="width: 100%; background: linear-gradient(135deg, #a18cd1, #fbc2eb); color:white; border:none; padding:15px; font-weight:800; border-radius:30px; box-shadow:0 5px 15px rgba(161, 140, 209, 0.4);">
            <i class="fa-solid fa-robot"></i> AIè‡ªå‹•ã‚«ã‚¦ãƒ³ãƒˆ (BETA)
        </button>
        <p style="font-size: 0.85em; color: #666; text-align: center; margin-top: 8px; font-weight:600;">
            â€»ã‚«ãƒ¡ãƒ©ã®å‰ã§å‹•ä½œã‚’è¡Œã†ã¨å›æ•°ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã€‚
        </p>
        
        <div id="ai-verification-container">
            <video id="input_video" style="display:none" playsinline></video>
            <canvas id="output_canvas"></canvas>
            <div id="ai-status-overlay">å¾…æ©Ÿä¸­...</div>
            <div id="ai-rep-counter-overlay">0 å›</div>
        </div>
    </div>

    <div th:if="${trainingType == 'free-weight'}" class="record-form-container">
        <h3 style="color:white; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            <i class="fa-solid fa-pen-to-square"></i> å®Ÿç¸¾ã‚’è¨˜éŒ²
            <span id="ai-verified-badge" class="verification-badge" style="background:#00c853; color:white;"><i class="fa-solid fa-check"></i> AIæ¤œçŸ¥</span>
        </h3>
        <form th:action="@{/training-log/save}" method="post" id="weight-form" onsubmit="return validateTrainingTime(this);">
            <input type="hidden" name="recordDate" th:value="${today}">
            <input type="hidden" name="type" value="WEIGHT">
            <input type="hidden" name="exerciseName" th:value="${selectedExercise}">
            
            <table style="width: 100%; color: white; border-collapse: separate; border-spacing: 0 10px;">
                <thead>
                    <tr style="color: #aaa; font-size: 0.9em;">
                        <th style="text-align: center; width: 15%;">Set</th>
                        <th style="text-align: center; width: 40%;">é‡é‡ (kg)</th>
                        <th style="text-align: center; width: 40%;">å›æ•° (Reps)</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="sets-container">
                </tbody>
            </table>

            <button type="button" id="add-set-btn" class="button secondary" style="width: 100%; margin-top: 10px; padding: 10px; font-size: 0.9em; background:rgba(255,255,255,0.1); color:white; border:1px dashed #666;">
                <i class="fa-solid fa-plus"></i> ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
            </button>

            <div style="margin-top: 20px;">
                <label class="form-label"><i class="fa-regular fa-comment-dots"></i> ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
                <textarea name="memo" class="memo-area" placeholder="é‡é‡ã®æ„Ÿè¦šã‚„ã€èª¿å­ãªã©ã‚’è¨˜éŒ²..."></textarea>
            </div>
            
            <button type="submit" class="btn-finish">
                è¨˜éŒ²ã—ã¦çµ‚äº† <i class="fa-solid fa-check"></i>
            </button>
        </form>
    </div>

    <div th:if="${trainingType == 'cardio'}" class="record-form-container">
        <h3 style="color:white; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            <i class="fa-solid fa-pen-to-square"></i> å®Ÿç¸¾ã‚’è¨˜éŒ²
        </h3>
        
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed rgba(255,255,255,0.2);">
            <div id="gps-status" class="gps-status" style="color:#4facfe; font-weight:700;"><i class="fa-solid fa-location-dot"></i> GPSæœªè¨ˆæ¸¬</div>
            <button type="button" id="toggle-gps" class="button secondary small" style="width:100%; background:rgba(255,255,255,0.1); color:white; border:none; margin-top:10px;">
                <i class="fa-solid fa-play"></i> GPSè¨ˆæ¸¬é–‹å§‹
            </button>
        </div>

        <form th:action="@{/training-log/save}" method="post" id="cardio-form" onsubmit="return validateCardio(this);">
            <input type="hidden" name="recordDate" th:value="${today}">
            <input type="hidden" name="type" value="CARDIO">
            <input type="hidden" name="cardioType" th:value="${selectedExercise}">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">æ™‚é–“</label>
                    <input type="number" name="durationMinutes" id="cardio-duration" class="form-input" placeholder="0" required>
                    <span class="unit">åˆ†</span>
                </div>
                <div class="form-group">
                    <label class="form-label">è·é›¢</label>
                    <input type="number" name="distanceKm" id="cardio-distance" class="form-input" step="0.1" placeholder="0.0">
                    <span class="unit">km</span>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <label class="form-label"><i class="fa-regular fa-comment-dots"></i> ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³</label>
                <textarea name="memo" class="memo-area" placeholder="ã‚³ãƒ¼ã‚¹ã®çŠ¶æ³ã‚„æ„Ÿæƒ³ã‚’è¨˜éŒ²..."></textarea>
            </div>
            
            <button type="submit" class="btn-finish">
                è¨˜éŒ²ã—ã¦çµ‚äº† <i class="fa-solid fa-check"></i>
            </button>
        </form>
    </div>

    <div th:if="${trainingType == 'myset'}" class="record-form-container">
        <h3 style="color:white; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            <i class="fa-solid fa-list-check"></i> ãƒã‚¤ã‚»ãƒƒãƒˆä¸€æ‹¬è¨˜éŒ²
        </h3>
        <p style="color:#aaa; font-size:0.9em; margin-bottom:20px;">å®Ÿæ–½ã—ãŸã‚»ãƒƒãƒˆã®ã¿è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</p>

        <form th:action="@{/training-log/save-batch}" method="post" onsubmit="return validateTrainingTime(this);">
            <input type="hidden" name="recordDate" th:value="${today}">
            
            <div th:each="exName, stat : ${mySetExercises}" class="myset-exercise-block" style="background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1);">
                
                <div th:if="${#lists.contains(cardioList, exName)}">
                    <div class="myset-exercise-title" style="color:#4facfe; font-weight:700;">
                        <i class="fa-solid fa-person-running"></i> <span th:text="${exName}">ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°</span>
                    </div>
                    <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                    <input type="hidden" th:name="|logs[${stat.index}].type|" value="CARDIO">
                    <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ™‚é–“</label>
                            <input type="number" th:name="|logs[${stat.index}].durationMinutes|" class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è·é›¢</label>
                            <input type="number" th:name="|logs[${stat.index}].distanceKm|" class="form-input" step="0.1" placeholder="0.0">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <textarea th:name="|logs[${stat.index}].memo|" class="memo-area" style="min-height:50px; font-size:0.9rem;" placeholder="ãƒ¡ãƒ¢..."></textarea>
                    </div>
                </div>

                <div th:unless="${#lists.contains(cardioList, exName)}">
                    <div class="myset-exercise-title" th:text="${exName}" style="color:#4facfe; font-weight:700; margin-bottom:10px;">ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹</div>
                    
                    <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                    <input type="hidden" th:name="|logs[${stat.index}].type|" value="WEIGHT">
                    <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                    
                    <table style="width: 100%; color: white; border-collapse: separate; border-spacing: 0 5px;">
                        <thead>
                            <tr style="color: #aaa; font-size: 0.8em;">
                                <th style="text-align: center; width: 15%;">Set</th>
                                <th style="text-align: center; width: 40%;">kg</th>
                                <th style="text-align: center; width: 40%;">Reps</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody th:id="|batch-sets-container-${stat.index}|">
                            </tbody>
                    </table>
                    
                    <button type="button" class="button small" 
                            style="width: 100%; padding: 8px; font-size: 0.8em; margin-top:8px; background:rgba(255,255,255,0.1); color:white; border:none;"
                            th:onclick="|addBatchSetRow(${stat.index})|">
                        <i class="fa-solid fa-plus"></i>
                    </button>

                    <div style="margin-top: 10px;">
                        <textarea th:name="|logs[${stat.index}].memo|" class="memo-area" style="min-height:50px; font-size:0.9rem;" placeholder="ãƒ¡ãƒ¢..."></textarea>
                    </div>
                </div>

            </div>
            
            <button type="submit" class="btn-finish">
                ä¸€æ‹¬è¨˜éŒ²ã—ã¦çµ‚äº† <i class="fa-solid fa-check"></i>
            </button>
        </form>
    </div>

    <div th:if="${trainingType == 'ai-suggested'}">
         <div class="log-placeholder">
            <p style="color: #00f2fe; font-weight: 700;">FitBotã®ææ¡ˆå†…å®¹:</p>
            <ul class="program-list">
                <li th:each="program : ${programList}" style="border-bottom-color:rgba(255,255,255,0.1);">
                    <i class="fa-solid fa-circle-check" style="color:#00e676;"></i> 
                    <span th:text="${program}">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…å®¹</span>
                </li>
            </ul>
            <p style="margin-top: 20px; color: #fff;">
                ç›®æ¨™: <span th:text="${targetTime}">45</span>åˆ† / ä¼‘æ†©: <span th:text="${restTime}">60</span>ç§’
            </p>
        </div>
        <div class="control-buttons">
             <a th:href="@{/training-log}" class="button primary" style="background:#4facfe; color:white;">ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†</a>
        </div>
    </div>

    <div class="control-buttons">
        <a th:href="@{/ai-coach}" class="button" style="background:linear-gradient(45deg, #ff9a9e, #fad0c4); color:#fff; border:none;">
             <i class="fa-solid fa-robot"></i> AIç›¸è«‡
        </a>
    </div>

</div>

<script>
    // === ğŸŒŸ CANVAS PARTICLE SYSTEM ===
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    const flare = document.getElementById('mouse-flare');
    
    let particlesArray = [];
    let width, height;

    function resizeCanvas() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const mouse = { x: undefined, y: undefined };
    window.addEventListener('mousemove', (event) => {
        mouse.x = event.x;
        mouse.y = event.y;
        if(flare) flare.style.transform = `translate(${event.clientX}px, ${event.clientY}px) translate(-50%, -50%)`;
        for(let i = 0; i < 2; i++) particlesArray.push(new Particle());
    });

    class Particle {
        constructor() {
            this.x = mouse.x;
            this.y = mouse.y;
            this.size = Math.random() * 5 + 2;
            this.speedX = Math.random() * 4 - 2;
            this.speedY = Math.random() * 4 - 2;
            this.color = 'rgba(255, 255, 255, ' + (Math.random() * 0.5 + 0.5) + ')';
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            if (this.size > 0.2) this.size -= 0.1;
        }
        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'white';
            ctx.fill();
            ctx.shadowBlur = 0;
        }
    }

    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update();
            particlesArray[i].draw();
            if (particlesArray[i].size <= 0.3) {
                particlesArray.splice(i, 1);
                i--;
            }
        }
        requestAnimationFrame(animate);
    }
    
    // èƒŒæ™¯ã®é›²ã®ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹åŠ¹æœ
    const cloud1 = document.querySelector('.cloud-1');
    const cloud2 = document.querySelector('.cloud-2');
    document.addEventListener('mousemove', (e) => {
        const x = (window.innerWidth - e.pageX) / 60;
        const y = (window.innerHeight - e.pageY) / 60;
        if (cloud1) cloud1.style.transform = `translate(${x}px, ${y}px)`;
        if (cloud2) cloud2.style.transform = `translate(${-x}px, ${-y}px)`;
    });

    animate();
</script>

<script th:inline="javascript">
    // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ç®¡ç† ===
    let sessionStartTime = Date.now();
    let sessionElapsedTime = 0; // ç§’
    
    setInterval(() => {
        sessionElapsedTime = Math.floor((Date.now() - sessionStartTime) / 1000);
    }, 1000);

    window.validateTrainingTime = function(form) {
        if (sessionElapsedTime < 30) {
            if(!confirm("é–‹å§‹ã‹ã‚‰æ™‚é–“ãŒçŸ­ã™ãã¾ã™ï¼ˆ" + sessionElapsedTime + "ç§’ï¼‰ã€‚æœ¬å½“ã«è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) {
                return false;
            }
        }
        return true;
    };

    document.addEventListener('DOMContentLoaded', () => {
        const formatTime = (ms) => {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        };

        // 1. ã‚»ãƒƒãƒˆè¿½åŠ 
        const setsContainer = document.getElementById('sets-container');
        const addSetBtn = document.getElementById('add-set-btn');
        if (setsContainer && addSetBtn) {
            let setCounter = 0;
            const addSetRow = (weight = '', reps = '') => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align: center; font-weight: bold; vertical-align: middle;">${setCounter + 1}</td>
                    <td style="padding: 0 5px;">
                        <input type="number" name="setList[${setCounter}].weight" class="form-input" step="0.5" placeholder="kg" value="${weight}" required>
                    </td>
                    <td style="padding: 0 5px;">
                        <input type="number" name="setList[${setCounter}].reps" class="form-input ai-rep-target" placeholder="å›" value="${reps}" required>
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                         <i class="fa-solid fa-trash" onclick="removeRow(this)" style="color: #888; cursor: pointer;"></i>
                    </td>
                `;
                setsContainer.appendChild(tr);
                setCounter++;
            };
            addSetRow(); addSetRow(); addSetRow();
            addSetBtn.addEventListener('click', () => addSetRow());
            
            window.updateCurrentSetReps = function(count) {
                const inputs = document.querySelectorAll('.ai-rep-target');
                if(inputs.length > 0) {
                    inputs[0].value = count;
                    const badge = document.getElementById('ai-verified-badge');
                    if(badge) badge.style.display = 'inline-block';
                }
            };
        }

        window.addBatchSetRow = function(exerciseIndex) {
            const container = document.getElementById(`batch-sets-container-${exerciseIndex}`);
            if (!container) return;
            const nextIndex = container.querySelectorAll('tr').length;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align: center; font-weight: bold; vertical-align: middle;">${nextIndex + 1}</td>
                <td style="padding: 0 5px;">
                    <input type="number" name="logs[${exerciseIndex}].setList[${nextIndex}].weight" class="form-input" step="0.5" placeholder="kg">
                </td>
                <td style="padding: 0 5px;">
                    <input type="number" name="logs[${exerciseIndex}].setList[${nextIndex}].reps" class="form-input" placeholder="å›">
                </td>
                <td style="text-align: center; vertical-align: middle;">
                     <i class="fa-solid fa-trash" onclick="removeRow(this)" style="color: #888; cursor: pointer;"></i>
                </td>
            `;
            container.appendChild(tr);
        };

        /*[# th:if="${trainingType == 'myset'}"]*/
        const mySetExercises = /*[[${mySetExercises}]]*/ [];
        const cardioList = /*[[${cardioList}]]*/ []; 
        if (mySetExercises && cardioList) {
            for (let i = 0; i < mySetExercises.length; i++) {
                if (!cardioList.includes(mySetExercises[i])) {
                    addBatchSetRow(i);
                }
            }
        }
        /*[/]*/

        window.removeRow = function(icon) {
            const row = icon.closest('tr');
            const container = row.parentElement;
            row.remove();
            Array.from(container.children).forEach((tr, index) => {
                tr.querySelector('td:first-child').textContent = index + 1;
            });
        };

        // 2. ã‚¿ã‚¤ãƒãƒ¼
        const ivDisplay = document.getElementById('interval-display');
        const ivMinInput = document.getElementById('interval-minutes');
        const ivSecInput = document.getElementById('interval-seconds');
        const ivSetBtn = document.getElementById('interval-set');
        const ivStartPauseBtn = document.getElementById('interval-start-pause');
        const ivResetBtn = document.getElementById('interval-reset');

        let ivInitialTime = 60000;
        let ivRemainingTime = ivInitialTime;
        let ivTimer = null;
        let isIvRunning = false;

        const updateIvDisplay = () => {
            if(!ivDisplay) return;
            ivDisplay.textContent = formatTime(ivRemainingTime);
            ivDisplay.style.color = (ivRemainingTime <= 10000 && ivRemainingTime > 0) ? '#ff5252' : '#fff';
        };

        const handleIvFinish = () => {
            clearInterval(ivTimer);
            isIvRunning = false;
            ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> é–‹å§‹';
            alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«çµ‚äº†ï¼æ¬¡ã®ã‚»ãƒƒãƒˆã¸ï¼');
        };

        const startInterval = () => {
            if (ivRemainingTime <= 0) { resetInterval(); return; }
            if (!isIvRunning) {
                isIvRunning = true;
                ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> åœæ­¢';
                const startTime = Date.now() - (ivInitialTime - ivRemainingTime);
                ivTimer = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    ivRemainingTime = ivInitialTime - elapsedTime;
                    if (ivRemainingTime <= 0) {           
                        ivRemainingTime = 0;
                        updateIvDisplay();
                        handleIvFinish();
                        return;
                    }
                    updateIvDisplay();
                }, 100);
            } else {
                clearInterval(ivTimer);
                isIvRunning = false;
                ivInitialTime = ivRemainingTime;
                ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> å†é–‹';
            }
        };

        const resetInterval = () => {
            clearInterval(ivTimer);
            isIvRunning = false;
            const minutes = parseInt(ivMinInput.value) || 0;
            const seconds = parseInt(ivSecInput.value) || 0;
            ivInitialTime = Math.max(1000, (minutes * 60000) + (seconds * 1000));
            ivRemainingTime = ivInitialTime;
            updateIvDisplay();
            ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> é–‹å§‹';
        };

        if(ivSetBtn && ivStartPauseBtn && ivResetBtn) {
            ivSetBtn.addEventListener('click', resetInterval);
            ivStartPauseBtn.addEventListener('click', startInterval);
            ivResetBtn.addEventListener('click', resetInterval);
            resetInterval();
        }

        // 3. AI Camera
        const toggleAiBtn = document.getElementById('toggle-ai-camera');
        const aiContainer = document.getElementById('ai-verification-container');

        if (toggleAiBtn && aiContainer) {
            let cameraStream = null;
            let pose = null;
            let repCount = 0;
            let poseState = "UP";

            function calcAngle(a, b, c) {
                const rad = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
                let deg = Math.abs((rad * 180) / Math.PI);
                if (deg > 180) deg = 360 - deg;
                return deg;
            }

            async function startAICamera() {
                const video = document.getElementById("input_video");
                const canvas = document.getElementById("output_canvas");
                const status = document.getElementById("ai-status-overlay");
                const counter = document.getElementById("ai-rep-counter-overlay");

                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                    video.srcObject = cameraStream;
                    await video.play();
                } catch (e) {
                    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + e.message);
                    return;
                }

                canvas.width = 640; canvas.height = 480;
                pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
                pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minTrackingConfidence: 0.5, minDetectionConfidence: 0.5 });

                pose.onResults((results) => {
                    const ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
                    if (performance.now() % 2 > 1) return;
                    if (!results.poseLandmarks) return;
                    
                    const lm = results.poseLandmarks;
                    const hip = lm[24], knee = lm[26], ankle = lm[28];

                    if (hip.visibility < 0.5 || knee.visibility < 0.5) {
                        status.innerText = "å…¨èº«ã‚’æ˜ ã—ã¦ãã ã•ã„";
                        status.style.color = "#ff5252";
                        return;
                    }
                    const angle = calcAngle(hip, knee, ankle);
                    if (angle > 160) {
                        poseState = "UP";
                        status.innerText = "Stand";
                        status.style.color = "#00e676";
                    } 
                    if (angle < 90 && poseState === "UP") {
                        poseState = "DOWN";
                        status.innerText = "Down (OK)";
                        status.style.color = "#ffeb3b";
                    }
                    if (angle > 160 && poseState === "DOWN") {
                        poseState = "UP";
                        repCount++;
                        counter.innerText = repCount + " å›";
                        if (typeof window.updateCurrentSetReps === 'function') window.updateCurrentSetReps(repCount);
                    }
                });

                async function loop() {
                    if (!cameraStream) return;
                    if(video.paused || video.ended) { requestAnimationFrame(loop); return; }
                    await pose.send({ image: video });
                    requestAnimationFrame(loop);
                }
                loop();
            }

            function stopAICamera() {
                const video = document.getElementById("input_video");
                if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
                video.pause(); video.srcObject = null;
                if (pose) { pose.close(); pose = null; }
            }

            toggleAiBtn.addEventListener("click", async () => {
                if (!cameraStream) {
                    aiContainer.style.display = "block";
                    toggleAiBtn.innerHTML = '<i class="fa-solid fa-stop"></i> åœæ­¢';
                    await startAICamera();
                } else {
                    aiContainer.style.display = "none";
                    toggleAiBtn.innerHTML = '<i class="fa-solid fa-robot"></i> AIè‡ªå‹•ã‚«ã‚¦ãƒ³ãƒˆ (BETA)';
                    stopAICamera();
                }
            });
        }

        // 4. GPS
        const toggleGpsBtn = document.getElementById('toggle-gps');
        const gpsStatus = document.getElementById('gps-status');
        const distanceInput = document.getElementById('cardio-distance');
        window.gpsTotalDistanceKm = 0.0; 

        if (toggleGpsBtn) {
            let watchId = null;
            let lastLat = null, lastLon = null;

            function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                var R = 6371; var dLat = (lat2-lat1)*(Math.PI/180); var dLon = (lon2-lon1)*(Math.PI/180);
                var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * (2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            }

            toggleGpsBtn.addEventListener('click', () => {
                if (watchId === null) {
                    if (navigator.geolocation) {
                        gpsStatus.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ¸¬ä½ä¸­...';
                        toggleGpsBtn.innerHTML = '<i class="fa-solid fa-stop"></i> åœæ­¢';
                        watchId = navigator.geolocation.watchPosition((pos) => {
                            const lat = pos.coords.latitude, lon = pos.coords.longitude;
                            if (lastLat != null) {
                                const dist = getDistanceFromLatLonInKm(lastLat, lastLon, lat, lon);
                                if(dist > 0.002 && dist < 0.1) { 
                                    window.gpsTotalDistanceKm += dist;
                                    const disp = Math.floor(window.gpsTotalDistanceKm*100)/100;
                                    gpsStatus.innerHTML = `<i class="fa-solid fa-location-arrow"></i> ${disp} km`;
                                    if(distanceInput) distanceInput.value = disp;
                                }
                            }
                            lastLat = lat; lastLon = lon;
                        }, (e) => { gpsStatus.innerText = 'ã‚¨ãƒ©ãƒ¼: ' + e.message; }, { enableHighAccuracy: true });
                    } else { alert("GPSéå¯¾å¿œ"); }
                } else {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                    gpsStatus.innerHTML = `<i class="fa-solid fa-check"></i> çµ‚äº†: ${Math.floor(window.gpsTotalDistanceKm*100)/100} km`;
                    toggleGpsBtn.innerHTML = '<i class="fa-solid fa-play"></i> å†é–‹';
                }
            });
        }
        
        window.validateCardio = function(form) {
            if (!validateTrainingTime(form)) return false;
            const inputDist = parseFloat(document.getElementById('cardio-distance').value) || 0;
            if (window.gpsTotalDistanceKm > 0 && (inputDist - window.gpsTotalDistanceKm) > 1.0) {
                return confirm("å…¥åŠ›è·é›¢ã¨GPSè¨ˆæ¸¬å€¤ãŒå¤§ããç•°ãªã‚Šã¾ã™ã€‚è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ");
            }
            return true;
        };
    });
</script>
</body>
</html>