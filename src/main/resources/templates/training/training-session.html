<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${trainingTitle}"></title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
	
	<script th:src="@{/js/theme.js}"></script>
    <style>
        .session-page .main-container { max-width: 650px; padding: 30px; }
        .program-card {
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            background: #2a2a2a;
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
            text-align: center;
        }
        .program-card h2 { color: var(--primary-color); font-size: 28px; margin-top: 0; }
        .program-card p.exercise-type {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .program-list { list-style: none; padding: 0; text-align: left; }
        .program-list li { 
            padding: 10px 0; 
            border-bottom: 1px dashed #444; 
            color: #ddd; 
            font-weight: 500;
        }
        .control-buttons { margin-top: 40px; display: flex; flex-direction: column; gap: 15px; }
        .control-buttons a, .control-buttons button { flex-grow: 1; }
        
        .log-placeholder {
            background-color: #1e1e1e;
            border: 1px dashed #555;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            color: #888;
        }
        
        /* === TIMER STYLES === */
        .timer-section {
            background-color: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 1px solid #333;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
        }
        .timer-display {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 3px;
            color: #fff;
            margin: 10px 0 20px;
            font-family: 'Poppins', monospace;
        }
        .timer-interval {
            color: var(--primary-color);
        }
        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .timer-controls button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
            flex-grow: 1;
        }
        .timer-button-primary {
            background-color: var(--primary-color);
            color: #1a1a1a;
        }
        .timer-button-secondary {
            background-color: #444;
            color: #ddd;
        }
        .timer-button-tertiary {
            background-color: #555;
            color: #fff;
            font-size: 14px;
            padding: 8px 15px;
        }
        .timer-controls button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .timer-settings {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            color: #ddd;
        }
        .timer-settings input {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
            text-align: center;
            font-size: 16px;
        }

        /* === RECORD FORM STYLES === */
        .record-form-container {
            background-color: #1e1e1e;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }
        .form-label {
            display: block;
            color: #aaa;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            flex: 1;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }
        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .unit {
            color: #888;
            font-size: 0.8rem;
            text-align: center;
            display: block;
            margin-top: 3px;
        }
        .btn-finish {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: #1a1a1a;
            font-weight: 800;
            font-size: 1.1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s;
            display: block;
            text-decoration: none;
            text-align: center;
            margin-top: 20px;
        }
        .btn-finish:hover {
            transform: scale(1.02);
            background-color: #00c853;
        }
        
        /* マイセット用のスタイル調整 */
        .myset-exercise-block {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .myset-exercise-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 10px;
            border-bottom: 1px dashed #555;
            padding-bottom: 5px;
        }

        /* AI Camera Styles */
        #ai-verification-container {
            margin-top: 20px;
            background: #000;
            border: 2px solid var(--ai-accent-color);
            border-radius: 10px;
            overflow: hidden;
            display: none; /* 初期状態は非表示 */
            position: relative;
        }
        #output_canvas {
            width: 100%;
            height: auto;
            display: block;
        }
        #ai-status-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00e676;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        #ai-rep-counter-overlay {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 24px;
            font-weight: 800;
            border: 1px solid var(--primary-color);
        }
        .verification-badge {
            background-color: #333;
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
            display: none;
        }
        .gps-status {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #aaa;
            text-align: center;
        }
    </style>
</head>
<body class="session-page">
<div class="main-container">
    <h1 th:text="${trainingTitle}"><i class="fa-solid fa-bolt-lightning header-icon"></i>セッション開始</h1>

    <div class="interval-container">
        <h3 style="color: var(--primary-color); margin-bottom: 5px; margin-top: 20px; text-align: center;">インターバルタイマー</h3>
        <div id="interval-display" class="timer-display timer-interval" style="text-align: center;">01:00</div>
        <div class="timer-settings">
            <input type="number" id="interval-minutes" value="1" min="0" max="59" style="width: 50px;"> 分
            <input type="number" id="interval-seconds" value="0" min="0" max="59" style="width: 50px;"> 秒
            <button id="interval-set" class="button timer-button-tertiary"><i class="fa-solid fa-clock"></i> 設定</button>
        </div>
        <div class="timer-controls">
            <button id="interval-start-pause" class="button timer-button-primary"><i class="fa-solid fa-play"></i> 開始</button>
            <button id="interval-reset" class="button timer-button-secondary"><i class="fa-solid fa-rotate-left"></i> リセット</button>
        </div>
    </div>

    <div th:if="${trainingType == 'free-weight'}" style="margin-top: 20px;">
        <button id="toggle-ai-camera" class="button primary" style="width: 100%; background: linear-gradient(45deg, #00c853, #009688);">
            <i class="fa-solid fa-video"></i> AI自動カウントを起動 (BETA)
        </button>
        <p style="font-size: 0.8em; color: #aaa; text-align: center; margin-top: 5px;">
            ※カメラの前でスクワット等の動作を行うと自動で回数が入力されます。全身が映るようにしてください。
        </p>
        
        <div id="ai-verification-container">
            <video id="input_video" style="display:none" playsinline></video>
            <canvas id="output_canvas"></canvas>
            <div id="ai-status-overlay">待機中...</div>
            <div id="ai-rep-counter-overlay">0 回</div>
        </div>
    </div>

    <div th:if="${trainingType == 'free-weight'}" class="record-form-container">
        <h3 style="color:white; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
            <i class="fa-solid fa-pen-to-square"></i> 実績を記録
            <span id="ai-verified-badge" class="verification-badge"><i class="fa-solid fa-check-circle"></i> AI確認済み</span>
        </h3>
        <form th:action="@{/training-log/save}" method="post" id="weight-form" onsubmit="return validateTrainingTime(this);">
            <input type="hidden" name="recordDate" th:value="${today}">
            <input type="hidden" name="type" value="WEIGHT">
            <input type="hidden" name="exerciseName" th:value="${selectedExercise}">
            
            <table style="width: 100%; color: white; border-collapse: separate; border-spacing: 0 10px;">
                <thead>
                    <tr style="color: #aaa; font-size: 0.9em;">
                        <th style="text-align: center; width: 15%;">Set</th>
                        <th style="text-align: center; width: 40%;">重量 (kg)</th>
                        <th style="text-align: center; width: 40%;">回数 (Reps)</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="sets-container">
                </tbody>
            </table>

            <button type="button" id="add-set-btn" class="button secondary" style="width: 100%; margin-top: 10px; padding: 10px; font-size: 0.9em;">
                <i class="fa-solid fa-plus"></i> セットを追加
            </button>
            
            <button type="submit" class="btn-finish" style="margin-top: 20px;">
                記録して終了 <i class="fa-solid fa-check"></i>
            </button>
        </form>
    </div>

    <div th:if="${trainingType == 'cardio'}" class="record-form-container">
        <h3 style="color:white; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
            <i class="fa-solid fa-pen-to-square"></i> 実績を記録
        </h3>
        
        <div style="background: #222; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #555;">
            <div id="gps-status" class="gps-status"><i class="fa-solid fa-location-crosshairs"></i> GPS未計測</div>
            <button type="button" id="toggle-gps" class="button secondary small" style="width:100%;">
                <i class="fa-solid fa-play"></i> GPS計測開始
            </button>
        </div>

        <form th:action="@{/training-log/save}" method="post" id="cardio-form" onsubmit="return validateCardio(this);">
            <input type="hidden" name="recordDate" th:value="${today}">
            <input type="hidden" name="type" value="CARDIO">
            <input type="hidden" name="cardioType" th:value="${selectedExercise}">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">時間</label>
                    <input type="number" name="durationMinutes" id="cardio-duration" class="form-input" placeholder="0" required>
                    <span class="unit">分 (Minutes)</span>
                </div>
                <div class="form-group">
                    <label class="form-label">距離</label>
                    <input type="number" name="distanceKm" id="cardio-distance" class="form-input" step="0.1" placeholder="0.0">
                    <span class="unit">km (GPS自動入力)</span>
                </div>
            </div>
            
            <button type="submit" class="btn-finish">
                記録して終了 <i class="fa-solid fa-check"></i>
            </button>
        </form>
    </div>

    <div th:if="${trainingType == 'myset'}" class="record-form-container">
        <h3 style="color:white; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
            <i class="fa-solid fa-list-check"></i> マイセット一括記録
        </h3>
        <p style="color:#aaa; font-size:0.9em; margin-bottom:20px;">実施したセットのみ記録されます。未入力の種目は無視されます。</p>

        <form th:action="@{/training-log/save-batch}" method="post" onsubmit="return validateTrainingTime(this);">
            <input type="hidden" name="recordDate" th:value="${today}">
            
            <div th:each="exName, stat : ${mySetExercises}" class="myset-exercise-block">
                
                <div th:if="${#lists.contains(cardioList, exName)}">
                    <div class="myset-exercise-title">
                        <i class="fa-solid fa-person-running"></i> <span th:text="${exName}">ランニング</span> (有酸素)
                    </div>
                    <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                    <input type="hidden" th:name="|logs[${stat.index}].type|" value="CARDIO">
                    <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">時間</label>
                            <input type="number" th:name="|logs[${stat.index}].durationMinutes|" class="form-input" placeholder="0">
                            <span class="unit">分</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">距離</label>
                            <input type="number" th:name="|logs[${stat.index}].distanceKm|" class="form-input" step="0.1" placeholder="0.0">
                            <span class="unit">km</span>
                        </div>
                    </div>
                </div>

                <div th:unless="${#lists.contains(cardioList, exName)}">
                    <div class="myset-exercise-title" th:text="${exName}">ベンチプレス</div>
                    
                    <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                    <input type="hidden" th:name="|logs[${stat.index}].type|" value="WEIGHT">
                    <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                    
                    <table style="width: 100%; color: white; border-collapse: separate; border-spacing: 0 5px;">
                        <thead>
                            <tr style="color: #aaa; font-size: 0.8em;">
                                <th style="text-align: center; width: 15%;">Set</th>
                                <th style="text-align: center; width: 40%;">重量 (kg)</th>
                                <th style="text-align: center; width: 40%;">回数</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody th:id="|batch-sets-container-${stat.index}|">
                            </tbody>
                    </table>
                    
                    <button type="button" class="button secondary small" 
                            style="width: 100%; padding: 5px; font-size: 0.8em; margin-top:5px;"
                            th:onclick="|addBatchSetRow(${stat.index})|">
                        <i class="fa-solid fa-plus"></i> セット追加
                    </button>
                </div>

            </div>
            
            <button type="submit" class="btn-finish">
                一括記録して終了 <i class="fa-solid fa-check"></i>
            </button>
        </form>
    </div>

    <div th:if="${trainingType == 'ai-suggested'}">
         <div class="log-placeholder" style="border-color: var(--ai-accent-color); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);">
            <p style="color: var(--ai-accent-color); font-weight: 600;">FitBotの提案内容:</p>
            <ul class="program-list">
                <li th:each="program : ${programList}">
                    <i class="fa-solid fa-circle-right" style="color:#00c8c8;"></i> 
                    <span th:text="${program}">1. 種目A: 4セット x 10回 (70kg) (AIプログラムの例)</span>
                </li>
            </ul>
            <p style="margin-top: 20px; color: var(--primary-color);">
                目標時間: <span th:text="${targetTime}">45</span>分 / 休憩時間: <span th:text="${restTime}">60</span>秒
            </p>
        </div>
        <div class="control-buttons">
             <a th:href="@{/training-log}" class="button primary">セッション完了 (カレンダーに戻る)</a>
        </div>
    </div>
</div>

<div class="button-container" style="margin-top: 20px;">
    <a th:href="@{/ai-coach}" class="button primary">
         <i class="fa-solid fa-robot" style="margin-left: 5px;"></i> トレーニング内容をAIコーチに相談
    </a>
</div>
    
<div class="control-buttons" style="margin-top: -5px;">
    <a th:href="@{/training}" class="button secondary">
        <i class="fa-solid fa-arrow-rotate-left"></i> 中断してメニュー選択に戻る
    </a>
</div>
</div>

<script th:inline="javascript">
    // === グローバル変数: セッション時間管理 ===
    let sessionStartTime = Date.now();
    let sessionElapsedTime = 0; // 秒
    
    // 1秒ごとにセッション時間を更新
    setInterval(() => {
        sessionElapsedTime = Math.floor((Date.now() - sessionStartTime) / 1000);
    }, 1000);

    // === バリデーション関数 (タイマー強制) ===
    window.validateTrainingTime = function(form) {
        // 例: ページ滞在時間が30秒未満なら警告
        if (sessionElapsedTime < 30) {
            if(!confirm("セッション開始から時間が短すぎます（まだ" + sessionElapsedTime + "秒）。本当に記録しますか？\nしっかりトレーニングを行いましょう！")) {
                return false;
            }
        }
        return true;
    };

    document.addEventListener('DOMContentLoaded', () => {
        // --- Utility function for formatting time (Minutes:Seconds) ---
        const formatTime = (ms) => {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(seconds)}`;
        };

        // =======================================================
        // 1. セット追加機能 (単発記録用)
        // =======================================================
        const setsContainer = document.getElementById('sets-container');
        const addSetBtn = document.getElementById('add-set-btn');
        
        if (setsContainer && addSetBtn) {
            let setCounter = 0;
            const addSetRow = (weight = '', reps = '') => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align: center; font-weight: bold; vertical-align: middle;">${setCounter + 1}</td>
                    <td style="padding: 0 5px;">
                        <input type="number" name="setList[${setCounter}].weight" class="form-input" step="0.5" placeholder="kg" value="${weight}" required style="text-align: center;">
                    </td>
                    <td style="padding: 0 5px;">
                        <input type="number" name="setList[${setCounter}].reps" class="form-input ai-rep-target" placeholder="回" value="${reps}" required style="text-align: center;" id="reps-input-${setCounter}">
                    </td>
                    <td style="text-align: center; vertical-align: middle;">
                         <i class="fa-solid fa-trash" onclick="removeRow(this)" style="color: #666; cursor: pointer;"></i>
                    </td>
                `;
                setsContainer.appendChild(tr);
                setCounter++;
            };
            addSetRow(); addSetRow(); addSetRow();
            addSetBtn.addEventListener('click', () => addSetRow());
            
            // AI用: グローバル関数として公開
            window.updateCurrentSetReps = function(count) {
                // 現在入力可能な最後のセット（または最初の空のセット）を探す
                const inputs = document.querySelectorAll('.ai-rep-target');
                if(inputs.length > 0) {
                    // 簡易的に最初のセット、あるいはフォーカスされているセットに入力
                    // ここでは便宜上、最初の行（セット1）に入力し、満杯なら次へ...というロジックも組めるが
                    // シンプルに「セット1」を更新する
                    inputs[0].value = count;
                    
                    // バッジ表示
                    const badge = document.getElementById('ai-verified-badge');
                    if(badge) badge.style.display = 'inline-block';
                }
            };
        }

        // =======================================================
        // 1.5. セット追加機能 (マイセット一括用)
        // =======================================================
        window.addBatchSetRow = function(exerciseIndex) {
            const container = document.getElementById(`batch-sets-container-${exerciseIndex}`);
            if (!container) return; // 有酸素運動の場合はコンテナがないのでスキップ

            const currentRows = container.querySelectorAll('tr').length;
            const nextIndex = currentRows;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align: center; font-weight: bold; vertical-align: middle;">${nextIndex + 1}</td>
                <td style="padding: 0 5px;">
                    <input type="number" name="logs[${exerciseIndex}].setList[${nextIndex}].weight" class="form-input" step="0.5" placeholder="kg" style="text-align: center;">
                </td>
                <td style="padding: 0 5px;">
                    <input type="number" name="logs[${exerciseIndex}].setList[${nextIndex}].reps" class="form-input" placeholder="回" style="text-align: center;">
                </td>
                <td style="text-align: center; vertical-align: middle;">
                     <i class="fa-solid fa-trash" onclick="removeRow(this)" style="color: #666; cursor: pointer;"></i>
                </td>
            `;
            container.appendChild(tr);
        };

        // マイセットの初期表示（各筋トレ種目に1セットずつ追加）
        /*[# th:if="${trainingType == 'myset'}"]*/
        const mySetExercises = /*[[${mySetExercises}]]*/ [];
        const cardioList = /*[[${cardioList}]]*/ []; 

        if (mySetExercises && cardioList) {
            for (let i = 0; i < mySetExercises.length; i++) {
                if (!cardioList.includes(mySetExercises[i])) {
                    addBatchSetRow(i);
                }
            }
        }
        /*[/]*/

        window.removeRow = function(icon) {
            const row = icon.closest('tr');
            const container = row.parentElement;
            row.remove();
            Array.from(container.children).forEach((tr, index) => {
                tr.querySelector('td:first-child').textContent = index + 1;
            });
        };

        // =======================================================
        // 2. インターバルタイマー機能
        // =======================================================
        const ivDisplay = document.getElementById('interval-display');
        const ivMinInput = document.getElementById('interval-minutes');
        const ivSecInput = document.getElementById('interval-seconds');
        const ivSetBtn = document.getElementById('interval-set');
        const ivStartPauseBtn = document.getElementById('interval-start-pause');
        const ivResetBtn = document.getElementById('interval-reset');

        let ivInitialTime = 60000;
        let ivRemainingTime = ivInitialTime;
        let ivTimer = null;
        let isIvRunning = false;

        const updateIvDisplay = () => {
            if(!ivDisplay) return;
            ivDisplay.textContent = formatTime(ivRemainingTime);
            if (ivRemainingTime <= 10000 && ivRemainingTime > 0) {
                 ivDisplay.style.color = '#ff0000'; 
            } else {
                 ivDisplay.style.color = 'var(--primary-color)';
            }
        };

        const handleIvFinish = () => {
            clearInterval(ivTimer);
            isIvRunning = false;
            ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> 開始';
            ivStartPauseBtn.classList.remove('timer-button-primary');
            ivStartPauseBtn.classList.add('timer-button-primary');
            alert('インターバル終了！次のセットに移りましょう！');
        };

        const startInterval = () => {
            if (ivRemainingTime <= 0) {
                resetInterval();
                return;
            }
            if (!isIvRunning) {
                isIvRunning = true;
                ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i> 停止';
                ivStartPauseBtn.classList.remove('timer-button-primary');
                ivStartPauseBtn.classList.add('timer-button-secondary');
                const startTime = Date.now() - (ivInitialTime - ivRemainingTime);

                ivTimer = setInterval(() => {
                    const elapsedTime = Date.now() - startTime;
                    ivRemainingTime = ivInitialTime - elapsedTime;
                    if (ivRemainingTime <= 0) {           
                        ivRemainingTime = 0;
                        updateIvDisplay();
                        handleIvFinish();
                        return;
                    }
                    updateIvDisplay();
                }, 100);
            } else {
                clearInterval(ivTimer);
                isIvRunning = false;
                ivInitialTime = ivRemainingTime;
                ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> 再開';
                ivStartPauseBtn.classList.remove('timer-button-secondary');
                ivStartPauseBtn.classList.add('timer-button-primary');
            }
        };

        const resetInterval = () => {
            clearInterval(ivTimer);
            isIvRunning = false;
            const minutes = parseInt(ivMinInput.value) || 0;
            const seconds = parseInt(ivSecInput.value) || 0;
            const newInitialTime = (minutes * 60000) + (seconds * 1000);
            
            if (newInitialTime < 1000) {
                ivInitialTime = 60000;
                ivMinInput.value = 1;
                ivSecInput.value = 0;
            } else {
                ivInitialTime = newInitialTime;
            }
            ivRemainingTime = ivInitialTime;
            updateIvDisplay();
            ivStartPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i> 開始';
            ivStartPauseBtn.classList.remove('timer-button-secondary');
            ivStartPauseBtn.classList.add('timer-button-primary');
        };

        if(ivSetBtn && ivStartPauseBtn && ivResetBtn) {
            ivSetBtn.addEventListener('click', resetInterval);
            ivStartPauseBtn.addEventListener('click', startInterval);
            ivResetBtn.addEventListener('click', resetInterval);
            resetInterval();
        }

        // =======================================================
        // 3. AI Motion Tracking (完全改良版)
        // =======================================================
        const toggleAiBtn = document.getElementById('toggle-ai-camera');
        const aiContainer = document.getElementById('ai-verification-container');

        if (toggleAiBtn && aiContainer) {
            // 変数をグローバルスコープで保持
            let cameraStream = null;
            let pose = null;
            let repCount = 0;
            let poseState = "UP";

            // 角度計算関数 (ラジアン→度数法)
            function calcAngle(a, b, c) {
                const rad = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
                let deg = Math.abs((rad * 180) / Math.PI);
                if (deg > 180) deg = 360 - deg;
                return deg;
            }

            // カメラ起動 & ループ開始処理
            async function startAICamera() {
                const video = document.getElementById("input_video");
                const canvas = document.getElementById("output_canvas");
                const status = document.getElementById("ai-status-overlay");
                const counter = document.getElementById("ai-rep-counter-overlay");

                // --- 1. カメラストリームの取得 (標準API使用) ---
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 } // 480pで負荷軽減
                    });
                    video.srcObject = cameraStream;
                    await video.play();
                } catch (e) {
                    console.error("Camera error:", e);
                    alert("カメラの起動に失敗しました: " + e.message);
                    return;
                }

                // Canvasサイズをビデオに合わせる
                canvas.width = 640;
                canvas.height = 480;

                // --- 2. Poseインスタンスの生成 (毎回新品を作る) ---
                pose = new Pose({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
                });
                
                // 軽量設定 (modelComplexity: 0 が最重要)
                pose.setOptions({
                    modelComplexity: 0, // 0:軽量, 1:標準, 2:高精度
                    smoothLandmarks: true,
                    minTrackingConfidence: 0.5,
                    minDetectionConfidence: 0.5,
                });

                // --- 3. 推論結果の処理 ---
                pose.onResults((results) => {
                    const ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

                    // ★FPS制御: 2回に1回だけ処理して負荷を半減させる
                    if (performance.now() % 2 > 1) return;

                    if (!results.poseLandmarks) return;
                    const lm = results.poseLandmarks;

                    // 必要な関節点 (右半身で判定)
                    const hip = lm[24];
                    const knee = lm[26];
                    const ankle = lm[28];

                    // 描画 (骨格線)
                    if(window.drawConnectors && window.drawLandmarks) {
                        drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                        drawLandmarks(ctx, lm, {color: '#FF0000', lineWidth: 2});
                    }

                    // 全身が入っていない場合の警告
                    if (hip.visibility < 0.5 || knee.visibility < 0.5 || ankle.visibility < 0.5) {
                        status.innerText = "全身が映る位置に立ってください";
                        status.style.color = "#ff5252";
                        return;
                    } else {
                        // 角度計算
                        const angle = calcAngle(hip, knee, ankle);

                        // カウントロジック (スクワット)
                        if (angle > 160) {
                            poseState = "UP";
                            status.innerText = "状態: 立位 (Start)";
                            status.style.color = "#00e676";
                        } 
                        if (angle < 90 && poseState === "UP") {
                            poseState = "DOWN";
                            status.innerText = "状態: ボトム (OK!)";
                            status.style.color = "#ffeb3b";
                        }
                        if (angle > 160 && poseState === "DOWN") {
                            poseState = "UP";
                            repCount++;
                            counter.innerText = repCount + " 回";
                            
                            // フォームに入力
                            if (typeof window.updateCurrentSetReps === 'function') {
                                window.updateCurrentSetReps(repCount);
                            }
                            const badge = document.getElementById('ai-verified-badge');
                            if(badge) badge.style.display = "inline-block";
                        }
                    }
                });

                // --- 4. 推論ループ ---
                async function loop() {
                    // ストリームが止まっていたらループ終了
                    if (!cameraStream) return; 
                    
                    // ビデオが再生中でなければスキップ
                    if(video.paused || video.ended) {
                        requestAnimationFrame(loop);
                        return;
                    }
                    
                    // 推論実行
                    await pose.send({ image: video });
                    
                    // 次のフレームへ
                    requestAnimationFrame(loop);
                }
                loop();
            }

            // カメラ停止処理
            function stopAICamera() {
                const video = document.getElementById("input_video");

                // ストリームを物理的に停止 (ライトを消す)
                if (cameraStream) {
                    cameraStream.getTracks().forEach((track) => track.stop());
                    cameraStream = null;
                }
                video.pause();
                video.srcObject = null;

                // メモリ解放
                if (pose) {
                    pose.close(); 
                    pose = null;
                }
                
                // カウントリセット (任意)
                repCount = 0;
                poseState = "UP";
                document.getElementById("ai-rep-counter-overlay").innerText = "0 回";
                document.getElementById("ai-status-overlay").innerText = "待機中...";
            }

            // ボタンクリック時の挙動
            toggleAiBtn.addEventListener("click", async () => {
                if (!cameraStream) {
                    // 起動
                    aiContainer.style.display = "block";
                    toggleAiBtn.innerHTML = '<i class="fa-solid fa-stop"></i> カメラ停止';
                    toggleAiBtn.classList.remove('primary');
                    toggleAiBtn.classList.add('secondary');
                    await startAICamera();
                } else {
                    // 停止
                    aiContainer.style.display = "none";
                    toggleAiBtn.innerHTML = '<i class="fa-solid fa-video"></i> AI自動カウントを起動 (BETA)';
                    toggleAiBtn.classList.add('primary');
                    toggleAiBtn.classList.remove('secondary');
                    stopAICamera();
                }
            });
        }

        // =======================================================
        // 4. GPS Tracking (Cardio)
        // =======================================================
        const toggleGpsBtn = document.getElementById('toggle-gps');
        const gpsStatus = document.getElementById('gps-status');
        const distanceInput = document.getElementById('cardio-distance');
        
        // グローバル変数として保持して送信時に検証に使う
        window.gpsTotalDistanceKm = 0.0; 

        if (toggleGpsBtn) {
            let watchId = null;
            let lastLat = null;
            let lastLon = null;

            // ハバースイン公式 (2点間の距離km)
            function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                var R = 6371; // Earth radius in km
                var dLat = deg2rad(lat2 - lat1);
                var dLon = deg2rad(lon2 - lon1);
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat1)) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c;
                return d;
            }
            function deg2rad(deg) { return deg * (Math.PI / 180); }

            toggleGpsBtn.addEventListener('click', () => {
                if (watchId === null) {
                    if (navigator.geolocation) {
                        gpsStatus.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> GPS測位中...';
                        toggleGpsBtn.innerHTML = '<i class="fa-solid fa-stop"></i> GPS計測停止';
                        toggleGpsBtn.classList.remove('secondary');
                        toggleGpsBtn.classList.add('primary'); // 計測中は緑色などに

                        watchId = navigator.geolocation.watchPosition((position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;

                            if (lastLat != null) {
                                const dist = getDistanceFromLatLonInKm(lastLat, lastLon, lat, lon);
                                // 誤差対策: 極端に小さい移動や異常値は無視 (例: 1秒で100m以上など)
                                if(dist > 0.002 && dist < 0.1) { 
                                    window.gpsTotalDistanceKm += dist;
                                    
                                    // 表示更新 (小数点第2位まで)
                                    const displayDist = Math.floor(window.gpsTotalDistanceKm * 100) / 100;
                                    gpsStatus.innerHTML = `<i class="fa-solid fa-location-arrow"></i> 計測中: ${displayDist} km`;
                                    
                                    // 入力欄に自動反映
                                    if(distanceInput) {
                                        distanceInput.value = displayDist;
                                    }
                                }
                            }
                            lastLat = lat;
                            lastLon = lon;
                        }, (error) => {
                            gpsStatus.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> GPSエラー: ' + error.message;
                        }, {
                            enableHighAccuracy: true,
                            maximumAge: 0,
                            timeout: 5000
                        });

                    } else {
                        alert("このブラウザはGPSに対応していません。");
                    }
                } else {
                    // 停止処理
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                    gpsStatus.innerHTML = `<i class="fa-solid fa-check"></i> 計測終了: ${Math.floor(window.gpsTotalDistanceKm * 100) / 100} km`;
                    toggleGpsBtn.innerHTML = '<i class="fa-solid fa-play"></i> GPS計測再開';
                    toggleGpsBtn.classList.add('secondary');
                    toggleGpsBtn.classList.remove('primary');
                }
            });
        }
        
        // 有酸素運動の送信時バリデーション
        window.validateCardio = function(form) {
            // 時間チェック
            if (!validateTrainingTime(form)) return false;

            const inputDist = parseFloat(document.getElementById('cardio-distance').value) || 0;
            // GPS計測値との乖離チェック (例: 入力がGPS計測より1km以上大きい場合は警告)
            // ※GPS精度や、ルームランナーの場合を考慮して「警告」にとどめる
            if (window.gpsTotalDistanceKm > 0 && (inputDist - window.gpsTotalDistanceKm) > 1.0) {
                return confirm("入力された距離(" + inputDist + "km)が、GPS計測距離(" + 
                               Math.floor(window.gpsTotalDistanceKm*100)/100 + "km)と大きく異なります。\n" +
                               "屋外ランニングの場合は不正の可能性があります。\n本当に記録しますか？");
            }
            return true;
        };
    });
</script>
</body>
</html>