<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${trainingTitle}"></title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700;900&family=M+PLUS+Rounded+1c:wght@500;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script th:src="@{/js/theme.js}"></script>
    
    <style>
        /* ==========================================================================
           üåå BACKGROUND & THEME
           ========================================================================== */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.9);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #00f2fe;
            --text-color: #333;
        }

        body {
            margin: 0; padding: 0;
            background-color: #f0f8ff;
            min-height: 100vh;
            font-family: 'M PLUS Rounded 1c', 'Noto Sans JP', sans-serif;
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .interactive-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1);
            background-size: 400% 400%; animation: auroraFlow 20s ease infinite;
        }
        @keyframes auroraFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatOrb 30s infinite alternate ease-in-out; z-index: 0; }
        .orb-1 { width: 60vh; height: 60vh; background: #a18cd1; top: -10%; left: -10%; }
        .orb-2 { width: 50vh; height: 50vh; background: #00f2fe; bottom: -10%; right: -10%; animation-delay: -5s; }
        
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; mix-blend-mode: screen; }
        .bg-cloud { position: absolute; background: #fff; border-radius: 50%; filter: blur(30px); opacity: 0.8; z-index: 2; pointer-events: none; }
        .cloud-1 { top: 5%; left: 5%; width: 300px; height: 300px; animation: floatCloud 25s infinite alternate ease-in-out; }
        .cloud-2 { bottom: 10%; right: -5%; width: 400px; height: 400px; animation: floatCloud 30s infinite alternate-reverse ease-in-out; }
        @keyframes floatCloud { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, -20px); } }
        @keyframes floatOrb { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 30px) scale(1.1); } }

        /* ==========================================================================
           üèó MAIN LAYOUT
           ========================================================================== */
        .main-container {
            max-width: 800px; width: 92%; margin: 40px auto 100px; padding: 30px 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 40px;
            border: 2px solid #fff;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(255,255,255,0.5);
            position: relative; z-index: 10;
        }

        /* ‚òÖÂ§âÊõ¥: Áµ±‰∏Ä„Åï„Çå„Åü„Éò„ÉÉ„ÉÄ„Éº„Çπ„Çø„Ç§„É´ */
        .page-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #007bff; padding-bottom: 10px; gap: 15px; flex-wrap: wrap; }
        .header-left { display: flex; align-items: center; gap: 15px; flex: 1 1 auto; min-width: 0; }
        .page-title { color: #343a40; font-size: 2rem; margin: 0; text-shadow: none; white-space: nowrap; line-height: 1.2; }
        .home-link-icon { display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; background-color: white; color: #007bff; border: 2px solid #007bff; border-radius: 50%; text-decoration: none; transition: all 0.3s ease; font-size: 1.5rem; flex-shrink: 0; }
        .home-link-icon:hover { background-color: #007bff; color: white; transform: scale(1.1); }

        /* „Çø„Ç§„Éû„Éº„Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà */
        .timer-widget {
            background: #2d3436; color: #fff;
            border-radius: 25px; padding: 25px; margin-bottom: 30px; text-align: center;
            box-shadow: 0 10px 30px rgba(45, 52, 54, 0.3); border: 3px solid #636e72;
            position: relative; overflow: hidden;
        }
        .timer-widget::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1);
        }
        .timer-display {
            font-family: 'Poppins', monospace; font-size: 3.5rem; font-weight: 700;
            letter-spacing: 3px; color: #81ecec; margin: 10px 0;
            text-shadow: 0 0 20px rgba(129, 236, 236, 0.4);
        }
        .timer-controls { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-timer {
            padding: 10px 20px; border-radius: 20px; border: none; font-weight: 700; cursor: pointer;
            transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
        }
        .btn-start { background: #00b894; color: white; flex: 2; justify-content: center; box-shadow: 0 4px 0 #00896f; }
        .btn-start:active { transform: translateY(4px); box-shadow: none; }
        .btn-reset { background: #636e72; color: white; flex: 1; justify-content: center; box-shadow: 0 4px 0 #2d3436; }
        .btn-reset:active { transform: translateY(4px); box-shadow: none; }
        .timer-input-group { display: flex; justify-content: center; align-items: center; gap: 5px; margin-bottom: 10px; color: #b2bec3; font-size: 0.9rem; }
        .timer-input { background: #636e72; border: 1px solid #b2bec3; color: white; width: 50px; text-align: center; border-radius: 8px; padding: 5px; font-weight: bold; }

        /* „Éï„Ç©„Éº„É† */
        .form-section {
            background: #fff; border-radius: 25px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #eee;
        }
        .section-heading {
            font-size: 1.2rem; font-weight: 800; color: #333; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;
        }
        .section-heading i { color: #a18cd1; }

        .set-row-card {
            display: flex; align-items: center; gap: 10px;
            background: #f8f9fa; border: 2px solid #eee;
            padding: 12px; border-radius: 15px; margin-bottom: 12px; transition: all 0.2s;
        }
        .set-row-card:focus-within { border-color: #a18cd1; background: #fff; box-shadow: 0 5px 15px rgba(161, 140, 209, 0.2); }
        .set-num {
            background: #333; color: #fff; width: 28px; height: 28px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: 800; font-size: 0.8rem; flex-shrink: 0;
        }
        
        .input-group { flex: 1; position: relative; }
        .input-group input {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd;
            font-size: 1.1rem; font-weight: bold; text-align: center; color: #333;
            background: #fff; box-sizing: border-box;
        }
        .input-group input:focus { outline: none; border-color: #a18cd1; }
        .unit-label {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            color: #999; font-size: 0.8rem; font-weight: 700; pointer-events: none;
        }

        .btn-remove { color: #ff7675; cursor: pointer; padding: 5px; transition: 0.2s; font-size: 1.1rem; }
        .btn-remove:hover { color: #d63031; transform: scale(1.2); }

        .btn-add-set {
            width: 100%; padding: 12px; border: 2px dashed #b2bec3;
            background: #f0f0f0; color: #636e72; border-radius: 15px;
            font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-add-set:hover { background: #dfe6e9; border-color: #636e72; color: #333; }

        .memo-area {
            width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #eee;
            background: #fdfdfd; font-family: inherit; font-size: 1rem; color: #333;
            min-height: 80px; box-sizing: border-box; margin-top: 10px;
            resize: none; 
            overflow-y: hidden; 
        }
        .memo-area:focus { outline: none; border-color: #a18cd1; background: #fff; }

        .btn-finish {
            width: 100%; padding: 18px; margin-top: 25px;
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: #fff; border: none; border-radius: 30px;
            font-size: 1.2rem; font-weight: 900; letter-spacing: 1px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0, 176, 155, 0.3);
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .btn-finish:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0, 176, 155, 0.4); }
        .btn-finish:active { transform: scale(0.98); }
        
        .btn-finish:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .ai-camera-section { margin-bottom: 25px; text-align: center; }
        .btn-ai-camera {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 25px; border-radius: 25px;
            font-weight: 800; cursor: pointer; box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
            display: inline-flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn-ai-camera:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(118, 75, 162, 0.5); }
        
        #ai-verification-container {
            margin-top: 15px; border-radius: 15px; overflow: hidden;
            border: 3px solid #764ba2; background: #000; position: relative; display: none;
        }
        #ai-status-overlay {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7);
            color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold;
        }
        #ai-rep-counter-overlay {
            position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7);
            color: #00e676; padding: 5px 15px; border-radius: 5px; font-size: 1.5rem; font-weight: 900;
        }

        @media (max-width: 600px) {
            .main-container { padding: 20px 15px; width: 95%; margin-top: 40px; }
            /* Header mobile styles */
            .page-header-container { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-left { width: 100%; margin-bottom: 0; }
            .page-title { font-size: 1.6rem; white-space: normal; }
            .home-link-icon { width: 40px; height: 40px; font-size: 1.2rem; }

            .session-title { font-size: 1.5rem; }
            .timer-display { font-size: 2.8rem; }
            .set-row-card { gap: 8px; padding: 10px; }
            .input-group input { font-size: 1rem; padding: 10px; }
        }
    </style>
</head>
<body>

    <div class="interactive-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <canvas id="bg-canvas"></canvas>
        <div class="bg-cloud cloud-1"></div>
        <div class="bg-cloud cloud-2"></div>
    </div>

    <div class="main-container">
        
        <div class="page-header-container">
            <div class="header-left">
                <a th:href="@{/training}" class="home-link-icon" title="Êàª„Çã">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div style="display: flex; flex-direction: column; justify-content: center;">
                    <h1 class="page-title" th:text="${trainingTitle}">„Éà„É¨„Éº„Éã„É≥„Ç∞</h1>
                    <p th:if="${selectedExercise != null}" style="margin: 3px 0 0 0; font-size: 0.9rem; color: #666; font-weight: 700;">
                        <i class="fa-solid fa-dumbbell"></i> <span th:text="${selectedExercise}">Á®ÆÁõÆÂêç</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="timer-widget">
            <div style="font-size: 0.85rem; color: #dfe6e9; font-weight: 700; letter-spacing: 1px;">INTERVAL TIMER</div>
            <div id="interval-display" class="timer-display">01:00</div>
            
            <div class="timer-input-group">
                Ë®≠ÂÆö: 
                <input type="number" id="interval-minutes" class="timer-input" value="1" min="0" max="59"> ÂàÜ
                <input type="number" id="interval-seconds" class="timer-input" value="0" min="0" max="59"> Áßí
            </div>
            
            <div class="timer-controls">
                <button id="interval-start-pause" class="btn-timer btn-start">
                    <i class="fa-solid fa-play"></i> „Çπ„Çø„Éº„Éà
                </button>
                <button id="interval-reset" class="btn-timer btn-reset">
                    <i class="fa-solid fa-rotate-left"></i>
                </button>
            </div>
        </div>

        <div th:if="${trainingType == 'free-weight'}" class="ai-camera-section">
            <button id="toggle-ai-camera" class="btn-ai-camera">
                <i class="fa-solid fa-robot"></i> AIËá™Âãï„Ç´„Ç¶„É≥„Éà (BETA)
            </button>
            <div id="ai-verification-container">
                <video id="input_video" style="display:none" playsinline></video>
                <canvas id="output_canvas"></canvas>
                <div id="ai-status-overlay">ÂæÖÊ©ü‰∏≠...</div>
                <div id="ai-rep-counter-overlay">0 Âõû</div>
            </div>
        </div>

        <div th:if="${trainingType == 'free-weight'}" class="form-section">
            <div class="section-heading">
                <i class="fa-solid fa-pen-to-square"></i> ÂÆüÁ∏æ„ÇíË®òÈå≤
                <span id="ai-verified-badge" style="display:none; margin-left:auto; background:#00e676; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">AIË®àÊ∏¨‰∏≠</span>
            </div>

            <form th:action="@{/training/log/save}" method="post" id="weight-form" onsubmit="return validateTrainingTime(this);">
                <input type="hidden" name="date" th:value="${today}">
                <input type="hidden" name="type" value="WEIGHT">
                <input type="hidden" name="exerciseName" th:value="${selectedExercise}">
                
                <div id="sets-container">
                    </div>

                <button type="button" id="add-set-btn" class="btn-add-set">
                    <i class="fa-solid fa-plus-circle"></i> „Çª„ÉÉ„Éà„ÇíËøΩÂä†
                </button>

                <div style="margin-top: 25px;">
                    <label style="font-weight: 700; color: #555; display:block; margin-bottom:5px;">
                        <i class="fa-regular fa-comment-dots"></i> „É°„É¢„ÉªÊÑüÊÉ≥
                    </label>
                    <textarea name="memo" class="memo-area" placeholder="Ë™øÂ≠ê„ÅØ„Å©„ÅÜ„Å†„Å£„ÅüÔºüÈáçÈáè„ÅÆÊÑüË¶ö„ÅØÔºü"></textarea>
                </div>
                
                <button type="submit" class="btn-finish" disabled>
                    Ë®òÈå≤„Åó„Å¶ÁµÇ‰∫Ü <i class="fa-solid fa-check"></i>
                </button>
            </form>
        </div>

        <div th:if="${trainingType == 'cardio'}" class="form-section">
            <div class="section-heading">
                <i class="fa-solid fa-person-running"></i> ÊúâÈÖ∏Á¥†ÈÅãÂãï
            </div>
            
            <div style="background: #f0f8ff; border: 1px dashed #4facfe; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                <div id="gps-status" style="color:#0288d1; font-weight:800; margin-bottom:10px;">
                    <i class="fa-solid fa-location-dot"></i> GPSÊú™Ë®àÊ∏¨
                </div>
                <button type="button" id="toggle-gps" class="btn-ai-camera" style="font-size:0.9rem; padding:8px 20px;">
                    <i class="fa-solid fa-play"></i> Ë®àÊ∏¨ÈñãÂßã
                </button>
            </div>

            <form th:action="@{/training/log/save}" method="post" id="cardio-form" onsubmit="return validateCardio(this);">
                <input type="hidden" name="date" th:value="${today}">
                <input type="hidden" name="type" value="CARDIO">
                <input type="hidden" name="exerciseName" th:value="${selectedExercise}">
                
                <div class="set-row-card">
                    <div class="set-num"><i class="fa-regular fa-clock"></i></div>
                    <div class="input-group">
                        <input type="number" name="duration" id="cardio-duration" placeholder="0" required>
                        <span class="unit-label">ÂàÜ</span>
                    </div>
                </div>
                <div class="set-row-card">
                    <div class="set-num"><i class="fa-solid fa-route"></i></div>
                    <div class="input-group">
                        <input type="number" name="distance" id="cardio-distance" step="0.1" placeholder="0.0">
                        <span class="unit-label">km</span>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <label style="font-weight: 700; color: #555; display:block; margin-bottom:5px;">
                        <i class="fa-regular fa-comment-dots"></i> „É°„É¢„ÉªÊÑüÊÉ≥
                    </label>
                    <textarea name="memo" class="memo-area" placeholder="„Ç≥„Éº„Çπ„ÅÆÁä∂Ê≥Å„ÇÑÊÑüÊÉ≥„ÇíË®òÈå≤..."></textarea>
                </div>
                
                <button type="submit" class="btn-finish" disabled>
                    Ë®òÈå≤„Åó„Å¶ÁµÇ‰∫Ü <i class="fa-solid fa-check"></i>
                </button>
            </form>
        </div>

        <div th:if="${trainingType == 'myset'}" class="form-section">
            <div class="section-heading">
                <i class="fa-solid fa-list-check"></i> „Éû„Ç§„Çª„ÉÉ„Éà‰∏ÄÊã¨Ë®òÈå≤
            </div>
            
            <form th:action="@{/training-log/save-batch}" method="post" onsubmit="return validateTrainingTime(this);">
                <input type="hidden" name="recordDate" th:value="${today}">
                
                <div th:each="exName, stat : ${mySetExercises}" style="background: #fdfdfd; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                    
                    <div th:if="${#lists.contains(cardioList, exName)}">
                        <h4 style="margin:0 0 10px; color:#4facfe;">
                            <i class="fa-solid fa-person-running"></i> <span th:text="${exName}">Run</span>
                        </h4>
                        <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                        <input type="hidden" th:name="|logs[${stat.index}].type|" value="CARDIO">
                        <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                        
                        <div class="set-row-card">
                            <div class="input-group">
                                <input type="number" th:name="|logs[${stat.index}].durationMinutes|" placeholder="0">
                                <span class="unit-label">ÂàÜ</span>
                            </div>
                            <div class="input-group">
                                <input type="number" th:name="|logs[${stat.index}].distanceKm|" step="0.1" placeholder="0.0">
                                <span class="unit-label">km</span>
                            </div>
                        </div>
                        <textarea th:name="|logs[${stat.index}].memo|" class="memo-area" style="min-height:50px; margin-top:5px;" placeholder="„É°„É¢..."></textarea>
                    </div>

                    <div th:unless="${#lists.contains(cardioList, exName)}">
                        <h4 style="margin:0 0 10px; color:#6a11cb;">
                            <i class="fa-solid fa-dumbbell"></i> <span th:text="${exName}">Bench Press</span>
                        </h4>
                        <input type="hidden" th:name="|logs[${stat.index}].exerciseName|" th:value="${exName}">
                        <input type="hidden" th:name="|logs[${stat.index}].type|" value="WEIGHT">
                        <input type="hidden" th:name="|logs[${stat.index}].recordDate|" th:value="${today}">
                        
                        <div th:id="|batch-sets-container-${stat.index}|">
                            </div>
                        
                        <button type="button" class="btn-add-set" style="padding: 8px; font-size: 0.9rem;" th:onclick="|addBatchSetRow(${stat.index})|">
                            <i class="fa-solid fa-plus"></i> ËøΩÂä†
                        </button>
                        
                        <textarea th:name="|logs[${stat.index}].memo|" class="memo-area" style="min-height:50px; margin-top:10px;" placeholder="„É°„É¢..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn-finish" disabled>
                    ‰∏ÄÊã¨Ë®òÈå≤„Åó„Å¶ÁµÇ‰∫Ü <i class="fa-solid fa-check"></i>
                </button>
            </form>
        </div>

        <div th:if="${trainingType == 'ai-suggested'}" class="form-section">
            <div class="section-heading"><i class="fa-solid fa-wand-magic-sparkles"></i> FitBotÊèêÊ°à„É°„Éã„É•„Éº</div>
            <ul style="list-style: none; padding: 0;">
                <li th:each="program : ${programList}" style="padding: 10px 0; border-bottom: 1px dashed #eee; font-weight: bold; color: #555;">
                    <i class="fa-solid fa-check-circle" style="color: #00b894; margin-right: 8px;"></i>
                    <span th:text="${program}">„É°„Éã„É•„Éº</span>
                </li>
            </ul>
            <div style="margin-top: 20px; font-weight: bold; text-align: center; color: #666;">
                ÁõÆÊ®ôÊôÇÈñì: <span th:text="${targetTime}" style="color:#00b894; font-size:1.2rem;"></span>ÂàÜ / 
                ‰ºëÊÜ©: <span th:text="${restTime}" style="color:#0984e3; font-size:1.2rem;"></span>Áßí
            </div>
            <a th:href="@{/training-log}" class="btn-finish" style="display:block; text-align:center; text-decoration:none;">
                „Çª„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü
            </a>
        </div>

    </div>

    <script>
        // ËÉåÊôØ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 1; this.speedX = Math.random() * 1 - 0.5; this.speedY = Math.random() * 1 - 0.5;
            }
            update() { this.x+=this.speedX; this.y+=this.speedY; if(this.size>0.2) this.size-=0.01; }
            draw() { ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
        }
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if(particles.length<50) particles.push(new Particle());
            for(let i=0; i<particles.length; i++){
                particles[i].update(); particles[i].draw();
                if(particles[i].size<=0.2){ particles.splice(i,1); i--; }
            }
            requestAnimationFrame(animate);
        }
        animate();
    </script>

    <script th:inline="javascript">
        let sessionStartTime = Date.now();
        
        // ‚òÖ„Çª„ÉÉ„ÉàÂâäÈô§„Å®„É™„Éä„É≥„Éê„É™„É≥„Ç∞Ê©üËÉΩ
        window.removeSetRow = function(btn) {
            const row = btn.closest('.set-row-card');
            const container = row.parentElement;
            row.remove();
            updateSetNumbers(container);
            checkFormValidity(); // ÂâäÈô§ÊôÇ„Å´„ÇÇ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÂÆüË°å
        };

        window.updateSetNumbers = function(container) {
            // „Ç≥„É≥„ÉÜ„ÉäÁõ¥‰∏ã„ÅÆ .set-row-card „ÇíÂèñÂæó
            const rows = container.querySelectorAll('.set-row-card');
            rows.forEach((row, index) => {
                // 1. Áï™Âè∑„ÅÆÊõ¥Êñ∞ (1, 2, 3...)
                const numDiv = row.querySelector('.set-num');
                if (numDiv) {
                    numDiv.textContent = index + 1;
                }
                
                // 2. nameÂ±ûÊÄß„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊõ¥Êñ∞ („Éê„ÉÉ„ÉÅË®òÈå≤Áî®)
                const inputs = row.querySelectorAll('input');
                inputs.forEach(input => {
                    if (input.name && input.name.includes('.setList[')) {
                        input.name = input.name.replace(/setList\[\d+\]/, `setList[${index}]`);
                    }
                });
            });
        };

        // ‚òÖ„É°„É¢Ê¨Ñ„ÅÆËá™ÂãïÊã°ÂºµÈñ¢Êï∞
        window.autoResizeTextarea = function(element) {
            element.style.height = 'auto'; // ‰∏ÄÊó¶„É™„Çª„ÉÉ„Éà
            element.style.height = element.scrollHeight + 'px'; // ÂÜÖÂÆπ„Å´Âêà„Çè„Åõ„Å¶Êã°Âºµ
        };

        // ‚òÖ„Éï„Ç©„Éº„É†„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
        window.checkFormValidity = function() {
            const activeForm = document.querySelector('form');
            if (!activeForm) return;

            const submitBtn = activeForm.querySelector('.btn-finish');
            if (!submitBtn) return;

            let isValid = true;

            // „Éï„Ç©„Éº„É†ÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆÊï∞ÂÄ§ÂÖ•ÂäõÊ¨Ñ„ÇíÂèñÂæóÔºàÈáçÈáè„ÄÅÂõûÊï∞„ÄÅÊôÇÈñì„ÄÅË∑ùÈõ¢„Å™„Å©Ôºâ
            const numericInputs = activeForm.querySelectorAll('input[type="number"]');
            
            // „Ç¶„Çß„Ç§„Éà„Éà„É¨„Éº„Éã„É≥„Ç∞„Å™„Å©„Åß„Çª„ÉÉ„ÉàË°å„Åå„ÅÇ„ÇãÂ†¥Âêà
            const setsContainer = document.getElementById('sets-container');
            
            if (setsContainer) {
                // „Ç¶„Çß„Ç§„Éà„Éà„É¨„Éº„Éã„É≥„Ç∞„ÅÆÂ†¥Âêà
                const rows = setsContainer.querySelectorAll('.set-row-card');
                if (rows.length === 0) {
                    isValid = false; // „Çª„ÉÉ„Éà„Åå1„Å§„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÅØNG
                } else {
                    // „Åô„Åπ„Å¶„ÅÆË°å„ÅÆinput„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    rows.forEach(row => {
                        const inputs = row.querySelectorAll('input[type="number"]');
                        inputs.forEach(input => {
                            if (!input.value || parseFloat(input.value) <= 0) {
                                isValid = false;
                            }
                        });
                    });
                }
            } else {
                // ÊúâÈÖ∏Á¥†„ÇÑ„Éû„Ç§„Çª„ÉÉ„Éà‰∏ÄÊã¨„ÅÆÂ†¥Âêà
                const inputs = activeForm.querySelectorAll('input[type="number"]');
                if (inputs.length > 0) {
                    inputs.forEach(input => {
                        // requiredÂ±ûÊÄß„Åå„ÅÇ„Çã„ÅÆ„Å´Á©∫„ÄÅ„Åæ„Åü„ÅØÂÄ§„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„ÅÆ„Å´‰∏çÊ≠£„Å™ÂÄ§
                        if(input.hasAttribute('required') && !input.value) isValid = false;
                        
                        // „Éê„ÉÉ„ÉÅË®òÈå≤„ÅÆÂ†¥Âêà„ÄÅËøΩÂä†„Åï„Çå„ÅüË°å„ÅÆinput„ÅØÂøÖÈ†à„Å´„Åó„Åü„ÅÑ
                        if (input.closest('.set-row-card') && !input.value) {
                            isValid = false;
                        }
                        
                        // ÊúâÈÖ∏Á¥†„Éï„Ç©„Éº„É†„ÅÆÁâπÂà•ÂØæÂøú (duration„ÅØÂøÖÈ†à)
                        if (input.id === 'cardio-duration' && !input.value) {
                            isValid = false;
                        }
                    });
                }
            }

            submitBtn.disabled = !isValid;
        };

        document.addEventListener('DOMContentLoaded', () => {
            const formatTime = (ms) => {
                const s = Math.floor((ms/1000)%60);
                const m = Math.floor(ms/60000);
                return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            };

            // ‚òÖ„É°„É¢Ê¨Ñ„Å∏„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            document.body.addEventListener('input', (e) => {
                if (e.target.classList.contains('memo-area')) {
                    autoResizeTextarea(e.target);
                }
                // ‚òÖÂÖ•Âäõ„Ç§„Éô„É≥„Éà„Åß„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÂÆüË°å
                if (e.target.tagName === 'INPUT') {
                    checkFormValidity();
                }
            });
            // ÂàùÊúü„É≠„Éº„ÉâÊôÇ„ÅÆË™øÊï¥
            document.querySelectorAll('.memo-area').forEach(autoResizeTextarea);
            checkFormValidity(); // ÂàùÊúü„Éê„É™„Éá„Éº„Ç∑„Éß„É≥

            // „Çª„ÉÉ„ÉàËøΩÂä†„É≠„Ç∏„ÉÉ„ÇØ (ÈÄöÂ∏∏)
            const setsContainer = document.getElementById('sets-container');
            const addSetBtn = document.getElementById('add-set-btn');
            if (setsContainer && addSetBtn) {
                const addSetRow = (w='', r='') => {
                    const currentCount = setsContainer.querySelectorAll('.set-row-card').length + 1;
                    const div = document.createElement('div');
                    div.className = 'set-row-card';
                    div.innerHTML = `
                        <div class="set-num">${currentCount}</div>
                        <div class="input-group">
                            <input type="number" name="weights" step="0.5" placeholder="0" value="${w}">
                            <span class="unit-label">kg</span>
                        </div>
                        <div class="input-group">
                            <input type="number" name="repsList" class="ai-rep-target" placeholder="0" value="${r}">
                            <span class="unit-label">Âõû</span>
                        </div>
                        <i class="fa-solid fa-trash btn-remove" onclick="removeSetRow(this)"></i>
                    `;
                    setsContainer.appendChild(div);
                    checkFormValidity(); // ËøΩÂä†ÊôÇ„Å´„ÇÇ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                };
                addSetRow(); 
                addSetBtn.addEventListener('click', () => addSetRow());
            }

            // „Éê„ÉÉ„ÉÅË®òÈå≤Áî®„Çª„ÉÉ„ÉàËøΩÂä†
            window.addBatchSetRow = function(exIdx) {
                const container = document.getElementById(`batch-sets-container-${exIdx}`);
                const idx = container.children.length; // ÁèæÂú®„ÅÆË¶ÅÁ¥†Êï∞ = Ê¨°„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
                const div = document.createElement('div');
                div.className = 'set-row-card';
                // ‚òÖ‰øÆÊ≠£: Âçò‰Ωç„É©„Éô„É´„ÇíËøΩÂä†„Åó„ÄÅ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Çí„Äå0„Äç„Å´Áµ±‰∏Ä
                div.innerHTML = `
                    <div class="set-num">${idx+1}</div>
                    <div class="input-group">
                        <input type="number" name="logs[${exIdx}].setList[${idx}].weight" step="0.5" placeholder="0">
                        <span class="unit-label">kg</span>
                    </div>
                    <div class="input-group">
                        <input type="number" name="logs[${exIdx}].setList[${idx}].reps" placeholder="0">
                        <span class="unit-label">Âõû</span>
                    </div>
                    <i class="fa-solid fa-trash btn-remove" onclick="removeSetRow(this)"></i>
                `;
                container.appendChild(div);
                checkFormValidity(); // ËøΩÂä†ÊôÇ„Å´„ÇÇ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            }
            
            /*[# th:if="${trainingType == 'myset'}"]*/
            const mySetExercises = /*[[${mySetExercises}]]*/ [];
            const cardioList = /*[[${cardioList}]]*/ []; 
            if(mySetExercises) {
                mySetExercises.forEach((ex, i) => {
                    if(!cardioList.includes(ex)) addBatchSetRow(i);
                });
            }
            /*[/]*/

            // „Çø„Ç§„Éû„Éº
            let timer = null;
            let remaining = 60000;
            const display = document.getElementById('interval-display');
            const btnStart = document.getElementById('interval-start-pause');
            
            const updateDisplay = () => {
                if(display) display.textContent = formatTime(remaining);
            };
            
            if(btnStart) {
                btnStart.addEventListener('click', () => {
                    if(timer) {
                        clearInterval(timer); timer = null;
                        btnStart.innerHTML = '<i class="fa-solid fa-play"></i> ÂÜçÈñã';
                        btnStart.style.background = '#00b894';
                    } else {
                        if(remaining <= 0) remaining = (document.getElementById('interval-minutes').value * 60000) + (document.getElementById('interval-seconds').value * 1000);
                        btnStart.innerHTML = '<i class="fa-solid fa-pause"></i> ÂÅúÊ≠¢';
                        btnStart.style.background = '#e17055'; // Ëµ§„Å£„ÅΩ„Åè
                        const end = Date.now() + remaining;
                        timer = setInterval(() => {
                            remaining = end - Date.now();
                            if(remaining <= 0) {
                                remaining = 0; clearInterval(timer); timer = null;
                                alert("„Ç§„É≥„Çø„Éº„Éê„É´ÁµÇ‰∫ÜÔºÅ");
                                btnStart.innerHTML = '<i class="fa-solid fa-play"></i> „Çπ„Çø„Éº„Éà';
                                btnStart.style.background = '#00b894';
                            }
                            updateDisplay();
                        }, 100);
                    }
                });
                
                document.getElementById('interval-reset').addEventListener('click', () => {
                    clearInterval(timer); timer = null;
                    remaining = (document.getElementById('interval-minutes').value * 60000) + (document.getElementById('interval-seconds').value * 1000);
                    updateDisplay();
                    btnStart.innerHTML = '<i class="fa-solid fa-play"></i> „Çπ„Çø„Éº„Éà';
                    btnStart.style.background = '#00b894';
                });
            }
        });

        window.validateTrainingTime = function(form) {
            const elapsed = (Date.now() - sessionStartTime) / 1000;
            if (elapsed < 10) return confirm("ÈñãÂßã„Åã„ÇâÊôÇÈñì„ÅåÁü≠„Åô„Åé„Åæ„Åô„ÄÇË®òÈå≤„Åó„Åæ„Åô„ÅãÔºü");
            return true;
        };
    </script>
</body>
</html>