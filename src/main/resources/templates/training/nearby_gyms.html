<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トレーニング施設検索</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script th:src="@{/js/theme.js}"></script>

    <style>
        /* ★重要: すべての要素のサイズ計算を枠線込みにする（レイアウト崩れ防止） */
        *, *::before, *::after { box-sizing: border-box; }

        /* 背景アニメーションスタイル */
        :root { --glass-bg: rgba(255, 255, 255, 0.65); --primary-color: #ff69b4; }
        body { margin: 0; padding: 0; background-color: #f0f8ff; min-height: 100vh; font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; }
        .interactive-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1); background-size: 400% 400%; animation: auroraFlow 20s ease infinite; }
        @keyframes auroraFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatOrb 30s infinite alternate ease-in-out; z-index: 0; }
        .orb-1 { width: 60vh; height: 60vh; background: #a18cd1; top: -10%; left: -10%; }
        .orb-2 { width: 50vh; height: 50vh; background: #00f2fe; bottom: -10%; right: -10%; animation-delay: -5s; }
        .bg-cloud { position: absolute; background: #fff; border-radius: 50%; filter: blur(40px); opacity: 0.85; z-index: 2; pointer-events: none; }
        .cloud-1 { top: 5%; left: 5%; width: 400px; height: 400px; animation: floatCloud 25s infinite alternate ease-in-out; }
        .cloud-2 { bottom: 5%; right: -5%; width: 550px; height: 550px; animation: floatCloud 30s infinite alternate-reverse ease-in-out; }
        @keyframes floatOrb { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 30px) scale(1.1); } }
        @keyframes floatCloud { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, -20px); } }
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; mix-blend-mode: screen; }

        .main-container {
            max-width: 900px; width: 92%; margin: 40px auto; padding: 40px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 45px;
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 30px 60px rgba(100, 149, 237, 0.2), 0 0 0 2px rgba(255, 255, 255, 0.6) inset;
            position: relative; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
        } 

        /* ヘッダー修正 */
        .page-header-container { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 3px solid #007bff; padding-bottom: 15px; gap: 15px; width: 100%; }
        
        .page-title { 
            color: #343a40; font-size: 2rem; margin: 0; flex-grow: 1; text-align: left;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .home-link-icon {
            display: flex; align-items: center; justify-content: center;
            width: 50px; height: 50px; background-color: white; color: #007bff;
            border: 2px solid #007bff; border-radius: 50%; text-decoration: none;
            transition: all 0.3s ease; font-size: 1.5rem; flex-shrink: 0;
        }
        .home-link-icon:hover { background-color: #007bff; color: white; transform: scale(1.1); }

        /* 検索エリア */
        .search-container { 
            width: 100%; 
            max-width: 800px; 
            margin: 20px 0; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            flex-wrap: wrap; /* 折り返しを許可 */
        }
        
        .search-box-wrapper {
            position: relative;
            flex: 1; /* 残りのスペースを埋める */
            min-width: 250px; /* 小さくなりすぎないように */
        }

        .search-input { 
            width: 100%; 
            padding: 15px 50px 15px 25px;
            border-radius: 50px; 
            border: 2px solid rgba(255,255,255,0.8); 
            font-size: 1rem; 
            background: #fff; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            transition: all 0.3s ease; 
            appearance: none; 
        }
        
        .search-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.25);
            transform: translateY(-2px);
            background: #fff;
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #4facfe;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 10;
        }

        /* ★検索ボタンのデザイン変更（青系グラデーション） */
        .search-button {
            background: linear-gradient(135deg, #4facfe, #00f2fe); /* 青系 */
            color: white; 
            border: none; 
            padding: 15px 25px; 
            border-radius: 50px;
            cursor: pointer; 
            font-weight: bold; 
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.4); /* 青系の影 */
            transition: all 0.3s;
            line-height: 1.2;
            flex-shrink: 0; 
        }
        .search-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(79, 172, 254, 0.6); /* 青系の影（濃いめ） */
        }
        .search-button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        #map-container { 
            width: 100%; height: 50vh; min-height: 400px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: 20px 0; position: relative; border: 2px solid rgba(255,255,255,0.8);
        }
        #map { width: 100%; height: 100%; border-radius: 23px; z-index: 1; }
        
        .map-center-marker { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin-top: -10px; margin-left: -10px; z-index: 1000; pointer-events: none; font-size: 20px; color: #ff4444; text-align: center; line-height: 20px; text-shadow: 0 0 3px white; }
        .current-location-btn { position: absolute; bottom: 20px; right: 20px; z-index: 1000; background-color: white; border: none; border-radius: 50%; width: 50px; height: 50px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #333; transition: background-color 0.3s; }
        .current-location-btn:hover { background-color: #f0f0f0; }

        #status-message { padding: 8px 15px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; border-radius: 20px; margin-top: 10px; font-weight: 700; color: #2c3e50; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; font-size: 0.9rem; } 

        #places-list { width: 100%; height: 300px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 20px; overflow-y: auto; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; } 
        #places-list h2 { font-size: 1.2rem; margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        #gym-results-ul { list-style: none; padding: 0; margin: 0; }
        #gym-results-ul li { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 12px 5px; cursor: pointer; transition: background 0.2s; border-radius: 10px; }
        #gym-results-ul li:hover { background-color: rgba(255,255,255,0.9); }
        .place-info { flex-grow: 1; }
        .place-name { font-weight: bold; font-size: 1rem; color: #333; display: block; }
        .place-dist { font-size: 0.85rem; color: #666; }
        .route-btn { background-color: #4CAF50; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; white-space: nowrap; box-shadow: 0 3px 8px rgba(76,175,80,0.3); }
        .route-btn:hover { background-color: #45a049; }

        /* ★レスポンシブ対応: 768px以下で縦並び */
        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            .search-box-wrapper { 
                width: 100%; 
                min-width: 0; 
            }
            .search-button { 
                width: 100%; 
            }

            .page-header-container {
                flex-wrap: nowrap;
            }
            .page-title {
                font-size: 1.3rem; 
                white-space: nowrap;
            }
            .home-link-icon {
                width: 40px; height: 40px; font-size: 1.2rem;
            }
            .main-container {
                padding: 25px 20px; 
                width: 95%;
            }
        }
    </style>  
</head>
<body>
    <div class="interactive-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <canvas id="bg-canvas"></canvas>
        <div class="bg-cloud cloud-1"></div>
        <div class="bg-cloud cloud-2"></div>
    </div>

<div class="main-container">
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="page-header-container">
        <a th:href="@{/home}" class="home-link-icon" title="ホームに戻る">
            <i class="fa-solid fa-house"></i>
        </a>
        <h1 class="page-title"><i class="fa-solid fa-map-location-dot"></i> トレーニング施設検索</h1>
    </div>

    <p style="color: #666; font-size: 0.9rem;">地図を動かして中心（<i class="fa-solid fa-plus" style="color:red;"></i>）から半径5km以内を検索します</p>

    <div class="search-container">
        <div class="search-box-wrapper">
            <input type="text" id="keyword-input" class="search-input" placeholder="例: ジム, 市民体育館, プール">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
        </div>
        <button onclick="performSearch()" id="search-btn" class="search-button">この場所で検索</button>
    </div>

    <div id="status-message">現在地を取得中です...</div>

    <div id="map-container">
        <div id="map"></div>
        <div class="map-center-marker"><i class="fa-solid fa-plus"></i></div>
        
        <button id="current-loc-btn" class="current-location-btn" title="現在地に戻る" onclick="backToCurrentLocation()">
            <i class="fa-solid fa-crosshairs"></i>
        </button>
    </div>

    <div id="places-list">
        <h2>地図中心周辺の施設</h2>
        <ul id="gym-results-ul">
            <li style="color:#888; justify-content:center;">検索ボタンを押してください</li>
        </ul>
    </div>
    
    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<script>
    // 背景アニメーション
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let particlesArray = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    const mouse = { x: undefined, y: undefined };
    window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; for(let i=0; i<2; i++) particlesArray.push(new Particle()); });
    class Particle {
        constructor() { this.x = mouse.x; this.y = mouse.y; this.size = Math.random() * 5 + 2; this.speedX = Math.random() * 4 - 2; this.speedY = Math.random() * 4 - 2; this.color = 'rgba(255, 255, 255, ' + (Math.random() * 0.5 + 0.5) + ')'; }
        update() { this.x += this.speedX; this.y += this.speedY; if (this.size > 0.2) this.size -= 0.1; }
        draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
    }
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); particlesArray[i].draw(); if (particlesArray[i].size <= 0.3) { particlesArray.splice(i, 1); i--; } }
        requestAnimationFrame(animate);
    }
    animate();

    // マップ機能 (既存)
    let map;
    let markersLayer;
    const defaultLocation = [35.681236, 139.767125]; 
    let currentLocation = null;
    const SEARCH_RADIUS_METERS = 5000;

    document.addEventListener('DOMContentLoaded', () => {
        map = L.map('map').setView(defaultLocation, 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
        markersLayer = L.layerGroup().addTo(map);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    currentLocation = [lat, lng];
                    map.setView([lat, lng], 13); 
                    updateStatus("現在地を表示しました。検索ボタンを押してください。");
                    L.circleMarker([lat, lng], { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map).bindPopup("現在地");
                },
                (error) => { updateStatus("現在地を取得できませんでした。デフォルト位置を表示します。"); }
            );
        } else { updateStatus("お使いのブラウザは位置情報をサポートしていません。"); }
    });

    function backToCurrentLocation() {
        if (currentLocation) {
            map.setView(currentLocation, 13);
            updateStatus("現在地に戻りました。");
        } else {
            updateStatus("現在地を取得中...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(currentLocation, 13);
                        updateStatus("現在地を表示しました。");
                        L.circleMarker(currentLocation, { radius: 8, fillColor: "#3388ff", color: "#fff", weight: 2, fillOpacity: 0.8 }).addTo(map).bindPopup("現在地");
                    },
                    (error) => { updateStatus("現在地を取得できませんでした。"); }
                );
            } else { updateStatus("位置情報が利用できません。"); }
        }
    }

    function updateStatus(msg) { document.getElementById('status-message').textContent = msg; }

    async function performSearch() {
        const center = map.getCenter();
        const keyword = document.getElementById('keyword-input').value.trim();
        const searchBtn = document.getElementById('search-btn');
        const resultsUl = document.getElementById('gym-results-ul');

        searchBtn.disabled = true; searchBtn.textContent = "検索中...";
        updateStatus(`中心から半径${SEARCH_RADIUS_METERS/1000}km以内を検索しています...`);
        resultsUl.innerHTML = '<li style="justify-content:center;"><i class="fa-solid fa-spinner fa-spin"></i> 検索中...</li>';
        markersLayer.clearLayers();

        try {
            let nameFilter = keyword ? `[~"name"~"${keyword}",i]` : "";
            const query = `[out:json][timeout:25];(node["leisure"="fitness_centre"]${nameFilter}(around:${SEARCH_RADIUS_METERS},${center.lat},${center.lng});way["leisure"="fitness_centre"]${nameFilter}(around:${SEARCH_RADIUS_METERS},${center.lat},${center.lng});node["sport"="fitness"]${nameFilter}(around:${SEARCH_RADIUS_METERS},${center.lat},${center.lng}););out center;`;
            const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            displayResults(data.elements, center);
        } catch (error) {
            console.error(error); updateStatus("検索中にエラーが発生しました。"); resultsUl.innerHTML = '<li style="color:red; justify-content:center;">エラーが発生しました。再試行してください。</li>';
        } finally {
            searchBtn.disabled = false; searchBtn.textContent = "この場所で検索";
        }
    }

    function displayResults(elements, center) {
        const resultsUl = document.getElementById('gym-results-ul'); resultsUl.innerHTML = "";
        if (elements.length === 0) { updateStatus("この周辺に施設は見つかりませんでした。"); resultsUl.innerHTML = '<li style="justify-content:center;">見つかりませんでした。<br>地図を移動して再度検索してください。</li>'; return; }
        updateStatus(`${elements.length} 件の施設が見つかりました。`);
        const sortedElements = elements.map(element => {
            const lat = element.lat || element.center.lat; const lon = element.lon || element.center.lon;
            const dist = getDistanceFromLatLonInKm(center.lat, center.lng, lat, lon);
            return { ...element, lat, lon, dist };
        }).sort((a, b) => a.dist - b.dist);

        sortedElements.forEach(element => {
            const name = element.tags.name || "名称不明のジム";
            const distStr = element.dist.toFixed(2);
            const marker = L.marker([element.lat, element.lon]).bindPopup(`<b>${name}</b><br>距離: ${distStr}km`).addTo(markersLayer);
            const li = document.createElement('li');
            li.innerHTML = `<div class="place-info"><span class="place-name">${name}</span><span class="place-dist"><i class="fa-solid fa-location-arrow"></i> 直線距離: ${distStr} km</span></div><a href="https://www.google.com/maps/dir/?api=1&destination=${element.lat},${element.lon}" target="_blank" class="route-btn"><i class="fa-solid fa-diamond-turn-right"></i> ルート</a>`;
            li.querySelector('.place-info').addEventListener('click', () => { map.setView([element.lat, element.lon], 16); marker.openPopup(); });
            resultsUl.appendChild(li);
        });
    }
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371; const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180) }
</script>
</body>
</html>