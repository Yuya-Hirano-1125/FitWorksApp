<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <title>進化の軌跡 - CRYSTAL PATH</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/characters/CharactersUnlock.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
	<style>
	    body {
	        margin: 0; padding: 0;
	        background-color: #f0f8ff;
	        min-height: 100vh;
	        font-family: 'Noto Sans JP', sans-serif;
	        color: #333;
	    }

	    /* キャラクターカード */
	    .character-card { 
	        display: inline-block; margin: 10px; text-align: center; 
	        background: #ffffff;
	        padding: 15px; border-radius: 12px;
	        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
	        color: #333;
	    }
	    .character-img-wrapper { 
	        width: 120px; height: 120px; margin: 0 auto; border-radius: 50%; 
	        overflow: hidden; border: 3px solid #eee; position: relative; background: #fff; 
	    }
	    .character-img { width: 100%; height: 100%; object-fit: cover; }
	    .character-name { font-weight: 800; color: #000; margin: 8px 0 4px; font-size: 1.1rem; }
	    .character-rarity { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
	    .requirements { font-size: 0.9rem; margin-top: 5px; font-weight: 700; color: #333; background: rgba(0,0,0,0.03); padding: 4px; border-radius: 4px; }
	    .unlocked-label { font-weight: bold; color: #27ae60; }
	    .locked .character-img { filter: brightness(0%); opacity: 0.7; }
	    .lock-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.8); }

	    /* ===== モーダル ===== */
	    .modal {
	      position: absolute; /* スクロールに追従 */
	      top: 0; left: 0; right: 0; bottom: 0;
	      background-color: rgba(0,0,0,0.6);
	      opacity: 0;
	      visibility: hidden;
	      pointer-events: none;
	      transition: opacity 0.3s ease;
	      z-index: 1000;

	      display: flex;
	      justify-content: center;
	      align-items: flex-start; /* 上から配置してスクロールに追従 */
	      padding-top: 50px; /* 少し余白を入れて中央寄せ感 */
	    }

	    .modal.show {
	      opacity: 1;
	      visibility: visible;
	      pointer-events: auto;
	    }

	    .modal-content {
	      position: relative;
	      width: 90%;
	      max-width: 500px;
	      background: #fff;
	      border-radius: 12px;
	      padding: 25px;
	      text-align: left;
	      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
	      max-height: 80vh; /* 高さ制限してスクロール可能に */
	      overflow-y: auto;
	    }

	    .close {
	        position: absolute; right: 12px; top: 12px;
	        font-size: 1.5rem; cursor: pointer; color: #888;
	    }
	    .close:hover { color: #000; }

	    .btn-confirm {
	        margin-top: 15px;
	        padding: 8px 16px;
	        background: #4caf50; color: #fff;
	        border: none; border-radius: 4px; cursor: pointer;
	        transition: background 0.2s;
	    }
	    .btn-confirm:hover { background: #45a049; }
	</style>

</head>

<body>
    <div class="glass-wrapper">
        <header style="text-align: center; margin-bottom: 20px;">
            <h1>キャラクター解放</h1>
            <div class="status-bar">
                <div class="status-item" style="display:inline-block; background:rgb(0, 0, 0); padding:5px 15px; border-radius:20px; margin:0 10px;">
                    <i class="fa-solid fa-crown" style="color:#f1c40f;"></i>
                    Lv.<span th:text="${userLevel}">1</span>
                </div>
                <div class="status-item" style="display:inline-block; background:rgba(255,255,255,0.9); padding:5px 15px; border-radius:20px; margin:0 10px;">
                    <a th:href="@{/materials}" class="material-link" style="text-decoration:none;">
                        <i class="fa-solid fa-gem"></i> 素材管理
                    </a>
                </div>
            </div>
        </header>

		<!-- 炎属性 -->
		<div class="pass-section">
		    <h2 class="attribute-heading fire-color"><i class="fa-solid fa-fire"></i> 炎属性</h2>
		    <div class="char-list">
		        <div th:each="chara : ${fireChars}" class="character-card fire">
		            <div class="character-img-wrapper" th:classappend="${chara.name ne 'エンバーハート'} ? 'locked' : ''">
		                <img class="character-img" th:src="${chara.imagePath}" th:alt="${chara.name}">
		                <i th:if="${chara.name ne 'エンバーハート'}" class="fa-solid fa-lock lock-icon"></i>
		            </div>
		            <p class="character-name" th:text="${chara.name}">キャラ名</p>
		            <span class="character-rarity" th:text="${chara.rarity}">★</span>
		            <div class="requirements">
		                <span>必要Lv: <span th:text="${chara.requiredLevel}">1</span></span>
		                <span>素材: <span th:text="${chara.unlockCost}">0</span></span>
		            </div>
		            <div class="unlock-action" style="margin-top:10px;">
		                <span th:if="${chara.name eq 'エンバーハート'}" class="unlocked-label">✅ 開放済み</span>
		                <div th:if="${chara.name ne 'エンバーハート'}">
		                    <button type="button" class="btn-confirm"
		                            onclick="openModal(
		                                this.getAttribute('data-id'),
		                                this.getAttribute('data-name'),
		                                this.getAttribute('data-materials'),
		                                this.getAttribute('data-conditions'),
		                                this.getAttribute('data-cost'),
		                                this.getAttribute('data-materialType')
		                            )"
		                            th:attr="data-id=${chara.id},
		                                     data-name=${chara.name}, 
		                                     data-materials=${#strings.arrayJoin(chara.evolutionMaterials,';')}, 
		                                     data-conditions=${#strings.arrayJoin(chara.evolutionConditions,';')},
		                                     data-cost=${chara.unlockCost},
		                                     data-materialType='紅玉'">
		                        <i class="fa-solid fa-lock-open"></i> 解放条件
		                    </button>
		                </div>
		            </div>
		        </div>
		    </div>
		</div>

		<!-- モーダル -->
		<div id="globalModal" class="modal">
		    <div class="modal-content">
		        <span class="close" onclick="closeModal()">&times;</span>
		        <h3 id="modalTitle">進化条件</h3>
		        <div id="modalBody"></div>
		    </div>
		</div>

		<style>
		.evolution-table {
		  width: 100%;
		  border-collapse: collapse;
		  margin: 10px 0;
		}
		.evolution-table th {
		  text-align: left;
		  background: #f8f9fa;
		  padding: 6px 10px;
		  border: 1px solid #ddd;
		  font-weight: bold;
		  width: 50%;
		}
		.evolution-table td {
		  padding: 6px 10px;
		  border: 1px solid #ddd;
		  text-align: center;
		  width: 50%;
		}
		.modal-section h4 {
		  margin-top: 15px;
		  font-size: 1rem;
		  color: #e74c3c;
		}
		</style>

		<!-- ✅ スクリプトは body の最後に置く -->
		<script>
		document.addEventListener("DOMContentLoaded", function() {

		  window.openModal = function(id, name, materials, conditions, cost, materialType) {
		    if (materials) materials = materials.replace(/[{}]/g, "");
		    if (conditions) conditions = conditions.replace(/[{}]/g, "");

		    document.getElementById("modalTitle").innerText = name + " の進化条件";

		    // 進化素材テーブル
		    let bodyHtml = "<div class='modal-section'><h4>進化素材</h4><table class='evolution-table'>";
		    if (materials && materials.trim()) {
		      let matArray = materials.split(",");
		      matArray.forEach(m => {
		        let parts = m.trim().split("=");
		        if (parts.length === 2) {
		          bodyHtml += "<tr><th>" + parts[0].trim() + "</th><td>" + parts[1].trim() + "</td></tr>";
		        }
		      });
		    } else {
		      bodyHtml += "<tr><td colspan='2'>素材情報なし</td></tr>";
		    }
		    bodyHtml += "</table></div>";

		    // 進化条件テーブル
		    bodyHtml += "<div class='modal-section'><h4>進化条件</h4><table class='evolution-table'>";
		    if (conditions && conditions.trim()) {
		      let condArray = conditions.split(",");
		      condArray.forEach(c => {
		        let parts = c.trim().split("=");
		        if (parts.length === 2) {
		          bodyHtml += "<tr><th>" + parts[0].trim() + "</th><td>" + parts[1].trim() + "</td></tr>";
		        }
		      });
		    } else {
		      bodyHtml += "<tr><td colspan='2'>条件情報なし</td></tr>";
		    }
		    bodyHtml += "</table></div>";

		    // 解放ボタン
		    bodyHtml += "<div style='text-align:center; margin-top:20px;'>"
		             + "<button class='btn-confirm' onclick=\"unlockCharacter('" + id + "','" + name + "','" + cost + "','" + materialType + "')\">"
		             + "<i class='fa-solid fa-unlock'></i> このキャラを解放する"
		             + "</button></div>";

		    document.getElementById("modalBody").innerHTML = bodyHtml;
		    document.getElementById("globalModal").classList.add("show");
		  };

		  window.closeModal = function() {
		    document.getElementById("globalModal").classList.remove("show");
		  };

		  // ✅ サーバー連携版の解放処理
		  window.unlockCharacter = function(id, name, cost, materialType) {
		    fetch("/unlock", {
		      method: "POST",
		      headers: { "Content-Type": "application/json" },
		      body: JSON.stringify({
		        characterId: id,
		        characterName: name,
		        cost: cost,
		        materialType: materialType
		      })
		    })
		    .then(response => response.json())
		    .then(data => {
		      if (data.success) {
		        alert(name + " を解放しました！");
		        closeModal();
		        location.reload(); // 画面更新で解放済み表示に切り替え
		      } else {
		        alert("解放失敗: " + (data.message || "不明なエラー"));
		      }
		    })
		    .catch(error => {
		      console.error("解放エラー:", error);
		      alert("通信エラーが発生しました");
		    });
		  };
		});
		</script>


	
        <div class="pass-section">
            <h2 class="attribute-heading water-color"><i class="fa-solid fa-droplet"></i> 水属性</h2>
            <div class="char-list">
                <div th:each="chara : ${waterChars}" class="character-card water">
                    <div class="character-img-wrapper">
                        <img class="character-img" th:src="@{${chara.imagePath}}" th:alt="${chara.name}">
                    </div>
                    <p class="character-name" th:text="${chara.name}">キャラ名</p>
                    <span class="character-rarity" th:text="${chara.rarity}">★</span>
                    <div class="requirements">
                        <span>必要Lv: <span th:text="${chara.requiredLevel}">1</span></span>
                        <span>素材: <span th:text="${chara.unlockCost}">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pass-section">
            <h2 class="attribute-heading grass-color"><i class="fa-solid fa-leaf"></i> 草属性</h2>
            <div class="char-list">
                <div th:each="chara : ${grassChars}" class="character-card grass">
                    <div class="character-img-wrapper">
                        <img class="character-img" th:src="@{${chara.imagePath}}" th:alt="${chara.name}">
                    </div>
                    <p class="character-name" th:text="${chara.name}">キャラ名</p>
                    <span class="character-rarity" th:text="${chara.rarity}">★</span>
                    <div class="requirements">
                        <span>必要Lv: <span th:text="${chara.requiredLevel}">1</span></span>
                        <span>素材: <span th:text="${chara.unlockCost}">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pass-section">
            <h2 class="attribute-heading light-color"><i class="fa-solid fa-sun"></i> 光属性</h2>
            <div class="char-list">
                <div th:each="chara : ${lightChars}" class="character-card light">
                    <div class="character-img-wrapper">
                        <img class="character-img" th:src="@{${chara.imagePath}}" th:alt="${chara.name}">
                    </div>
                    <p class="character-name" th:text="${chara.name}">キャラ名</p>
                    <span class="character-rarity" th:text="${chara.rarity}">★</span>
                    <div class="requirements">
                        <span>必要Lv: <span th:text="${chara.requiredLevel}">1</span></span>
                        <span>素材: <span th:text="${chara.unlockCost}">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pass-section">
            <h2 class="attribute-heading dark-color"><i class="fa-solid fa-moon"></i> 闇属性</h2>
            <div class="char-list">
                <div th:each="chara : ${darkChars}" class="character-card dark">
                    <div class="character-img-wrapper">
                        <img class="character-img" th:src="@{${chara.imagePath}}" th:alt="${chara.name}">
                    </div>
                    <p class="character-name" th:text="${chara.name}">キャラ名</p>
                    <span class="character-rarity" th:text="${chara.rarity}">★</span>
                    <div class="requirements">
                        <span>必要Lv: <span th:text="${chara.requiredLevel}">1</span></span>
                        <span>素材: <span th:text="${chara.unlockCost}">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pass-section">
            <h2 class="attribute-heading secret-color">
                <i class="fa-solid fa-star"></i> シークレット属性
            </h2>
            <div class="char-list">
                <div th:each="chara : ${secretChars}" class="character-card secret">
                    <div class="character-img-wrapper">
                        <img class="character-img" th:src="@{${chara.imagePath}}" th:alt="${chara.name}">
                    </div>
                    <p class="character-name" th:text="${chara.name}">キャラ名</p>
                    <span class="character-rarity" th:text="${chara.rarity}">★</span>
                    <div class="requirements">
                        <span>必要Lv: <span th:text="${chara.requiredLevel}">1</span></span>
                        <span>素材: <span th:text="${chara.unlockCost}">0</span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="back-btn-container" style="margin:40px 0 20px; text-align:center;">
            <a th:href="@{/characters}" class="btn-back">
                <i class="fa-solid fa-reply"></i> メニューへ戻る
            </a>
        </div>
    </div>

    <div id="globalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">進化条件</h3>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
    // === 背景アニメーションスクリプト ===
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    const flare = document.getElementById('mouse-flare');
    let particlesArray = [];
    let width, height;

    function resizeCanvas() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    const mouse = { x: undefined, y: undefined };
    window.addEventListener('mousemove', (event) => {
        mouse.x = event.x; mouse.y = event.y;
        flare.style.transform = `translate(${event.clientX}px, ${event.clientY}px) translate(-50%, -50%)`;
        particlesArray.push(new Particle(event.clientX, event.clientY));
    });

    class Particle {
        constructor(x, y) {
            this.x = x || Math.random() * width; this.y = y || Math.random() * height;
            this.size = Math.random() * 5 + 2;
            this.speedX = Math.random() * 4 - 2; this.speedY = Math.random() * 4 - 2;
            this.color = 'rgba(255, 255, 255, ' + (Math.random() * 0.5 + 0.5) + ')';
        }
        update() { this.x += this.speedX; this.y += this.speedY; if (this.size > 0.2) this.size -= 0.1; }
        draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
    }

    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update(); particlesArray[i].draw();
            if (particlesArray[i].size <= 0.3) { particlesArray.splice(i, 1); i--; }
        }
        requestAnimationFrame(animate);
    }
    animate();

    // === モーダル関連スクリプト (既存) ===
    function openModal(name, materials, conditions) {
      document.getElementById("modalTitle").innerText = name + " の進化条件";
      let bodyHtml = "<h4>進化素材</h4><ul>";
      if (materials) { materials.split(";").forEach(m => bodyHtml += "<li>" + m + "</li>"); }
      bodyHtml += "</ul><h4>進化条件</h4><ul>";
      if (conditions) { conditions.split(";").forEach(c => bodyHtml += "<li>" + c + "</li>"); }
      bodyHtml += "</ul>";
      bodyHtml += "<div style='text-align:center; margin-top:20px;'><button class='btn-confirm' onclick=\"unlockCharacter('" + name + "')\"><i class='fa-solid fa-unlock'></i> このキャラを解放する</button></div>";
      document.getElementById("modalBody").innerHTML = bodyHtml;
      document.getElementById("globalModal").classList.add("show");
    }

    function closeModal() { document.getElementById("globalModal").classList.remove("show"); }

    function unlockCharacter(name) {
      alert(name + " を解放しました！（ここにサーバー連携処理を追加）");
      closeModal();
    }
    
    // モーダル外クリックで閉じる
    window.onclick = function(event) {
        if (event.target == document.getElementById("globalModal")) {
            closeModal();
        }
    }
    </script>
</body>
</html>