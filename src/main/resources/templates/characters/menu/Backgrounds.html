<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背景一覧 | FitWorks</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/characters/Backgrounds.css}">
</head>

<body class="font-sans">

    <div class="main-container"> 
        
        <div class="page-header">
            <h1 class="page-title text-3xl font-extrabold flex items-center justify-center gap-2">
                <i class="fa-solid fa-image"></i>
                背景一覧
            </h1>
            <p class="text-gray-500 mt-2 text-sm font-bold">ホーム画面の背景カスタマイズ</p>
            
            <!-- ユーザーレベル表示 -->
            <div id="current-level-display" class="mt-4 text-center">
                <span class="text-lg font-extrabold text-[var(--primary-color)] bg-yellow-100 px-4 py-1 rounded-full shadow-md">
                    Lv.<span id="user-level-value" th:text="${userLevel}">1</span>
                </span>
            </div>
            
            <!-- 夢幻の鍵所持数表示 -->
            <div id="dream-key-display" class="mt-2 text-center">
                <span class="text-md font-bold text-purple-600 bg-purple-100 px-4 py-1 rounded-full shadow-md">
                    <i class="fa-solid fa-key"></i> 夢幻の鍵: <span id="dream-key-count" th:text="${dreamKeyCount}">0</span>個
                </span>
            </div>
        </div>

        <div id="content-area"></div>

        <div class="back-btn-area">
            <a th:href="@{/characters/menu/CharactersMenu}" class="menu-back-btn">
                メニューに戻る
            </a>
        </div>

    </div>

    <!-- データソース: 背景アイテムの定義 -->
    <div id="data-source" style="display: none;">
        <!-- 自然・元素系背景 (レベル解放) -->
        <div class="data-item" data-id="fire" data-category="nature" data-name="炎の世界" data-bg="fire-original" 
             data-img-src="/img/background/fire-original.png" data-locked="false" data-unlock-level="0"></div>

        <div class="data-item" data-id="water" data-category="nature" data-name="水の世界" data-bg="water-original" 
             data-img-src="/img/background/water-original.png" data-locked="true" data-unlock-level="40"></div>

        <div class="data-item" data-id="grass" data-category="nature" data-name="木の世界" data-bg="grass-original" 
             data-img-src="/img/background/grass-original.png" data-locked="true" data-unlock-level="70"></div>

        <div class="data-item" data-id="light" data-category="nature" data-name="光の世界" data-bg="cloud-sky" 
             data-img-src="/img/background/light-original.png" data-locked="true" data-unlock-level="100"></div>

        <div class="data-item" data-id="dark" data-category="nature" data-name="闇の世界" data-bg="dark-castle" 
             data-img-src="/img/background/dark-original.png" data-locked="true" data-unlock-level="130"></div>

        <!-- 日常・スペシャル系背景 (素材「夢幻の鍵」で解放) -->
        <div class="data-item" data-id="classroom" data-category="special" data-name="教室" data-bg="classroom" 
             data-img-src="/img/background/classroom.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>

        <div class="data-item" data-id="gaming" data-category="special" data-name="ゲーミングルーム" data-bg="gaming-room" 
             data-img-src="/img/background/gaming-room.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
             
        <div class="data-item" data-id="server" data-category="special" data-name="サーバールーム" data-bg="server-room" 
             data-img-src="/img/background/server-room.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
    </div>

    <!-- 解放確認ポップアップ -->
    <div id="unlock-popup" class="popup-hidden fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800">ロック解放</h3>
            <p id="unlock-message" class="mb-6 text-gray-600 font-medium whitespace-pre-line"></p>
            <div class="flex gap-4 justify-center">
                <button id="cancel-unlock" class="flex-1 py-2 bg-gray-200 text-gray-600 rounded-lg font-bold hover:bg-gray-300 transition">キャンセル</button>
                <button id="confirm-unlock" class="flex-1 py-2 bg-[var(--primary-color)] text-white rounded-lg font-bold shadow-md hover:opacity-90 transition">解放する</button>
            </div>
        </div>
    </div>

    <script src="Backgrounds.js" defer></script>
    
    <script th:inline="javascript"> 
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', () => {

        // Thymeleafから値を取得
        let userLevel = /*[[${userLevel}]]*/ 1;
        let dreamKeyCount = /*[[${dreamKeyCount}]]*/ 0;
        
        console.log('========== 背景画面JavaScript初期化 ==========');
        console.log('ユーザーレベル:', userLevel);
        console.log('夢幻の鍵所持数:', dreamKeyCount);
        console.log('userLevelの型:', typeof userLevel);
        console.log('dreamKeyCountの型:', typeof dreamKeyCount);
        console.log('==========================================');
        
        if (userLevel === null || userLevel === undefined) {
            console.error('ERROR: userLevel is null or undefined!');
            userLevel = 1; // デフォルト値
        }
        
        if (dreamKeyCount === null || dreamKeyCount === undefined) {
            console.error('ERROR: dreamKeyCount is null or undefined!');
            dreamKeyCount = 0; // デフォルト値
        }
        
        // 表示を更新
        const userLevelElement = document.getElementById('user-level-value');
        const dreamKeyCountElement = document.getElementById('dream-key-count');
        
        if (userLevelElement) {
            userLevelElement.textContent = userLevel;
        }
        
        if (dreamKeyCountElement) {
            dreamKeyCountElement.textContent = dreamKeyCount;
        }
		
        const contentArea = document.getElementById('content-area');

        // データ読み込み
        const dataItems = document.querySelectorAll('#data-source .data-item');
        const bgList = [];
        
        dataItems.forEach(item => {
            let isLocked = item.dataset.locked === "true";
            const unlockLevel = parseInt(item.dataset.unlockLevel || 0);
            const needsMaterial = item.dataset.material === "true";
            const materialName = item.dataset.materialName || "";
            const materialId = parseInt(item.dataset.materialId || 0);
            
            // ロック判定
            if (needsMaterial) {
                // 素材が必要な背景: 初期状態はロック
                isLocked = true;
            } else if (unlockLevel > 0) {
                // レベル解放: userLevelが解放レベル以上ならロック解除
                isLocked = unlockLevel > userLevel;
            } else {
                // unlockLevel === 0 の場合は最初から解放済み
                isLocked = false;
            }
            
            bgList.push({
                id: item.dataset.id,
                category: item.dataset.category || 'other',
                name: item.dataset.name,
                bgCode: item.dataset.bg,
                imgSrc: item.dataset.imgSrc,
                locked: isLocked,
                unlockLevel: unlockLevel,
                needsMaterial: needsMaterial,
                materialName: materialName,
                materialId: materialId,
                selected: false
            });
        });
        
        // 初期選択: ロック解除済みの最初のアイテムを選択
        const initialSelectIndex = bgList.findIndex(bg => !bg.locked);
        if (initialSelectIndex !== -1) {
            bgList[initialSelectIndex].selected = true;
        } else if (bgList.length > 0) {
            bgList[0].selected = true;
        }

        const categories = [
            { id: 'nature', title: '自然・元素', icon: 'fa-leaf' },
            { id: 'special', title: '日常・スペシャル', icon: 'fa-star' }
        ];

        function renderAll() {
            contentArea.innerHTML = ''; 

            categories.forEach(cat => {
                const items = bgList.filter(item => item.category === cat.id);
                if (items.length === 0) return;

                const section = document.createElement('div');
                section.className = 'mb-8';
                
                section.innerHTML = `
                    <div class="section-header">
                        <h2 class="section-title">${cat.title}</h2>
                    </div>
                    <div class="card-grid" id="grid-${cat.id}"></div>
                `;
                contentArea.appendChild(section);
                const grid = section.querySelector(`#grid-${cat.id}`);

                items.forEach(bg => {
                    const card = document.createElement('div');
                    card.className = `bg-card ${bg.selected ? 'selected' : ''}`;
                    
                    let overlayHtml = '';
                    let actionHtml = '';
                    let canUnlock = false;

                    if (bg.locked) {
                        let lockText = '';
                        
                        if (bg.needsMaterial) {
                            // 素材解放の場合
                            if (dreamKeyCount > 0) {
                                lockText = `<i class="fa-solid fa-key"></i> ${bg.materialName}で解放`;
                                canUnlock = true;
                            } else {
                                lockText = `<i class="fa-solid fa-lock"></i> ${bg.materialName}が必要`;
                                canUnlock = false;
                            }
                        } else if (bg.unlockLevel > 0) {
                            // レベル解放の場合
                            if (userLevel >= bg.unlockLevel) {
                                lockText = "解放可能";
                                canUnlock = true;
                            } else {
                                lockText = `Lv.${bg.unlockLevel}で解放`;
                                canUnlock = false;
                            }
                        }

                        overlayHtml = `
                            <div class="card-lock-overlay">
                                <i class="fa-solid fa-lock text-2xl mb-1"></i>
                                <span class="text-xs font-bold tracking-widest">LOCKED</span>
                            </div>
                        `;
                        
                        if (canUnlock) {
                            actionHtml = `<button class="status-text text-unlock-ready unlock-trigger bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-4 py-2 rounded-lg font-bold transition shadow-md">
                                <i class="fa-solid fa-unlock-keyhole"></i> 解放する
                            </button>`;
                        } else {
                            actionHtml = `<span class="status-text text-locked">${lockText}</span>`;
                        }

                    } else {
                        if (bg.selected) {
                            actionHtml = `<span class="status-text text-selected"><i class="fa-solid fa-check"></i> 適用中</span>`;
                        } else {
                            actionHtml = `<button class="status-text text-unlock-ready select-trigger bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold transition shadow-md">
                                <i class="fa-solid fa-hand-pointer"></i> 選択する
                            </button>`;
                        }
                    }

                    card.innerHTML = `
                        <div class="card-image-wrapper">
                            <img src="${bg.imgSrc}" alt="${bg.name}" class="card-img">
                            ${overlayHtml}
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">${bg.name}</h3>
                            ${actionHtml}
                        </div>
                    `;
                    
                    const unlockTrigger = card.querySelector('.unlock-trigger');
                    if (unlockTrigger) {
                        unlockTrigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openUnlockPopup(bg);
                        });
                    }

                    const selectTrigger = card.querySelector('.select-trigger');
                    if (selectTrigger) {
                        selectTrigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectBackground(bg);
                        });
                    }

                    grid.appendChild(card);
                });
            });
        }

        function selectBackground(bg) {
            bgList.forEach(b => b.selected = false);
            bg.selected = true;
            renderAll();
            
            // TODO: サーバーに選択した背景を保存するリクエストを送信
            console.log('選択した背景:', bg.name, bg.bgCode);
        }

        const unlockPopup = document.getElementById('unlock-popup');
        const unlockMessage = document.getElementById('unlock-message');
        const confirmUnlockBtn = document.getElementById('confirm-unlock');
        const cancelUnlockBtn = document.getElementById('cancel-unlock');

        function openUnlockPopup(bg) {
            let message = `「${bg.name}」を解放しますか?`;
            
            if (bg.needsMaterial) {
                message += `\n\n必要素材: ${bg.materialName} × 1`;
                message += `\n現在の所持数: ${dreamKeyCount}個`;
            }
            
            unlockMessage.textContent = message;
            unlockPopup.classList.remove('popup-hidden');
            
            const newConfirm = confirmUnlockBtn.cloneNode(true);
            confirmUnlockBtn.parentNode.replaceChild(newConfirm, confirmUnlockBtn);
            
            newConfirm.addEventListener('click', () => {
                console.log('解放リクエスト:', bg.name, 'material_id:', bg.materialId);
                
                // TODO: サーバーに解放リクエストを送信
                // fetch('/characters/backgrounds/unlock', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ backgroundId: bg.id, materialId: bg.materialId })
                // })
                
                // 仮の処理: ロック解除
                bg.locked = false;
                unlockPopup.classList.add('popup-hidden');
                
                // 素材を消費した場合は表示を更新
                if (bg.needsMaterial) {
                    dreamKeyCount--;
                    if (dreamKeyCountElement) {
                        dreamKeyCountElement.textContent = dreamKeyCount;
                    }
                    alert(`${bg.materialName}を1個消費して「${bg.name}」を解放しました!`);
                }
                
                selectBackground(bg);
                renderAll(); 
            });
        }

        cancelUnlockBtn.addEventListener('click', () => {
            unlockPopup.classList.add('popup-hidden');
        });

        renderAll();
    });
    /*]]>*/
    </script>

</body>
</html>