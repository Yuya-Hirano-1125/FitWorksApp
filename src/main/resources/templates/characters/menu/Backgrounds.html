<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背景一覧 | FitWorks</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/characters/Backgrounds.css}">
</head>

<body class="font-sans">

    <div class="main-container"> 
        
        <div class="page-header">
            <h1 class="page-title text-3xl font-extrabold flex items-center justify-center gap-2">
                <i class="fa-solid fa-image"></i>
                背景一覧
            </h1>
            <p class="text-gray-500 mt-2 text-sm font-bold">ホーム画面の背景カスタマイズ</p>
			<div id="current-level-display" class="mt-4 text-center">
			    <span class="text-lg font-extrabold text-[var(--primary-color)] bg-yellow-100 px-4 py-1 rounded-full shadow-md">
			        現在のレベル: <span th:text="${currentLevel}"></span>
			        </span>
			</div>
            </div>

        <div id="content-area"></div>

        <div class="back-btn-area">
            <a th:href="@{/characters/menu/CharactersMenu}" class="menu-back-btn">
                メニューに戻る
            </a>
        </div>

    </div>

    <div id="data-source" style="display: none;">
        <div class="data-item" data-id="fire" data-category="nature" data-name="炎の世界" data-bg="fire-original" 
             data-img-src="/img/background/fire-original.png" data-locked="false" data-unlock-level="0"></div>

        <div class="data-item" data-id="water" data-category="nature" data-name="水の世界" data-bg="water-original" 
             data-img-src="/img/background/water-original.png" data-locked="true" data-unlock-level="40"></div>

        <div class="data-item" data-id="grass" data-category="nature" data-name="木の世界" data-bg="grass-original" 
             data-img-src="/img/background/grass-original.png" data-locked="true" data-unlock-level="70"></div>

        <div class="data-item" data-id="light" data-category="nature" data-name="光の世界" data-bg="cloud-sky" 
             data-img-src="/img/background/light-original.png" data-locked="true" data-unlock-level="100"></div>

        <div class="data-item" data-id="dark" data-category="nature" data-name="闇の世界" data-bg="dark-castle" 
             data-img-src="/img/background/dark-original.png" data-locked="true" data-unlock-level="130"></div>

        <div class="data-item" data-id="classroom" data-category="special" data-name="教室" data-bg="classroom" 
             data-img-src="/img/background/classroom.png" data-locked="true" data-material="true"></div>

        <div class="data-item" data-id="gaming" data-category="special" data-name="ゲーミングルーム" data-bg="gaming-room" 
             data-img-src="/img/background/gaming-room.png" data-locked="true" data-material="true"></div>
             
        <div class="data-item" data-id="server" data-category="special" data-name="サーバールーム" data-bg="server-room" 
             data-img-src="/img/background/server-room.png" data-locked="true" data-material="true"></div>
    </div>


    <div id="unlock-popup" class="popup-hidden fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800">ロック解放</h3>
            <p id="unlock-message" class="mb-6 text-gray-600 font-medium"></p>
            <div class="flex gap-4 justify-center">
                <button id="cancel-unlock" class="flex-1 py-2 bg-gray-200 text-gray-600 rounded-lg font-bold">キャンセル</button>
                <button id="confirm-unlock" class="flex-1 py-2 bg-[var(--primary-color)] text-white rounded-lg font-bold shadow-md">解放する</button>
            </div>
        </div>
    </div>

    <script src="Backgrounds.js" defer></script>
    
    <script th:inline="javascript"> 
    document.addEventListener('DOMContentLoaded', () => {
        // -----------------------------------------------------
		// 【元に戻す箇所】
		const currentLevel = /*[[${currentLevel}]]*/ 12; // またはDBから渡るはずの正しいキー名
        // -----------------------------------------------------
		
        const hasMaterial = true; 
        const contentArea = document.getElementById('content-area');

        // データ読み込み
        const dataItems = document.querySelectorAll('#data-source .data-item');
        const bgList = [];
        
        dataItems.forEach(item => {
            let isLocked = item.dataset.locked === "true";
            const unlockLevel = parseInt(item.dataset.unlockLevel || 0);
            
            // ✅ 修正: ロック判定の際に currentLevel を考慮
            if (unlockLevel > 0 && unlockLevel <= currentLevel) {
                 isLocked = false; // 現在のレベルが解放レベル以上ならロック解除
            } else if (unlockLevel === 0) {
                 isLocked = false;
            }
            // ---------------------------------------------
            
            bgList.push({
                id: item.dataset.id,
                category: item.dataset.category || 'other',
                name: item.dataset.name,
                bgCode: item.dataset.bg,
                imgSrc: item.dataset.imgSrc,
                locked: isLocked,
                unlockLevel: unlockLevel,
                needsMaterial: item.dataset.material === "true",
                selected: false
            });
        });
        
        // 初期選択
        // ✅ 修正: 初期選択は、ロックされていないアイテムで最初のもの、またはリストの最初のアイテムにするのが自然ですが、
        // 既存のコード通りにリストの最初のアイテムを選択するロジックを維持します。
        // すでにロックが解除されているものを選ぶ方が実用的ですが、ここではロジックの変更を最小限にとどめます。
        const initialSelectIndex = bgList.findIndex(bg => !bg.locked) !== -1 ? bgList.findIndex(bg => !bg.locked) : 0;
        bgList[initialSelectIndex].selected = true;


        const categories = [
            { id: 'nature', title: '自然・元素', icon: 'fa-leaf' },
            { id: 'special', title: '日常・スペシャル', icon: 'fa-star' }
        ];

        function renderAll() {
            contentArea.innerHTML = ''; 

            categories.forEach(cat => {
                const items = bgList.filter(item => item.category === cat.id);
                if (items.length === 0) return;

                const section = document.createElement('div');
                section.className = 'mb-8';
                
                section.innerHTML = `
                    <div class="section-header">
                        <h2 class="section-title">${cat.title}</h2>
                    </div>
                    <div class="card-grid" id="grid-${cat.id}"></div>
                `;
                contentArea.appendChild(section);
                const grid = section.querySelector(`#grid-${cat.id}`);

                items.forEach(bg => {
                    const card = document.createElement('div');
                    // ✅ 修正: ロック解除済みで選択可能になった背景にも 'unlocked' クラスを付けるなどで区別できるようにしても良いですが、
                    // ここでは既存のロジックをベースに、UIの表示内容を変更します。
                    card.className = `bg-card ${bg.selected ? 'selected' : ''}`;
                    
                    let overlayHtml = '';
                    let actionHtml = '';
                    let isUnlockableByMaterial = false; // 素材解放可能か

                    if (bg.locked) {
                        let lockText = '';
                        
                        if (bg.needsMaterial) {
                            // 素材ロックの場合
                            if (hasMaterial) {
                                lockText = "解放可能";
                                isUnlockableByMaterial = true;
                            } else {
                                lockText = "素材不足";
                            }
                        } else if (bg.unlockLevel > 0) {
                            // レベルロックの場合
                            if (currentLevel >= bg.unlockLevel) {
                                // レベルが足りている場合
                                lockText = "解放可能";
                            } else {
                                // レベルが足りない場合
                                lockText = `Lv.${bg.unlockLevel}で解放`;
                            }
                        }

                        overlayHtml = `
                            <div class="card-lock-overlay">
                                <i class="fa-solid fa-lock text-2xl mb-1"></i>
                                <span class="text-xs font-bold tracking-widest">LOCKED</span>
                            </div>
                        `;
                        
                        // ✅ 修正: 解放トリガーの条件を見直し
                        if (isUnlockableByMaterial || (bg.unlockLevel > 0 && currentLevel >= bg.unlockLevel && !bg.needsMaterial)) {
                            // レベル条件を満たしているか、素材解放可能 (hasMaterial=true) な場合
                            actionHtml = `<span class="status-text text-unlock-ready unlock-trigger">解放する</span>`;
                        } else {
                            // 解放条件を満たしていない場合
                            actionHtml = `<span class="status-text text-locked">${lockText}</span>`;
                        }

                    } else {
                        if (bg.selected) {
                            actionHtml = `<span class="status-text text-selected"><i class="fa-solid fa-check"></i> 適用中</span>`;
                        } else {
                            actionHtml = `<span class="status-text text-unlock-ready select-trigger">選択する</span>`;
                        }
                    }

                    card.innerHTML = `
                        <div class="card-image-wrapper">
                            <img src="${bg.imgSrc}" alt="${bg.name}" class="card-img">
                            ${overlayHtml}
                        </div>
                        <div class="card-body">
                            <h3 class="card-title">${bg.name}</h3>
                            ${actionHtml}
                        </div>
                    `;
                    
                    // イベント付与
                    const unlockTrigger = card.querySelector('.unlock-trigger');
                    if (unlockTrigger) {
                        // ロック解除可能な場合（レベル達成または素材あり）のみイベントを付与
                        unlockTrigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openUnlockPopup(bg);
                        });
                    }

                    const selectTrigger = card.querySelector('.select-trigger');
                    if (selectTrigger) {
                        selectTrigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectBackground(bg);
                        });
                        // カード全体クリックでも反応させる
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => selectBackground(bg));
                    }

                    grid.appendChild(card);
                });
            });
        }

        function selectBackground(bg) {
            bgList.forEach(b => b.selected = false);
            bg.selected = true;
            renderAll();
        }

        const unlockPopup = document.getElementById('unlock-popup');
        const unlockMessage = document.getElementById('unlock-message');
        const confirmUnlockBtn = document.getElementById('confirm-unlock');
        const cancelUnlockBtn = document.getElementById('cancel-unlock');

        function openUnlockPopup(bg) {
            unlockMessage.textContent = `「${bg.name}」を解放しますか？`;
            unlockPopup.classList.remove('popup-hidden');
            
            // 確認ボタンに新たなイベントリスナーを再設定するため、一度クローンして置き換える
            const newConfirm = confirmUnlockBtn.cloneNode(true);
            confirmUnlockBtn.parentNode.replaceChild(newConfirm, confirmUnlockBtn);
            
            newConfirm.addEventListener('click', () => {
                // ここで実際にサーバー側などに解放処理をリクエストするロジックが入ります。
                bg.locked = false;
                bg.needsMaterial = false; // 素材ロック解除の場合は素材を消費したと見なす
                unlockPopup.classList.add('popup-hidden');
                selectBackground(bg); // 解放したら選択状態にする
                renderAll(); 
            });
        }

        cancelUnlockBtn.addEventListener('click', () => {
            unlockPopup.classList.add('popup-hidden');
        });

        renderAll();
    });
    </script>

</body>
</html>