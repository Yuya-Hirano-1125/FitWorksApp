<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背景一覧 | FitWorks</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/characters/Backgrounds.css}">
    <style>
        /* 背景アニメーション */
        body { font-family: 'Noto Sans JP', sans-serif; }
        .interactive-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(-45deg, #a18cd1, #fbc2eb, #a6c1ee, #96e6a1);
            background-size: 400% 400%; animation: auroraFlow 20s ease infinite;
        }
        @keyframes auroraFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatOrb 30s infinite alternate ease-in-out; z-index: 0; }
        .orb-1 { width: 60vh; height: 60vh; background: #a18cd1; top: -10%; left: -10%; }
        .orb-2 { width: 50vh; height: 50vh; background: #00f2fe; bottom: -10%; right: -10%; animation-delay: -5s; }
        @keyframes floatOrb { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 30px) scale(1.1); } }
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; mix-blend-mode: screen; }
        .mouse-flare { position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(200,240,255,0.8) 30%, rgba(64,150,255,0) 70%); transform: translate(-50%, -50%); pointer-events: none; mix-blend-mode: screen; z-index: 20; filter: blur(15px); }

        /* ガラス効果の上書き */
        .glass-main {
            background: rgba(255, 255, 255, 0.65) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 20px 50px rgba(100, 149, 237, 0.2);
            border-radius: 30px;
        }
    </style>
</head>

<body class="font-sans">
    <div class="interactive-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <canvas id="bg-canvas"></canvas>
        <div id="mouse-flare" class="mouse-flare"></div>
    </div>

    <div class="main-container glass-main p-8 mx-auto my-8 max-w-6xl relative z-10"> 
        
        <div class="page-header text-center mb-8">
            <h1 class="page-title text-3xl font-extrabold flex items-center justify-center gap-2 text-gray-800">
                <i class="fa-solid fa-image text-blue-500"></i>
                背景一覧
            </h1>
            
            <div id="current-level-display" class="mt-4 text-center">
                <span class="text-lg font-extrabold text-[var(--primary-color)] bg-yellow-100 px-4 py-1 rounded-full shadow-md">
                    Lv.<span id="user-level-value" th:text="${userLevel}">1</span>
                </span>
            </div>
        </div>

        <div id="content-area" class="mt-6"></div>

        <div class="back-btn-area text-center mt-8">
            <a th:href="@{/characters/menu/CharactersMenu}" class="menu-back-btn inline-block bg-white border-2 border-blue-400 text-blue-400 font-bold py-2 px-6 rounded-full hover:bg-blue-400 hover:text-white transition">
                <i class="fa-solid fa-reply"></i> メニューに戻る
            </a>
        </div>

    </div>

    <div id="data-source" style="display: none;">
        <div class="data-item" data-id="fire" data-category="nature" data-name="炎の世界" data-bg="fire-original" 
             data-img-src="/img/background/fire-original.png" data-locked="false" data-unlock-level="0"></div>
        <div class="data-item" data-id="water" data-category="nature" data-name="水の世界" data-bg="water-original" 
             data-img-src="/img/background/water-original.png" data-locked="true" data-unlock-level="40"></div>
        <div class="data-item" data-id="grass" data-category="nature" data-name="木の世界" data-bg="grass-original" 
             data-img-src="/img/background/grass-original.png" data-locked="true" data-unlock-level="70"></div>
        <div class="data-item" data-id="light" data-category="nature" data-name="光の世界" data-bg="light-original" 
             data-img-src="/img/background/light-original.png" data-locked="true" data-unlock-level="100"></div>
        <div class="data-item" data-id="dark" data-category="nature" data-name="闇の世界" data-bg="dark-original" 
             data-img-src="/img/background/dark-original.png" data-locked="true" data-unlock-level="130"></div>
        <div class="data-item" data-id="classroom" data-category="special" data-name="教室" data-bg="classroom" 
             data-img-src="/img/background/classroom.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
        <div class="data-item" data-id="gaming" data-category="special" data-name="ゲーミングルーム" data-bg="gaming-room" 
             data-img-src="/img/background/gaming-room.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
        <div class="data-item" data-id="server" data-category="special" data-name="サーバールーム" data-bg="server-room" 
             data-img-src="/img/background/server-room.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
		<div class="data-item" data-id="town" data-category="special" data-name="町並み" data-bg="town-road" 
			 data-img-src="/img/background/town-road.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
		<div class="data-item" data-id="snow" data-category="special" data-name="雪道" data-bg="snow-road" 
			 data-img-src="/img/background/snow-road.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
	    <div class="data-item" data-id="forest" data-category="special" data-name="深い森" data-bg="deep-forest" 
			 data-img-src="/img/background/deep-forest.png" data-locked="true" data-material="true" data-material-name="夢幻の鍵" data-material-id="16"></div>
    </div>

    <div id="unlock-popup" class="popup-hidden unlock-popup-overlay">
        <div class="unlock-popup-content">
            <h3 class="unlock-popup-title">ロック解放</h3>
            <div id="unlock-message" class="unlock-popup-message"></div>
            <div class="unlock-popup-buttons">
                <button id="cancel-unlock" class="unlock-btn-cancel"><i class="fa-solid fa-times"></i> キャンセル</button>
                <button id="confirm-unlock" class="unlock-btn-confirm"><i class="fa-solid fa-unlock-keyhole"></i> 解放する</button>
            </div>
        </div>
    </div>

    <script th:src="@{/js/characters/Backgrounds.js}" defer></script>
    
    <script th:inline="javascript"> 
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', () => {
        // --- アニメーション初期化 ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        const flare = document.getElementById('mouse-flare');
        let particlesArray = [];
        let width, height;
        function resizeCanvas() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        window.addEventListener('mousemove', (event) => {
            flare.style.transform = `translate(${event.clientX}px, ${event.clientY}px) translate(-50%, -50%)`;
            particlesArray.push(new Particle(event.clientX, event.clientY));
        });
        class Particle {
            constructor(x, y) {
                this.x = x || Math.random() * width; this.y = y || Math.random() * height;
                this.size = Math.random() * 5 + 2; this.speedX = Math.random() * 4 - 2; this.speedY = Math.random() * 4 - 2;
                this.color = 'rgba(255, 255, 255, ' + (Math.random() * 0.5 + 0.5) + ')';
            }
            update() { this.x += this.speedX; this.y += this.speedY; if (this.size > 0.2) this.size -= 0.1; }
            draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update(); particlesArray[i].draw();
                if (particlesArray[i].size <= 0.3) { particlesArray.splice(i, 1); i--; }
            }
            requestAnimationFrame(animate);
        }
        animate();
        // --- アニメーション終了 ---

        // --- メインロジック ---
        console.log('========== DOMContentLoaded 開始 ==========');
        
        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            let userLevel = /*[[${userLevel}]]*/ 1;
            let dreamKeyCount = /*[[${dreamKeyCount}]]*/ 0;
            let unlockedBackgroundsSet = /*[[${unlockedBackgrounds}]]*/ [];
            let unlockedBackgrounds = Array.isArray(unlockedBackgroundsSet) 
                ? unlockedBackgroundsSet 
                : Array.from(unlockedBackgroundsSet || []);
            let selectedBackgroundCode = /*[[${selectedBackground}]]*/ 'fire-original';
            
            const contentArea = document.getElementById('content-area');
            const dataItems = document.querySelectorAll('#data-source .data-item');
            const bgList = [];
            
            dataItems.forEach((item) => {
                let isLocked = item.dataset.locked === "true";
                const unlockLevel = parseInt(item.dataset.unlockLevel || 0);
                const needsMaterial = item.dataset.material === "true";
                const materialName = item.dataset.materialName || "";
                const materialId = parseInt(item.dataset.materialId || 0);
                const backgroundId = item.dataset.id;
                
                if (needsMaterial) {
                    isLocked = !unlockedBackgrounds.includes(backgroundId);
                } else if (unlockLevel > 0) {
                    isLocked = unlockLevel > userLevel;
                } else {
                    isLocked = false;
                }
                
                bgList.push({
                    id: item.dataset.id,
                    category: item.dataset.category || 'other',
                    name: item.dataset.name,
                    bgCode: item.dataset.bg,
                    imgSrc: item.dataset.imgSrc,
                    locked: isLocked,
                    unlockLevel: unlockLevel,
                    needsMaterial: needsMaterial,
                    materialName: materialName,
                    materialId: materialId,
                    selected: false
                });
            });
            
            const selectedBg = bgList.find(bg => bg.bgCode === selectedBackgroundCode);
            if (selectedBg && !selectedBg.locked) {
                selectedBg.selected = true;
            } else {
                const initialSelectIndex = bgList.findIndex(bg => !bg.locked);
                if (initialSelectIndex !== -1) bgList[initialSelectIndex].selected = true;
            }

            const categories = [
                { id: 'nature', title: "デフォルト背景"},
                { id: 'special', title: 'スペシャル背景'}
            ];

            function renderAll() {
                contentArea.innerHTML = ''; 
                categories.forEach(cat => {
                    const items = bgList.filter(item => item.category === cat.id);
                    if (items.length === 0) return;

                    const section = document.createElement('div');
                    section.className = 'mb-8';
                    
                    // スペシャル背景の場合は夢幻の鍵表示を追加
                    let dreamKeyHtml = '';
                    if (cat.id === 'special') {
                        dreamKeyHtml = `
                            <div id="dream-key-display" style="display: inline-block; margin-left: 20px; vertical-align: middle;">
                                <div style="background: linear-gradient(135deg, #fae8ff 0%, #f3e8ff 100%); border: 3px solid #9333ea; border-radius: 16px; padding: 10px 14px; box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3); display: inline-flex; align-items: center; gap: 10px;">
                                    <img src="/img/item/UR-niji-touka.png" alt="夢幻の鍵" style="width: 32px !important; height: 32px !important; display: inline-block !important; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));" onerror="this.style.display='none'">
                                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                        <span style="font-size: 10px; color: #7e22ce; font-weight: 600; line-height: 1;">夢幻の鍵</span>
                                        <span id="dream-key-count" style="font-size: 18px; color: #9333ea; font-weight: 800; line-height: 1.2;">${dreamKeyCount}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    section.innerHTML = `
                        <div class="section-header border-b border-gray-200 pb-2 mb-4">
                            <h2 class="section-title text-xl font-bold text-gray-700">
                                <i class="fa-solid ${cat.icon} mr-2"></i>${cat.title}
                            </h2>
                            ${dreamKeyHtml}
                        </div>
                        <div class="card-grid" id="grid-${cat.id}"></div>
                    `;
                    contentArea.appendChild(section);
                    const grid = section.querySelector(`#grid-${cat.id}`);

                    items.forEach(bg => {
                        const card = document.createElement('div');
                        card.className = `bg-card ${bg.selected ? 'selected' : ''}`;
                        let overlayHtml = '', actionHtml = '', canUnlock = false;

                        if (bg.locked) {
                            let lockText = '';
                            if (bg.needsMaterial) {
                                if (dreamKeyCount > 0) {
                                    lockText = `<i class="fa-solid fa-key"></i> ${bg.materialName}で解放`;
                                    canUnlock = true;
                                } else {
                                    lockText = `<i class="fa-solid fa-lock"></i> ${bg.materialName}が必要`;
                                }
                            } else if (bg.unlockLevel > 0) {
                                if (userLevel >= bg.unlockLevel) {
                                    lockText = "解放可能";
                                    canUnlock = true;
                                } else {
                                    lockText = `Lv.${bg.unlockLevel}で解放`;
                                }
                            }
                            overlayHtml = `<div class="card-lock-overlay"><i class="fa-solid fa-lock text-2xl mb-1"></i><span class="text-xs font-bold tracking-widest">LOCKED</span></div>`;
                            if (canUnlock) {
                                actionHtml = `<button class="status-text text-unlock-ready unlock-trigger bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-4 py-2 rounded-lg font-bold transition shadow-md"><i class="fa-solid fa-unlock-keyhole"></i> 解放する</button>`;
                            } else {
                                actionHtml = `<span class="status-text text-locked">${lockText}</span>`;
                            }
                        } else {
                            if (bg.selected) {
                                actionHtml = `<span class="status-text text-selected"><i class="fa-solid fa-check"></i> 適用中</span>`;
                            } else {
                                actionHtml = `<button class="status-text text-unlock-ready select-trigger bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold transition shadow-md"><i class="fa-solid fa-check-circle"></i> 適用する</button>`;
                            }
                        }

                        card.innerHTML = `
                            <div class="card-image-wrapper">
                                <img src="${bg.imgSrc}" alt="${bg.name}" class="card-img">
                                ${overlayHtml}
                            </div>
                            <div class="card-body">
                                <h3 class="card-title">${bg.name}</h3>
                                ${actionHtml}
                            </div>
                        `;
                        
                        const unlockTrigger = card.querySelector('.unlock-trigger');
                        if (unlockTrigger) unlockTrigger.addEventListener('click', (e) => { e.stopPropagation(); openUnlockPopup(bg); });
                        const selectTrigger = card.querySelector('.select-trigger');
                        if (selectTrigger) selectTrigger.addEventListener('click', (e) => { e.stopPropagation(); selectBackground(bg); });
                        grid.appendChild(card);
                    });
                });
            }

            function selectBackground(bg) {
                bgList.forEach(b => b.selected = false);
                bg.selected = true;
                saveSelectedBackground(bg.bgCode);
                renderAll();
            }

            async function saveSelectedBackground(backgroundCode) {
                try {
                    await fetch('/characters/backgrounds/select', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
                        body: JSON.stringify({ backgroundCode: backgroundCode })
                    });
                } catch (error) { console.error(error); }
            }

            const unlockPopup = document.getElementById('unlock-popup');
            const unlockMessage = document.getElementById('unlock-message');
            const confirmUnlockBtn = document.getElementById('confirm-unlock');
            const cancelUnlockBtn = document.getElementById('cancel-unlock');

            function openUnlockPopup(bg) {
                let messageHtml = `<strong>「${bg.name}」</strong>を解放しますか?`;
                if (bg.needsMaterial) {
                    messageHtml += `<br><br><div style="color: #9333ea; font-weight: bold;"><i class="fa-solid fa-key"></i> 必要素材: ${bg.materialName} × 1</div>`;
                }
                unlockMessage.innerHTML = messageHtml;
                unlockPopup.classList.remove('popup-hidden');
                
                const newConfirm = confirmUnlockBtn.cloneNode(true);
                confirmUnlockBtn.parentNode.replaceChild(newConfirm, confirmUnlockBtn);
                
                newConfirm.addEventListener('click', async () => {
                    try {
                        const response = await fetch('/characters/backgrounds/unlock', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
                            body: JSON.stringify({ backgroundId: bg.id, materialId: bg.materialId })
                        });
                        const result = await response.json();
                        if (result.success) {
                            bg.locked = false;
                            if (!unlockedBackgrounds.includes(bg.id)) unlockedBackgrounds.push(bg.id);
                            unlockPopup.classList.add('popup-hidden');
                            if (bg.needsMaterial && result.remainingCount !== undefined) {
                                document.getElementById('dream-key-count').textContent = result.remainingCount;
                                dreamKeyCount = result.remainingCount;
                            }
                            alert(`「${bg.name}」を解放しました!`);
                            selectBackground(bg);
                        } else {
                            alert(result.message || '解放に失敗しました');
                            unlockPopup.classList.add('popup-hidden');
                        }
                    } catch (error) {
                        alert('エラーが発生しました');
                        unlockPopup.classList.add('popup-hidden');
                    }
                });
            }

            cancelUnlockBtn.addEventListener('click', () => { unlockPopup.classList.add('popup-hidden'); });
            renderAll();
        } catch (error) { console.error(error); }
    });
    /*]]>*/
    </script>

</body>
</html>