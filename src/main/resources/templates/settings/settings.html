<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <title>設定 | FitWorks</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/settings.css}">
	<link rel="stylesheet" th:href="@{/css/base.css}">
    
    <script th:src="@{/js/theme.js}"></script>
    <style>
        /* セキュリティセクション用の追加スタイル */
        .btn-register-bio {
            padding: 8px 12px;
            background-color: var(--primary-color, #ffb300);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
        }
        .bio-message {
            font-size: 12px;
            margin-top: 5px;
            color: #666;
            display: block;
        }
    </style>
</head>
<body class="settings-page">
<div class="main-container">
    <h1><i class="fa-solid fa-gear header-icon"></i>設定</h1>
    
    <div class="setting-section" style="--section-index: 1;">
        <div class="section-header" onclick="toggleSection('account-content')">
            <div><span class="section-icon"><i class="fa-solid fa-user-gear"></i></span> アカウント管理</div>
            <span class="arrow">▼</span>
        </div>
        <div class="section-content" id="account-content">
            <div class="setting-item">
                <label>ユーザー名</label>
                <a th:href="@{/edit-username}">変更</a>
            </div>
            <div class="setting-item">
                <label>メールアドレス</label>
                <a th:href="@{/edit-email}">変更</a>
            </div>
            <div class="setting-item">
                <label>パスワード</label>
                <a th:href="@{/change-password}">変更</a>
            </div>
            <div class="setting-item">
                <label>アカウントの削除</label>
                <a th:href="@{/delete-account}" style="color: var(--error-color);">退会</a>
            </div>
        </div>
    </div>

    <div class="setting-section" style="--section-index: 2;">
        <div class="section-header" onclick="toggleSection('security-content')">
            <div><span class="section-icon"><i class="fa-solid fa-fingerprint"></i></span> セキュリティ設定</div>
            <span class="arrow">▼</span>
        </div>
        <div class="section-content" id="security-content">
            <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                    <label>生体認証 (Touch ID / Face ID)</label>
                    <button type="button" id="btn-register-biometric" class="btn-register-bio">デバイスを登録</button>
                </div>
                <span id="bio-message" class="bio-message"></span>
            </div>
        </div>
    </div>

    <div class="setting-section" style="--section-index: 3;">
        <div class="section-header" onclick="toggleSection('notification-content')">
            <div><span class="section-icon"><i class="fa-solid fa-bell"></i></span> 通知設定</div>
            <span class="arrow">▼</span>
        </div>
        <div class="section-content" id="notification-content">
            <div class="setting-item">
                <label for="trainingReminder">トレーニングリマインダー</label>
                <label class="switch">
                    <input type="checkbox" id="trainingReminder" 
                           th:checked="${user.notificationTrainingReminder}"
                           onchange="updateSetting('notificationTrainingReminder', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="aiSuggestion">AIコーチの提案通知</label>
                <label class="switch">
                    <input type="checkbox" id="aiSuggestion"
                           th:checked="${user.notificationAiSuggestion}"
                           onchange="updateSetting('notificationAiSuggestion', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label for="progressReport">進捗レポートメール</label>
                <label class="switch">
                    <input type="checkbox" id="progressReport"
                           th:checked="${user.notificationProgressReport}"
                           onchange="updateSetting('notificationProgressReport', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="setting-section" style="--section-index: 4;">
        <div class="section-header" onclick="toggleSection('privacy-content')">
            <div><span class="section-icon"><i class="fa-solid fa-shield-halved"></i></span> データとプライバシー</div>
            <span class="arrow">▼</span>
        </div>
        <div class="section-content" id="privacy-content">
            <div class="setting-item">
                <label>データ利用の同意</label>
                <label class="switch">
                    <input type="checkbox" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label>広告のパーソナライズ</label>
                <label class="switch">
                    <input type="checkbox">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <label>データのダウンロード</label>
                <a th:href="@{/data-export}">エクスポート</a>
            </div>
        </div>
    </div>

    <div class="setting-section" style="--section-index: 5;">
        <div class="section-header" onclick="toggleSection('general-content')">
            <div><span class="section-icon"><i class="fa-solid fa-sliders"></i></span> 一般設定</div>
            <span class="arrow">▼</span>
        </div>
        <div class="section-content" id="general-content">
            <div class="setting-item">
                <label for="theme-selector">テーマ設定 (色覚サポート)</label>
                <select id="theme-selector" onchange="handleThemeChange(this.value)">
                    <option value="default" th:selected="${user.theme == 'default'}">デフォルト (パステル)</option>
                    <option value="universal" th:selected="${user.theme == 'universal'}">ユニバーサル (青・オレンジ)</option>
                    <option value="high-contrast" th:selected="${user.theme == 'high-contrast'}">ハイコントラスト</option>
                </select>
            </div>
            <div class="setting-item">
                <label>測定単位</label>
                <select>
                    <option>メートル法 (kg/cm)</option>
                    <option>ヤード・ポンド法 (lb/in)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="setting-section" style="--section-index: 6;">
        <div class="section-header" onclick="toggleSection('info-content')">
            <div><span class="section-icon"><i class="fa-solid fa-circle-info"></i></span> ヘルプと情報</div>
            <span class="arrow">▼</span>
        </div>
        <div class="section-content" id="info-content">
            <div class="setting-item">
                <label>よくある質問 (FAQ)</label>
                <a th:href="@{/faq}">表示</a>
            </div>
            <div class="setting-item">
                <label>利用規約</label>
                <a th:href="@{/terms}">表示</a>
            </div>
            <div class="setting-item">
                <label>プライバシーポリシー</label>
                <a th:href="@{/privacy}">表示</a>
            </div>
            <div class="setting-item">
                <label>バージョン</label>
                <span>1.0.0 (FitBot-v3)</span>
            </div>
        </div>
    </div>
    
    <div class="button-container" style="margin-top: 40px;">
        <form th:action="@{/logout}" method="post" style="display:inline;">
            <button type="submit" onclick="return confirmLogout()" class="button primary" style="background: var(--error-color); border-color: var(--error-color); box-shadow: 0 8px 25px rgba(255, 74, 74, 0.6);">
                ログアウト <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </form>
        
        <a th:href="@{/home}" class="button secondary" style="margin-top: 10px;">
            <i class="fa-solid fa-house"></i> ホームに戻る
        </a>
    </div>
</div>

<script>
    // --- 設定更新用API呼び出し ---
    async function updateSetting(key, value) {
        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            const payload = {};
            payload[key] = value;

            const response = await fetch('/api/settings/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.success) {
                console.log(key + ' updated successfully');
            } else {
                console.error('Failed to update setting');
                alert('設定の保存に失敗しました。');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // --- テーマ変更処理 ---
    function handleThemeChange(themeName) {
        localStorage.setItem('fitworks-theme', themeName);
        if (typeof applyTheme === 'function') {
            applyTheme();
        }
        updateSetting('theme', themeName);
    }

    // --- ログアウト確認 ---
    function confirmLogout() {
        return confirm("本当にログアウトしますか？");
    }

    // --- アコーディオン処理 ---
    function toggleSection(contentId) {
        const content = document.getElementById(contentId);
        const sectionHeader = content.previousElementSibling; 
        const arrow = sectionHeader.querySelector('.arrow');
        
        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
            // 閉じる
            content.style.maxHeight = '0px';
            content.style.paddingTop = '0px';
            content.style.paddingBottom = '0px';
            arrow.innerHTML = '▼';
            setTimeout(() => { content.style.display = 'none'; }, 300); 
        } else {
            // 開く
            content.style.display = 'block'; 
            content.style.maxHeight = content.scrollHeight + 30 + "px"; 
            content.style.paddingTop = '10px';
            content.style.paddingBottom = '15px';
            arrow.innerHTML = '▲';
        }
    }

    // --- ★生体認証登録処理 ---
    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function base64urlToBuffer(base64url) {
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }

    document.getElementById('btn-register-biometric').addEventListener('click', async () => {
        const msgArea = document.getElementById('bio-message');
        msgArea.textContent = '処理中...';
        msgArea.style.color = '#666';

        if (!window.PublicKeyCredential) {
            alert('このデバイスは生体認証に対応していません。');
            return;
        }

        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            // 1. オプション取得
            const optRes = await fetch('/api/webauthn/register/options');
            if (!optRes.ok) throw new Error('オプション取得失敗');
            const options = await optRes.json();

            // 2. 認証器作成
            const credential = await navigator.credentials.create({
                publicKey: {
                    rp: { name: "FitWorks" },
                    user: {
                        id: base64urlToBuffer(options.user.id),
                        name: options.user.name,
                        displayName: options.user.displayName
                    },
                    challenge: base64urlToBuffer(options.challenge),
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 }, 
                        { type: "public-key", alg: -257 }
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform", 
                        userVerification: "preferred"
                    },
                    timeout: 60000
                }
            });

            // 3. 登録リクエスト
            const regRes = await fetch('/api/webauthn/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                    attestationObject: bufferToBase64url(credential.response.attestationObject),
                    deviceName: "My Device"
                })
            });

            if (regRes.ok) {
                msgArea.textContent = '登録完了！次回からログインで使用できます。';
                msgArea.style.color = 'green';
                alert('生体認証を登録しました');
            } else {
                const errText = await regRes.text();
                throw new Error(errText);
            }
        } catch (e) {
            console.error(e);
            msgArea.textContent = 'エラー: ' + e.message;
            msgArea.style.color = 'red';
        }
    });

    // --- 初期化処理 ---
    document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('theme-selector');
        if (selector) {
            localStorage.setItem('fitworks-theme', selector.value);
            if (typeof applyTheme === 'function') {
                applyTheme();
            }
        }

        // アコーディオン初期状態 (全て閉じる)
        document.querySelectorAll('.setting-section').forEach(section => {
            const content = section.querySelector('.section-content');
            const arrow = section.querySelector('.arrow');
            
            content.style.maxHeight = '0px';
            content.style.paddingTop = '0px';
            content.style.paddingBottom = '0px';
            content.style.display = 'none';
            if (arrow) arrow.innerHTML = '▼';
        });
    });
</script>
</body>
</html>